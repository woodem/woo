


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>woo.utils &#8212; Woo 1.0+rev1-git-8bbb0e2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/cloud.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>

    
    
     
        <script src="../../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../../_static/cloud.base.js"></script>
    

    
     
        <script src="../../_static/cloud.js"></script>
    

    <link rel="shortcut icon" href="../../_static/woo-favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">Woo 1.0+rev1-git-8bbb0e2 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">woo.utils</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for woo.utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># encoding: utf-8</span>
<span class="c1">#</span>
<span class="c1"># utility functions for woo</span>
<span class="c1">#</span>
<span class="c1"># 2008-2009 © Václav Šmilauer &lt;eudoxos@arcig.cz&gt;</span>

<span class="sd">&quot;&quot;&quot;Heap of functions that don&#39;t (yet) fit anywhere else.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span><span class="nn">random</span><span class="o">,</span><span class="nn">doctest</span>
<span class="kn">import</span> <span class="nn">woo</span><span class="o">,</span> <span class="nn">woo.dem</span><span class="o">,</span> <span class="nn">woo.core</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">minieigen</span> <span class="k">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">woo.dem</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">woo.fem</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">woo.core</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">woo</span>
<span class="kn">import</span> <span class="nn">woo.config</span>

<span class="c1"># c++ implementations for performance reasons</span>
<span class="c1">#from woo._utils import *</span>
<span class="c1">#from woo._utils2 import *</span>
<span class="kn">from</span> <span class="nn">woo._utils2</span> <span class="k">import</span> <span class="o">*</span>


<span class="c1"># declare that _utils2 should be documented here</span>
<span class="n">_docInlineModules</span><span class="o">=</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">_utils2</span><span class="p">,)</span>

<span class="n">inf</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

<span class="c1"># try at import time, this is expensive</span>
<span class="n">hasGL</span><span class="o">=</span><span class="kc">True</span>
<span class="k">try</span><span class="p">:</span> <span class="kn">import</span> <span class="nn">woo.gl</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="n">hasGL</span><span class="o">=</span><span class="kc">False</span>


<div class="viewcode-block" id="find_executable"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.find_executable">[docs]</a><span class="k">def</span> <span class="nf">find_executable</span><span class="p">(</span><span class="n">ex</span><span class="p">):</span>
    <span class="s1">&#39;Thin wrapper for find_executable, using either shutil.which or distutils.spawn.find_executable.&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">shutil</span>
        <span class="k">return</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">distutils.spawn</span>
        <span class="k">return</span> <span class="n">distutils</span><span class="o">.</span><span class="n">spawn</span><span class="o">.</span><span class="n">find_executable</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span></div>

<span class="c1"># https://stackoverflow.com/a/55276759/761090</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span><span class="p">,</span><span class="n">partialmethod</span>
<span class="n">logging</span><span class="o">.</span><span class="n">TRACE</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="o">-</span><span class="mi">5</span>
<span class="n">logging</span><span class="o">.</span><span class="n">addLevelName</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">TRACE</span><span class="p">,</span><span class="s1">&#39;TRACE&#39;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="o">.</span><span class="n">trace</span><span class="o">=</span><span class="n">partialmethod</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="n">logging</span><span class="o">.</span><span class="n">TRACE</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">trace</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="n">logging</span><span class="o">.</span><span class="n">TRACE</span><span class="p">)</span>

<div class="viewcode-block" id="makeLog"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.makeLog">[docs]</a><span class="k">def</span> <span class="nf">makeLog</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">coloredlogs</span>
        <span class="n">coloredlogs</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(name)-8s</span><span class="s1"> </span><span class="si">%(filename)s</span><span class="s1">:</span><span class="si">%(lineno)d</span><span class="s1"> [</span><span class="si">%(levelname)s</span><span class="s1">] </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="k">pass</span>
    <span class="c1">## does not really color... why?</span>
    <span class="c1">#try:</span>
    <span class="c1">#    import colorlog</span>
    <span class="c1">#    handler=colorlog.StreamHandler()</span>
    <span class="c1">#    handler.setFormatter(colorlog.ColoredFormatter(&#39;%(asctime)s %(name)-8s %(filename)s:%(lineno)d [%(levelname)s] %(message)s&#39;,datefmt=&#39;%H:%M:%S&#39;,reset=True))</span>
    <span class="c1">#    ret=colorlog.getLogger(name)</span>
    <span class="c1">#    ret.addHandler(handler)</span>
    <span class="c1">#    ret.setLevel(&#39;INFO&#39;)</span>
    <span class="c1">#    return ret</span>
    <span class="c1">#except ImportError: pass</span>
    <span class="k">return</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<span class="c1"># use right away, for functions in this module</span>
<span class="n">log</span><span class="o">=</span><span class="n">makeLog</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="spherePWaveDt"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.spherePWaveDt">[docs]</a><span class="k">def</span> <span class="nf">spherePWaveDt</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span><span class="n">density</span><span class="p">,</span><span class="n">young</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute P-wave critical timestep for a single (presumably representative) sphere, using formula for P-Wave propagation speed :math:`\Delta t_{c}=\frac{r}{\sqrt{E/\rho}}`. If you want to compute minimum critical timestep for all spheres in the simulation, use :obj:`woo.utils.pWaveDt` instead.</span>

<span class="sd">    &gt;&gt;&gt; spherePWaveDt(1e-3,2400,30e9)</span>
<span class="sd">    2.8284271247461903e-07</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">sqrt</span>
    <span class="k">return</span> <span class="n">radius</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">young</span><span class="o">/</span><span class="n">density</span><span class="p">)</span></div>

<div class="viewcode-block" id="defaultMaterial"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.defaultMaterial">[docs]</a><span class="k">def</span> <span class="nf">defaultMaterial</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return default material, when creating particles with :obj:`woo.utils.sphere` and friends and material is unspecified. This function returns ``FrictMat(density=1e3,young=1e7,ktDivKn=.2,tanPhi=tan(.5))``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="k">return</span> <span class="n">FrictMat</span><span class="p">(</span><span class="n">density</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">young</span><span class="o">=</span><span class="mf">1e7</span><span class="p">,</span><span class="n">ktDivKn</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span><span class="n">tanPhi</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="p">))</span></div>

<div class="viewcode-block" id="defaultEngines"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.defaultEngines">[docs]</a><span class="k">def</span> <span class="nf">defaultEngines</span><span class="p">(</span><span class="n">damping</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">gravity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">verletDist</span><span class="o">=-.</span><span class="mi">05</span><span class="p">,</span><span class="n">kinSplit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dontCollect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">noSlip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">noBreak</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cp2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">law</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">collider</span><span class="o">=</span><span class="s1">&#39;sap&#39;</span><span class="p">,</span><span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dynDtPeriod</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">cpKw</span><span class="o">=</span><span class="p">{},</span><span class="n">lawKw</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;Return default set of engines, suitable for basic simulations during testing.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">grid</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;*grid* argument is deprecated, use collider=&quot;grid&quot; instead.&#39;</span><span class="p">)</span>
        <span class="n">collider</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span>
    <span class="k">if</span> <span class="n">gravity</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;gravity MUST NOT be specified anymore, set DemField.gravity=... instead.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cp2</span> <span class="ow">or</span> <span class="n">law</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;cp2 and law args are ignored when model is provided.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">damping</span><span class="o">!=</span><span class="mf">0.</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;damping is ignored when model is provided.&quot;</span><span class="p">)</span>
        <span class="n">cp2</span><span class="p">,</span><span class="n">law</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">getFunctors</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">law</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">law</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;contactLaw&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cp2</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">cp2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;cp2&#39;</span>
        <span class="n">damping</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">getNonviscDamping</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">distFactor</span><span class="o">!=</span><span class="mf">1.0</span><span class="p">:</span>
            <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">checkApi</span><span class="p">(</span><span class="mi">10103</span><span class="p">,</span><span class="s2">&quot;woo.models.ContactModelSelector.distFactor has non-default value. The new API does not set this value in engines returned from DemField.minimalEngines anymore, it *must* be set as DemField.distFactor by the caller.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cp2</span><span class="o">=</span><span class="p">[</span><span class="n">cp2</span> <span class="k">if</span> <span class="n">cp2</span> <span class="k">else</span> <span class="n">Cp2_FrictMat_FrictPhys</span><span class="p">()]</span>
        <span class="n">law</span><span class="o">=</span><span class="p">[</span><span class="n">law</span> <span class="k">if</span> <span class="n">law</span> <span class="k">else</span> <span class="n">Law2_L6Geom_FrictPhys_IdealElPl</span><span class="p">(</span><span class="n">noSlip</span><span class="o">=</span><span class="n">noSlip</span><span class="p">,</span><span class="n">noBreak</span><span class="o">=</span><span class="n">noBreak</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;contactLaw&#39;</span><span class="p">)]</span>
        
    <span class="n">cp2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">updateAttrs</span><span class="p">(</span><span class="n">cpKw</span><span class="p">)</span>
    <span class="n">law</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">updateAttrs</span><span class="p">(</span><span class="n">lawKw</span><span class="p">)</span>

    <span class="n">bo1_aabb</span><span class="o">=</span><span class="p">[</span><span class="n">Bo1_Sphere_Aabb</span><span class="p">(),</span><span class="n">Bo1_Facet_Aabb</span><span class="p">(),</span><span class="n">Bo1_Wall_Aabb</span><span class="p">(),</span><span class="n">Bo1_InfCylinder_Aabb</span><span class="p">(),</span><span class="n">Bo1_Ellipsoid_Aabb</span><span class="p">(),</span><span class="n">Bo1_Rod_Aabb</span><span class="p">(),</span><span class="n">Bo1_Capsule_Aabb</span><span class="p">(),</span><span class="n">Bo1_Cone_Aabb</span><span class="p">()]</span>

    <span class="k">if</span> <span class="n">collider</span><span class="o">==</span><span class="s1">&#39;sap&#39;</span><span class="p">:</span> <span class="n">coll</span><span class="o">=</span><span class="n">InsertionSortCollider</span><span class="p">(</span><span class="n">bo1_aabb</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;collider&#39;</span><span class="p">,</span><span class="n">verletDist</span><span class="o">=</span><span class="n">verletDist</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">collider</span><span class="o">==</span><span class="s1">&#39;tree&#39;</span><span class="p">:</span> <span class="n">coll</span><span class="o">=</span><span class="n">AabbTreeCollider</span><span class="p">(</span><span class="n">bo1_aabb</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;collider&#39;</span><span class="p">,</span><span class="n">verletDist</span><span class="o">=</span><span class="n">verletDist</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">collider</span><span class="o">==</span><span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">coll</span><span class="o">=</span><span class="n">GridCollider</span><span class="p">([</span><span class="n">Grid1_Sphere</span><span class="p">(),</span><span class="n">Grid1_Facet</span><span class="p">(),</span><span class="n">Grid1_Wall</span><span class="p">(),</span><span class="n">Grid1_InfCylinder</span><span class="p">()],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;collider&#39;</span><span class="p">,</span><span class="n">verletDist</span><span class="o">=</span><span class="n">verletDist</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">Leapfrog</span><span class="p">(</span><span class="n">damping</span><span class="o">=</span><span class="n">damping</span><span class="p">,</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">kinSplit</span><span class="o">=</span><span class="n">kinSplit</span><span class="p">,</span><span class="n">dontCollect</span><span class="o">=</span><span class="n">dontCollect</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;leapfrog&#39;</span><span class="p">),</span>
        <span class="n">coll</span><span class="p">,</span>
        <span class="n">ContactLoop</span><span class="p">(</span>
            <span class="p">[</span><span class="n">Cg2_Sphere_Sphere_L6Geom</span><span class="p">(),</span><span class="n">Cg2_Facet_Sphere_L6Geom</span><span class="p">(),</span><span class="n">Cg2_Wall_Sphere_L6Geom</span><span class="p">(),</span><span class="n">Cg2_InfCylinder_Sphere_L6Geom</span><span class="p">(),</span><span class="n">Cg2_Ellipsoid_Ellipsoid_L6Geom</span><span class="p">(),</span><span class="n">Cg2_Sphere_Ellipsoid_L6Geom</span><span class="p">(),</span><span class="n">Cg2_Wall_Ellipsoid_L6Geom</span><span class="p">(),</span><span class="n">Cg2_Wall_Facet_L6Geom</span><span class="p">(),</span><span class="n">Cg2_Rod_Sphere_L6Geom</span><span class="p">(),</span><span class="n">Cg2_Wall_Capsule_L6Geom</span><span class="p">(),</span><span class="n">Cg2_Capsule_Capsule_L6Geom</span><span class="p">(),</span><span class="n">Cg2_InfCylinder_Capsule_L6Geom</span><span class="p">(),</span><span class="n">Cg2_Facet_Capsule_L6Geom</span><span class="p">(),</span><span class="n">Cg2_Sphere_Capsule_L6Geom</span><span class="p">(),</span><span class="n">Cg2_Facet_Facet_L6Geom</span><span class="p">(),</span><span class="n">Cg2_Facet_InfCylinder_L6Geom</span><span class="p">(),</span><span class="n">Cg2_Cone_Sphere_L6Geom</span><span class="p">()],</span>
            <span class="n">cp2</span><span class="p">,</span><span class="n">law</span><span class="p">,</span><span class="n">applyForces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;contactLoop&#39;</span>
        <span class="p">),</span>
    <span class="p">]</span><span class="o">+</span><span class="p">([</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">DynDt</span><span class="p">(</span><span class="n">stepPeriod</span><span class="o">=</span><span class="n">dynDtPeriod</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;dynDt&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="n">dynDtPeriod</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="p">[])</span></div>

<span class="k">def</span> <span class="nf">_commonBodySetup</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">nodes</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assign common body parameters.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">Material</span><span class="p">):</span> <span class="n">b</span><span class="o">.</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span>
    <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">mat</span><span class="p">):</span> <span class="n">b</span><span class="o">.</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The &#39;mat&#39; argument must be Material instance, or a callable returning Material.&quot;</span><span class="p">);</span>
    <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">nodes</span><span class="o">=</span><span class="n">nodes</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">b</span><span class="o">.</span><span class="n">updateMassInertia</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">mass</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">inertia</span><span class="o">=</span><span class="n">Vector3</span><span class="o">.</span><span class="n">Zero</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">nodes</span><span class="p">):</span>
        <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">addParRef</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="c1"># tell the node that it has that particle</span>
        <span class="k">if</span> <span class="n">fixed</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="k">pass</span> <span class="c1"># do not modify blocked at all</span>
        <span class="k">elif</span> <span class="n">fixed</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">blocked</span><span class="o">=</span><span class="s1">&#39;xyzXYZ&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">blocked</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;XYZ&#39;</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">inertia</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">==</span><span class="n">inf</span><span class="p">])</span> <span class="c1"># block rotational DOFs where inertia is infinite</span>

<span class="k">def</span> <span class="nf">_mkDemNode</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Helper function to create new Node instance, with dem set to an new empty instance.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">hasGL</span><span class="p">:</span> <span class="k">return</span> <span class="n">Node</span><span class="p">(</span><span class="n">dem</span><span class="o">=</span><span class="n">DemData</span><span class="p">(),</span><span class="n">gl</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">gl</span><span class="o">.</span><span class="n">GlData</span><span class="p">(),</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">Node</span><span class="p">(</span><span class="n">dem</span><span class="o">=</span><span class="n">DemData</span><span class="p">(),</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<div class="viewcode-block" id="sphere"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.sphere">[docs]</a><span class="k">def</span> <span class="nf">sphere</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">defaultMaterial</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">wire</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">highlight</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">DemField</span><span class="o">.</span><span class="n">defaultMovableMask</span><span class="p">,</span><span class="n">vel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create sphere with given parameters; mass and inertia computed automatically.</span>

<span class="sd">    :param Vector3 center: center</span>
<span class="sd">    :param float radius: radius</span>
<span class="sd">    :param float-or-None: particle&#39;s color as float; random color will be assigned if ``None``.</span>
<span class="sd">    :param mat:</span>
<span class="sd">        specify :obj:`woo.dem.Particle.material`; different types are accepted:</span>
<span class="sd">            * :obj:`woo.dem.Material` instance: this instance will be used</span>
<span class="sd">            * callable: will be called without arguments; returned Material value will be used (Material factory object, if you like)</span>
<span class="sd">    :param int mask: :obj:`woo.dem.Particle.mask` for the body</span>

<span class="sd">    :return:</span>
<span class="sd">        Particle instance with desired characteristics.</span>

<span class="sd">    Instance of material can be given::</span>

<span class="sd">        &gt;&gt;&gt; from woo import utils</span>
<span class="sd">        &gt;&gt;&gt; s1=utils.sphere((0,0,0),1,wire=False,color=.7,mat=ElastMat(young=30e9,density=2e3))</span>
<span class="sd">        &gt;&gt;&gt; s1.shape.wire</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; s1.shape.color</span>
<span class="sd">        0.7</span>
<span class="sd">        &gt;&gt;&gt; s1.mat.density</span>
<span class="sd">        2000.0</span>

<span class="sd">    Finally, material can be a callable object (taking no arguments), which returns a Material instance.</span>
<span class="sd">    Use this if you don&#39;t call this function directly (for instance, through woo.pack.randomDensePack), passing</span>
<span class="sd">    only 1 *material* parameter, but you don&#39;t want material to be shared.</span>

<span class="sd">    For instance, randomized material properties can be created like this:</span>

<span class="sd">        &gt;&gt;&gt; import random</span>
<span class="sd">        &gt;&gt;&gt; def matFactory(): return ElastMat(young=1e10*random.random(),density=1e3+1e3*random.random())</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; s2=utils.sphere([0,2,0],1,mat=matFactory)</span>
<span class="sd">        &gt;&gt;&gt; s3=utils.sphere([1,2,0],1,mat=matFactory)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">b</span><span class="o">=</span><span class="n">Particle</span><span class="p">()</span>
    <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="n">Sphere</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span> <span class="k">if</span> <span class="n">color</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
    <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">wire</span><span class="o">=</span><span class="n">wire</span>
    <span class="n">_commonBodySetup</span><span class="p">(</span><span class="n">b</span><span class="p">,([</span><span class="n">center</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="n">Node</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">_mkDemNode</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">center</span><span class="p">),]),</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="n">fixed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vel</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">vel</span><span class="o">=</span><span class="n">vel</span>
    <span class="c1">#b.aspherical=False</span>
    <span class="n">b</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span>
    <span class="k">return</span> <span class="n">b</span></div>

<div class="viewcode-block" id="ellipsoid"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.ellipsoid">[docs]</a><span class="k">def</span> <span class="nf">ellipsoid</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="n">semiAxes</span><span class="p">,</span><span class="n">ori</span><span class="o">=</span><span class="n">Quaternion</span><span class="o">.</span><span class="n">Identity</span><span class="p">,</span><span class="n">angVel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">defaultMaterial</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">wire</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">DemField</span><span class="o">.</span><span class="n">defaultMovableMask</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="s1">&#39;Return an :obj:`woo.dem.Ellipsoid` particle.&#39;</span>
    <span class="n">p</span><span class="o">=</span><span class="n">Particle</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="n">Ellipsoid</span><span class="p">(</span><span class="n">semiAxes</span><span class="o">=</span><span class="n">semiAxes</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span> <span class="k">if</span> <span class="n">color</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
    <span class="n">_commonBodySetup</span><span class="p">(</span><span class="n">p</span><span class="p">,([</span><span class="n">center</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="n">Node</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">_mkDemNode</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">center</span><span class="p">,</span><span class="n">ori</span><span class="o">=</span><span class="n">ori</span><span class="p">),]),</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="n">fixed</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">wire</span><span class="o">=</span><span class="n">wire</span>
    <span class="c1">#p.aspherical=True</span>
    <span class="n">p</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">visible</span><span class="o">=</span><span class="n">visible</span>
    <span class="k">if</span> <span class="n">angVel</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">angVel</span><span class="o">=</span><span class="n">angVel</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="capsule"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.capsule">[docs]</a><span class="k">def</span> <span class="nf">capsule</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">shaft</span><span class="p">,</span><span class="n">ori</span><span class="o">=</span><span class="n">Quaternion</span><span class="o">.</span><span class="n">Identity</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">wire</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">defaultMaterial</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">DemField</span><span class="o">.</span><span class="n">defaultMovableMask</span><span class="p">):</span>
    <span class="s1">&#39;Return a ready-made capsule particle.&#39;</span>
    <span class="n">p</span><span class="o">=</span><span class="n">Particle</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="n">Capsule</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="n">shaft</span><span class="o">=</span><span class="n">shaft</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span> <span class="k">if</span> <span class="n">color</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
    <span class="n">_commonBodySetup</span><span class="p">(</span><span class="n">p</span><span class="p">,([</span><span class="n">center</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="n">Node</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">_mkDemNode</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">center</span><span class="p">,</span><span class="n">ori</span><span class="o">=</span><span class="n">ori</span><span class="p">),]),</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="n">fixed</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">wire</span><span class="o">=</span><span class="n">wire</span>
    <span class="c1">#p.aspherical=True</span>
    <span class="n">p</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="cone"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.cone">[docs]</a><span class="k">def</span> <span class="nf">cone</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span><span class="n">radii</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">wire</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">angVel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">defaultMaterial</span><span class="p">,</span><span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">DemField</span><span class="o">.</span><span class="n">defaultBoundaryMask</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create cone with given parameters.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">Node</span><span class="p">):</span> <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_mkDemNode</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dem</span><span class="p">:</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dem</span><span class="o">=</span><span class="n">DemData</span><span class="p">()</span>
    <span class="n">p</span><span class="o">=</span><span class="n">Particle</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="n">Cone</span><span class="p">(</span><span class="n">radii</span><span class="o">=</span><span class="n">radii</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span> <span class="k">if</span> <span class="n">color</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">wire</span><span class="o">=</span><span class="n">wire</span>
    <span class="n">_commonBodySetup</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">nodes</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="n">fixed</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">visible</span><span class="o">=</span><span class="n">visible</span>
    <span class="k">if</span> <span class="n">angVel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">angVel</span><span class="p">,(</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">)):</span> <span class="n">angVel</span><span class="o">=</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pos</span><span class="o">-</span><span class="n">p</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span><span class="o">*</span><span class="n">angVel</span>
        <span class="n">p</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">angVel</span><span class="o">=</span><span class="n">angVel</span>
    <span class="k">return</span> <span class="n">p</span></div>


<div class="viewcode-block" id="wall"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.wall">[docs]</a><span class="k">def</span> <span class="nf">wall</span><span class="p">(</span><span class="n">position</span><span class="p">,</span><span class="n">axis</span><span class="p">,</span><span class="n">sense</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">glAB</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">defaultMaterial</span><span class="p">,</span><span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">DemField</span><span class="o">.</span><span class="n">defaultBoundaryMask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return ready-made wall body.</span>

<span class="sd">    :param float-or-Vector3-or-Node position: center of the wall. If float, it is the position along given axis, the other 2 components being zero</span>
<span class="sd">    :param ∈{0,1,2} axis: orientation of the wall normal (0,1,2) for x,y,z (sc. planes yz, xz, xy)</span>
<span class="sd">    :param ∈{-1,0,1} sense: sense in which to interact (0: both, -1: negative, +1: positive; see :obj:`woo.dem.Wall`)</span>

<span class="sd">    See :obj:`woo.utils.sphere`&#39;s documentation for meaning of other parameters.&quot;&quot;&quot;</span>
    <span class="n">p</span><span class="o">=</span><span class="n">Particle</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="n">Wall</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">sense</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span> <span class="k">if</span> <span class="n">color</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">glAB</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">glAB</span><span class="o">=</span><span class="n">glAB</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fixed</span> <span class="ow">and</span> <span class="n">mass</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non-fixed wall must have positive mass&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">position</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">)):</span>
        <span class="n">pos2</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> <span class="n">pos2</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">=</span><span class="n">position</span>
        <span class="n">node</span><span class="o">=</span><span class="n">_mkDemNode</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">pos2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">position</span><span class="p">,</span><span class="n">Node</span><span class="p">):</span> <span class="n">node</span><span class="o">=</span><span class="n">position</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">node</span><span class="o">=</span><span class="n">_mkDemNode</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">position</span><span class="p">)</span>
    <span class="n">_commonBodySetup</span><span class="p">(</span><span class="n">p</span><span class="p">,[</span><span class="n">node</span><span class="p">],</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="n">fixed</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">mass</span><span class="o">=</span><span class="n">mass</span>
    <span class="c1">#p.aspherical=False # wall never rotates anyway</span>
    <span class="n">p</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">visible</span><span class="o">=</span><span class="n">visible</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="wallBox"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.wallBox">[docs]</a><span class="k">def</span> <span class="nf">wallBox</span><span class="p">(</span><span class="n">box</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return box delimited by walls, created by :obj:`woo.dem.Wall.make`, which receives most arguments. :obj:`Wall.glAB &lt;woo.dem.Wall.glAB&gt;` are computed automatically so that walls visually end at the edges.</span>
<span class="sd">    </span>
<span class="sd">    .. note:: Since :obj:`walls &lt;woo.dem.Wall&gt;` are infinite, they will still interact with other particle beyond this box; use :obj:`woo.triangulated.box` for true box with arbitrary orientation.</span>
<span class="sd">    </span>
<span class="sd">    :param box: axis-aligned box determining positions of walls.</span>
<span class="sd">    :param which: determines which of the 6 walls are created (boolean values), in the order -x, -y, -z, +x, +y, +z. For instance, to create a box which does not have the top, say ``which=(1,1,1,1,1,0)``).</span>
<span class="sd">    :returns: list of :obj:`~woo.dem.Particle` objects.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ret</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">box</span><span class="o">=</span><span class="n">AlignedBox3</span><span class="p">(</span><span class="n">box</span><span class="p">)</span> <span class="c1"># force conversion</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">which</span><span class="p">)</span><span class="o">!=</span><span class="mi">6</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wall.makeBox: which must be a sequence of 6 boolean-convertibles.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sense</span><span class="p">,</span><span class="n">ix</span><span class="p">,</span><span class="n">coord</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">box</span><span class="o">.</span><span class="n">min</span><span class="p">),(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">box</span><span class="o">.</span><span class="n">max</span><span class="p">)]:</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">which</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ix</span><span class="o">+</span><span class="n">ax</span><span class="p">]:</span> <span class="k">continue</span>
            <span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="o">=</span><span class="p">(</span><span class="n">ax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">3</span><span class="p">,(</span><span class="n">ax</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">%</span><span class="mi">3</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Wall</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="n">ax</span><span class="p">],</span><span class="n">sense</span><span class="o">=</span><span class="n">sense</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">glAB</span><span class="o">=</span><span class="n">AlignedBox2</span><span class="p">((</span><span class="n">box</span><span class="o">.</span><span class="n">min</span><span class="p">[</span><span class="n">ax1</span><span class="p">],</span><span class="n">box</span><span class="o">.</span><span class="n">min</span><span class="p">[</span><span class="n">ax2</span><span class="p">]),(</span><span class="n">box</span><span class="o">.</span><span class="n">max</span><span class="p">[</span><span class="n">ax1</span><span class="p">],</span><span class="n">box</span><span class="o">.</span><span class="n">max</span><span class="p">[</span><span class="n">ax2</span><span class="p">])),</span><span class="o">**</span><span class="n">kw</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="rod"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.rod">[docs]</a><span class="k">def</span> <span class="nf">rod</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">wire</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">defaultMaterial</span><span class="p">,</span><span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">DemField</span><span class="o">.</span><span class="n">defaultBoundaryMask</span><span class="p">,</span><span class="n">__class</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Rod</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create :obj:`~woo.dem.Rod` with given parameters:</span>

<span class="sd">        :param vertices: endpoints given as coordinates (Vector3) or nodes</span>
<span class="sd">        :param radius: radius of the rod</span>
<span class="sd">        :param wire: render as wire by default</span>
<span class="sd">        :param color: color as scalar (0...1); if not given, random color is assigned</span>
<span class="sd">        :param mat: material; if not given, default material is assigned</span>
<span class="sd">        :param visible:</span>
<span class="sd">        :param mask:</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">Node</span><span class="p">):</span> <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_mkDemNode</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dem</span><span class="p">:</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dem</span><span class="o">=</span><span class="n">DemData</span><span class="p">()</span>
    <span class="n">p</span><span class="o">=</span><span class="n">Particle</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="n">__class</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span> <span class="k">if</span> <span class="n">color</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">wire</span><span class="o">=</span><span class="n">wire</span>
    <span class="n">_commonBodySetup</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">nodes</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="n">fixed</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">visible</span><span class="o">=</span><span class="n">visible</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="truss"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.truss">[docs]</a><span class="k">def</span> <span class="nf">truss</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rod</span><span class="p">(</span><span class="n">__class</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Truss</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>



<div class="viewcode-block" id="facet"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.facet">[docs]</a><span class="k">def</span> <span class="nf">facet</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span><span class="n">fakeVel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">halfThick</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">wire</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">highlight</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">defaultMaterial</span><span class="p">,</span><span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">DemField</span><span class="o">.</span><span class="n">defaultBoundaryMask</span><span class="p">,</span><span class="n">flex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">__class</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Facet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create facet with given parameters.</span>

<span class="sd">    :param [Vector3,Vector3,Vector3] vertices: coordinates of vertices in the global coordinate system.</span>
<span class="sd">    :param bool wire: if ``True``, facets are shown as skeleton; otherwise facets are filled</span>

<span class="sd">    See :obj:`woo.utils.sphere`&#39;s documentation for meaning of other parameters.&quot;&quot;&quot;</span>
    <span class="n">p</span><span class="o">=</span><span class="n">Particle</span><span class="p">()</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Node</span><span class="p">):</span>
        <span class="n">nodes</span><span class="o">=</span><span class="n">vertices</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">=</span><span class="n">DemData</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="n">_mkDemNode</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">_mkDemNode</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">_mkDemNode</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">vertices</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
    <span class="k">if</span> <span class="n">flex</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">flex</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Facet.make(...,flex=True) is deprecated, use Membrane.make(...) instead.&#39;</span><span class="p">,</span><span class="ne">DeprecationWarning</span><span class="p">,</span><span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">__class</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Membrane</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="n">__class</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span> <span class="k">if</span> <span class="n">color</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span><span class="n">halfThick</span><span class="o">=</span><span class="n">halfThick</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fakeVel</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">fakeVel</span><span class="o">=</span><span class="n">fakeVel</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">wire</span><span class="o">=</span><span class="n">wire</span>
    <span class="n">_commonBodySetup</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">nodes</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="n">fixed</span><span class="p">)</span>
    <span class="c1">#p.aspherical=False # mass and inertia are 0 anyway; fell free to change to ``True`` if needed</span>
    <span class="n">p</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">visible</span><span class="o">=</span><span class="n">visible</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="membrane"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.membrane">[docs]</a><span class="k">def</span> <span class="nf">membrane</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;flex&#39;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Membrane.make: *flex* argument not accepted (use Membrane.make for Membranes and Facet.make for pure facets).&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">facet</span><span class="p">(</span><span class="n">__class</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Membrane</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>

<div class="viewcode-block" id="tetra"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.tetra">[docs]</a><span class="k">def</span> <span class="nf">tetra</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">wire</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">highlight</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">defaultMaterial</span><span class="p">,</span><span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">DemField</span><span class="o">.</span><span class="n">defaultBoundaryMask</span><span class="p">,</span><span class="n">__class</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Tetra</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create tetrahedral particle&#39;&#39;&#39;</span>
    <span class="n">p</span><span class="o">=</span><span class="n">Particle</span><span class="p">()</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">Node</span><span class="p">):</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dem</span><span class="p">:</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dem</span><span class="o">=</span><span class="n">DemData</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_mkDemNode</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="n">__class</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span> <span class="k">if</span> <span class="n">color</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span>
    <span class="n">_commonBodySetup</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">nodes</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="n">fixed</span><span class="p">)</span>
    <span class="c1">#p.aspherical=False</span>
    <span class="n">p</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">wire</span><span class="o">=</span><span class="n">wire</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">visible</span><span class="o">=</span><span class="n">visible</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">canonicalizeVertexOrder</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="tet4"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.tet4">[docs]</a><span class="k">def</span> <span class="nf">tet4</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tetra</span><span class="p">(</span><span class="n">__class</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Tet4</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>

<div class="viewcode-block" id="infCylinder"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.infCylinder">[docs]</a><span class="k">def</span> <span class="nf">infCylinder</span><span class="p">(</span><span class="n">position</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">axis</span><span class="p">,</span><span class="n">glAB</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">wire</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">angVel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">defaultMaterial</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">DemField</span><span class="o">.</span><span class="n">defaultMovableMask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a ready-made infinite cylinder particle.&quot;&quot;&quot;</span>
    <span class="n">p</span><span class="o">=</span><span class="n">Particle</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="n">InfCylinder</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span> <span class="k">if</span> <span class="n">color</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">glAB</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">glAB</span><span class="o">=</span><span class="n">glAB</span>
    <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">wire</span><span class="o">=</span><span class="n">wire</span>
    <span class="n">node</span><span class="o">=</span><span class="n">position</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">position</span><span class="p">,</span><span class="n">Node</span><span class="p">)</span> <span class="k">else</span> <span class="n">_mkDemNode</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">position</span><span class="p">)</span>
    <span class="n">_commonBodySetup</span><span class="p">(</span><span class="n">p</span><span class="p">,[</span><span class="n">node</span><span class="p">],</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="n">fixed</span><span class="p">)</span>
    <span class="c1">#p.aspherical=False # only rotates along one axis</span>
    <span class="n">p</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span>
    <span class="k">if</span> <span class="n">angVel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">angVel</span><span class="o">=</span><span class="n">angVel</span>
    <span class="k">return</span> <span class="n">p</span></div>


<div class="viewcode-block" id="importNmesh"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.importNmesh">[docs]</a><span class="k">def</span> <span class="nf">importNmesh</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">trsf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dem</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">surf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">surfMat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">surfMask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">surfHalfThick</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Import nmesh file, text format written by `Netgen &lt;http://sourceforge.net/projects/netgen-mesher/&gt;`__. All nodes are created with :obj:`woo.dem.DemData.blocked` equal to ``XYZ`` (no rotations, but all translations allowed); if some of them are to be fixed, this must be done by the user after calling the function. Tetrahedra mass is lumped onto nodes. Thickness of surface triangles (if any) is ignored for mass lumping.</span>

<span class="sd">    :param mat: material for volume (:obj:`woo.fem.Tet4`) elements.</span>
<span class="sd">    :param mask: :obj:`woo.dem.Particle.mask` for new volume elements.</span>
<span class="sd">    :param trsf: callable for transforming input-file vertex coordinate to the simulation space.</span>
<span class="sd">    :param dem: a :obj:`woo.dem.DemField` instance; if given, nodes and particles will be added to this :obj:`~woo.dem.DemField`.</span>
<span class="sd">    :param surf: create surface triangulation, for collisions.</span>
<span class="sd">    :param surfMat: material for surface (:obj:`woo.dem.Facet`); if ``None``, *mat* is used.</span>
<span class="sd">    :param surfMask: mask for surface; if ``None``, *mask* is used.</span>
<span class="sd">    :param surfHalfThick: :obj:`woo.dem.Facet.halfThick` for the surface (must be positive for collisions between two triangulated surfaces).</span>
<span class="sd">    :return: ([Node,Node,...],[Particle,Particle,...])</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">mesh</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">lens</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">l</span><span class="o">=</span><span class="n">ll</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">mesh</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">lens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="c1"># for consistency check below</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">v</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">trsf</span><span class="p">:</span> <span class="n">v</span><span class="o">=</span><span class="n">trsf</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">mesh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">mesh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;nodes&#39;</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;triangles&#39;</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;tetrahedra&#39;</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="n">lens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Inconsistent nmesh file </span><span class="si">%s</span><span class="s1">: number of </span><span class="si">%s</span><span class="s1"> should be </span><span class="si">%d</span><span class="s1">, is </span><span class="si">%d</span><span class="s1">.&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">lens</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span><span class="o">!=</span><span class="mi">3</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Error in </span><span class="si">%s</span><span class="s1">: incorrect number of section (</span><span class="si">%d</span><span class="s1">, should be 3)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">surfMat</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="n">surfMat</span><span class="o">=</span><span class="n">mat</span>
    <span class="k">if</span> <span class="n">surfMask</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="n">surfMask</span><span class="o">=</span><span class="n">mask</span>
    <span class="n">nn</span><span class="o">=</span><span class="p">[</span><span class="n">Node</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">dem</span><span class="o">=</span><span class="n">DemData</span><span class="p">(</span><span class="n">blocked</span><span class="o">=</span><span class="s1">&#39;XYZ&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">mesh</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">t4</span><span class="o">=</span><span class="p">[</span><span class="n">Tet4</span><span class="o">.</span><span class="n">make</span><span class="p">((</span><span class="n">nn</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">nn</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">nn</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="n">nn</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]]),</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">wire</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mesh</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">surf</span><span class="p">:</span> <span class="n">f3</span><span class="o">=</span><span class="p">[</span><span class="n">Facet</span><span class="o">.</span><span class="n">make</span><span class="p">((</span><span class="n">nn</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">nn</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">nn</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]]),</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">wire</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">halfThick</span><span class="o">=</span><span class="n">surfHalfThick</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">surfMask</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mesh</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">f3</span><span class="o">=</span><span class="p">[]</span>
    <span class="c1"># lump mass</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nn</span><span class="p">:</span>
        <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">mass</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">density</span><span class="o">*.</span><span class="mi">25</span><span class="o">*</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">getVolume</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">parRef</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">Tet4</span><span class="p">)])</span>
    <span class="k">if</span> <span class="n">dem</span><span class="p">:</span>
        <span class="n">dem</span><span class="o">.</span><span class="n">nodesAppend</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span>
        <span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t4</span><span class="o">+</span><span class="n">f3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nn</span><span class="p">,</span><span class="n">t4</span><span class="o">+</span><span class="n">f3</span></div>


<div class="viewcode-block" id="ensureDir"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.ensureDir">[docs]</a><span class="k">def</span> <span class="nf">ensureDir</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Creating directory </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="s1">&#39;Ensure that directory ``d`` exists. If ``d`` is empty, return immediately (signifies usually the current directory). Otherwise try to create the directory. *msg* is an optional message to be printed to stdout only when something is actually done, and must include </span><span class="si">%s</span><span class="s1"> which will be replaced by the directory.&#39;</span>
    <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="c1"># current dir</span>
    <span class="c1"># this checks only if something will be created; may not see it in some corner cases... doesn&#39;t matter, just diagnostics</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">%</span><span class="n">d</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="makeVideo"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.makeVideo">[docs]</a><span class="k">def</span> <span class="nf">makeVideo</span><span class="p">(</span><span class="n">frameSpec</span><span class="p">,</span><span class="n">out</span><span class="p">,</span><span class="n">renameNotOverwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fps</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span><span class="n">kbps</span><span class="o">=</span><span class="mi">15000</span><span class="p">,</span><span class="n">holdLast</span><span class="o">=-.</span><span class="mi">5</span><span class="p">,</span><span class="nb">open</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a video from external image files using `mencoder &lt;http://www.mplayerhq.hu&gt;`__, `avconv &lt;http://libav.org/avconv.html&gt;`__ or `ffmpeg &lt;http://www.ffmpeg.org&gt;`__ (whichever is found on the system). Encodes using the default mencoder codec (mpeg4), two-pass with mencoder and one-pass with avconv, running multi-threaded with number of threads equal to number of OpenMP threads allocated for Woo.</span>

<span class="sd">    Some *out* extensions (``.gif``, ``.mng``) will call ImageMagick (``convert``; likely not available under Windows) to create animated image instead of video file.</span>

<span class="sd">    :param frameSpec: wildcard | sequence of filenames. If list or tuple, filenames to be encoded in given order; otherwise wildcard understood by mencoder&#39;s mf:// URI option (shell wildcards such as ``/tmp/snap-*.png`` or and printf-style pattern like ``/tmp/snap-%05d.png``), if using mencoder, or understood by ``avconv`` or ``ffmpeg`` if those are being used.</span>
<span class="sd">    :param str out: file to save video into</span>
<span class="sd">    :param bool renameNotOverwrite: if True, existing same-named video file will have -*number* appended; will be overwritten otherwise.</span>
<span class="sd">    :param int fps: Frames per second (``-mf fps=…``)</span>
<span class="sd">    :param int kbps: Bitrate (``-lavcopts vbitrate=…``) in kb/s (ignored for animated images)</span>
<span class="sd">    :param holdLast: Repeat the last frame this many times; if negative, it means seconds and will be converted to frames according to *fps*. This option is not applicable if *frameSpec* is a wildcard (as opposed to a list of images).</span>
<span class="sd">    :param open: Open the resulting movie file with the default system program for that type of file.</span>

<span class="sd">    .. note:: ``avconv`` and ``ffmpeg`` need symlinks, which are not available under Windows.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># find which encoder to actually use</span>
    <span class="n">menc</span><span class="o">=</span><span class="n">find_executable</span><span class="p">(</span><span class="s1">&#39;mencoder&#39;</span><span class="p">)</span>
    <span class="n">ffmp</span><span class="o">=</span><span class="n">find_executable</span><span class="p">(</span><span class="s1">&#39;ffmpeg&#39;</span><span class="p">)</span>
    <span class="n">avco</span><span class="o">=</span><span class="n">find_executable</span><span class="p">(</span><span class="s1">&#39;avconv&#39;</span><span class="p">)</span>
    <span class="n">conv</span><span class="o">=</span><span class="n">find_executable</span><span class="p">(</span><span class="s1">&#39;convert&#39;</span><span class="p">)</span>
    <span class="c1"># the first one wins</span>
    <span class="n">WIN</span><span class="o">=</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s1">&#39;win32&#39;</span><span class="p">)</span>
    <span class="n">IMG</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.gif&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">out</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mng&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">IMG</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">avco</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">WIN</span><span class="p">:</span> <span class="n">encExec</span><span class="p">,</span><span class="n">encType</span><span class="o">=</span><span class="n">avco</span><span class="p">,</span><span class="s1">&#39;avconv&#39;</span>
        <span class="k">elif</span> <span class="n">ffmp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">WIN</span><span class="p">:</span> <span class="n">encExec</span><span class="p">,</span><span class="n">encType</span><span class="o">=</span><span class="n">ffmp</span><span class="p">,</span><span class="s1">&#39;avconv&#39;</span>
        <span class="k">elif</span> <span class="n">menc</span><span class="p">:</span> <span class="n">encExec</span><span class="p">,</span><span class="n">encType</span><span class="o">=</span><span class="n">menc</span><span class="p">,</span><span class="s1">&#39;mencoder&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No suitable video encoder (ffmpeg (non-Windows), avconv (non-Windows), mencoder) found in PATH.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">conv</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Convert (from ImageMagick) not found for animated image conversion.&#39;</span><span class="p">)</span>
        <span class="n">encExec</span><span class="p">,</span><span class="n">encType</span><span class="o">=</span><span class="n">conv</span><span class="p">,</span><span class="s1">&#39;IMG&#39;</span>

    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">os.path</span><span class="o">,</span><span class="nn">subprocess</span>
    <span class="k">if</span> <span class="n">renameNotOverwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">while</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out</span><span class="o">+</span><span class="s2">&quot;~</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)):</span> <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="n">out</span><span class="o">+</span><span class="s2">&quot;~</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">);</span> <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Output file `</span><span class="si">%s</span><span class="s2">&#39; already existed, old file renamed to `</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="n">out</span><span class="o">+</span><span class="s2">&quot;~</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">holdLast</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">holdLast</span><span class="o">*=-</span><span class="n">fps</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frameSpec</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frameSpec</span><span class="p">,</span><span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">holdLast</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">frameSpec</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">frameSpec</span><span class="p">)</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">holdLast</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="n">frameSpec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">frameSpecMenc</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">frameSpec</span><span class="p">)</span>
        <span class="n">frameSpecAvconv</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">frameSpec</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frameSpecMenc</span><span class="o">=</span><span class="n">frameSpec</span>
        <span class="n">frameSpecAvconv</span><span class="o">=</span><span class="p">[</span><span class="n">frameSpec</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">encType</span><span class="o">==</span><span class="s1">&#39;avconv&#39;</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Encoding via ffmpeg/avconv is only possible when list of files (as opposed to a pattern) is passed.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">encType</span><span class="o">==</span><span class="s1">&#39;avconv&#39;</span> <span class="ow">or</span> <span class="n">encType</span><span class="o">==</span><span class="s1">&#39;IMG&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s1">&#39;win32&#39;</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Encoding via ffmpeg/avconv and to animated images is not yet implemented under Windows (symlinks not functional on this platform).&#39;</span><span class="p">)</span>
        <span class="n">symDir</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">tmpFilename</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">symDir</span><span class="p">)</span>
        <span class="n">ff2</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">ext</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">frameSpecAvconv</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">symPattern</span><span class="o">=</span><span class="n">symDir</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">%05d</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">ext</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frameSpecAvconv</span><span class="p">):</span>
            <span class="n">ff2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">symPattern</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">f</span><span class="p">),</span><span class="n">ff2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">frameSpecAvconv</span><span class="o">=</span><span class="n">ff2</span>

    <span class="k">if</span> <span class="n">IMG</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="n">conv</span><span class="p">,</span><span class="s1">&#39;-delay&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">+</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">fps</span><span class="p">)</span><span class="o">/</span><span class="mf">100.</span><span class="p">)),</span><span class="s1">&#39;-loop&#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">frameSpecAvconv</span><span class="o">+</span><span class="p">[</span><span class="n">out</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Animated image: &#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="n">ret</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ret</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Error running </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="o">%</span><span class="n">encExec</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">devNull</span><span class="o">=</span><span class="s1">&#39;nul&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s1">&#39;win32&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;/dev/null&#39;</span>
        <span class="c1"># mencoder normally creates divx2pass.log in the current dir, which might fail</span>
        <span class="c1"># use temp file instead, explicitly</span>
        <span class="n">passLogFile</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">tmpFilename</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.log&#39;</span>
        <span class="c1"># passNo==0 means single pass (avconv)</span>
        <span class="k">for</span> <span class="n">passNo</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">encType</span><span class="o">==</span><span class="s1">&#39;mencoder&#39;</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)):</span>
            <span class="k">if</span> <span class="n">encType</span><span class="o">==</span><span class="s1">&#39;mencoder&#39;</span><span class="p">:</span> <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="n">encExec</span><span class="p">,</span><span class="s1">&#39;mf://</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">frameSpecMenc</span><span class="p">,</span><span class="s1">&#39;-mf&#39;</span><span class="p">,</span><span class="s1">&#39;fps=</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">int</span><span class="p">(</span><span class="n">fps</span><span class="p">),</span><span class="s1">&#39;-ovc&#39;</span><span class="p">,</span><span class="s1">&#39;lavc&#39;</span><span class="p">,</span><span class="s1">&#39;-lavcopts&#39;</span><span class="p">,</span><span class="s1">&#39;vbitrate=</span><span class="si">%d</span><span class="s1">:vpass=</span><span class="si">%d</span><span class="s1">:threads=</span><span class="si">%d</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">kbps</span><span class="p">),</span><span class="n">passNo</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">numThreads</span><span class="p">,</span><span class="s1">&#39;turbo&#39;</span> <span class="k">if</span> <span class="n">passNo</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span><span class="s1">&#39;-passlogfile&#39;</span><span class="p">,</span><span class="n">passLogFile</span><span class="p">,</span><span class="s1">&#39;-o&#39;</span><span class="p">,(</span><span class="n">devNull</span> <span class="k">if</span> <span class="n">passNo</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">out</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">encType</span><span class="o">==</span><span class="s1">&#39;avconv&#39;</span><span class="p">:</span>
                <span class="c1">#inputs=sum([[&#39;-i&#39;,f] for f in frameSpecAvconv],[])</span>
                <span class="c1"># inputs=[&#39;-i&#39;,&#39;concat:&quot;&#39;+&#39;|&#39;.join(frameSpecAvconv)+&#39;&quot;&#39;]</span>
                <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span><span class="n">symPattern</span><span class="p">]</span>
                <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="n">encExec</span><span class="p">]</span><span class="o">+</span><span class="n">inputs</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fps</span><span class="p">)),</span><span class="s1">&#39;-b:v&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">k&#39;</span><span class="o">%</span><span class="nb">int</span><span class="p">(</span><span class="n">kbps</span><span class="p">),</span><span class="s1">&#39;-threads&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">numThreads</span><span class="p">)]</span><span class="o">+</span><span class="p">([</span><span class="s1">&#39;-pass&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">passNo</span><span class="p">),</span><span class="s1">&#39;-passlogfile&#39;</span><span class="p">,</span><span class="n">passLogFile</span><span class="p">]</span> <span class="k">if</span> <span class="n">passNo</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="p">[])</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;-an&#39;</span><span class="p">,</span><span class="s1">&#39;-vf&#39;</span><span class="p">,</span><span class="s1">&#39;crop=(floor(in_w/2)*2):(floor(in_h/2)*2)&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">([</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span><span class="s1">&#39;rawvideo&#39;</span><span class="p">,</span><span class="s1">&#39;-y&#39;</span><span class="p">,</span><span class="n">devNull</span><span class="p">]</span> <span class="k">if</span> <span class="n">passNo</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span><span class="s1">&#39;mp4&#39;</span><span class="p">,</span><span class="s1">&#39;-y&#39;</span><span class="p">,</span><span class="n">out</span><span class="p">])</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Pass </span><span class="si">%d</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">passNo</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)))</span>
            <span class="n">ret</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ret</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Error running </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="o">%</span><span class="n">encExec</span><span class="p">)</span>
    
    <span class="c1"># clean up symlinks directory</span>
    <span class="k">if</span> <span class="n">encType</span><span class="o">==</span><span class="s1">&#39;avconv&#39;</span> <span class="ow">or</span> <span class="n">encType</span><span class="o">==</span><span class="s1">&#39;IMG&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">shutil</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">symDir</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">open</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">webbrowser</span>
        <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">out</span><span class="p">))</span></div>

<span class="k">def</span> <span class="nf">_procStatus</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/proc/</span><span class="si">%d</span><span class="s1">/status&#39;</span><span class="o">%</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">name</span><span class="p">:</span> <span class="k">return</span> <span class="n">l</span>
    <span class="k">raise</span> <span class="s2">&quot;No such line in /proc/[pid]/status: &quot;</span><span class="o">+</span><span class="n">name</span>
<div class="viewcode-block" id="vmData"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.vmData">[docs]</a><span class="k">def</span> <span class="nf">vmData</span><span class="p">():</span>
    <span class="s2">&quot;Return memory usage data from Linux&#39;s /proc/[pid]/status, line VmData.&quot;</span>
    <span class="n">l</span><span class="o">=</span><span class="n">_procStatus</span><span class="p">(</span><span class="s1">&#39;VmData&#39;</span><span class="p">);</span> <span class="n">ll</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">();</span> <span class="k">assert</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;kB&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s1">&#39;win32&#39;</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">fixWindowsPath</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;On Windows, replace some well-known UNIX directories by their native equivalents,</span>
<span class="sd">        so that defaults works cross-platform. Currently, the following substitutions are made:</span>
<span class="sd">        1. leading `/tmp` is transformed to `%TEMP%` (or c:/temp is undefined)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">==</span><span class="s1">&#39;/tmp&#39;</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/tmp/&#39;</span><span class="p">):</span>
            <span class="n">temp</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TEMP&#39;</span><span class="p">,</span><span class="s1">&#39;c:/temp&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">temp</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">p</span>
<span class="k">else</span><span class="p">:</span>
<div class="viewcode-block" id="fixWindowsPath"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.fixWindowsPath">[docs]</a>    <span class="k">def</span> <span class="nf">fixWindowsPath</span><span class="p">(</span><span class="n">p</span><span class="p">):</span> <span class="k">return</span> <span class="n">p</span></div>
    
    


<div class="viewcode-block" id="xMirror"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.xMirror">[docs]</a><span class="k">def</span> <span class="nf">xMirror</span><span class="p">(</span><span class="n">half</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mirror a sequence of 2d points around the x axis (changing sign on the y coord).</span>
<span class="sd">The sequence should start up and then it will wrap from y downwards (or vice versa).</span>
<span class="sd">If the last point&#39;s x coord is zero, it will not be duplicated.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">half</span><span class="p">)</span><span class="o">+</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span><span class="o">-</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">half</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">half</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">half</span><span class="p">)]</span></div>

<div class="viewcode-block" id="tesselatePolyline"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.tesselatePolyline">[docs]</a><span class="k">def</span> <span class="nf">tesselatePolyline</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">maxDist</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return polyline tesselated so that distance between consecutive points is no more than maxDist. *l* is list of points (Vector2 or Vector3).&#39;&#39;&#39;</span>
    <span class="n">ret</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="o">=</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dX</span><span class="o">=</span><span class="n">x1</span><span class="o">-</span><span class="n">x0</span>
        <span class="n">dist</span><span class="o">=</span><span class="n">dX</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dist</span><span class="o">&gt;</span><span class="n">maxDist</span><span class="p">:</span>
            <span class="n">nDiv</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">dist</span><span class="o">/</span><span class="n">maxDist</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">dist</span><span class="o">/</span><span class="n">maxDist</span><span class="p">)</span><span class="o">*</span><span class="n">maxDist</span><span class="o">&lt;</span><span class="n">dist</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nDiv</span><span class="p">)):</span> <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">dX</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="mf">1.</span><span class="o">/</span><span class="n">nDiv</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="htmlReportHead"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.htmlReportHead">[docs]</a><span class="k">def</span> <span class="nf">htmlReportHead</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">headline</span><span class="p">,</span><span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;xhtml&#39;</span><span class="p">,</span><span class="n">repBase</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">hideWooExtra</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return (X)HTML fragment for simulation report: (X)HTML header, title, Woo logo, configuration and preprocessor parameters. </span>

<span class="sd">        In order to obtain a well-formed XHTML document, don&#39;t forget to add &#39;&lt;/body&gt;&lt;/html&gt;&#39;.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">platform</span><span class="o">,</span> <span class="nn">pkg_resources</span><span class="o">,</span> <span class="nn">shutil</span>
    <span class="kn">import</span> <span class="nn">base64</span>
    <span class="n">headers</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">xhtml</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s1">    &lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt; </span>
<span class="s1">    &lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xmlns:svg=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;&#39;&#39;</span><span class="p">,</span><span class="n">html5</span><span class="o">=</span><span class="s1">&#39;&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&#39;</span><span class="p">,</span><span class="n">html4</span><span class="o">=</span><span class="s1">&#39;&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot; &quot;http://www.w3.org/TR/html4/strict.dtd&quot;&gt;&lt;html&gt;&#39;</span><span class="p">)</span>
    <span class="n">logoSrc</span><span class="o">=</span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;woo&#39;</span><span class="p">,</span><span class="s1">&#39;data/woo-icon.128.png&#39;</span><span class="p">)</span>
    <span class="n">logoExtern</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_wooLogo.png&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">repBase</span><span class="p">)</span>
    <span class="n">logoBase64</span><span class="o">=</span><span class="s1">&#39;&lt;img src=&quot;data:image/png;base64,&#39;</span><span class="o">+</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">logoSrc</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())))</span><span class="o">+</span><span class="s1">&#39;&quot; alt=&quot;Woo logo&quot;/&gt;&#39;</span>
    <span class="n">logoImgExtern</span><span class="o">=</span><span class="s1">&#39;&lt;img src=&quot;</span><span class="si">%s</span><span class="s1">_wooLogo.png&quot; alt=&quot;Woo logo&quot;/&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">repBase</span><span class="p">)</span>
    <span class="n">svgLogos</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="c1"># embedded svg</span>
        <span class="n">xhtml</span><span class="o">=</span><span class="n">svgFileFragment</span><span class="p">(</span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;woo&#39;</span><span class="p">,</span><span class="s1">&#39;data/woodem-6.woo.svg&#39;</span><span class="p">)),</span>
        <span class="c1"># embedded base64-encoded pngs</span>
        <span class="n">html5</span><span class="o">=</span><span class="n">logoBase64</span><span class="p">,</span>
        <span class="n">html4</span><span class="o">=</span><span class="n">logoImgExtern</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dialect</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported HTML dialect &#39;</span><span class="si">%s</span><span class="s2">&#39;; must be one of: &quot;</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">headers</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">dialect</span><span class="o">==</span><span class="s1">&#39;html4&#39;</span><span class="p">:</span> <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">logoSrc</span><span class="p">,</span><span class="n">logoExtern</span><span class="p">)</span>
    <span class="c1"># &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=UTF-8&quot; /&gt;</span>
    <span class="n">html</span><span class="o">=</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;&#39;&#39;&lt;head&gt;&lt;title&gt;</span><span class="si">{headline}</span><span class="s1">&lt;/title&gt;&lt;meta charset=&quot;utf-8&quot;/&gt;&lt;/head&gt;&lt;body&gt;</span>
<span class="s1">        &lt;h1&gt;</span><span class="si">{headline}</span><span class="s1">&lt;/h1&gt;</span>
<span class="s1">        &lt;h2&gt;General&lt;/h2&gt;</span>
<span class="s1">        &lt;table style=&quot;text-align: center&quot;&gt;</span>
<span class="s1">            &lt;tr&gt;&lt;td rowspan=&quot;3&quot;&gt;</span><span class="si">{svgLogo}</span><span class="s1">&lt;/td&gt;&lt;td&gt;&lt;a href=&quot;http://www.woodem.eu/&quot;&gt;Woo[dem]&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s1">            &lt;tr&gt;&lt;td&gt;© &lt;a href=&quot;mailto:vaclav.smilauer@woodem.eu&quot;&gt;Václav Šmilauer&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s1">            &lt;tr&gt;&lt;td&gt;Licensed under &lt;a href=&quot;http://opensource.org/licenses/gpl-2.0.php&quot;&gt;GNU GPL v2&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s1">        &lt;/table&gt;</span>
<span class="s1">        &lt;table&gt;</span>
<span class="s1">            &lt;tr&gt;&lt;td&gt;title&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;</span><span class="si">{title}</span><span class="s1">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s1">            &lt;tr&gt;&lt;td&gt;id&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;</span><span class="si">{id}</span><span class="s1">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s1">            &lt;tr&gt;&lt;td&gt;started&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;</span><span class="si">{started}</span><span class="s1">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s1">            &lt;tr&gt;&lt;td&gt;duration&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;</span><span class="si">{duration:g}</span><span class="s1"> s (</span><span class="si">{step}</span><span class="s1"> steps)&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s1">            &lt;tr&gt;&lt;td&gt;average speed&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;</span><span class="si">{stepsPerSec:g}</span><span class="s1"> steps/sec&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s1">            &lt;tr&gt;&lt;td&gt;operator&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;</span><span class="si">{user}</span><span class="s1">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s1">            &lt;tr&gt;&lt;td&gt;number of cores used&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;</span><span class="si">{nCores}</span><span class="s1">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s1">            &lt;tr&gt;&lt;td&gt;engine&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;</span><span class="si">{engine}</span><span class="s1">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s1">            &lt;tr&gt;&lt;td&gt;compiled with&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;</span><span class="si">{compiledWith}</span><span class="s1">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s1">            &lt;tr&gt;&lt;td&gt;platform&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;</span><span class="si">{platform}</span><span class="s1">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s1">        &lt;/table&gt;</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="n">headline</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&lt;i&gt;[none]&lt;/i&gt;&#39;</span><span class="p">),</span><span class="nb">id</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span><span class="n">user</span><span class="o">=</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]),</span><span class="n">started</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">realtime</span><span class="p">),</span><span class="n">step</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">step</span><span class="p">,</span><span class="n">duration</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">realtime</span><span class="p">,</span><span class="n">nCores</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">numThreads</span><span class="p">,</span><span class="n">stepsPerSec</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">step</span><span class="o">/</span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">realtime</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;wooDem &#39;</span><span class="o">+</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">version</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">revision</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39; (debug)&#39;</span> <span class="k">if</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span><span class="n">compiledWith</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">features</span><span class="p">),</span><span class="n">platform</span><span class="o">=</span><span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">),</span><span class="n">svgLogo</span><span class="o">=</span><span class="n">svgLogos</span><span class="p">[</span><span class="n">dialect</span><span class="p">])</span>
        <span class="o">+</span><span class="s1">&#39;&lt;h2&gt;Input data&lt;/h2&gt;&#39;</span><span class="o">+</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">,</span><span class="n">fragment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">showDoc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">hideWooExtra</span><span class="o">=</span><span class="n">hideWooExtra</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">headers</span><span class="p">[</span><span class="n">dialect</span><span class="p">]</span><span class="o">+</span><span class="n">html</span></div>

<div class="viewcode-block" id="htmlReport"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.htmlReport">[docs]</a><span class="k">def</span> <span class="nf">htmlReport</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">repFmt</span><span class="p">,</span><span class="n">headline</span><span class="p">,</span><span class="n">afterHead</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">figures</span><span class="o">=</span><span class="p">[],</span><span class="n">dialect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">figFmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">svgEmbed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">hideWooExtra</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate (X)HTML report for simulation.</span>

<span class="sd">    :param S: :obj:`Scene` object; must contain :obj:`Scene.pre`</span>
<span class="sd">    :param repFmt: format for the output file; will be expanded using :obj:`Scene.tags`; it should end with `.html` or `.xhtml`.</span>
<span class="sd">    :param headline: title of the report, used as HTML title and the first ``&lt;h1&gt;`` heading.</span>
<span class="sd">    :param afterHead: contents (XHTML fragment) to be added verbatim after the header (title, woo config table, preprocessor parameters)</span>
<span class="sd">    :param figs: figures included in the report; they are either embedded (SVG, optionally ) or saved to files in the same directory as the report, using its name as prefix, and referenced via relative links from the XHTML. Figures are given as list of 2- or 3-tuples, where each item contains:</span>
<span class="sd">       </span>
<span class="sd">         1. name of the figure (will generate a ``&lt;h2&gt;`` heading)</span>
<span class="sd">         2. figure object (`Matplotlib &lt;http://matplotlib.org&gt;`__ figure object)</span>
<span class="sd">         3. optionally, format to save the figure to (`svg`, `png`, ...)</span>

<span class="sd">    :param figFmt: format of figures, if the format is not specified by the figure itself; if None, choose format appropriate for given dialect (png for html4, svg for html5 and xhtml)</span>
<span class="sd">    :param dialect: one of &quot;xhtml&quot;, &quot;html5&quot;, &quot;html4&quot;; if not given (*None*), selected from file suffix (``.html`` for ``html4``, ``.xhtml`` for ``xhtml``). ``html4`` will save figures as PNG (even if something else is specified) so that the resulting file is easily importable into LibreOffice (which does not import HTML with SVG correctly now).</span>
<span class="sd">    :param svgEmbed: don&#39;t save SVG as separate files, embed them in the report instead. </span>
<span class="sd">    :param show: open the report in browser via the webbrowser module, unless running in batch.</span>
<span class="sd">    :param hideWooExtra: don&#39;t show wooExtra.* modules in object names or URLs</span>
<span class="sd">    :return: (filename of the report, list of external figures)</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">codecs</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">os.path</span>
    <span class="kn">import</span> <span class="nn">woo</span><span class="o">,</span><span class="nn">woo.batch</span>
    <span class="n">dialects</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;html5&#39;</span><span class="p">,</span><span class="s1">&#39;html4&#39;</span><span class="p">,</span><span class="s1">&#39;xhtml&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dialect</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">repFmt</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xhtml&#39;</span><span class="p">):</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;xhtml&#39;</span>
        <span class="k">elif</span> <span class="n">repFmt</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.html&#39;</span><span class="p">):</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;html4&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to guess dialect (not given) from *repFmt* &#39;</span><span class="si">%s</span><span class="s2">&#39; (not ending in .xhtml or .html)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dialect</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dialects</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown dialect &#39;</span><span class="si">%s</span><span class="s2">&#39;: must be one of &quot;</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dialects</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">figFmt</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="n">figFmt</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;html5&#39;</span><span class="p">:</span><span class="s1">&#39;png&#39;</span><span class="p">,</span><span class="s1">&#39;html4&#39;</span><span class="p">:</span><span class="s1">&#39;png&#39;</span><span class="p">,</span><span class="s1">&#39;xhtml&#39;</span><span class="p">:</span><span class="s1">&#39;svg&#39;</span><span class="p">}[</span><span class="n">dialect</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">dialect</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;html5&#39;</span><span class="p">,)</span> <span class="ow">and</span> <span class="n">svgEmbed</span> <span class="ow">and</span> <span class="n">figFmt</span><span class="o">==</span><span class="s1">&#39;svg&#39;</span><span class="p">:</span>
        <span class="n">svgEmbed</span><span class="o">=</span><span class="kc">False</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Dialect &#39;</span><span class="si">%s</span><span class="s2">&#39; does not support embedded SVG -- will not be embedded.&quot;</span><span class="o">%</span><span class="n">dialect</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dialect</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;html4&#39;</span><span class="p">,)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">figFmt</span><span class="o">==</span><span class="s1">&#39;png&#39;</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Dialect &#39;</span><span class="si">%s</span><span class="s2">&#39; will save images as &#39;png&#39;, not &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dialect</span><span class="p">,</span><span class="n">figFmt</span><span class="p">))</span>
        <span class="n">figFmt</span><span class="o">=</span><span class="s1">&#39;png&#39;</span>
    <span class="n">repName</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">repFmt</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">S</span><span class="o">=</span><span class="n">S</span><span class="p">,</span><span class="o">**</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">)))</span>
    <span class="n">rep</span><span class="o">=</span><span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">repName</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing report to file://&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">repName</span><span class="p">))</span>
    <span class="n">repBase</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\.x?html$&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">repName</span><span class="p">)</span>
    <span class="n">s</span><span class="o">=</span><span class="n">htmlReportHead</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">headline</span><span class="p">,</span><span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">,</span><span class="n">repBase</span><span class="o">=</span><span class="n">repBase</span><span class="p">,</span><span class="n">hideWooExtra</span><span class="o">=</span><span class="n">hideWooExtra</span><span class="p">)</span>
    <span class="n">s</span><span class="o">+=</span><span class="n">afterHead</span>


    <span class="k">if</span> <span class="n">figures</span><span class="p">:</span> <span class="n">s</span><span class="o">+=</span><span class="s1">&#39;&lt;h2&gt;Figures&lt;/h2&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">extFiles</span><span class="o">=</span><span class="p">[]</span>
    <span class="kn">from</span> <span class="nn">matplotlib.backends.backend_agg</span> <span class="k">import</span> <span class="n">FigureCanvasAgg</span>
    <span class="k">for</span> <span class="n">ith</span><span class="p">,</span><span class="n">figspec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">figures</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">figspec</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">figspec</span><span class="o">=</span><span class="p">(</span><span class="n">figspec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">figspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">figFmt</span><span class="p">)</span>
        <span class="n">figName</span><span class="p">,</span><span class="n">figObj</span><span class="p">,</span><span class="n">figSuffix</span><span class="o">=</span><span class="n">figspec</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">figName</span><span class="p">:</span> <span class="n">figName</span><span class="o">=</span><span class="s1">&#39;Figure </span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ith</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">s</span><span class="o">+=</span><span class="s1">&#39;&lt;h3&gt;&#39;</span><span class="o">+</span><span class="n">figName</span><span class="o">+</span><span class="s1">&#39;&lt;/h3&gt;&#39;</span>
        <span class="n">canvas</span><span class="o">=</span><span class="n">FigureCanvasAgg</span><span class="p">(</span><span class="n">figObj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">figSuffix</span><span class="o">==</span><span class="s1">&#39;svg&#39;</span> <span class="ow">and</span> <span class="n">svgEmbed</span><span class="p">:</span>
            <span class="n">figFile</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">tmpFilename</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">figSuffix</span>
            <span class="n">figObj</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figFile</span><span class="p">)</span>
            <span class="n">s</span><span class="o">+=</span><span class="n">svgFileFragment</span><span class="p">(</span><span class="n">figFile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">figFile</span><span class="o">=</span><span class="n">repBase</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^a-zA-Z0-9_-]&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">figName</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">figSuffix</span>
            <span class="n">figObj</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figFile</span><span class="p">)</span>
            <span class="n">s</span><span class="o">+=</span><span class="s1">&#39;&lt;img src=&quot;</span><span class="si">%s</span><span class="s1">&quot; alt=&quot;</span><span class="si">%s</span><span class="s1">&quot;/&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">figFile</span><span class="p">),</span><span class="n">figName</span><span class="p">)</span>
            <span class="n">extFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">figFile</span><span class="p">))</span>
    <span class="n">s</span><span class="o">+=</span><span class="s1">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span>
    <span class="n">rep</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">rep</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># flushed write buffers</span>

    <span class="c1"># attempt conversion to ODT, not under Windows</span>
    <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">!=</span><span class="s1">&#39;win32&#39;</span><span class="p">:</span>
        <span class="c1"># TODO TODO TODO: have timeout on the abiword call; some versions stall forever</span>
        <span class="k">def</span> <span class="nf">convertToOdt</span><span class="p">(</span><span class="n">html</span><span class="p">,</span><span class="n">odt</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">subprocess</span>
                <span class="c1"># may raise OSError if the executable is not found</span>
                <span class="n">out</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">&#39;abiword&#39;</span><span class="p">,</span><span class="s1">&#39;--to=ODT&#39;</span><span class="p">,</span><span class="s1">&#39;--to-name=&#39;</span><span class="o">+</span><span class="n">odt</span><span class="p">,</span><span class="n">html</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Report converted to ODT via Abiword: file://&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">odt</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Report conversion to ODT failed (error when running Abiword), returning </span><span class="si">%d</span><span class="s1">; the output was: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">output</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Report conversion to ODT not done (Abiword not installed?).&#39;</span><span class="p">)</span>
        <span class="c1"># if this is run in the background, main process may finish before that thread, leading potentially to some error messages??</span>
        <span class="kn">import</span> <span class="nn">threading</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">convertToOdt</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">repName</span><span class="p">,</span><span class="n">repBase</span><span class="o">+</span><span class="s1">&#39;.odt&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                
    <span class="k">if</span> <span class="n">show</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">woo</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">inBatch</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">webbrowser</span>
        <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">repName</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">repName</span><span class="p">,</span><span class="n">extFiles</span></div>


<div class="viewcode-block" id="svgFileFragment"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.svgFileFragment">[docs]</a><span class="k">def</span> <span class="nf">svgFileFragment</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="s1">&#39;Return fragment beginning with ``&lt;svg`` till the end of given *filename*. Those data may be used for embedding SVG in other formats, such as XHTML.&#39;</span>
    <span class="kn">import</span> <span class="nn">codecs</span><span class="o">,</span><span class="nn">re</span>
    <span class="n">data</span><span class="o">=</span><span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="c1"># returns the first match</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;svg( |$)&#39;</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">):</span> <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">():]</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;&quot;&lt;svg&quot; was not found in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">filename</span><span class="p">)</span></div>
    


<div class="viewcode-block" id="ensureWriteableDir"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.ensureWriteableDir">[docs]</a><span class="k">def</span> <span class="nf">ensureWriteableDir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="s1">&#39;Make sure given directory is writeable; raise exception (IOError) if not.&#39;</span>
    <span class="kn">import</span> <span class="nn">errno</span><span class="o">,</span> <span class="nn">os</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Created directory:&#39;</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="o">!=</span><span class="n">errno</span><span class="o">.</span><span class="n">EEXISTS</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;failed to create directory &#39;</span><span class="o">+</span><span class="n">d</span><span class="p">)</span>
            <span class="k">raise</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Directory </span><span class="si">%s</span><span class="s1"> not writeable.&#39;</span><span class="o">%</span><span class="n">d</span><span class="p">)</span></div>


<div class="viewcode-block" id="runAllPreprocessors"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.runAllPreprocessors">[docs]</a><span class="k">def</span> <span class="nf">runAllPreprocessors</span><span class="p">():</span>
    <span class="s1">&#39;Run all preprocessors with default parameters, and run the very first step of their simulation.&#39;</span>
    <span class="k">for</span> <span class="n">P</span> <span class="ow">in</span> <span class="n">woo</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">childClasses</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Preprocessor</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">50</span><span class="o">*</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="mi">10</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">P</span><span class="o">.</span><span class="vm">__module__</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">P</span><span class="o">.</span><span class="vm">__name__</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="mi">50</span><span class="o">*</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
        <span class="n">S</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">scene</span><span class="o">=</span><span class="n">P</span><span class="p">()()</span>
        <span class="n">S</span><span class="o">.</span><span class="n">one</span>
    <span class="nb">print</span><span class="p">(</span><span class="mi">20</span><span class="o">*</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="s1">&#39;   ALL OK   &#39;</span><span class="o">+</span><span class="mi">20</span><span class="o">*</span><span class="s1">&#39;*&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="unbalancedEnergy"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.unbalancedEnergy">[docs]</a><span class="k">def</span> <span class="nf">unbalancedEnergy</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">S</span><span class="o">.</span><span class="n">trackEnergy</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Scene.trackEnergy==False&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;elast&#39;</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">energy</span> <span class="ow">or</span> <span class="s1">&#39;kinetic&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">energy</span><span class="p">:</span> <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
    <span class="c1">#raise RuntimeError(&#39;Scene.energy: does not contain *elast* or *kinetic* keys&#39;)</span>
    <span class="c1"># this line seems to be necessary under Windows, zero raises ZeroDivisionError...?!</span>
    <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">energy</span><span class="p">[</span><span class="s1">&#39;elast&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">energy</span><span class="p">[</span><span class="s1">&#39;kinetic&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">S</span><span class="o">.</span><span class="n">energy</span><span class="p">[</span><span class="s1">&#39;elast&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="freecadExport"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.freecadExport">[docs]</a><span class="k">def</span> <span class="nf">freecadExport</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">out</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">textwrap</span><span class="o">,</span> <span class="nn">math</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">            import FreeCAD, Part</span>
<span class="s1">            Vector,Rotation,Placement=FreeCAD.Base.Vector,FreeCAD.Base.Rotation,FreeCAD.Base.Placement</span>
<span class="s1">            doc=FreeCAD.newDocument()</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="p">))</span>
        <span class="k">def</span> <span class="nf">node2placement</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="s1">&#39;Return textual representation of position and orientation of the :obj:`woo.core.Node` object.&#39;</span>
            <span class="n">pos</span><span class="p">,(</span><span class="n">axis</span><span class="p">,</span><span class="n">rot</span><span class="p">)</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span><span class="n">n</span><span class="o">.</span><span class="n">ori</span><span class="o">.</span><span class="n">toAxisAngle</span><span class="p">()</span>
            <span class="k">return</span> <span class="s1">&#39;Placement(Vector(</span><span class="si">%g</span><span class="s1">,</span><span class="si">%g</span><span class="s1">,</span><span class="si">%g</span><span class="s1">),Rotation(Vector(</span><span class="si">%g</span><span class="s1">,</span><span class="si">%g</span><span class="s1">,</span><span class="si">%g</span><span class="s1">),</span><span class="si">%g</span><span class="s1">))&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">rot</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span> <span class="ow">or</span> <span class="p">(</span><span class="n">mask</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mask</span><span class="o">&amp;</span><span class="n">mask</span><span class="o">==</span><span class="mi">0</span><span class="p">)):</span> <span class="k">continue</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;par_</span><span class="si">%05d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">p</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Sphere</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">                    p=doc.addObject(&quot;Part::Sphere&quot;,&quot;</span><span class="si">{name}</span><span class="s1">&quot;)</span>
<span class="s1">                    p.Radius=</span><span class="si">{r}</span><span class="s1"></span>
<span class="s1">                    p.Placement=</span><span class="si">{placement}</span><span class="s1"></span>
<span class="s1">                &#39;&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span><span class="n">placement</span><span class="o">=</span><span class="n">node2placement</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Ellipsoid</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">                    p=doc.addObject(&quot;Part::Ellipsoid&quot;,&quot;</span><span class="si">{name}</span><span class="s1">&quot;)</span>
<span class="s1">                    p.Radius1,p.Radius2,p.Radius3=</span><span class="si">{r[0]}</span><span class="s1">,</span><span class="si">{r[1]}</span><span class="s1">,</span><span class="si">{r[2]}</span><span class="s1"></span>
<span class="s1">                    &#39;&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">semiAxes</span><span class="p">,</span><span class="n">placement</span><span class="o">=</span><span class="n">node2placement</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;S.dem.par[</span><span class="si">%d</span><span class="s1">] not exported (unhandled shape </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;doc.recompute()</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

    

<span class="c1">#############################</span>
<span class="c1">##### deprecated functions</span>


<span class="k">def</span> <span class="nf">_deprecatedUtilsFunction</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">):</span>
    <span class="s2">&quot;Wrapper for deprecated functions, example below.&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Function utils.</span><span class="si">%s</span><span class="s1"> is deprecated, use </span><span class="si">%s</span><span class="s1"> instead.&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">),</span><span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>

<span class="c1"># example of _deprecatedUtilsFunction usage:</span>
<span class="c1">#</span>
<span class="c1"># def import_mesh_geometry(*args,**kw):</span>
<span class="c1">#    &quot;|ydeprecated|&quot;</span>
<span class="c1">#    _deprecatedUtilsFunction(&#39;import_mesh_geometry&#39;,&#39;woo.import.gmsh&#39;)</span>
<span class="c1">#    import woo.ymport</span>
<span class="c1">#    return woo.ymport.stl(*args,**kw)</span>

<span class="kn">import</span> <span class="nn">woo.batch</span>

<div class="viewcode-block" id="runningInBatch"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.runningInBatch">[docs]</a><span class="k">def</span> <span class="nf">runningInBatch</span><span class="p">():</span>
    <span class="n">_deprecatedUtilsFunction</span><span class="p">(</span><span class="s1">&#39;runningInBatch&#39;</span><span class="p">,</span><span class="s1">&#39;woo.batch.inBatch&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">woo</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">inBatch</span><span class="p">()</span></div>
<div class="viewcode-block" id="waitIfBatch"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.waitIfBatch">[docs]</a><span class="k">def</span> <span class="nf">waitIfBatch</span><span class="p">():</span>
    <span class="n">_deprecatedUtilsFunction</span><span class="p">(</span><span class="s1">&#39;waitIfBatch&#39;</span><span class="p">,</span><span class="s1">&#39;woo.batch.wait&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">woo</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>
<div class="viewcode-block" id="readParamsFromTable"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.readParamsFromTable">[docs]</a><span class="k">def</span> <span class="nf">readParamsFromTable</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="n">_deprecatedUtilsFunction</span><span class="p">(</span><span class="s1">&#39;readParamsFromTable&#39;</span><span class="p">,</span><span class="s1">&#39;woo.batch.readParamsFromTable&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">woo</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">readParamsFromTable</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>
<div class="viewcode-block" id="runPreprocessorInBatch"><a class="viewcode-back" href="../../woo.utils.html#woo.utils.runPreprocessorInBatch">[docs]</a><span class="k">def</span> <span class="nf">runPreprocessorInBatch</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="n">_deprecatedUtilsFunction</span><span class="p">(</span><span class="s1">&#39;runPreprocessorInBatch&#39;</span><span class="p">,</span><span class="s1">&#39;woo.batch.runPreprocessor&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">woo</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">runPreprocessor</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">Woo 1.0+rev1-git-8bbb0e2 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">woo.utils</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2012−2022, Václav Šmilauer &lt;eu@doxos.eu&gt;.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>