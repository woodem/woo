


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>woo.batch &#8212; Woo 1.0+rev1-git-aac4f82 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/cloud.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>

    
    
     
        <script src="../../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../../_static/cloud.base.js"></script>
    

    
     
        <script src="../../_static/cloud.js"></script>
    

    <link rel="shortcut icon" href="../../_static/woo-favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">Woo 1.0+rev1-git-aac4f82 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">woo.batch</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for woo.batch</h1><div class="highlight"><pre>
<span></span><span class="c1"># encoding: utf-8</span>

<span class="c1"># for use with globals() when reading table</span>

<span class="n">nan</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="o">*</span> 
<span class="kn">from</span> <span class="nn">minieigen</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">utils</span>

<span class="n">log</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">makeLog</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">wooMain</span> <span class="k">import</span> <span class="n">options</span> <span class="k">as</span> <span class="n">wooOptions</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">lockfile</span> <span class="k">import</span> <span class="n">FileLock</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">FileLock</span><span class="p">:</span>
        <span class="s1">&#39;Dummy class if the `lockfile &lt;/https://pypi.python.org/pypi/lockfile&gt;`_ module is not importable.&#39;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The &#39;lockfile&#39; module is not importable, &#39;</span><span class="si">%s</span><span class="s2">&#39; will not be locked. If this file is concurrently accessed by several simulations, it may get corrupted!&quot;</span><span class="o">%</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="k">pass</span>
    

<span class="c1"># increase every time the db format changes, to avoid errors</span>
<span class="c1"># applies to both sqlite and hdf5 dbs</span>
<span class="n">dbFormatVersion</span><span class="o">=</span><span class="mi">3</span>

<span class="c1">## timeout for opening the database if locked</span>
<span class="n">sqliteTimeout</span><span class="o">=</span><span class="mi">1000</span>

<div class="viewcode-block" id="wait"><a class="viewcode-back" href="../../woo.batch.html#woo.batch.wait">[docs]</a><span class="k">def</span> <span class="nf">wait</span><span class="p">():</span>
    <span class="s1">&#39;If running inside a batch, start the master simulation (if not already running) and block until it stops by itself. Typically used at the end of script so that it does not finish prematurely in batch mode (the execution would be ended in such a case). Does nothing outisde of batch.&#39;</span>
    <span class="kn">import</span> <span class="nn">woo</span>
    <span class="n">S</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">scene</span>
    <span class="k">if</span> <span class="n">inBatch</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">S</span><span class="o">.</span><span class="n">running</span><span class="p">:</span> <span class="n">S</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">waitForScenes</span><span class="p">()</span> <span class="c1"># wait for Master (in case scene is re-assigned)</span></div>

<div class="viewcode-block" id="inBatch"><a class="viewcode-back" href="../../woo.batch.html#woo.batch.inBatch">[docs]</a><span class="k">def</span> <span class="nf">inBatch</span><span class="p">():</span>
    <span class="s1">&#39;Tell whether we are running inside the batch or separately.&#39;</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">wooOptions</span><span class="o">.</span><span class="n">batchTable</span><span class="p">)</span> <span class="ow">or</span> <span class="n">wooOptions</span><span class="o">.</span><span class="n">batchLine</span><span class="o">&gt;=</span><span class="mi">0</span></div>

<div class="viewcode-block" id="hasBatchTable"><a class="viewcode-back" href="../../woo.batch.html#woo.batch.hasBatchTable">[docs]</a><span class="k">def</span> <span class="nf">hasBatchTable</span><span class="p">():</span>
    <span class="s1">&#39;Tell whether an external batch table is given or not (scripts may be run in script also without batch tables)&#39;</span>
    <span class="k">return</span> <span class="n">wooOptions</span><span class="o">.</span><span class="n">batchTable</span><span class="o">!=</span><span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">wooOptions</span><span class="o">.</span><span class="n">batchTable</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span></div>

<div class="viewcode-block" id="mayHaveStaleLock"><a class="viewcode-back" href="../../woo.batch.html#woo.batch.mayHaveStaleLock">[docs]</a><span class="k">def</span> <span class="nf">mayHaveStaleLock</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">os.path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">db</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span><span class="s1">&#39;.hdf5&#39;</span><span class="p">,</span><span class="s1">&#39;.he5&#39;</span><span class="p">,</span><span class="s1">&#39;.hdf&#39;</span><span class="p">):</span> <span class="k">return</span>
    <span class="k">return</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">is_locked</span><span class="p">()</span></div>

<div class="viewcode-block" id="writeResults"><a class="viewcode-back" href="../../woo.batch.html#woo.batch.writeResults">[docs]</a><span class="k">def</span> <span class="nf">writeResults</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span><span class="n">defaultDb</span><span class="o">=</span><span class="s1">&#39;woo-results.hdf5&#39;</span><span class="p">,</span><span class="n">hdf5version</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">,</span><span class="n">syncXls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dbFmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">postHooks</span><span class="o">=</span><span class="p">[],</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Write results to batch database. With *syncXls*, corresponding excel-file is re-generated.</span>
<span class="sd">    Series is a dicionary of 1d arrays written to separate sheets in the XLS. If *series* is `None`</span>
<span class="sd">    (default), `S.plot.data` are automatically added. All other ``**kw``</span>
<span class="sd">    arguments are serialized in the misc field, which then appears in the main XLS sheet. If *verbsoe* is given,</span>
<span class="sd">    labels and engines will be written in JSON to HDF5 attributes.</span>
<span class="sd">    *h5ver* specified HDF5 version format as used in h5py (possibilities are: earliest, latest).</span>

<span class="sd">    All data are serialized using json so that they can be read back in a language-independent manner.</span>

<span class="sd">    *postHooks* is list of functions (taking a single argument - the database name) which will be called</span>
<span class="sd">    once the database has been updated. They can be used in conjunction with :obj:`woo.batch.dbReadResults`</span>
<span class="sd">    to write aaggregate results from all records in the database.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">woo</span><span class="o">,</span> <span class="nn">woo.plot</span><span class="o">,</span> <span class="nn">woo.core</span>
    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">os.path</span><span class="o">,</span> <span class="nn">datetime</span>
    <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="kn">import</span> <span class="nn">json</span>
    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="n">S</span><span class="o">=</span><span class="n">scene</span>
    <span class="k">if</span> <span class="n">inBatch</span><span class="p">()</span> <span class="ow">and</span> <span class="n">hasBatchTable</span><span class="p">():</span> <span class="n">table</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="n">db</span><span class="o">=</span><span class="n">wooOptions</span><span class="o">.</span><span class="n">batchTable</span><span class="p">,</span><span class="n">wooOptions</span><span class="o">.</span><span class="n">batchLine</span><span class="p">,</span><span class="n">wooOptions</span><span class="o">.</span><span class="n">batchResults</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">table</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="n">db</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,(</span><span class="n">defaultDb</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">wooOptions</span><span class="o">.</span><span class="n">batchResults</span> <span class="k">else</span> <span class="n">wooOptions</span><span class="o">.</span><span class="n">batchResults</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No database to write results to (forgot to pass --batch-results?).&#39;</span><span class="p">)</span>
    <span class="n">newDb</span><span class="o">=</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing results to the database </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="s1">&#39;new&#39;</span> <span class="k">if</span> <span class="n">newDb</span> <span class="k">else</span> <span class="s1">&#39;existing&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">dbFmt</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">ext</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">db</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.sqlite&#39;</span><span class="p">,</span><span class="s1">&#39;.db&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;.sqlite&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;.db&#39;</span><span class="p">,</span><span class="sa">u</span><span class="s1">&#39;.sqlite&#39;</span><span class="p">,</span><span class="sa">u</span><span class="s1">&#39;.db&#39;</span><span class="p">):</span> <span class="n">dbFmt</span><span class="o">=</span><span class="s1">&#39;sqlite&#39;</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span><span class="s1">&#39;.hdf5&#39;</span><span class="p">,</span><span class="s1">&#39;.he5&#39;</span><span class="p">,</span><span class="s1">&#39;.hdf&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;.hdf5&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;.he4&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;.hdf&#39;</span><span class="p">,</span><span class="sa">u</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span><span class="sa">u</span><span class="s1">&#39;.hdf5&#39;</span><span class="p">,</span><span class="sa">u</span><span class="s1">&#39;.he5&#39;</span><span class="p">,</span><span class="sa">u</span><span class="s1">&#39;.hdf&#39;</span><span class="p">):</span> <span class="n">dbFmt</span><span class="o">=</span><span class="s1">&#39;hdf5&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to determine database format from &#39;&quot;</span><span class="o">+</span><span class="n">db</span><span class="o">+</span><span class="s2">&quot;&#39; (extension &#39;&quot;</span><span class="o">+</span><span class="n">ext</span><span class="o">+</span><span class="s2">&quot;&#39;): must be *.h5, *.hdf5, *.he5, *.hdf.&quot;</span><span class="p">)</span>

    <span class="c1"># make sure keys are unicode objects (which is what json converts to!)</span>
    <span class="n">unicodeTags</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
    <span class="c1"># make sure series are 1d arrays</span>
    <span class="k">if</span> <span class="n">series</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">series</span><span class="o">=</span><span class="p">{};</span> <span class="n">series</span><span class="o">.</span><span class="n">update</span><span class="p">([(</span><span class="s1">&#39;plot/&#39;</span><span class="o">+</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">series</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dbFmt</span><span class="o">==</span><span class="s1">&#39;sqlite&#39;</span><span class="p">:</span> <span class="n">series</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1"># sqlite needs lists, hdf5 is fine with numpy arrays</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s1">&#39;__len__&#39;</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;series[&quot;</span><span class="si">%s</span><span class="s1">&quot;] not a sequence (__len__ not defined).&#39;</span><span class="o">%</span><span class="n">k</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dbFmt</span><span class="o">==</span><span class="s1">&#39;sqlite&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;SQLite is no longer supported.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dbFmt</span><span class="o">==</span><span class="s1">&#39;hdf5&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">h5py</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hdf</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">db</span><span class="p">,(</span><span class="s1">&#39;w&#39;</span> <span class="k">if</span> <span class="n">newDb</span> <span class="k">else</span> <span class="s1">&#39;a&#39;</span><span class="p">),</span><span class="n">libver</span><span class="o">=</span><span class="n">hdf5version</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">warnings</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Error opening HDF5 file </span><span class="si">%s</span><span class="s2">, moving to </span><span class="si">%s</span><span class="s2">~~corrupt and creating a new one&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">db</span><span class="p">))</span>
            <span class="kn">import</span> <span class="nn">shutil</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">db</span><span class="o">+</span><span class="s1">&#39;~~corrupt&#39;</span><span class="p">)</span>
            <span class="n">hdf</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="n">libver</span><span class="o">=</span><span class="n">hdf5version</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
            <span class="n">wooJSON</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">WooJSONEncoder</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">oneway</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">sceneId</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;~</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sceneId</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdf</span><span class="p">:</span> <span class="k">break</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
            <span class="c1"># group for our Scene</span>
            <span class="n">G</span><span class="o">=</span><span class="n">hdf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">sceneId</span><span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;formatVersion&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dbFormatVersion</span>
            <span class="n">G</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;finished&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;batchTable&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">table</span>
            <span class="n">G</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;batchTableLine&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">line</span>
            <span class="n">G</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;sceneId&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">G</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
            <span class="n">G</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">duration</span>
            <span class="n">G</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pre&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">pre</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">G</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">unicodeTags</span><span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;plots&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plots</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">G</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">wooJSON</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span>
                <span class="n">G</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;engines&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">wooJSON</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="p">))</span>
            <span class="n">G_misc</span><span class="o">=</span><span class="n">G</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;misc&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="n">G_misc</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">wooJSON</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">G_series</span><span class="o">=</span><span class="n">G</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;series&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">series</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># hdf5 is smart enough to create sub-groups automatically if the name contains slashes</span>
                <span class="n">G_series</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">v</span>
            <span class="n">hdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;*fmt* must be one of &quot;sqlite&quot;, &quot;hdf5&quot;, None (autodetect based on suffix)&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">syncXls</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">xls</span><span class="o">=</span><span class="n">db</span><span class="o">+</span><span class="s1">&#39;.xlsx&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Converting </span><span class="si">%s</span><span class="s1"> to file://</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">xls</span><span class="p">)))</span>
        <span class="n">dbToSpread</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">xls</span><span class="p">,</span><span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;xlsx&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">postHooks</span><span class="p">:</span> <span class="n">ph</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_checkHdf5sim</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;formatVersion&#39;</span> <span class="ow">in</span> <span class="n">sim</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;database </span><span class="si">%s</span><span class="s1">: simulation </span><span class="si">%s</span><span class="s1"> does not define formatVersion?!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sim</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;formatVersion&#39;</span><span class="p">]</span><span class="o">!=</span><span class="n">dbFormatVersion</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;database format mismatch: </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">/formatVersion==</span><span class="si">%s</span><span class="s1">, should be </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">sim</span><span class="p">,</span><span class="n">sim</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;formatVersion&#39;</span><span class="p">],</span><span class="n">dbFormatVersion</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="c1"># return all series stored in the database</span>
<div class="viewcode-block" id="dbReadResults"><a class="viewcode-back" href="../../woo.batch.html#woo.batch.dbReadResults">[docs]</a><span class="k">def</span> <span class="nf">dbReadResults</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">basicTypes</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>    
    <span class="sd">&#39;&#39;&#39;Return list of dictionaries, representing database contents.</span>

<span class="sd">    :param basicTypes: don&#39;t reconstruct Woo objects from JSON (keep those as dicts) and don&#39;t return data series as numpy arrays.</span>

<span class="sd">    .. todo:: Nested (grouped) series are not read correctly from HDF5. Should be fixed either by flattening the hiearchy (like we do in :obj:`dbToSpread` and stuffing it into returned dict; or by reflecting the hierarchy in the dict returned.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">numpy</span><span class="o">,</span> <span class="nn">sqlite3</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">woo.core</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">h5py</span><span class="o">,</span> <span class="nn">h5py.h5f</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">h5py</span><span class="o">.</span><span class="n">h5f</span><span class="o">.</span><span class="n">is_hdf5</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)):</span> <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Not a HDF5 file.&#39;</span><span class="p">)</span>
        <span class="n">hdf</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">libver</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span><span class="ne">IOError</span><span class="p">):</span>
        <span class="c1"># connect always succeeds, as it seems, even if the type is not sqlite3 db</span>
        <span class="c1"># in that case, it will fail at conn.execute below</span>
        <span class="n">conn</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="n">sqliteTimeout</span><span class="p">,</span><span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span>
        <span class="n">hdf</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">hdf</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
            <span class="n">ret</span><span class="o">=</span><span class="p">[]</span>
            <span class="c1"># iterate over simulations</span>
            <span class="k">for</span> <span class="n">simId</span> <span class="ow">in</span> <span class="n">hdf</span><span class="p">:</span>
                <span class="n">sim</span><span class="o">=</span><span class="n">hdf</span><span class="p">[</span><span class="n">simId</span><span class="p">]</span>
                <span class="n">_checkHdf5sim</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
                <span class="n">rowDict</span><span class="o">=</span><span class="p">{}</span>
                <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">sim</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">att</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;pre&#39;</span><span class="p">,</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span><span class="s1">&#39;plots&#39;</span><span class="p">,</span><span class="s1">&#39;engines&#39;</span><span class="p">,</span><span class="s1">&#39;labels&#39;</span><span class="p">):</span>
                        <span class="n">val</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">att</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">rowDict</span><span class="p">[</span><span class="n">att</span><span class="p">]</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">WooJSONDecoder</span><span class="p">(</span><span class="n">onError</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">rowDict</span><span class="p">[</span><span class="n">att</span><span class="p">]</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">att</span><span class="p">]</span>
                <span class="n">rowDict</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">],</span><span class="n">rowDict</span><span class="p">[</span><span class="s1">&#39;series&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{},{}</span>
                <span class="k">for</span> <span class="n">misc</span> <span class="ow">in</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span> <span class="n">rowDict</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">][</span><span class="n">misc</span><span class="p">]</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">WooJSONDecoder</span><span class="p">(</span><span class="n">onError</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">misc</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;series&#39;</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># This was sometimes causing trouble (why?)</span>
                        <span class="c1">#</span>
                        <span class="c1"># File &quot;/usr/lib/python2.7/dist-packages/h5py/_hl/group.py&quot;, line 153, in __getitem__</span>
                        <span class="c1">#    oid = h5o.open(self.id, self._e(name), lapl=self._lapl)</span>
                        <span class="c1">#  File &quot;/usr/lib/python2.7/dist-packages/h5py/_hl/base.py&quot;, line 113, in _e</span>
                        <span class="c1">#    name = name.encode(&#39;ascii&#39;)</span>
                        <span class="c1"># AttributeError: &#39;int&#39; object has no attribute &#39;encode&#39;</span>
                        <span class="n">rowDict</span><span class="p">[</span><span class="s1">&#39;series&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;series&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="c1"># should we fail, do the conversion indirectly, through list (perhaps slower)</span>
                        <span class="n">rowDict</span><span class="p">[</span><span class="s1">&#39;series&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;series&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]))</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rowDict</span><span class="p">)</span>
            <span class="c1">## hdf.close()</span>
            <span class="k">return</span> <span class="n">ret</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># sqlite</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
        <span class="n">ret</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM batch ORDER BY finished&#39;</span><span class="p">)):</span>
            <span class="n">rowDict</span><span class="o">=</span><span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># json-encoded fields</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;pre&#39;</span><span class="p">,</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span><span class="s1">&#39;plots&#39;</span><span class="p">,</span><span class="s1">&#39;misc&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">basicTypes</span><span class="p">:</span> <span class="n">val</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">val</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">WooJSONDecoder</span><span class="p">(</span><span class="n">onError</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">key</span><span class="o">==</span><span class="s1">&#39;series&#39;</span><span class="p">:</span>
                    <span class="n">series</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="o">==</span><span class="nb">dict</span>
                    <span class="k">if</span> <span class="n">basicTypes</span><span class="p">:</span> <span class="n">val</span><span class="o">=</span><span class="n">series</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">val</span><span class="o">=</span><span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">series</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">basicTypes</span> <span class="ow">and</span> <span class="n">key</span><span class="o">==</span><span class="s1">&#39;finished&#39;</span><span class="p">:</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">rowDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">val</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rowDict</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># don&#39;t occupy the db longer than necessary</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="dbToJSON"><a class="viewcode-back" href="../../woo.batch.html#woo.batch.dbToJSON">[docs]</a><span class="k">def</span> <span class="nf">dbToJSON</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return simulation database as JSON string.</span>
<span class="sd">    </span>
<span class="sd">    :param kw: additional arguments passed to `json.dumps &lt;http://docs.python.org/3/library/json.html#json.dumps&gt;`_.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">woo.core</span>
    <span class="k">return</span> <span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">WooJSONEncoder</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">oneway</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">dbReadResults</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">basicTypes</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>



<div class="viewcode-block" id="dbToSpread"><a class="viewcode-back" href="../../woo.batch.html#woo.batch.dbToSpread">[docs]</a><span class="k">def</span> <span class="nf">dbToSpread</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;xls&#39;</span><span class="p">,</span><span class="n">rows</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">series</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">ignored</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;plotData&#39;</span><span class="p">,</span><span class="s1">&#39;tags&#39;</span><span class="p">),</span><span class="n">sortFirst</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="s1">&#39;batchtable&#39;</span><span class="p">,</span><span class="s1">&#39;batchTableLine&#39;</span><span class="p">,</span><span class="s1">&#39;finished&#39;</span><span class="p">,</span><span class="s1">&#39;sceneId&#39;</span><span class="p">,</span><span class="s1">&#39;duration&#39;</span><span class="p">),</span><span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Select simulation results (using *selector*) stored in batch database *db*, flatten data for each simulation,</span>
<span class="sd">    and dump the data in the CSV format (using *dialect*: &#39;excel&#39;, &#39;excel-tab&#39;, &#39;xls&#39;) into file *out* (standard output</span>
<span class="sd">    if not given). If *rows*, every simulation is saved into one row of the CSV file (i.e. attributes are in columns),</span>
<span class="sd">    otherwise each simulation corresponds to one column and each attribute is in one row.</span>
<span class="sd">    </span>
<span class="sd">    If *out* ends with &#39;.xls&#39;, the &#39;xls&#39; dialect is forced regardless of the value given. The &#39;xls&#39; format will refuse to write to standard output (*out* must be given).</span>

<span class="sd">    *ignored* fields are used to exclude large data from the dump: either database column of that name, or any attribute</span>
<span class="sd">    of that name. Attributes are flattened and path separated with &#39;.&#39;.</span>

<span class="sd">    *series* determines whether the `series` field will be written to a separate sheet, named by the sceneId. This is only supported with the `xls` dialect and raises error otherwise (unless `series` field is empty).</span>

<span class="sd">    Fields are sorted in their natural order (i.e. alphabetically, but respecting numbers), with *sortFirst* fields coming at the beginning.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Flatten possibly nested structure of dictionaries and lists (such as data decoded from JSON).</span>
<span class="sd">        Returns dictionary, where each object is denoted by its path, paths being separated by *sep*.</span>
<span class="sd">        Unicode strings are encoded to utf-8 strings (with encoding errors ignored) so that the result</span>
<span class="sd">        can be written with the csv module.</span>
<span class="sd">        </span>
<span class="sd">        Adapted from http://stackoverflow.com/questions/8477550/flattening-a-list-of-dicts-of-lists-of-dicts-etc-of-unknown-depth-in-python-n .</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ret</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span> <span class="n">flatten</span><span class="p">(</span><span class="n">item</span><span class="p">,(</span><span class="n">path</span><span class="o">+</span><span class="n">sep</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span> <span class="n">flatten</span><span class="p">(</span><span class="n">value</span><span class="p">,(</span><span class="n">path</span><span class="o">+</span><span class="n">sep</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># other values passed as they are</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">=</span><span class="n">obj</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">natural_key</span><span class="p">(</span><span class="n">string_</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return key for natural sorting (recognizing consecutive numerals as numbers):</span>
<span class="sd">        http://www.codinghorror.com/blog/archives/001018.html</span>
<span class="sd">        http://stackoverflow.com/a/3033342/761090</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)&#39;</span><span class="p">,</span> <span class="n">string_</span><span class="p">)]</span>
    
    <span class="k">def</span> <span class="nf">fixSheetname</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="c1"># truncate the name to 31 characters, otherwise there would be exception</span>
        <span class="c1"># see https://groups.google.com/forum/?fromgroups=#!topic/python-excel/QK4iJrPDSB8</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">30</span><span class="p">:</span> <span class="n">n</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="o">+</span><span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">29</span><span class="p">:]</span>
        <span class="c1"># invald characters (is that documented somewhere?? those are the only ones I found manually)</span>
        <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n</span>

    <span class="kn">import</span> <span class="nn">sqlite3</span><span class="o">,</span><span class="nn">json</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">csv</span><span class="o">,</span><span class="nn">warnings</span><span class="o">,</span><span class="nn">numpy</span><span class="o">,</span><span class="nn">operator</span>
    <span class="n">allData</span><span class="o">=</span><span class="p">{}</span>
    <span class="c1"># lowercase</span>
    <span class="n">ignored</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ignored</span><span class="p">]</span>
    <span class="n">sortFirst</span><span class="o">=</span><span class="p">[</span><span class="n">sf</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">sf</span> <span class="ow">in</span> <span class="n">sortFirst</span><span class="p">]</span>
    <span class="n">seriesData</span><span class="o">=</span><span class="p">{}</span>
    <span class="c1"># open db and get rows</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">h5py</span><span class="o">,</span> <span class="nn">h5py.h5f</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span> <span class="n">dbBytes</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">dbBytes</span><span class="o">=</span><span class="n">db</span>
        <span class="c1"># check first, to avoid warning from h5py.File in stderr</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">h5py</span><span class="o">.</span><span class="n">h5f</span><span class="o">.</span><span class="n">is_hdf5</span><span class="p">(</span><span class="n">dbBytes</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Not a HDF5 file.&#39;</span><span class="p">)</span>
        <span class="n">hdf</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">libver</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span><span class="ne">IOError</span><span class="p">):</span>
        <span class="c1"># connect always succeeds, as it seems, even if the type is not sqlite3 db</span>
        <span class="c1"># in that case, it will fail at conn.execute below</span>
        <span class="n">conn</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="n">sqliteTimeout</span><span class="p">,</span><span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span>
        <span class="n">hdf</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">hdf</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
            <span class="n">ret</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">if</span> <span class="n">selector</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;selector parameter ignored, since the file is HDF5 (not SQLite)&#39;</span><span class="p">)</span>
            <span class="c1"># first loop: sort by batchTable, batchTableLine, finished</span>
            <span class="c1"># for i,simId in enumerate(hdf):</span>
            <span class="n">sortAttrs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;batchTable&#39;</span><span class="p">,</span><span class="s1">&#39;batchTableLine&#39;</span><span class="p">,</span><span class="s1">&#39;finished&#39;</span><span class="p">)</span>
            <span class="c1"># sort simulation ids by attribute tuples:</span>
            <span class="c1"># http://stackoverflow.com/a/6620187/761090</span>
            <span class="n">simIds</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">hdf</span> <span class="k">if</span> <span class="n">_checkHdf5sim</span><span class="p">(</span><span class="n">hdf</span><span class="p">[</span><span class="n">s</span><span class="p">])],[</span><span class="nb">tuple</span><span class="p">([</span><span class="n">natural_key</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">hdf</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">sortAttrs</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">hdf</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">hdf</span> <span class="k">if</span> <span class="n">_checkHdf5sim</span><span class="p">(</span><span class="n">hdf</span><span class="p">[</span><span class="n">s</span><span class="p">])]),</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># print simIds</span>
            <span class="c1"># iterate over simulations</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">simId</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">simIds</span><span class="p">):</span>
                <span class="n">sim</span><span class="o">=</span><span class="n">hdf</span><span class="p">[</span><span class="n">simId</span><span class="p">]</span>
                <span class="n">_checkHdf5sim</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
                <span class="n">rowDict</span><span class="o">=</span><span class="p">{}</span>
                <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">sim</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="n">val</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">att</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span> <span class="n">val</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
                    <span class="n">rowDict</span><span class="p">[</span><span class="n">att</span><span class="p">]</span><span class="o">=</span><span class="n">val</span>
                <span class="n">rowDict</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
                <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="n">val</span><span class="o">=</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">att</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span> <span class="n">val</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
                    <span class="n">rowDict</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">][</span><span class="n">att</span><span class="p">]</span><span class="o">=</span><span class="n">val</span>
                <span class="n">series</span><span class="o">=</span><span class="p">{}</span>
                <span class="c1"># we have to flatten series, since it may contain nested hdf5 groups</span>
                <span class="c1"># http://stackoverflow.com/a/6036037/761090</span>
                <span class="k">def</span> <span class="nf">flat_group_helper</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">g</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span> <span class="n">prefix</span><span class="o">+=</span><span class="s1">&#39;/&#39;</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">sub</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span><span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">flat_group_helper</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="n">name</span><span class="p">,</span><span class="n">sub</span><span class="p">):</span> <span class="k">yield</span> <span class="n">j</span>
                        <span class="k">else</span><span class="p">:</span> <span class="k">yield</span> <span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="n">name</span><span class="p">,</span><span class="n">sub</span><span class="p">)</span>
                <span class="k">def</span> <span class="nf">flat_group</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
                    <span class="kn">import</span> <span class="nn">collections</span>
                    <span class="k">return</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">flat_group_helper</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">g</span><span class="p">))</span>
                <span class="c1"># print flat_group(sim[&#39;series&#39;]).keys()</span>
                <span class="k">for</span> <span class="n">sName</span><span class="p">,</span><span class="n">sVal</span> <span class="ow">in</span> <span class="n">flat_group</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;series&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># print sName</span>
                    <span class="n">series</span><span class="p">[</span><span class="n">sName</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sVal</span><span class="p">)</span>
                <span class="c1"># attributes are bytes, so &#39;_&#39; must be b&#39;_&#39; to avoid TypeError (can&#39;t concat bytes to str)</span>
                <span class="n">seriesData</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;sceneId&#39;</span><span class="p">])]</span><span class="o">=</span><span class="n">series</span>
                <span class="c1"># same as for sqlite3 below</span>
                <span class="n">flat</span><span class="o">=</span><span class="n">flatten</span><span class="p">(</span><span class="n">rowDict</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">flat</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ignored</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allData</span><span class="p">:</span> <span class="n">allData</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">allData</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">+=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">allData</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span><span class="o">+</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>
            <span class="c1">## hdf.close()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="n">sqliteTimeout</span><span class="p">,</span><span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">selector</span> <span class="k">if</span> <span class="n">selector</span><span class="o">!=</span><span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;SELECT * FROM batch ORDER BY title&#39;</span><span class="p">)):</span>
            <span class="n">rowDict</span><span class="o">=</span><span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ignored</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">val</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="c1"># decode val from json, if it fails, leave it alone</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">val</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">!=</span><span class="s1">&#39;series&#39;</span><span class="p">:</span> <span class="n">rowDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">val</span>
                <span class="k">elif</span> <span class="n">series</span><span class="p">:</span> <span class="n">seriesData</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;sceneId&#39;</span><span class="p">]]</span><span class="o">=</span><span class="n">val</span> <span class="c1"># set only if allowed</span>
            <span class="n">flat</span><span class="o">=</span><span class="n">flatten</span><span class="p">(</span><span class="n">rowDict</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">flat</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ignored</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allData</span><span class="p">:</span> <span class="n">allData</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">allData</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">+=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">allData</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span><span class="o">+</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># don&#39;t occupy the db longer than necessary</span>
    <span class="n">fields</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">allData</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">key</span><span class="o">=</span><span class="n">natural_key</span><span class="p">)</span>
    <span class="c1"># apply sortFirst</span>
    <span class="n">fieldsLower</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">];</span> <span class="n">fields0</span><span class="o">=</span><span class="n">fields</span><span class="p">[:]</span> <span class="c1"># these two have always same order</span>
    <span class="k">for</span> <span class="n">sf</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">sortFirst</span><span class="p">):</span> <span class="c1"># reverse so that the order of sortFirst is respected</span>
        <span class="k">if</span> <span class="n">sf</span> <span class="ow">in</span> <span class="n">fieldsLower</span><span class="p">:</span> <span class="c1"># lowercased name should be put to the front</span>
            <span class="n">field</span><span class="o">=</span><span class="n">fields0</span><span class="p">[</span><span class="n">fieldsLower</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sf</span><span class="p">)]</span> <span class="c1"># get the case-sensitive one</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">f</span><span class="o">!=</span><span class="n">field</span><span class="p">]</span> <span class="c1"># rearrange</span>

    <span class="n">xls</span><span class="o">=</span><span class="n">dialect</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;xls&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">out</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xls&#39;</span><span class="p">))</span>
    <span class="n">xlsx</span><span class="o">=</span><span class="n">dialect</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;xlsx&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">out</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">xls</span> <span class="ow">or</span> <span class="n">xlsx</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">out</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The *out* parameter must be given when using the xls/xlsx dialects (refusing to write binary to standard output).&#39;</span><span class="p">)</span>
        <span class="c1"># http://scienceoss.com/write-excel-files-with-python-using-xlwt/</span>
        <span class="c1"># http://www.youlikeprogramming.com/2011/04/examples-generating-excel-documents-using-pythons-xlwt/</span>
        <span class="kn">import</span> <span class="nn">urllib.parse</span>
        <span class="kn">import</span> <span class="nn">datetime</span>
        <span class="k">if</span> <span class="n">xls</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">xlwt</span>
            <span class="n">wbk</span><span class="o">=</span><span class="n">xlwt</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">sheet</span><span class="o">=</span><span class="n">wbk</span><span class="o">.</span><span class="n">add_sheet</span><span class="p">(</span><span class="n">fixSheetname</span><span class="p">(</span><span class="n">db</span><span class="p">))</span> <span class="c1"># truncate if too long, see below</span>
            <span class="c1"># datetime style</span>
            <span class="n">datetimeStyle</span><span class="o">=</span><span class="n">xlwt</span><span class="o">.</span><span class="n">XFStyle</span><span class="p">()</span>
            <span class="n">datetimeStyle</span><span class="o">.</span><span class="n">num_format_str</span><span class="o">=</span><span class="s1">&#39;yyyy-mm-dd_hh:mm:ss&#39;</span> <span class="c1"># http://office.microsoft.com/en-us/excel-help/number-format-codes-HP005198679.aspx</span>
            <span class="c1"># header style</span>
            <span class="n">font</span><span class="o">=</span><span class="n">xlwt</span><span class="o">.</span><span class="n">Font</span><span class="p">()</span>
            <span class="n">font</span><span class="o">.</span><span class="n">bold</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">headStyle</span><span class="o">=</span><span class="n">xlwt</span><span class="o">.</span><span class="n">XFStyle</span><span class="p">()</span>
            <span class="n">headStyle</span><span class="o">.</span><span class="n">font</span><span class="o">=</span><span class="n">font</span>
            <span class="n">hrefStyle</span><span class="o">=</span><span class="n">xlwt</span><span class="o">.</span><span class="n">easyxf</span><span class="p">(</span><span class="s1">&#39;font: underline single&#39;</span><span class="p">)</span>
            <span class="c1"># default style</span>
            <span class="n">defaultStyle</span><span class="o">=</span><span class="n">xlwt</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">default_style</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">xlsxwriter</span>
            <span class="n">wbk</span><span class="o">=</span><span class="n">xlsxwriter</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="n">sheet</span><span class="o">=</span><span class="n">wbk</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="n">fixSheetname</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
            <span class="n">headStyle</span><span class="o">=</span><span class="n">wbk</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bold&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>
            <span class="n">datetimeStyle</span><span class="o">=</span><span class="n">wbk</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;num_format&#39;</span><span class="p">:</span><span class="s1">&#39;yyyy-mm-dd_hh:mm:ss&#39;</span><span class="p">})</span>
            <span class="n">hrefStyle</span><span class="o">=</span><span class="n">wbk</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;underline&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
            <span class="n">defaultStyle</span><span class="o">=</span><span class="kc">None</span>
        <span class="c1"># cell styling </span>
        <span class="n">styleDict</span><span class="o">=</span><span class="p">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span><span class="n">datetimeStyle</span><span class="p">}</span> <span class="c1"># add styles for other custom types here</span>
        <span class="c1"># normal and transposed setters</span>
        <span class="k">if</span> <span class="n">rows</span><span class="p">:</span> <span class="n">setCell</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">style</span><span class="p">:</span> <span class="n">write_cell</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">style</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">setCell</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">style</span><span class="p">:</span> <span class="n">write_cell</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">style</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">write_cell</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">style</span><span class="p">):</span>
            <span class="n">hyperlink</span><span class="o">=</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,(</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;https://&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">hyperlink</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">xls</span><span class="p">:</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">xlwt</span><span class="o">.</span><span class="n">Formula</span><span class="p">(</span><span class="s1">&#39;HYPERLINK(&quot;</span><span class="si">%s</span><span class="s1">&quot;,&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">safe</span><span class="o">=</span><span class="s1">&#39;:/&#39;</span><span class="p">),</span><span class="n">data</span><span class="p">))</span>
                    <span class="n">style</span><span class="o">=</span><span class="n">hrefStyle</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">style</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">write_url</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">string</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">):</span> <span class="n">data</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span> <span class="n">data</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="c1"># XLSX does not handle NaN/Inf (yet)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">xls</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">isinf</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span> <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="n">style</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">style</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
            <span class="c1"># headers</span>
            <span class="n">setCell</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">field</span><span class="p">,</span><span class="n">headStyle</span><span class="p">)</span>
            <span class="c1"># data</span>
            <span class="k">for</span> <span class="n">row</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allData</span><span class="p">[</span><span class="n">field</span><span class="p">]):</span>
                <span class="n">style</span><span class="o">=</span><span class="n">styleDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">),</span><span class="n">defaultStyle</span><span class="p">)</span>
                <span class="n">setCell</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span><span class="n">row</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">style</span><span class="p">)</span>
                <span class="c1"># print row,type(val),val</span>
        <span class="c1"># save data series</span>
        <span class="k">if</span> <span class="n">seriesData</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sheetName</span><span class="p">,</span><span class="n">dic</span> <span class="ow">in</span> <span class="n">seriesData</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">xls</span><span class="p">:</span> <span class="n">sheet</span><span class="o">=</span><span class="n">wbk</span><span class="o">.</span><span class="n">add_sheet</span><span class="p">(</span><span class="n">fixSheetname</span><span class="p">(</span><span class="n">sheetName</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">sheet</span><span class="o">=</span><span class="n">wbk</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="n">fixSheetname</span><span class="p">(</span><span class="n">sheetName</span><span class="p">))</span>
                <span class="c1"># perhaps write some header here</span>
                <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">colName</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dic</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                    <span class="k">if</span> <span class="n">xls</span> <span class="ow">and</span> <span class="n">col</span><span class="o">&gt;</span><span class="mi">255</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Rhe data being converted to XLS (</span><span class="si">%s</span><span class="s1">) contain </span><span class="si">%d</span><span class="s1"> columns, which is more than 255, the limit of the XLS format. Extra data will be discarded from the XLS output. Use .xlsx to overcome this limitation.&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">dic</span><span class="p">)))</span>
                        <span class="k">break</span>
                    <span class="n">sheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">colName</span><span class="p">,</span><span class="n">headStyle</span><span class="p">)</span>
                    <span class="n">rowOffset</span><span class="o">=</span><span class="mi">1</span> <span class="c1"># length of header</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">dic</span><span class="p">[</span><span class="n">colName</span><span class="p">])):</span>
                        <span class="k">if</span> <span class="n">xls</span> <span class="ow">and</span> <span class="n">row</span><span class="o">+</span><span class="n">rowOffset</span><span class="o">&gt;</span><span class="mi">65535</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;the data being converted to XLS (</span><span class="si">%s</span><span class="s1">) contain </span><span class="si">%d</span><span class="s1"> rows (with </span><span class="si">%d</span><span class="s1"> header rows), which is more than 65535, the limit of the XLS file format. Extra data will be discarded from the XLS output. Use .xlsx to overcome this limitation.&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">dic</span><span class="p">[</span><span class="n">colName</span><span class="p">]),</span><span class="n">rowOffset</span><span class="p">))</span>
                            <span class="k">break</span>
                        <span class="n">val</span><span class="o">=</span><span class="n">dic</span><span class="p">[</span><span class="n">colName</span><span class="p">][</span><span class="n">row</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">xlsx</span> <span class="ow">and</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isinf</span><span class="p">(</span><span class="n">val</span><span class="p">)):</span> <span class="n">val</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                        <span class="n">sheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="o">+</span><span class="n">rowOffset</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xls</span><span class="p">:</span> <span class="n">wbk</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">wbk</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">seriesData</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Data series can only be written with the *xls* dialect&#39;</span><span class="p">)</span>
        <span class="n">outt</span><span class="o">=</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">out</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">datetime</span>
        <span class="k">def</span> <span class="nf">asStr</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="s1">&#39;Customize string conversions for some types&#39;</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">==</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H:%M:%S&#39;</span><span class="p">)</span> <span class="c1"># as ISO, but without microseconds</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="c1"># write into CSV</span>
        <span class="k">if</span> <span class="n">rows</span><span class="p">:</span>
            <span class="c1"># one attribute per column</span>
            <span class="n">writer</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">outt</span><span class="p">,</span><span class="n">fieldnames</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span><span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">allData</span><span class="p">[</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]])):</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span><span class="n">asStr</span><span class="p">(</span><span class="n">allData</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">allData</span><span class="o">.</span><span class="n">keys</span><span class="p">()]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># one attribute per row</span>
            <span class="n">writer</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">outt</span><span class="p">,</span><span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">a</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">asStr</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">allData</span><span class="p">[</span><span class="n">a</span><span class="p">]])</span></div>

    

<div class="viewcode-block" id="readParamsFromTable"><a class="viewcode-back" href="../../woo.batch.html#woo.batch.readParamsFromTable">[docs]</a><span class="k">def</span> <span class="nf">readParamsFromTable</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span><span class="n">under</span><span class="o">=</span><span class="s1">&#39;table&#39;</span><span class="p">,</span><span class="n">noTableOk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">unknownOk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read parameters from a file and assign them to :obj:`woo.core.Scene.lab` under the ``under`` pseudo-module (e.g. ``Scene.lab.table.foo`` and so on. This function is used for scripts (as opposed to preprocessors) running in a batch. The file format is described in :obj:`TableParamReader` (CSV or XLS).</span>

<span class="sd">    Assigned tags (the ``title`` column is synthesized if absent,see :obj:`woo.utils.TableParamReader`):: </span>

<span class="sd">        S=woo.master.scene</span>
<span class="sd">        S.tags[&#39;title&#39;]=                                            # assigns the title column; might be synthesized</span>
<span class="sd">        S.tags[&#39;params&#39;]=&quot;name1=val1,name2=val2,&quot;                   # all explicitly assigned parameters</span>
<span class="sd">        S.tags[&#39;defaultParams&#39;]=&quot;unassignedName1=defaultValue1,&quot;    # parameters that were left at their defaults</span>
<span class="sd">        S.tags[&#39;d.id&#39;]=s.tags[&#39;id&#39;]+&#39;.&#39;+s.tags[&#39;title&#39;]</span>
<span class="sd">        S.tags[&#39;id.d&#39;]=s.tags[&#39;title&#39;]+&#39;.&#39;+s.tags[&#39;id&#39;]</span>

<span class="sd">    :param tableFile: text file (with one value per blank-separated columns)</span>
<span class="sd">    :param under: name of pseudo-module under ``S.lab`` to save all values to (``table`` by default)</span>
<span class="sd">    :param int tableLine: number of line where to get the values from</span>
<span class="sd">    :param bool noTableOk: if False, raise exception if the file cannot be open; use default values otherwise</span>
<span class="sd">    :param bool unknownOk: do not raise exception if unknown column name is found in the file, and assign it as well</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tagsParams</span><span class="o">=</span><span class="p">[]</span>
    <span class="c1"># dictParams is what eventually ends up in S.lab.table.* (default+specified values)</span>
    <span class="n">dictDefaults</span><span class="p">,</span><span class="n">dictParams</span><span class="o">=</span><span class="p">{},{}</span>
    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">builtins</span><span class="o">,</span><span class="nn">re</span><span class="o">,</span><span class="nn">math</span><span class="o">,</span><span class="nn">woo</span>
    <span class="c1"># create the S.lab.table pseudo-module</span>
    <span class="n">S</span><span class="o">=</span><span class="n">scene</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">_newModule</span><span class="p">(</span><span class="n">under</span><span class="p">)</span>
    <span class="n">pseudoMod</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="p">,</span><span class="n">under</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inBatch</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">hasBatchTable</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">noTableOk</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;Batch options not defined (and required; pass noTableOk=True if they are not)&quot;</span><span class="p">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;l!&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tableFile</span><span class="p">,</span><span class="n">tableLine</span><span class="o">=</span><span class="n">wooOptions</span><span class="o">.</span><span class="n">batchTable</span><span class="p">,</span><span class="n">wooOptions</span><span class="o">.</span><span class="n">batchLine</span>
        <span class="k">if</span> <span class="n">tableFile</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">noTableOk</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No table specified in batch options, but noTableOk was not given.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">allTab</span><span class="o">=</span><span class="n">TableParamReader</span><span class="p">(</span><span class="n">tableFile</span><span class="p">)</span><span class="o">.</span><span class="n">paramDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tableLine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allTab</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Table </span><span class="si">%s</span><span class="s2"> doesn&#39;t contain valid line number </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">tableFile</span><span class="p">,</span><span class="n">tableLine</span><span class="p">))</span>
        <span class="n">vv</span><span class="o">=</span><span class="n">allTab</span><span class="p">[</span><span class="n">tableLine</span><span class="p">]</span>
        <span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;l</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tableLine</span>
        <span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
        <span class="c1">#S.tags[&#39;idt&#39;]=S.tags[&#39;id&#39;]+&#39;.&#39;+S.tags[&#39;title&#39;];</span>
        <span class="c1">#S.tags[&#39;tid&#39;]=S.tags[&#39;title&#39;]+&#39;.&#39;+S.tags[&#39;id&#39;]</span>
        <span class="c1"># assign values specified in the table to python vars</span>
        <span class="c1"># !something cols are skipped, those are env vars we don&#39;t treat at all (they are contained in title, though)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">vv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">==</span><span class="s1">&#39;title&#39;</span> <span class="ow">or</span> <span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;!&#39;</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">unknownOk</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;Parameter `</span><span class="si">%s</span><span class="s2">&#39; has no default value assigned&quot;</span><span class="o">%</span><span class="n">col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vv</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;*&#39;</span><span class="p">:</span> <span class="n">vv</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">=</span><span class="n">kw</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="c1"># use default value for * in the table</span>
            <span class="k">elif</span> <span class="n">vv</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;-&#39;</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip this column</span>
            <span class="k">elif</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="c1"># remove the var from kw, so that it contains only those that were default at the end of this loop</span>
            <span class="c1">#print &#39;ASSIGN&#39;,col,vv[col]</span>
            <span class="n">tagsParams</span><span class="o">+=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="n">vv</span><span class="p">[</span><span class="n">col</span><span class="p">])];</span>
            <span class="c1"># when reading from XLS, data might be numbers; use eval only for strings, otherwise use the thing itself</span>
            <span class="n">dictParams</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="n">col</span><span class="p">],</span><span class="nb">dict</span><span class="p">(</span><span class="n">woo</span><span class="o">=</span><span class="n">woo</span><span class="p">,</span><span class="o">**</span><span class="n">math</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="n">col</span><span class="p">],</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">vv</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
    <span class="c1"># assign remaining (default) keys to python vars</span>
    <span class="n">defaults</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">dictDefaults</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">kw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">defaults</span><span class="o">+=</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">kw</span><span class="p">[</span><span class="n">k</span><span class="p">])];</span>
    <span class="n">pseudoMod</span><span class="o">.</span><span class="n">defaultParams_</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
    <span class="n">pseudoMod</span><span class="o">.</span><span class="n">explicitParams_</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tagsParams</span><span class="p">)</span>
    <span class="c1"># save all vars to the pseudo-module</span>
    <span class="n">dictDefaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dictParams</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dictDefaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">pseudoMod</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="runPreprocessor"><a class="viewcode-back" href="../../woo.batch.html#woo.batch.runPreprocessor">[docs]</a><span class="k">def</span> <span class="nf">runPreprocessor</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span><span class="n">preFile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Execute given :obj:`Preprocessor &lt;woo.core.Preprocessor&gt;`, modifying its attributes from batch (if running in batch). Each column from the batch table (except of environment variables starting with ``!``) must correspond to a preprocessor&#39;s attribute.</span>

<span class="sd">    Nested attributes are allowed, e.g. with :obj:`woo.pre.horse.FallingHorse`, a column named ``mat.tanPhi`` will modify horse&#39;s material&#39;s friction angle, using the default material object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">nestedSetattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">attrs</span><span class="o">=</span><span class="n">attr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">indexRE</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;([a-zA-Z_0-9]+)\s*\[\s*(-?[0-9]+)\s*\]&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c1">#if i.strip().endswith(&#39;]&#39;)</span>
            <span class="n">m</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">indexRE</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span> <span class="n">obj</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))]</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">obj</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">m</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">indexRE</span><span class="p">,</span><span class="n">attrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))]</span><span class="o">=</span><span class="n">val</span>
        <span class="k">else</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">attrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">val</span><span class="p">)</span>
        <span class="c1">#if not hasattr(obj,attrs[-1]): raise AttributeError(&#39;%s: no such attribute: %s.&#39;%(obj.__module__+&#39;.&#39;+type(obj).__name__,attrs[-1]))</span>
        <span class="c1">#setattr(obj,attrs[-1],val)</span>

    <span class="c1"># just run preprocessor in this case, plus set title, if given in Preprocessor</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inBatch</span><span class="p">():</span>
        <span class="n">S</span><span class="o">=</span><span class="n">pre</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pre</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
            <span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">title</span>
        <span class="k">return</span> <span class="n">S</span>

    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">woo</span><span class="o">,</span><span class="nn">math</span><span class="o">,</span><span class="nn">numpy</span>
    <span class="n">tableFileLine</span><span class="o">=</span><span class="n">wooOptions</span><span class="o">.</span><span class="n">batchTable</span><span class="p">,</span><span class="n">wooOptions</span><span class="o">.</span><span class="n">batchLine</span>
    <span class="n">evalParams</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span> <span class="n">wooOptions</span><span class="o">.</span><span class="n">batchTable</span> <span class="ow">and</span> <span class="n">wooOptions</span><span class="o">.</span><span class="n">batchLine</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">allTab</span><span class="o">=</span><span class="n">TableParamReader</span><span class="p">(</span><span class="n">wooOptions</span><span class="o">.</span><span class="n">batchTable</span><span class="p">)</span><span class="o">.</span><span class="n">paramDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wooOptions</span><span class="o">.</span><span class="n">batchLine</span> <span class="ow">in</span> <span class="n">allTab</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Table </span><span class="si">%s</span><span class="s2"> doesn&#39;t contain valid line number </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">wooOptions</span><span class="o">.</span><span class="n">batchTable</span><span class="p">,</span><span class="n">wooOptions</span><span class="o">.</span><span class="n">batchLine</span><span class="p">))</span>
        <span class="n">vv</span><span class="o">=</span><span class="n">allTab</span><span class="p">[</span><span class="n">wooOptions</span><span class="o">.</span><span class="n">batchLine</span><span class="p">]</span>
        <span class="c1"># overriding things set in the #: lines of preprocessor from the table using %varName=...</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vv</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)]):</span>
            <span class="k">if</span> <span class="n">preFile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unable to re-load preprocessor due to </span><span class="si">%s</span><span class="s1">omething columns: preFile was left empty by the caller.&#39;</span><span class="p">)</span>
            <span class="n">overrideHashPercent</span><span class="o">=</span><span class="p">{}</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">vv</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="c1"># copy list so that dictionary does not change while iterating over it</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">):</span> <span class="k">continue</span>
                <span class="n">val</span><span class="o">=</span><span class="n">vv</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span> <span class="n">val</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">dict</span><span class="p">(</span><span class="n">woo</span><span class="o">=</span><span class="n">woo</span><span class="p">,</span><span class="o">**</span><span class="n">math</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">))</span>
                <span class="n">overrideHashPercent</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span><span class="o">=</span><span class="n">val</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Re-assigning #</span><span class="si">%%</span><span class="s1"> variable </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
                <span class="n">vv</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="c1"># print(vv)</span>
            <span class="n">pre</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Object</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">preFile</span><span class="p">,</span><span class="n">overrideHashPercent</span><span class="o">=</span><span class="n">overrideHashPercent</span><span class="p">)</span>
        <span class="c1"># set preprocessor parameters first</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">vv</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;!&#39;</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># pseudo-variables such as !SCRIPT, !THREADS and so on</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">==</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="k">continue</span> <span class="c1"># postponed, computed later</span>
            <span class="c1"># postpone evaluation of parameters starting with = so that they can use other params</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">):</span> <span class="n">evalParams</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;=&quot;</span><span class="p">):</span> <span class="n">evalParams</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;OVERRIDING FROM TABLE: </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>
                <span class="n">nestedSetattr</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">globals</span><span class="p">(),</span><span class="nb">dict</span><span class="p">(</span><span class="n">woo</span><span class="o">=</span><span class="n">woo</span><span class="p">,</span><span class="n">math</span><span class="o">=</span><span class="n">math</span><span class="p">,</span><span class="n">numpy</span><span class="o">=</span><span class="n">numpy</span><span class="p">)))</span> <span class="c1"># woo.unit</span>
    <span class="c1"># postponed evaluation of computable params</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">evalParams</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;OVERRIDING FROM TABLE (delayed): </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>
        <span class="n">nestedSetattr</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">globals</span><span class="p">(),</span><span class="nb">dict</span><span class="p">(</span><span class="n">woo</span><span class="o">=</span><span class="n">woo</span><span class="p">,</span><span class="n">math</span><span class="o">=</span><span class="n">math</span><span class="p">,</span><span class="n">numpy</span><span class="o">=</span><span class="n">numpy</span><span class="p">,</span><span class="bp">self</span><span class="o">=</span><span class="n">pre</span><span class="p">)))</span>
    <span class="c1"># check types, if this is a python preprocessor</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span><span class="s1">&#39;checkAttrTypes&#39;</span><span class="p">):</span> <span class="n">pre</span><span class="o">.</span><span class="n">checkAttrTypes</span><span class="p">()</span>
    <span class="c1"># run preprocessor</span>
    <span class="k">if</span> <span class="n">wooOptions</span><span class="o">.</span><span class="n">batchTable</span><span class="p">:</span> <span class="n">pre</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
    <span class="n">S</span><span class="o">=</span><span class="n">pre</span><span class="p">()</span>
    <span class="c1"># set tags from batch</span>
    <span class="k">if</span> <span class="n">wooOptions</span><span class="o">.</span><span class="n">batchTable</span><span class="p">:</span>
        <span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;l</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">wooOptions</span><span class="o">.</span><span class="n">batchLine</span>
        <span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;default&#39;</span>
        <span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">preFile</span> <span class="k">if</span> <span class="n">preFile</span> <span class="k">else</span> <span class="s1">&#39;[no file]&#39;</span><span class="p">)</span>
    <span class="c1">#S.tags[&#39;idt&#39;]=(S.tags[&#39;id&#39;]+&#39;.&#39;+S.tags[&#39;title&#39;]).replace(&#39;/&#39;,&#39;_&#39;)</span>
    <span class="c1">#S.tags[&#39;tid&#39;]=(S.tags[&#39;title&#39;]+&#39;.&#39;+S.tags[&#39;id&#39;]).replace(&#39;/&#39;,&#39;_&#39;)</span>
    <span class="k">return</span> <span class="n">S</span></div>

<div class="viewcode-block" id="TableParamReader"><a class="viewcode-back" href="../../woo.batch.html#woo.batch.TableParamReader">[docs]</a><span class="k">class</span> <span class="nc">TableParamReader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Class for reading simulation parameters from text file.</span>

<span class="sd">Each parameter is represented by one column, each parameter set by one line. Colums are separated by blanks (no quoting).</span>

<span class="sd">First non-empty line contains column titles (without quotes).</span>
<span class="sd">You may use special column named &#39;title&#39; to describe this parameter set;</span>
<span class="sd">if such colum is absent, title will be built by concatenating column names and corresponding values (``param1=34,param2=12.22,param4=foo``)</span>

<span class="sd">* from columns ending in ``!`` (the ``!`` is not included in the column name)</span>
<span class="sd">* from all columns, if no columns end in ``!``.</span>
<span class="sd">* columns containing literal - (minus) will be ignored</span>

<span class="sd">Empty lines within the file are ignored (although counted); ``#`` starts comment till the end of line. Number of blank-separated columns must be the same for all non-empty lines.</span>

<span class="sd">A special value ``=`` can be used instead of parameter value; value from the previous non-empty line will be used instead (works recursively); in XLS, *empty* cell is treated the same as ``=``.</span>

<span class="sd">This class is used by :obj:`woo.utils.readParamsFromTable`.</span>

<span class="sd">&gt;&gt;&gt; tryData=[</span>
<span class="sd">...   [&#39;head1&#39;,&#39;important2!&#39;,&#39;head3&#39;,&#39;...&#39;,&#39;...&#39;,&#39;...&#39;,&#39;!OMP_NUM_THREADS!&#39;,&#39;abcd&#39;],</span>
<span class="sd">...   [1,1.1, &#39;1&#39;,&#39;.&#39;,&#39;1&#39;,&#39;5&#39;, 1.2,1.3,],</span>
<span class="sd">...   [&#39;a&#39;,&#39;b&#39;,&#39;HE&#39;,&#39;AD&#39;,&#39;_&#39;,&#39;3&#39;,&#39;c&#39;,&#39;d&#39;,&#39;###&#39;,&#39;comment&#39;],</span>
<span class="sd">...   [&#39;# empty line&#39;],</span>
<span class="sd">...   [1,&#39;=&#39;,&#39;=&#39;,&#39;=&#39;,&#39;=&#39;,&#39;=&#39;,&#39;=&#39;,&#39;g&#39;]</span>
<span class="sd">... ]</span>
<span class="sd">&gt;&gt;&gt; import woo</span>
<span class="sd">&gt;&gt;&gt; tryFile=woo.master.tmpFilename()</span>
<span class="sd">&gt;&gt;&gt; # write text</span>
<span class="sd">&gt;&gt;&gt; f1=tryFile+&#39;.txt&#39;</span>
<span class="sd">&gt;&gt;&gt; txt=open(f1,&#39;w&#39;)</span>
<span class="sd">&gt;&gt;&gt; for ll in tryData: n=txt.write(&#39; &#39;.join([str(l) for l in ll])+&#39;\n&#39;) # set n to suppress output in doctest under py3k</span>
<span class="sd">&gt;&gt;&gt; txt.close()</span>
<span class="sd">&gt;&gt;&gt; </span>
<span class="sd">&gt;&gt;&gt; # write xls</span>
<span class="sd">&gt;&gt;&gt; import xlwt,itertools</span>
<span class="sd">&gt;&gt;&gt; f2=tryFile+&#39;.xls&#39;</span>
<span class="sd">&gt;&gt;&gt; xls=xlwt.Workbook(); sheet=xls.add_sheet(&#39;test&#39;)</span>
<span class="sd">&gt;&gt;&gt; for r in range(len(tryData)):</span>
<span class="sd">...   for c in range(len(tryData[r])):</span>
<span class="sd">...     sheet.write(r,c,tryData[r][c])</span>
<span class="sd">&gt;&gt;&gt; xls.save(f2)</span>
<span class="sd">&gt;&gt;&gt; </span>
<span class="sd">&gt;&gt;&gt; from pprint import *</span>
<span class="sd">&gt;&gt;&gt; pprint(TableParamReader(f1).paramDict())</span>
<span class="sd">{2: {&#39;!OMP_NUM_THREADS&#39;: &#39;1.2&#39;,</span>
<span class="sd">     &#39;abcd&#39;: &#39;1.3&#39;,</span>
<span class="sd">     &#39;head1&#39;: &#39;1&#39;,</span>
<span class="sd">     &#39;head3&#39;: &#39;1.15&#39;,</span>
<span class="sd">     &#39;important2&#39;: &#39;1.1&#39;,</span>
<span class="sd">     u&#39;title&#39;: u&#39;important2=1.1,OMP_NUM_THREADS=1.2&#39;},</span>
<span class="sd"> 3: {&#39;!OMP_NUM_THREADS&#39;: &#39;c&#39;,</span>
<span class="sd">     &#39;abcd&#39;: &#39;d&#39;,</span>
<span class="sd">     &#39;head1&#39;: &#39;a&#39;,</span>
<span class="sd">     &#39;head3&#39;: &#39;HEAD_3&#39;,</span>
<span class="sd">     &#39;important2&#39;: &#39;b&#39;,</span>
<span class="sd">     u&#39;title&#39;: u&#39;important2=b,OMP_NUM_THREADS=c&#39;},</span>
<span class="sd"> 5: {&#39;!OMP_NUM_THREADS&#39;: &#39;c&#39;,</span>
<span class="sd">     &#39;abcd&#39;: &#39;g&#39;,</span>
<span class="sd">     &#39;head1&#39;: &#39;1&#39;,</span>
<span class="sd">     &#39;head3&#39;: &#39;HEAD_3&#39;,</span>
<span class="sd">     &#39;important2&#39;: &#39;b&#39;,</span>
<span class="sd">     u&#39;title&#39;: u&#39;important2=b,OMP_NUM_THREADS=c__line=5__&#39;}}</span>
<span class="sd">&gt;&gt;&gt; pprint(TableParamReader(f2).paramDict())</span>
<span class="sd">{2: {u&#39;!OMP_NUM_THREADS&#39;: &#39;1.2&#39;,</span>
<span class="sd">     u&#39;abcd&#39;: &#39;1.3&#39;,</span>
<span class="sd">     u&#39;head1&#39;: &#39;1&#39;,</span>
<span class="sd">     u&#39;head3&#39;: &#39;1.15&#39;,</span>
<span class="sd">     u&#39;important2&#39;: &#39;1.1&#39;,</span>
<span class="sd">     u&#39;title&#39;: u&#39;important2=1.1,OMP_NUM_THREADS=1.2&#39;},</span>
<span class="sd"> 3: {u&#39;!OMP_NUM_THREADS&#39;: &#39;c&#39;,</span>
<span class="sd">     u&#39;abcd&#39;: &#39;d&#39;,</span>
<span class="sd">     u&#39;head1&#39;: &#39;a&#39;,</span>
<span class="sd">     u&#39;head3&#39;: &#39;HEAD_3&#39;,</span>
<span class="sd">     u&#39;important2&#39;: &#39;b&#39;,</span>
<span class="sd">     u&#39;title&#39;: u&#39;important2=b,OMP_NUM_THREADS=c&#39;},</span>
<span class="sd"> 5: {u&#39;!OMP_NUM_THREADS&#39;: &#39;c&#39;,</span>
<span class="sd">     u&#39;abcd&#39;: &#39;g&#39;,</span>
<span class="sd">     u&#39;head1&#39;: &#39;1&#39;,</span>
<span class="sd">     u&#39;head3&#39;: &#39;HEAD_3&#39;,</span>
<span class="sd">     u&#39;important2&#39;: &#39;b&#39;,</span>
<span class="sd">     u&#39;title&#39;: u&#39;important2=b,OMP_NUM_THREADS=c__line=5__&#39;}}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">file</span><span class="p">,</span><span class="n">firstLine</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="s2">&quot;Setup the reader class, read data into memory. *firstLine* determines the number of the first line; if negative, 1 is used for XLS files and 0 for text files. The reason is that spreadsheets number lines from 1 whereas text editors number lines from zero, and having the numbering the same as the usual UI for editing that format is convenient.&quot;</span>
        <span class="kn">import</span> <span class="nn">re</span>
        
        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xls&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">firstLine</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">firstLine</span><span class="o">=</span><span class="mi">1</span>
                <span class="kn">import</span> <span class="nn">xlrd</span>
                <span class="n">xls</span><span class="o">=</span><span class="n">xlrd</span><span class="o">.</span><span class="n">open_workbook</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="n">sheet</span><span class="o">=</span><span class="n">xls</span><span class="o">.</span><span class="n">sheet_by_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">maxCol</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">rows</span><span class="o">=</span><span class="p">[]</span> <span class="c1"># rows actually containing data (filled in the loop)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">nrows</span><span class="p">):</span>
                    <span class="c1"># find first non-empty and non-comment cell</span>
                    <span class="n">lastDataCol</span><span class="o">=-</span><span class="mi">1</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">ncols</span><span class="p">):</span>
                        <span class="n">c</span><span class="o">=</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">)</span>
                        <span class="n">empty</span><span class="o">=</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">ctype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">xlrd</span><span class="o">.</span><span class="n">XL_CELL_EMPTY</span><span class="p">,</span><span class="n">xlrd</span><span class="o">.</span><span class="n">XL_CELL_BLANK</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">ctype</span><span class="o">==</span><span class="n">xlrd</span><span class="o">.</span><span class="n">XL_CELL_TEXT</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
                        <span class="n">comment</span><span class="o">=</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">ctype</span><span class="o">==</span><span class="n">xlrd</span><span class="o">.</span><span class="n">XL_CELL_TEXT</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*(#.*)?$&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">))</span> 
                        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span> <span class="k">break</span> <span class="c1"># comment cancels all remaining cells on the line</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">empty</span><span class="p">:</span> <span class="n">lastDataCol</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="n">lastDataCol</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">lastDataCol</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                        <span class="n">maxCol</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">maxCol</span><span class="p">,</span><span class="n">lastDataCol</span><span class="p">)</span>
                        <span class="c1"># if lastDataCol&lt;maxCol: raise RuntimeError(&#39;Error in %s: all data rows should have the same number of colums; row %d has only %d columns, should have %d.&#39;%(file,row,lastDataCol+1,maxCol+1))</span>
                <span class="c1"># rows and cols with data</span>
                <span class="n">cols</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">maxCol</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="c1"># print &#39;maxCol=%d,cols=%s&#39;%(maxCol,cols)</span>
                <span class="c1"># iterate through cells, define rawHeadings, headings, values</span>
                <span class="n">headings</span><span class="o">=</span><span class="p">[</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
                <span class="c1">#headings=[(h[:-1] if (h and h[-1]==&#39;!&#39;) else h) for h in rawHeadings] # without trailing bangs</span>
                <span class="n">values</span><span class="o">=</span><span class="p">{}</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">vv</span><span class="o">=</span><span class="p">{}</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                        <span class="n">v</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                        <span class="c1"># if not isinstance(v,str): v=str(v)</span>
                        <span class="c1"># represent numbers with zero fractional part as ints, without trailing &quot;.0&quot; or such</span>
                        <span class="c1"># XLS does not know ints</span>
                        <span class="c1"># http://stackoverflow.com/questions/8825681/integers-from-excel-files-become-floats</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">f</span><span class="o">==</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">):</span> <span class="n">v</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="k">pass</span>
                        <span class="n">vv</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">=</span><span class="n">v</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="n">firstLine</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">vv</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">firstLine</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">firstLine</span><span class="o">=</span><span class="mi">0</span>
                <span class="c1"># text file, space separated</span>
                <span class="c1"># read file in memory, remove newlines and comments; the [&#39;&#39;] makes lines 1-indexed</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">ll</span><span class="o">=</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s*#.*&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">l</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
                <span class="c1"># usable lines are those that contain something else than just spaces</span>
                <span class="n">usableLines</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*(#.*)?$&#39;</span><span class="p">,</span><span class="n">ll</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
                <span class="n">headings</span><span class="o">=</span><span class="n">ll</span><span class="p">[</span><span class="n">usableLines</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="c1"># headings=[(h[:-1] if h[-1]==&#39;!&#39; else h) for h in rawHeadings] # copy of headings without trailing bangs (if any)</span>
                <span class="c1"># use all values of which heading has ! after its name to build up the title string</span>
                <span class="c1"># if there are none, use all columns</span>
                <span class="n">usableLines</span><span class="o">=</span><span class="n">usableLines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># and remove headindgs from usableLines</span>
                <span class="n">values</span><span class="o">=</span><span class="p">{}</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">usableLines</span><span class="p">:</span>
                    <span class="n">lSplit</span><span class="o">=</span><span class="n">ll</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">l</span><span class="o">+</span><span class="n">firstLine</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">lSplit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">headings</span><span class="p">))]</span>
            <span class="c1">#</span>
            <span class="c1"># each format has to define the following:</span>
            <span class="c1">#   values={lineNumber:[val,val,...],...}         # values ordered the same as headings</span>
            <span class="c1">#   headings=[&#39;col1title!&#39;,&#39;col2title&#39;,...]       # as in the file</span>
            <span class="c1">#</span>

            <span class="c1"># replace empty cells or &#39;=&#39; by the previous value of the parameter</span>
            <span class="n">lines</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">());</span> <span class="n">lines</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="c1"># print file,lines</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">l</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">values</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">col</span><span class="p">]</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]][</span><span class="n">col</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The = specifier on line </span><span class="si">%d</span><span class="s2">, column </span><span class="si">%d</span><span class="s2">, refers to nonexistent value on previous line?&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">col</span><span class="p">))</span>
    
            <span class="n">nCollapsed</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">ih</span><span class="p">,</span><span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">headings</span><span class="p">):</span> <span class="c1"># index of headings (headings are pruned after the loop)</span>
                <span class="n">iv</span><span class="o">=</span><span class="n">ih</span><span class="o">-</span><span class="n">nCollapsed</span> <span class="c1"># index of values: changes as values are being removed </span>
                <span class="k">if</span> <span class="n">h</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">,</span><span class="sa">u</span><span class="s1">&#39;...&#39;</span><span class="p">,</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="n">nCollapsed</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">ih</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The ... header continuation is not allowed in the first column.&quot;</span><span class="p">)</span>
                    <span class="c1"># merge adjacent cols contents</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                        <span class="n">vv</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                        <span class="n">collapsed</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="n">iv</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="n">iv</span><span class="p">])</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">=</span><span class="n">vv</span><span class="p">[:</span><span class="n">iv</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">collapsed</span><span class="p">]</span><span class="o">+</span><span class="n">vv</span><span class="p">[</span><span class="n">iv</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">headings</span><span class="o">=</span><span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headings</span> <span class="k">if</span> <span class="n">h</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">,</span><span class="sa">u</span><span class="s1">&#39;...&#39;</span><span class="p">,</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">)]</span>

            <span class="c1"># prune headings with trailing bangs</span>
            <span class="n">rawHeadings</span><span class="o">=</span><span class="n">headings</span>
            <span class="n">headings</span><span class="o">=</span><span class="p">[(</span><span class="n">h</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">h</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;!&#39;</span> <span class="k">else</span> <span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headings</span><span class="p">]</span>

            <span class="c1"># copy to dictionary; that is the way results are supposed to be returned</span>
            <span class="n">dvalues</span><span class="o">=</span><span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>

                <span class="n">dvalues</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">=</span><span class="nb">dict</span><span class="p">([(</span><span class="n">headings</span><span class="p">[</span><span class="n">c</span><span class="p">],</span><span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">c</span><span class="p">]))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">headings</span><span class="p">))])</span>

            <span class="c1"># add descriptions, but if they repeat, append line number as well</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">headings</span><span class="p">:</span>
                <span class="c1"># bangHeads=[h[:-1] for h in rawHeadings if (h and h[-1]==&#39;!&#39;)] or headings</span>
                <span class="n">hasBangs</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">rawHeadings</span> <span class="k">if</span> <span class="n">h</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;!&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span>
                <span class="n">descs</span><span class="o">=</span><span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="n">ddd</span><span class="o">=</span><span class="p">[]</span>
                    <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">head</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rawHeadings</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">hasBangs</span> <span class="ow">and</span> <span class="n">head</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;!&#39;</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">val</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">):</span> <span class="k">continue</span> <span class="c1"># default value used</span>
                        <span class="n">ddd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;=&#39;</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">val</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
                    <span class="n">dd</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ddd</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="c1">#dd=&#39;,&#39;.join(head.replace(&#39;!&#39;,&#39;&#39;)+&#39;=&#39;+(&#39;%g&#39;%values[head] if isinstance(values[l][head],float) else str(values[l][head])) for head in bangHeads if (values[l][head].strip()!=&#39;-&#39;).replace(&quot;&#39;&quot;,&#39;&#39;).replace(&#39;&quot;&#39;,&#39;&#39;)</span>
                    <span class="k">if</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">descs</span><span class="p">:</span> <span class="n">dd</span><span class="o">+=</span><span class="s1">&#39;__line=</span><span class="si">%d</span><span class="s1">__&#39;</span><span class="o">%</span><span class="n">l</span>
                    <span class="n">dvalues</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="sa">u</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*woo.unit&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">descs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">=</span><span class="n">dvalues</span>

<div class="viewcode-block" id="TableParamReader.paramDict"><a class="viewcode-back" href="../../woo.batch.html#woo.batch.TableParamReader.paramDict">[docs]</a>    <span class="k">def</span> <span class="nf">paramDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return dictionary containing data from file given to constructor. Keys are line numbers (which might be non-contiguous and refer to real line numbers that one can see in text editors), values are dictionaries mapping parameter names to their values given in the file. The special value &#39;=&#39; has already been interpreted, ``!`` (bangs) (if any) were already removed from column titles, ``title`` column has already been added (if absent).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div></div>


<div class="viewcode-block" id="cartProdParamTable"><a class="viewcode-back" href="../../woo.batch.html#woo.batch.cartProdParamTable">[docs]</a><span class="k">def</span> <span class="nf">cartProdParamTable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">out</span><span class="p">,</span><span class="n">same</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Write parameter table (as XLS) where all parameters in pp (which is a dictionary, or :obj:`python:collections.OrderedDict`) are traversed.</span>
<span class="sd">    </span>
<span class="sd">:param same: content of repeated cellls; if ``None``, repeated cells are filled with the repeated value. Other useful values are ``&#39;=&#39;`` and ``&#39;&#39;`` (empty cell)</span>
<span class="sd">:param out: XLS file to write to</span>
<span class="sd">:param params: dictionary-like with parameter values; keys may be n-tuples, which will span multiple columns -- in that case, values must also be n-tuples, and will also span those columns</span>
<span class="sd">:return: total number of lines written</span>

<span class="sd">&gt;&gt;&gt; import collections, woo.batch </span>
<span class="sd">&gt;&gt;&gt; pp=collections.OrderedDict() # use OrderedDict for predictable column ordering</span>
<span class="sd">&gt;&gt;&gt; pp[&#39;pattern&#39;]=[&#39;ortho&#39;,&#39;hexa&#39;]</span>
<span class="sd">&gt;&gt;&gt; pp[&#39;radius&#39;,&#39;...&#39;]=[(r,&#39;*woo.unit[&quot;mm&quot;]&#39;) for r in (1,2,3)]    # use continuation columns for unit specification</span>
<span class="sd">&gt;&gt;&gt; pp[&#39;gravity&#39;,&#39;...&#39;,&#39;...&#39;]=[(&#39;(0,0,&#39;,g,&#39;)&#39;) for g in (9.81,20)] # use continuation columns for concatenation of expression</span>
<span class="sd">&gt;&gt;&gt; xls=woo.master.tmpFilename()+&#39;.xls&#39;</span>
<span class="sd">&gt;&gt;&gt; woo.batch.cartProdParamTable(params=pp,out=xls)</span>
<span class="sd">12</span>
<span class="sd">&gt;&gt;&gt; import pprint</span>
<span class="sd">&gt;&gt;&gt; pprint.pprint(TableParamReader(xls).paramDict())</span>
<span class="sd">{2: {u&#39;gravity&#39;: &#39;(0,0,9.81)&#39;,</span>
<span class="sd">     u&#39;pattern&#39;: &#39;ortho&#39;,</span>
<span class="sd">     u&#39;radius&#39;: &#39;1*woo.unit[&quot;mm&quot;]&#39;,</span>
<span class="sd">     u&#39;title&#39;: u&#39;pattern=ortho,radius=1mm,gravity=(0,0,9.81)&#39;},</span>
<span class="sd"> 3: {u&#39;gravity&#39;: &#39;(0,0,20)&#39;,</span>
<span class="sd">     u&#39;pattern&#39;: &#39;ortho&#39;,</span>
<span class="sd">     u&#39;radius&#39;: &#39;1*woo.unit[&quot;mm&quot;]&#39;,</span>
<span class="sd">     u&#39;title&#39;: u&#39;pattern=ortho,radius=1mm,gravity=(0,0,20)&#39;},</span>
<span class="sd"> 4: {u&#39;gravity&#39;: &#39;(0,0,9.81)&#39;,</span>
<span class="sd">     u&#39;pattern&#39;: &#39;ortho&#39;,</span>
<span class="sd">     u&#39;radius&#39;: &#39;2*woo.unit[&quot;mm&quot;]&#39;,</span>
<span class="sd">     u&#39;title&#39;: u&#39;pattern=ortho,radius=2mm,gravity=(0,0,9.81)&#39;},</span>
<span class="sd"> 5: {u&#39;gravity&#39;: &#39;(0,0,20)&#39;,</span>
<span class="sd">     u&#39;pattern&#39;: &#39;ortho&#39;,</span>
<span class="sd">     u&#39;radius&#39;: &#39;2*woo.unit[&quot;mm&quot;]&#39;,</span>
<span class="sd">     u&#39;title&#39;: u&#39;pattern=ortho,radius=2mm,gravity=(0,0,20)&#39;},</span>
<span class="sd"> 6: {u&#39;gravity&#39;: &#39;(0,0,9.81)&#39;,</span>
<span class="sd">     u&#39;pattern&#39;: &#39;ortho&#39;,</span>
<span class="sd">     u&#39;radius&#39;: &#39;3*woo.unit[&quot;mm&quot;]&#39;,</span>
<span class="sd">     u&#39;title&#39;: u&#39;pattern=ortho,radius=3mm,gravity=(0,0,9.81)&#39;},</span>
<span class="sd"> 7: {u&#39;gravity&#39;: &#39;(0,0,20)&#39;,</span>
<span class="sd">     u&#39;pattern&#39;: &#39;ortho&#39;,</span>
<span class="sd">     u&#39;radius&#39;: &#39;3*woo.unit[&quot;mm&quot;]&#39;,</span>
<span class="sd">     u&#39;title&#39;: u&#39;pattern=ortho,radius=3mm,gravity=(0,0,20)&#39;},</span>
<span class="sd"> 8: {u&#39;gravity&#39;: &#39;(0,0,9.81)&#39;,</span>
<span class="sd">     u&#39;pattern&#39;: &#39;hexa&#39;,</span>
<span class="sd">     u&#39;radius&#39;: &#39;1*woo.unit[&quot;mm&quot;]&#39;,</span>
<span class="sd">     u&#39;title&#39;: u&#39;pattern=hexa,radius=1mm,gravity=(0,0,9.81)&#39;},</span>
<span class="sd"> 9: {u&#39;gravity&#39;: &#39;(0,0,20)&#39;,</span>
<span class="sd">     u&#39;pattern&#39;: &#39;hexa&#39;,</span>
<span class="sd">     u&#39;radius&#39;: &#39;1*woo.unit[&quot;mm&quot;]&#39;,</span>
<span class="sd">     u&#39;title&#39;: u&#39;pattern=hexa,radius=1mm,gravity=(0,0,20)&#39;},</span>
<span class="sd"> 10: {u&#39;gravity&#39;: &#39;(0,0,9.81)&#39;,</span>
<span class="sd">      u&#39;pattern&#39;: &#39;hexa&#39;,</span>
<span class="sd">      u&#39;radius&#39;: &#39;2*woo.unit[&quot;mm&quot;]&#39;,</span>
<span class="sd">      u&#39;title&#39;: u&#39;pattern=hexa,radius=2mm,gravity=(0,0,9.81)&#39;},</span>
<span class="sd"> 11: {u&#39;gravity&#39;: &#39;(0,0,20)&#39;,</span>
<span class="sd">      u&#39;pattern&#39;: &#39;hexa&#39;,</span>
<span class="sd">      u&#39;radius&#39;: &#39;2*woo.unit[&quot;mm&quot;]&#39;,</span>
<span class="sd">      u&#39;title&#39;: u&#39;pattern=hexa,radius=2mm,gravity=(0,0,20)&#39;},</span>
<span class="sd"> 12: {u&#39;gravity&#39;: &#39;(0,0,9.81)&#39;,</span>
<span class="sd">      u&#39;pattern&#39;: &#39;hexa&#39;,</span>
<span class="sd">      u&#39;radius&#39;: &#39;3*woo.unit[&quot;mm&quot;]&#39;,</span>
<span class="sd">      u&#39;title&#39;: u&#39;pattern=hexa,radius=3mm,gravity=(0,0,9.81)&#39;},</span>
<span class="sd"> 13: {u&#39;gravity&#39;: &#39;(0,0,20)&#39;,</span>
<span class="sd">      u&#39;pattern&#39;: &#39;hexa&#39;,</span>
<span class="sd">      u&#39;radius&#39;: &#39;3*woo.unit[&quot;mm&quot;]&#39;,</span>
<span class="sd">      u&#39;title&#39;: u&#39;pattern=hexa,radius=3mm,gravity=(0,0,20)&#39;}}</span>


<span class="sd">.. csv-table:: Generated cartesian product parameter table (XLS)</span>
<span class="sd">   :header: pattern,radius,...,gravity,...,...</span>

<span class="sd">   ortho,1,&quot;*woo.unit[&quot;&quot;mm&quot;&quot;]&quot;,&quot;(0,0,&quot;,9.81,)</span>
<span class="sd">   ,,,,20,</span>
<span class="sd">   ,2,,,9.81,</span>
<span class="sd">   ,,,,20,</span>
<span class="sd">   ,3,,,9.81,</span>
<span class="sd">   ,,,,20,</span>
<span class="sd">   hexa,1,,,9.81,</span>
<span class="sd">   ,,,,20,</span>
<span class="sd">   ,2,,,9.81,</span>
<span class="sd">   ,,,,20,</span>
<span class="sd">   ,3,,,9.81,</span>
<span class="sd">   ,,,,20,</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">xlwt</span><span class="o">,</span><span class="nn">itertools</span>
    <span class="n">xls</span><span class="o">=</span><span class="n">xlwt</span><span class="o">.</span><span class="n">Workbook</span><span class="p">();</span> <span class="n">sheet</span><span class="o">=</span><span class="n">xls</span><span class="o">.</span><span class="n">add_sheet</span><span class="p">(</span><span class="s1">&#39;product&#39;</span><span class="p">)</span>
    <span class="n">kk</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">col</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">bold</span><span class="o">=</span><span class="n">xlwt</span><span class="o">.</span><span class="n">easyxf</span><span class="p">(</span><span class="s1">&#39;font: bold on&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">tuple</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">sheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">bold</span><span class="p">)</span>
                <span class="n">col</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">bold</span><span class="p">)</span>
            <span class="n">col</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">prevVV</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">for</span> <span class="n">row</span><span class="p">,</span><span class="n">vv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
        <span class="c1">#print row+1,vv</span>
        <span class="n">col</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vv</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="nb">tuple</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="c1"># print w</span>
                    <span class="c1">#print row+1,col,w</span>
                    <span class="k">if</span> <span class="n">same</span><span class="o">==</span><span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">prevVV</span> <span class="ow">or</span> <span class="n">prevVV</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">!=</span><span class="n">w</span><span class="p">:</span> <span class="n">sheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">same</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">sheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">same</span><span class="p">)</span>
                    <span class="n">col</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#print row+1,col,v</span>
                <span class="k">if</span> <span class="n">same</span><span class="o">==</span><span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">prevVV</span> <span class="ow">or</span> <span class="n">prevVV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="n">v</span><span class="p">:</span> <span class="n">sheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">same</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">sheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">same</span><span class="p">)</span>
                <span class="n">col</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">prevVV</span><span class="o">=</span><span class="n">vv</span>
    <span class="n">xls</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">row</span><span class="o">+</span><span class="mi">1</span></div>



<span class="n">TableParamReader</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">=</span><span class="n">TableParamReader</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;u&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
<span class="n">cartProdParamTable</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">=</span><span class="n">cartProdParamTable</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;u&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1">## this is now in the doctest as well</span>
    <span class="n">tryData</span><span class="o">=</span><span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;head1&#39;</span><span class="p">,</span><span class="s1">&#39;important2!&#39;</span><span class="p">,</span><span class="s1">&#39;!OMP_NUM_THREADS!&#39;</span><span class="p">,</span><span class="s1">&#39;abcd&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.1</span><span class="p">,</span><span class="mf">1.2</span><span class="p">,</span><span class="mf">1.3</span><span class="p">,],</span>
        <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;###&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;# empty line&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">tryFile</span><span class="o">=</span><span class="s1">&#39;/tmp/try-tbl&#39;</span>

    <span class="c1"># write text</span>
    <span class="n">f1</span><span class="o">=</span><span class="n">tryFile</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span>
    <span class="n">txt</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">tryData</span><span class="p">:</span> <span class="n">txt</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">txt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># write xls</span>
    <span class="kn">import</span> <span class="nn">xlwt</span><span class="o">,</span><span class="nn">itertools</span>
    <span class="n">f2</span><span class="o">=</span><span class="n">tryFile</span><span class="o">+</span><span class="s1">&#39;.xls&#39;</span>
    <span class="n">xls</span><span class="o">=</span><span class="n">xlwt</span><span class="o">.</span><span class="n">Workbook</span><span class="p">();</span> <span class="n">sheet</span><span class="o">=</span><span class="n">xls</span><span class="o">.</span><span class="n">add_sheet</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tryData</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tryData</span><span class="p">[</span><span class="n">r</span><span class="p">])):</span>
            <span class="n">sheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">tryData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">])</span>
    <span class="n">xls</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">pprint</span><span class="p">(</span><span class="n">TableParamReader</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span><span class="o">.</span><span class="n">paramDict</span><span class="p">())</span>
    <span class="n">pprint</span><span class="p">(</span><span class="n">TableParamReader</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span><span class="o">.</span><span class="n">paramDict</span><span class="p">())</span>



</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">Woo 1.0+rev1-git-aac4f82 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">woo.batch</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 20122022, Vclav milauer &lt;eu@doxos.eu&gt;.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>