


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>woo.pack &#8212; Woo 1.0+rev1-git-681f22d documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/cloud.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>

    
    
     
        <script src="../../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../../_static/cloud.base.js"></script>
    

    
     
        <script src="../../_static/cloud.js"></script>
    

    <link rel="shortcut icon" href="../../_static/woo-favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">Woo 1.0+rev1-git-681f22d documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">woo.pack</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for woo.pack</h1><div class="highlight"><pre>
<span></span><span class="c1"># encoding: utf-8</span>
<span class="c1"># 2009 © Václav Šmilauer &lt;eudoxos@arcig.cz&gt;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Creating packings and filling volumes defined by boundary representation or constructive solid geometry.</span>


<span class="sd">.. warning:: Broken links ahead:</span>

<span class="sd">For examples, see</span>

<span class="sd">* :woosrc:`scripts/test/gts-operators.py`</span>
<span class="sd">* :woosrc:`scripts/test/gts-random-pack-obb.py`</span>
<span class="sd">* :woosrc:`scripts/test/gts-random-pack.py`</span>
<span class="sd">* :woosrc:`scripts/test/pack-cloud.py`</span>
<span class="sd">* :woosrc:`scripts/test/pack-predicates.py`</span>
<span class="sd">* :woosrc:`examples/packs/packs.py`</span>
<span class="sd">* :woosrc:`examples/gts-horse/gts-horse.py`</span>
<span class="sd">* :woosrc:`examples/WireMatPM/wirepackings.py`</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">itertools</span><span class="o">,</span><span class="nn">warnings</span><span class="o">,</span><span class="nn">os</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">arange</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">sqrt</span>
<span class="kn">from</span> <span class="nn">woo</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">from</span> <span class="nn">minieigen</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">woo</span>
<span class="kn">import</span> <span class="nn">woo.dem</span>
<span class="kn">import</span> <span class="nn">woo.utils</span>
<span class="kn">import</span> <span class="nn">woo.log</span>

<span class="n">log</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">makeLog</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="ShapePack_fromSimulation"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.ShapePack_fromSimulation">[docs]</a><span class="k">def</span> <span class="nf">ShapePack_fromSimulation</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">S</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">warnings</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;ShapePack.fromSimulation is deprecated, use ShapePack.fromDem instead&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">fromDem</span><span class="p">(</span><span class="n">scene</span><span class="o">=</span><span class="n">S</span><span class="p">,</span><span class="n">dem</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">skipUnsupported</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
<span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">ShapePack</span><span class="o">.</span><span class="n">fromSimulation</span><span class="o">=</span><span class="n">ShapePack_fromSimulation</span>

<div class="viewcode-block" id="ParticleGenerator_makeCloud"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.ParticleGenerator_makeCloud">[docs]</a><span class="k">def</span> <span class="nf">ParticleGenerator_makeCloud</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">dem</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">DemField</span><span class="o">.</span><span class="n">defaultMovableMask</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)):</span>
    <span class="c1">#S=woo.core.Scene(fields=[DemField()])</span>
    <span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">BoxInlet</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">,</span><span class="n">materials</span><span class="o">=</span><span class="p">[</span><span class="n">mat</span><span class="p">],</span><span class="n">generator</span><span class="o">=</span><span class="n">gen</span><span class="p">,</span><span class="n">massRate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span><span class="n">collideExisting</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="n">S</span><span class="p">,</span><span class="n">dem</span><span class="p">)</span></div>
<span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">ParticleGenerator</span><span class="o">.</span><span class="n">makeCloud</span><span class="o">=</span><span class="n">ParticleGenerator_makeCloud</span>

    


<span class="c1">## compatibility hack for python 2.5 (21/8/2009)</span>
<span class="c1">## can be safely removed at some point</span>
<span class="k">if</span> <span class="s1">&#39;product&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">itertools</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">product</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="s2">&quot;http://docs.python.org/library/itertools.html#itertools.product&quot;</span>
        <span class="n">pools</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span> <span class="o">*</span> <span class="n">kwds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;repeat&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[[]]</span>
        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">pools</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">pool</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span> <span class="k">yield</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">prod</span><span class="p">)</span>
    <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="o">=</span><span class="n">product</span>

<span class="c1"># for now skip the import, but try in inGtsSurface constructor again, to give error if we really use it</span>
<span class="k">try</span><span class="p">:</span> <span class="kn">import</span> <span class="nn">gts</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="k">pass</span>

<span class="c1"># make c++ predicates available in this module</span>
<span class="kn">from</span> <span class="nn">woo._packPredicates</span> <span class="k">import</span> <span class="o">*</span> <span class="c1">## imported in randomDensePack as well</span>
<span class="c1"># import SpherePack</span>
<span class="kn">from</span> <span class="nn">woo._packSpheres</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">woo._packObb</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">woo</span>
<span class="n">_docInlineModules</span><span class="o">=</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">_packPredicates</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">_packSpheres</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">_packObb</span><span class="p">)</span>

<span class="c1">##</span>
<span class="c1"># extend _packSphere.SpherePack c++ class by these methods</span>
<span class="c1">##</span>
<div class="viewcode-block" id="SpherePack_fromSimulation"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.SpherePack_fromSimulation">[docs]</a><span class="k">def</span> <span class="nf">SpherePack_fromSimulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scene</span><span class="p">,</span><span class="n">dem</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reset this SpherePack object and initialize it from the current simulation; only spherical particles are taken in account. Periodic boundary conditions are supported, but the hSize matrix must be diagonal. Clumps are supported.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="kn">import</span> <span class="nn">woo.dem</span>
    <span class="n">de</span><span class="o">=</span><span class="n">scene</span><span class="o">.</span><span class="n">dem</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">dem</span> <span class="k">else</span> <span class="n">dem</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">de</span><span class="o">.</span><span class="n">par</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="vm">__class__</span><span class="o">!=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Sphere</span><span class="p">:</span> <span class="k">continue</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">clumped</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># those will be added as clumps in the next block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
    <span class="c1"># handle clumps here</span>
    <span class="n">clumpId</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">de</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">clump</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">someOk</span><span class="o">=</span><span class="kc">False</span> <span class="c1"># prevent adding only a part of the clump to the packing</span>
        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span> <span class="c1"># get particles belonging to clumped nodes</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">nn</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">parRef</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="vm">__class__</span><span class="o">!=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Sphere</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">someOk</span><span class="p">:</span> <span class="k">raise</span> <span class="n">RuntimError</span><span class="p">(</span><span class="s2">&quot;A clump with mixed sphere/non-sphere shapes was encountered, which is not supported by SpherePack.fromSimulation&quot;</span><span class="p">);</span>
                    <span class="k">continue</span>
                <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">clumped</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span><span class="n">clumpId</span><span class="o">=</span><span class="n">clumpId</span><span class="p">),</span>
                <span class="n">someOk</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">clumpId</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">scene</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
        <span class="n">h</span><span class="o">=</span><span class="n">scene</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">hSize</span>
        <span class="k">if</span> <span class="n">h</span><span class="o">-</span><span class="n">h</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">!=</span><span class="n">Matrix3</span><span class="o">.</span><span class="n">Zero</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Only box-shaped (no shear) periodic boundary conditions can be represented with a pack.SpherePack object&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellSize</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span></div>

<div class="viewcode-block" id="SpherePack_fromDem"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.SpherePack_fromDem">[docs]</a><span class="k">def</span> <span class="nf">SpherePack_fromDem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scene</span><span class="p">,</span><span class="n">dem</span><span class="p">):</span> <span class="k">return</span> <span class="n">SpherePack_fromSimulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scene</span><span class="p">,</span><span class="n">dem</span><span class="p">)</span></div>

<span class="n">SpherePack</span><span class="o">.</span><span class="n">fromDem</span><span class="o">=</span><span class="n">SpherePack_fromDem</span>
<span class="n">SpherePack</span><span class="o">.</span><span class="n">fromSimulation</span><span class="o">=</span><span class="n">SpherePack_fromSimulation</span>

<div class="viewcode-block" id="SpherePack_toDem"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.SpherePack_toDem">[docs]</a><span class="k">def</span> <span class="nf">SpherePack_toDem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scene</span><span class="p">,</span><span class="n">dem</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rot</span><span class="o">=</span><span class="n">Matrix3</span><span class="o">.</span><span class="n">Identity</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sa">u</span><span class="sd">&quot;&quot;&quot;Append spheres directly to the simulation. In addition calling :obj:`woo.dem.ParticleContainer.add`,</span>
<span class="sd">this method also appropriately sets periodic cell information of the simulation.</span>

<span class="sd">    &gt;&gt;&gt; from woo import pack; from math import *; from woo.dem import *; from woo.core import *</span>
<span class="sd">    &gt;&gt;&gt; sp=pack.SpherePack()</span>

<span class="sd">Create random periodic packing with 20 spheres:</span>

<span class="sd">    &gt;&gt;&gt; sp.makeCloud((0,0,0),(5,5,5),rMean=.5,rRelFuzz=.5,periodic=True,num=20)</span>
<span class="sd">    20</span>

<span class="sd">Virgin simulation is aperiodic:</span>

<span class="sd">    &gt;&gt;&gt; scene=Scene(fields=[DemField()])</span>
<span class="sd">    &gt;&gt;&gt; scene.periodic</span>
<span class="sd">    False</span>

<span class="sd">Add generated packing to the simulation, rotated by 45° along +z</span>

<span class="sd">    &gt;&gt;&gt; sp.toDem(scene,scene.dem,rot=Quaternion((0,0,1),pi/4),color=0)</span>
<span class="sd">    [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]</span>

<span class="sd">Periodic properties are transferred to the simulation correctly, including rotation:</span>

<span class="sd">    &gt;&gt;&gt; scene.periodic</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; scene.cell.size</span>
<span class="sd">    Vector3(5,5,5)</span>
<span class="sd">    &gt;&gt;&gt; scene.cell.hSize</span>
<span class="sd">    Matrix3(3.5355339059327373,-3.5355339059327378,0, 3.5355339059327378,3.5355339059327373,0, 0,0,5)</span>

<span class="sd">The current state (even if rotated) is taken as mechanically undeformed, i.e. with identity transformation:</span>

<span class="sd">    &gt;&gt;&gt; scene.cell.trsf</span>
<span class="sd">    Matrix3(1,0,0, 0,1,0, 0,0,1)</span>

<span class="sd">:param Quaternion/Matrix3 rot: rotation of the packing, which will be applied on spheres and will be used to set :obj:`woo.core.Cell.trsf` as well.</span>
<span class="sd">:param kw: passed to :obj:`woo.utils.sphere`</span>
<span class="sd">:return: list of body ids added (like :obj:`woo.dem.ParticleContainer.add`)</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dem</span><span class="p">:</span> <span class="n">dem</span><span class="o">=</span><span class="n">scene</span><span class="o">.</span><span class="n">dem</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rot</span><span class="p">,</span><span class="n">Quaternion</span><span class="p">):</span> <span class="n">rot</span><span class="o">=</span><span class="n">rot</span><span class="o">.</span><span class="n">toRotationMatrix</span><span class="p">()</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rot</span><span class="p">,</span><span class="n">Matrix3</span><span class="p">))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellSize</span><span class="o">!=</span><span class="n">Vector3</span><span class="o">.</span><span class="n">Zero</span><span class="p">:</span>
        <span class="n">scene</span><span class="o">.</span><span class="n">periodic</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">scene</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">hSize</span><span class="o">=</span><span class="n">rot</span><span class="o">*</span><span class="n">Matrix3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">scene</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">trsf</span><span class="o">=</span><span class="n">Matrix3</span><span class="o">.</span><span class="n">Identity</span>

    <span class="kn">from</span> <span class="nn">woo.dem</span> <span class="k">import</span> <span class="n">DemField</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasClumps</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;mat&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;mat&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">defaultMaterial</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Sphere</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">rot</span><span class="o">*</span><span class="n">c</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">standalone</span><span class="p">,</span><span class="n">clumps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getClumps</span><span class="p">()</span>
        <span class="c1"># add standalone</span>
        <span class="n">ids</span><span class="o">=</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Sphere</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">rot</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">standalone</span><span class="p">])</span>
        <span class="c1"># add clumps</span>
        <span class="n">clumpIds</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">clump</span> <span class="ow">in</span> <span class="n">clumps</span><span class="p">:</span>
            <span class="n">clumpNode</span><span class="o">=</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">addClumped</span><span class="p">([</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">(</span><span class="n">rot</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clump</span><span class="p">])</span>
            <span class="c1"># make all particles within one clump same color (as the first particle),</span>
            <span class="c1"># unless color was already user-specified</span>
            <span class="n">clumpIds</span><span class="o">=</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">parRef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">clumpNode</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;color&#39;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
                <span class="n">c0</span><span class="o">=</span><span class="n">clumpNode</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">parRef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">color</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">clumpNode</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">parRef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">color</span><span class="o">=</span><span class="n">c0</span>
        <span class="k">return</span> <span class="n">ids</span><span class="o">+</span><span class="n">clumpIds</span></div>
<span class="n">SpherePack</span><span class="o">.</span><span class="n">toDem</span><span class="o">=</span><span class="n">SpherePack_toDem</span>

<div class="viewcode-block" id="SpherePack_toSimulation"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.SpherePack_toSimulation">[docs]</a><span class="k">def</span> <span class="nf">SpherePack_toSimulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scene</span><span class="p">,</span><span class="n">rot</span><span class="o">=</span><span class="n">Matrix3</span><span class="o">.</span><span class="n">Identity</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="s1">&#39;Proxy for old arguments, which merely calls :obj:`SpherePack.toDem`.&#39;</span>
    <span class="k">return</span> <span class="n">SpherePack_toDem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scene</span><span class="p">,</span><span class="n">scene</span><span class="o">.</span><span class="n">dem</span><span class="p">,</span><span class="n">rot</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>
<span class="n">SpherePack</span><span class="o">.</span><span class="n">toSimulation</span><span class="o">=</span><span class="n">SpherePack_toSimulation</span>


<div class="viewcode-block" id="inGtsSurface_py"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.inGtsSurface_py">[docs]</a><span class="k">class</span> <span class="nc">inGtsSurface_py</span><span class="p">(</span><span class="n">Predicate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class was re-implemented in c++, but should stay here to serve as reference for implementing</span>
<span class="sd">    Predicates in pure python code. C++ allows us to play dirty tricks in GTS which are not accessible</span>
<span class="sd">    through pygts itself; the performance penalty of pygts comes from fact that if constructs and destructs</span>
<span class="sd">    bb tree for the surface at every invocation of gts.Point().is_inside(). That is cached in the c++ code,</span>
<span class="sd">    provided that the surface is not manipulated with during lifetime of the object (user&#39;s responsibility).</span>

<span class="sd">    ---</span>
<span class="sd">    </span>
<span class="sd">    Predicate for GTS surfaces. Constructed using an already existing surfaces, which must be closed.</span>

<span class="sd">        import gts</span>
<span class="sd">        surf=gts.read(open(&#39;horse.gts&#39;))</span>
<span class="sd">        inGtsSurface(surf)</span>

<span class="sd">    .. note::</span>
<span class="sd">        Padding is optionally supported by testing 6 points along the axes in the pad distance. This</span>
<span class="sd">        must be enabled in the ctor by saying doSlowPad=True. If it is not enabled and pad is not zero,</span>
<span class="sd">        warning is issued.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">surf</span><span class="p">,</span><span class="n">noPad</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># call base class ctor; necessary for virtual methods to work as expected.</span>
        <span class="c1"># see comments in _packPredicates.cpp for struct PredicateWrap.</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">inGtsSurface_py</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">surf</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Surface for inGtsSurface predicate must be closed.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surf</span><span class="o">=</span><span class="n">surf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noPad</span><span class="o">=</span><span class="n">noPad</span>
        <span class="n">inf</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">=</span><span class="n">AlignedBox3</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">surf</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
            <span class="n">c</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">coords</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">Vector3</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="kn">import</span> <span class="nn">gts</span>
<div class="viewcode-block" id="inGtsSurface_py.aabb"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.inGtsSurface_py.aabb">[docs]</a>    <span class="k">def</span> <span class="nf">aabb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span></div>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">_pt</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="n">p</span><span class="o">=</span><span class="n">gts</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="o">*</span><span class="n">_pt</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noPad</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pad</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Padding disabled in ctor, using 0 instead.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">is_inside</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surf</span><span class="p">)</span>
        <span class="n">pp</span><span class="o">=</span><span class="p">[</span><span class="n">gts</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">_pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pad</span><span class="p">,</span><span class="n">_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">_pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="n">gts</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">_pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pad</span><span class="p">,</span><span class="n">_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">_pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="n">gts</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">_pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pad</span><span class="p">,</span><span class="n">_pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="n">gts</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">_pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">pad</span><span class="p">,</span><span class="n">_pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="n">gts</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">_pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">_pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">pad</span><span class="p">),</span><span class="n">gts</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">_pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">_pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">pad</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">is_inside</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surf</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_inside</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surf</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_inside</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surf</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">is_inside</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surf</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">is_inside</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surf</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">is_inside</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surf</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">is_inside</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surf</span><span class="p">)</span></div>

<span class="c1"># compiled without the local GTS module</span>
<span class="k">if</span> <span class="s1">&#39;inGtsSurface&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">():</span> <span class="n">inGtsSurface</span><span class="o">=</span><span class="n">inGtsSurface_py</span>

<div class="viewcode-block" id="inSpace"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.inSpace">[docs]</a><span class="k">class</span> <span class="nc">inSpace</span><span class="p">(</span><span class="n">Predicate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Predicate returning True for any points, with infinite bounding box.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_center</span><span class="o">=</span><span class="n">Vector3</span><span class="p">()</span><span class="o">.</span><span class="n">Zero</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center</span><span class="o">=</span><span class="n">_center</span>
<div class="viewcode-block" id="inSpace.aabb"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.inSpace.aabb">[docs]</a>    <span class="k">def</span> <span class="nf">aabb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inf</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">);</span> <span class="k">return</span> <span class="n">Vector3</span><span class="p">(</span><span class="o">-</span><span class="n">inf</span><span class="p">,</span><span class="o">-</span><span class="n">inf</span><span class="p">,</span><span class="o">-</span><span class="n">inf</span><span class="p">),</span><span class="n">Vector3</span><span class="p">(</span><span class="n">inf</span><span class="p">,</span><span class="n">inf</span><span class="p">,</span><span class="n">inf</span><span class="p">)</span></div>
<div class="viewcode-block" id="inSpace.center"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.inSpace.center">[docs]</a>    <span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center</span></div>
<div class="viewcode-block" id="inSpace.dim"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.inSpace.dim">[docs]</a>    <span class="k">def</span> <span class="nf">dim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inf</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">);</span> <span class="k">return</span> <span class="n">Vector3</span><span class="p">(</span><span class="n">inf</span><span class="p">,</span><span class="n">inf</span><span class="p">,</span><span class="n">inf</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pt</span><span class="p">,</span><span class="n">pad</span><span class="p">):</span> <span class="k">return</span> <span class="kc">True</span></div>

<span class="c1">#####</span>
<span class="c1">## surface construction and manipulation</span>
<span class="c1">#####</span>

<div class="viewcode-block" id="gtsSurface2Facets"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.gtsSurface2Facets">[docs]</a><span class="k">def</span> <span class="nf">gtsSurface2Facets</span><span class="p">(</span><span class="n">surf</span><span class="p">,</span><span class="n">shareNodes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">flex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct facets from given GTS surface. ``**kw`` is passed to :obj:`woo.dem.Facet.make` or :obj:`woo.fem.Mambrane.make`, depending on *flex*.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">gts</span>
    <span class="kn">from</span> <span class="nn">woo.core</span> <span class="k">import</span> <span class="n">Node</span>
    <span class="n">klass</span><span class="o">=</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Membrane</span> <span class="k">if</span> <span class="n">flex</span> <span class="k">else</span> <span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Facet</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">shareNodes</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">klass</span><span class="o">.</span><span class="n">make</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">coords</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">face</span><span class="o">.</span><span class="n">vertices</span><span class="p">()],</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">surf</span><span class="o">.</span><span class="n">faces</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nodesMap</span><span class="o">=</span><span class="nb">dict</span><span class="p">([(</span><span class="n">v</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">Node</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">coords</span><span class="p">()))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">surf</span><span class="o">.</span><span class="n">vertices</span><span class="p">()])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">klass</span><span class="o">.</span><span class="n">make</span><span class="p">([</span><span class="n">nodesMap</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">face</span><span class="o">.</span><span class="n">vertices</span><span class="p">()],</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">surf</span><span class="o">.</span><span class="n">faces</span><span class="p">()]</span></div>


<div class="viewcode-block" id="sweptPolylines2gtsSurface"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.sweptPolylines2gtsSurface">[docs]</a><span class="k">def</span> <span class="nf">sweptPolylines2gtsSurface</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">localCoords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">capStart</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">capEnd</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create swept suface (as GTS triangulation) given same-length sequences of points (as 3-tuples). If *localCoords* is given, it must be a :obj:`woo.core.Node` instance and will be used to convert local coordinates in *pts* to global coordinates.</span>

<span class="sd">If threshold is given (&gt;0), then</span>

<span class="sd">* degenerate faces (with edges shorter than threshold) will not be created</span>
<span class="sd">* gts.Surface().cleanup(threshold) will be called before returning, which merges vertices mutually closer than threshold. In case your pts are closed (last point concident with the first one) this will the surface strip of triangles. If you additionally have capStart==True and capEnd==True, the surface will be closed.</span>

<span class="sd">.. note:: capStart and capEnd make the most naive polygon triangulation (diagonals) and will perhaps fail for non-convex sections.</span>

<span class="sd">.. warning:: the algorithm connects points sequentially; if two polylines are mutually rotated or have inverse sense, the algorithm will not detect it and connect them regardless in their given order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">gts</span> <span class="c1"># will raise an exception in gts-less builds</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">pts1</span><span class="p">)</span> <span class="k">for</span> <span class="n">pts1</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">]))</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Polylines must be all of the same length!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">localCoords</span><span class="p">:</span> <span class="n">ptsGlob</span><span class="o">=</span><span class="p">[[</span><span class="n">localCoords</span><span class="o">.</span><span class="n">loc2glob</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pts1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pts1</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">ptsGlob</span><span class="o">=</span><span class="n">pts</span>
    <span class="n">vtxs</span><span class="o">=</span><span class="p">[[</span><span class="n">gts</span><span class="o">.</span><span class="n">Vertex</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="ow">in</span> <span class="n">pts1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pts1</span> <span class="ow">in</span> <span class="n">ptsGlob</span><span class="p">]</span>
    <span class="n">sectEdges</span><span class="o">=</span><span class="p">[[</span><span class="n">gts</span><span class="o">.</span><span class="n">Edge</span><span class="p">(</span><span class="n">vtx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">vtx</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">vtx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">vtx</span> <span class="ow">in</span> <span class="n">vtxs</span><span class="p">]</span>
    <span class="n">interSectEdges</span><span class="o">=</span><span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">vtxs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">vtxs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">vtxs</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
            <span class="n">interSectEdges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gts</span><span class="o">.</span><span class="n">Edge</span><span class="p">(</span><span class="n">vtxs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="n">vtxs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">vtxs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">interSectEdges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gts</span><span class="o">.</span><span class="n">Edge</span><span class="p">(</span><span class="n">vtxs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="n">vtxs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">threshold</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># replace edges of zero length with None; their faces will be skipped</span>
        <span class="k">def</span> <span class="nf">fixEdges</span><span class="p">(</span><span class="n">edges</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edges</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Vector3</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">-</span><span class="n">Vector3</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">z</span><span class="p">))</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">&lt;</span><span class="n">threshold</span><span class="p">:</span> <span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="n">sectEdges</span><span class="p">:</span> <span class="n">fixEdges</span><span class="p">(</span><span class="n">ee</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="n">interSectEdges</span><span class="p">:</span> <span class="n">fixEdges</span><span class="p">(</span><span class="n">ee</span><span class="p">)</span>
    <span class="n">surf</span><span class="o">=</span><span class="n">gts</span><span class="o">.</span><span class="n">Surface</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">vtxs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">vtxs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">ee1</span><span class="o">=</span><span class="n">interSectEdges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">sectEdges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="n">interSectEdges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">]</span>
            <span class="n">ee2</span><span class="o">=</span><span class="n">sectEdges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="n">interSectEdges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span><span class="n">interSectEdges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ee1</span><span class="p">:</span> <span class="n">surf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gts</span><span class="o">.</span><span class="n">Face</span><span class="p">(</span><span class="n">interSectEdges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">sectEdges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="n">interSectEdges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">]))</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ee2</span><span class="p">:</span> <span class="n">surf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gts</span><span class="o">.</span><span class="n">Face</span><span class="p">(</span><span class="n">sectEdges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="n">interSectEdges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span><span class="n">interSectEdges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">def</span> <span class="nf">doCap</span><span class="p">(</span><span class="n">vtx</span><span class="p">,</span><span class="n">edg</span><span class="p">,</span><span class="n">start</span><span class="p">):</span>
        <span class="n">ret</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">eFan</span><span class="o">=</span><span class="p">[</span><span class="n">edg</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">gts</span><span class="o">.</span><span class="n">Edge</span><span class="p">(</span><span class="n">vtx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">vtx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">vtx</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">edg</span><span class="p">)):</span>
            <span class="n">ret</span><span class="o">+=</span><span class="p">[</span><span class="n">gts</span><span class="o">.</span><span class="n">Face</span><span class="p">(</span><span class="n">eFan</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">eFan</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">edg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">start</span> <span class="k">else</span> <span class="n">gts</span><span class="o">.</span><span class="n">Face</span><span class="p">(</span><span class="n">eFan</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">edg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">eFan</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
        <span class="k">return</span> <span class="n">ret</span>
    <span class="n">caps</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span> <span class="n">capStart</span><span class="p">:</span> <span class="n">caps</span><span class="o">+=</span><span class="n">doCap</span><span class="p">(</span><span class="n">vtxs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sectEdges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">capEnd</span><span class="p">:</span> <span class="n">caps</span><span class="o">+=</span><span class="n">doCap</span><span class="p">(</span><span class="n">vtxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">sectEdges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">start</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cap</span> <span class="ow">in</span> <span class="n">caps</span><span class="p">:</span> <span class="n">surf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cap</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">threshold</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">surf</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">surf</span></div>

<div class="viewcode-block" id="gtsSurfaceBestFitOBB"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.gtsSurfaceBestFitOBB">[docs]</a><span class="k">def</span> <span class="nf">gtsSurfaceBestFitOBB</span><span class="p">(</span><span class="n">surf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return (Vector3 center, Vector3 halfSize, Quaternion orientation) describing</span>
<span class="sd">    best-fit oriented bounding box (OBB) for the given surface. See cloudBestFitOBB</span>
<span class="sd">    for details.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">gts</span>
    <span class="n">pts</span><span class="o">=</span><span class="p">[</span><span class="n">Vector3</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">surf</span><span class="o">.</span><span class="n">vertices</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">cloudBestFitOBB</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">pts</span><span class="p">))</span></div>

<div class="viewcode-block" id="revolutionSurfaceMeridians"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.revolutionSurfaceMeridians">[docs]</a><span class="k">def</span> <span class="nf">revolutionSurfaceMeridians</span><span class="p">(</span><span class="n">sects</span><span class="p">,</span><span class="n">angles</span><span class="p">,</span><span class="n">node</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Node</span><span class="p">(),</span><span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Revolution surface given sequences of 2d points and sequence of corresponding angles,</span>
<span class="sd">    returning sequences of 3d points representing meridian sections of the revolution surface.</span>
<span class="sd">    The 2d sections are turned around z-axis, but they can be transformed</span>
<span class="sd">    using the origin and orientation arguments to give arbitrary orientation.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">warnings</span>
    <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">node</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">,</span><span class="s1">&#39;origin and orientation are deprecated, pass Node object with appropriately set Node.pos and Node.ori. Update your code, backwards-compat will be removed at some point.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">pos</span><span class="o">=</span><span class="n">origin</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">ori</span><span class="o">=</span><span class="n">orientation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">sects</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;sects and angles must have the same length (</span><span class="si">%d</span><span class="s2">!=</span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sects</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)))</span>
    <span class="k">return</span> <span class="p">[[</span><span class="n">node</span><span class="o">.</span><span class="n">loc2glob</span><span class="p">(</span><span class="n">Vector3</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sects</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sects</span><span class="p">))]</span></div>

<span class="c1">########</span>
<span class="c1">## packing generators</span>
<span class="c1">########</span>


<div class="viewcode-block" id="regularOrtho"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.regularOrtho">[docs]</a><span class="k">def</span> <span class="nf">regularOrtho</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">retSpherePack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return set of spheres in regular orthogonal grid, clipped inside solid given by predicate.</span>
<span class="sd">    Created spheres will have given radius and will be separated by gap space.&quot;&quot;&quot;</span>
    <span class="n">ret</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="o">=</span><span class="n">predicate</span><span class="o">.</span><span class="n">aabb</span><span class="p">()</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">mx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">mn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)])</span><span class="o">==</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)):</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Aabb of the predicate must not be infinite (didn&#39;t you use union | instead of intersection &amp; for unbounded predicate such as notInNotch?&quot;</span><span class="p">);</span>
    <span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">zz</span><span class="o">=</span><span class="p">[</span><span class="n">arange</span><span class="p">(</span><span class="n">mn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">radius</span><span class="p">,</span><span class="n">mx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">radius</span><span class="o">+</span><span class="n">gap</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">zz</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">predicate</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">radius</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">retSpherePack</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xyz</span><span class="p">,</span><span class="n">radius</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">ret</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">retSpherePack</span><span class="p">:</span> <span class="k">return</span> <span class="n">woo</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">SpherePack</span><span class="p">(</span><span class="nb">list</span><span class="o">=</span><span class="n">ret</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="regularHexa"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.regularHexa">[docs]</a><span class="k">def</span> <span class="nf">regularHexa</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">retSpherePack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return set of spheres in regular hexagonal grid, clipped inside solid given by predicate.</span>
<span class="sd">    Created spheres will have given radius and will be separated by gap space.&quot;&quot;&quot;</span>
    <span class="n">ret</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">a</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">radius</span><span class="o">+</span><span class="n">gap</span>
    <span class="c1"># thanks to Nasibeh Moradi for finding bug here:</span>
    <span class="c1"># http://www.mail-archive.com/woo-users@lists.launchpad.net/msg01424.html</span>
    <span class="n">hy</span><span class="p">,</span><span class="n">hz</span><span class="o">=</span><span class="n">a</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">a</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="mf">3.</span>
    <span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="o">=</span><span class="n">predicate</span><span class="o">.</span><span class="n">aabb</span><span class="p">()</span>
    <span class="n">dim</span><span class="o">=</span><span class="n">mx</span><span class="o">-</span><span class="n">mn</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="o">==</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)):</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Aabb of the predicate must not be infinite (didn&#39;t you use union | instead of intersection &amp; for unbounded predicate such as notInNotch?&quot;</span><span class="p">);</span>
    <span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">kk</span><span class="o">=</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">hy</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">hz</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">kk</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="o">=</span><span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">radius</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="n">mn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radius</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">hy</span><span class="p">,</span><span class="n">mn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">radius</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">hz</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">x</span><span class="o">+=</span> <span class="n">a</span><span class="o">/</span><span class="mf">2.</span> <span class="k">if</span> <span class="n">k</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="n">a</span><span class="o">/</span><span class="mf">2.</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">%</span><span class="mi">2</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span> <span class="n">x</span><span class="o">+=</span><span class="n">a</span><span class="o">/</span><span class="mf">2.</span><span class="p">;</span> <span class="n">y</span><span class="o">+=</span><span class="n">hy</span><span class="o">/</span><span class="mf">2.</span>
        <span class="k">if</span> <span class="n">predicate</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">retSpherePack</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">ret</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">retSpherePack</span><span class="p">:</span> <span class="k">return</span> <span class="n">woo</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">SpherePack</span><span class="p">(</span><span class="nb">list</span><span class="o">=</span><span class="n">ret</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="randomLoosePsd"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.randomLoosePsd">[docs]</a><span class="k">def</span> <span class="nf">randomLoosePsd</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span><span class="n">psd</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">maxAttempts</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">clumps</span><span class="o">=</span><span class="p">[],</span><span class="n">returnSpherePack</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return loose packing based on given PSD.&#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">woo.dem</span>
    <span class="kn">import</span> <span class="nn">woo.core</span>
    <span class="kn">import</span> <span class="nn">woo.log</span>
    <span class="n">S</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Scene</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">DemField</span><span class="p">()])</span>
    <span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="o">=</span><span class="n">predicate</span><span class="o">.</span><span class="n">aabb</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">clumps</span><span class="p">:</span> <span class="n">generator</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">PsdSphereGenerator</span><span class="p">(</span><span class="n">psdPts</span><span class="o">=</span><span class="n">psd</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">generator</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">PsdClumpGenerator</span><span class="p">(</span><span class="n">psdPts</span><span class="o">=</span><span class="n">psd</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">clumps</span><span class="o">=</span><span class="n">clumps</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="o">=</span><span class="p">[</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">InsertionSortCollider</span><span class="p">([</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Bo1_Sphere_Aabb</span><span class="p">()]),</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">BoxInlet</span><span class="p">(</span>
            <span class="n">box</span><span class="o">=</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="p">),</span>
            <span class="n">maxMass</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">maxNum</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">massRate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">maxAttempts</span><span class="o">=</span><span class="n">maxAttempts</span><span class="p">,</span>
            <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
            <span class="n">materials</span><span class="o">=</span><span class="p">[</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">ElastMat</span><span class="p">(</span><span class="n">density</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span> <span class="c1"># must have some density</span>
            <span class="n">shooter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span>
    <span class="n">S</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">returnSpherePack</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;returnSpherePack must be True.&#39;</span><span class="p">)</span>
    <span class="n">sp</span><span class="o">=</span><span class="n">SpherePack</span><span class="p">()</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">fromDem</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="n">predicate</span><span class="p">)</span></div>
    <span class="c1">#ret=[]</span>
    <span class="c1">#for p in S.dem.par:</span>
    <span class="c1">#    if predicate(p.pos,p.shape.radius): ret+=[utils.sphere(p.pos,radius=p.shape.radius,**kw)]</span>
    <span class="c1">#return ret</span>


<div class="viewcode-block" id="filterSpherePack"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.filterSpherePack">[docs]</a><span class="k">def</span> <span class="nf">filterSpherePack</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span><span class="n">spherePack</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Using given SpherePack instance, return spheres the satisfy predicate.</span>
<span class="sd">    The packing will be recentered to match the predicate and warning is given if the predicate</span>
<span class="sd">    is larger than the packing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">spherePack</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="n">predicate</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_memoizePacking</span><span class="p">(</span><span class="n">memoizeDb</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">rRelFuzz</span><span class="p">,</span><span class="n">wantPeri</span><span class="p">,</span><span class="n">fullDim</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">memoizeDb</span><span class="p">:</span> <span class="k">return</span>
    <span class="kn">import</span> <span class="nn">pickle</span><span class="o">,</span><span class="nn">sqlite3</span><span class="o">,</span><span class="nn">time</span><span class="o">,</span><span class="nn">os</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">memoizeDb</span><span class="p">):</span>
        <span class="n">conn</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">memoizeDb</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">memoizeDb</span><span class="p">)</span>
        <span class="n">c</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;create table packings (radius real, rRelFuzz real, dimx real, dimy real, dimz real, N integer, timestamp real, periodic integer, pack blob)&#39;</span><span class="p">)</span>
    <span class="n">c</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="c1"># use protocol=2 so that we are compatible between py2/py3</span>
    <span class="n">packBlob</span><span class="o">=</span><span class="nb">memoryview</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">toList</span><span class="p">(),</span><span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">packDim</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span> <span class="k">if</span> <span class="n">wantPeri</span> <span class="k">else</span> <span class="n">fullDim</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;insert into packings values (?,?,?,?,?,?,?,?,?)&#39;</span><span class="p">,(</span><span class="n">radius</span><span class="p">,</span><span class="n">rRelFuzz</span><span class="p">,</span><span class="n">packDim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">packDim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">packDim</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">sp</span><span class="p">),</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span><span class="n">wantPeri</span><span class="p">,</span><span class="n">packBlob</span><span class="p">,))</span>
    <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Packing saved to the database&quot;</span><span class="p">,</span><span class="n">memoizeDb</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_getMemoizedPacking</span><span class="p">(</span><span class="n">memoizeDb</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">rRelFuzz</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">z1</span><span class="p">,</span><span class="n">fullDim</span><span class="p">,</span><span class="n">wantPeri</span><span class="p">,</span><span class="n">fillPeriodic</span><span class="p">,</span><span class="n">spheresInCell</span><span class="p">,</span><span class="n">memoDbg</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return suitable SpherePack read from *memoizeDb* if found, None otherwise.</span>
<span class="sd">        </span>
<span class="sd">        :param fillPeriodic: whether to fill fullDim by repeating periodic packing</span>
<span class="sd">        :param wantPeri: only consider periodic packings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">os.path</span><span class="o">,</span><span class="nn">sqlite3</span><span class="o">,</span><span class="nn">time</span><span class="o">,</span><span class="nn">pickle</span><span class="o">,</span><span class="nn">sys</span>
    <span class="k">if</span> <span class="n">memoDbg</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">memoDbgMsg</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">memoDbgMsg</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="k">pass</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">memoizeDb</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">memoizeDb</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">memoizeDb</span><span class="p">:</span> <span class="n">memoDbgMsg</span><span class="p">(</span><span class="s2">&quot;Database </span><span class="si">%s</span><span class="s2"> does not exist.&quot;</span><span class="o">%</span><span class="n">memoizeDb</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># find suitable packing and return it directly</span>
    <span class="n">conn</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">memoizeDb</span><span class="p">);</span> <span class="n">c</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">();</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select radius,rRelFuzz,dimx,dimy,dimz,N,timestamp,periodic from packings order by N&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;ERROR: database `&quot;</span><span class="o">+</span><span class="n">memoizeDb</span><span class="o">+</span><span class="s2">&quot;&#39; not compatible with randomDensePack (corrupt, deprecated format or not a db created by randomDensePack)&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">R</span><span class="p">,</span><span class="n">rDev</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">timestamp</span><span class="p">,</span><span class="n">isPeri</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">];</span> <span class="n">scale</span><span class="o">=</span><span class="n">radius</span><span class="o">/</span><span class="n">R</span>
        <span class="n">rDev</span><span class="o">*=</span><span class="n">scale</span><span class="p">;</span> <span class="n">X</span><span class="o">*=</span><span class="n">scale</span><span class="p">;</span> <span class="n">Y</span><span class="o">*=</span><span class="n">scale</span><span class="p">;</span> <span class="n">Z</span><span class="o">*=</span><span class="n">scale</span>
        <span class="n">memoDbgMsg</span><span class="p">(</span><span class="s2">&quot;Considering packing (radius=</span><span class="si">%g</span><span class="s2">±</span><span class="si">%g</span><span class="s2">,N=</span><span class="si">%g</span><span class="s2">,dim=</span><span class="si">%g</span><span class="s2">×</span><span class="si">%g</span><span class="s2">×</span><span class="si">%g</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,scale=</span><span class="si">%g</span><span class="s2">), created </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">rDev</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="s2">&quot;periodic&quot;</span> <span class="k">if</span> <span class="n">isPeri</span> <span class="k">else</span> <span class="s2">&quot;non-periodic&quot;</span><span class="p">,</span><span class="n">scale</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isPeri</span> <span class="ow">and</span> <span class="n">wantPeri</span><span class="p">:</span> <span class="n">memoDbgMsg</span><span class="p">(</span><span class="s2">&quot;REJECT: is not periodic, which is requested.&quot;</span><span class="p">);</span> <span class="k">continue</span>
        <span class="k">if</span> <span class="n">wantPeri</span> <span class="ow">and</span> <span class="p">(</span><span class="n">X</span><span class="o">/</span><span class="n">x1</span><span class="o">&gt;</span><span class="mf">0.9</span> <span class="ow">or</span> <span class="n">X</span><span class="o">/</span><span class="n">x1</span><span class="o">&lt;</span><span class="mf">0.6</span><span class="p">):</span>  <span class="n">memoDbgMsg</span><span class="p">(</span><span class="s2">&quot;REJECT: initSize differs too much from scaled packing size.&quot;</span><span class="p">);</span> <span class="k">continue</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rRelFuzz</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">rDev</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">rRelFuzz</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">rDev</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">rRelFuzz</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">((</span><span class="n">rDev</span><span class="o">-</span><span class="n">rRelFuzz</span><span class="p">)</span><span class="o">/</span><span class="n">rRelFuzz</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1e-2</span><span class="p">):</span> <span class="n">memoDbgMsg</span><span class="p">(</span><span class="s2">&quot;REJECT: radius fuzz differs too much (</span><span class="si">%g</span><span class="s2">, </span><span class="si">%g</span><span class="s2"> desired)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">rDev</span><span class="p">,</span><span class="n">rRelFuzz</span><span class="p">));</span> <span class="k">continue</span> <span class="c1"># radius fuzz differs too much</span>
        <span class="k">if</span> <span class="n">isPeri</span> <span class="ow">and</span> <span class="n">wantPeri</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spheresInCell</span><span class="o">&gt;</span><span class="n">NN</span> <span class="ow">and</span> <span class="n">spheresInCell</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">memoDbgMsg</span><span class="p">(</span><span class="s2">&quot;REJECT: Number of spheres in the packing too small&quot;</span><span class="p">);</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">y1</span><span class="o">/</span><span class="n">x1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Y</span><span class="o">/</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.3</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">((</span><span class="n">z1</span><span class="o">/</span><span class="n">x1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Z</span><span class="o">/</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.3</span><span class="p">:</span> <span class="n">memoDbgMsg</span><span class="p">(</span><span class="s2">&quot;REJECT: proportions (y/x=</span><span class="si">%g</span><span class="s2">, z/x=</span><span class="si">%g</span><span class="s2">) differ too much from what is desired (</span><span class="si">%g</span><span class="s2">, </span><span class="si">%g</span><span class="s2">).&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">Y</span><span class="o">/</span><span class="n">X</span><span class="p">,</span><span class="n">Z</span><span class="o">/</span><span class="n">X</span><span class="p">,</span><span class="n">y1</span><span class="o">/</span><span class="n">x1</span><span class="p">,</span><span class="n">z1</span><span class="o">/</span><span class="n">x1</span><span class="p">));</span> <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">X</span><span class="o">&lt;</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">Y</span><span class="o">&lt;</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">Z</span><span class="o">&lt;</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span> <span class="n">memoDbgMsg</span><span class="p">(</span><span class="s2">&quot;REJECT: not large enough&quot;</span><span class="p">);</span> <span class="k">continue</span> <span class="c1"># not large enough</span>
        <span class="n">memoDbgMsg</span><span class="p">(</span><span class="s2">&quot;ACCEPTED&quot;</span><span class="p">);</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found suitable packing in </span><span class="si">%s</span><span class="s2"> (radius=</span><span class="si">%g</span><span class="s2">±</span><span class="si">%g</span><span class="s2">,N=</span><span class="si">%g</span><span class="s2">,dim=</span><span class="si">%g</span><span class="s2">×</span><span class="si">%g</span><span class="s2">×</span><span class="si">%g</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,scale=</span><span class="si">%g</span><span class="s2">), created </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">memoizeDb</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">rDev</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="s2">&quot;periodic&quot;</span> <span class="k">if</span> <span class="n">isPeri</span> <span class="k">else</span> <span class="s2">&quot;non-periodic&quot;</span><span class="p">,</span><span class="n">scale</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select pack from packings where timestamp=?&#39;</span><span class="p">,(</span><span class="n">timestamp</span><span class="p">,))</span>
        <span class="n">sp</span><span class="o">=</span><span class="n">SpherePack</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">scale</span><span class="p">);</span>
        <span class="k">if</span> <span class="n">isPeri</span> <span class="ow">and</span> <span class="n">wantPeri</span><span class="p">:</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span><span class="o">=</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">);</span>
            <span class="k">if</span> <span class="n">fillPeriodic</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">cellFill</span><span class="p">(</span><span class="n">Vector3</span><span class="p">(</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
        <span class="c1">#sp.cellSize=(0,0,0) # resetting cellSize avoids warning when rotating</span>
        <span class="k">return</span> <span class="n">sp</span>
        <span class="c1">#if orientation: sp.rotate(*orientation.toAxisAngle())</span>
        <span class="c1">#return filterSpherePack(predicate,sp,mat=mat)</span>
    <span class="c1">#print &quot;No suitable packing in database found, running&quot;,&#39;PERIODIC compression&#39; if wantPeri else &#39;triaxial&#39;</span>
    <span class="c1">#sys.stdout.flush()</span>


<div class="viewcode-block" id="randomDensePack"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.randomDensePack">[docs]</a><span class="k">def</span> <span class="nf">randomDensePack</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">mat</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cropLayers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">rRelFuzz</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">spheresInCell</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">memoizeDb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">useOBB</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">memoDbg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generator of random dense packing with given geometry properties, using TriaxialTest (aperiodic)</span>
<span class="sd">    or PeriIsoCompressor (periodic). The periodicity depens on whether the spheresInCell parameter is given.</span>

<span class="sd">    :param predicate: solid-defining predicate for which we generate packing</span>
<span class="sd">    :param spheresInCell: if given, the packing will be periodic, with given number of spheres in the periodic cell.</span>
<span class="sd">    :param radius: mean radius of spheres</span>
<span class="sd">    :param rRelFuzz: relative fuzz of the radius -- e.g. radius=10, rRelFuzz=.2, then spheres will have radii 10 ± (10*.2)).</span>
<span class="sd">        0 by default, meaning all spheres will have exactly the same radius.</span>
<span class="sd">    :param cropLayers: (aperiodic only) how many layers of spheres will be added to the computed dimension of the box so that there no</span>
<span class="sd">        (or not so much, at least) boundary effects at the boundaries of the predicate.</span>
<span class="sd">    :param dim: dimension of the packing, to override dimensions of the predicate (if it is infinite, for instance)</span>
<span class="sd">    :param memoizeDb: name of sqlite database (existent or nonexistent) to find an already generated packing or to store</span>
<span class="sd">        the packing that will be generated, if not found (the technique of caching results of expensive computations</span>
<span class="sd">        is known as memoization). Fuzzy matching is used to select suitable candidate -- packing will be scaled, rRelFuzz</span>
<span class="sd">        and dimensions compared. Packing that are too small are dictarded. From the remaining candidate, the one with the</span>
<span class="sd">        least number spheres will be loaded and returned.</span>
<span class="sd">    :param useOBB: effective only if a inGtsSurface predicate is given. If true (default), oriented bounding box will be</span>
<span class="sd">        computed first; it can reduce substantially number of spheres for the triaxial compression (like 10× depending on</span>
<span class="sd">        how much asymmetric the body is), see scripts/test/gts-triax-pack-obb.py.</span>
<span class="sd">    :param memoDbg: show packigns that are considered and reasons why they are rejected/accepted</span>

<span class="sd">    :return: SpherePack object with spheres, filtered by the predicate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">sqlite3</span><span class="o">,</span> <span class="nn">os.path</span><span class="o">,</span> <span class="nn">pickle</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">woo._packPredicates</span>
    <span class="kn">from</span> <span class="nn">woo</span> <span class="k">import</span> <span class="n">core</span><span class="p">,</span> <span class="n">dem</span>
    <span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">pi</span>
    <span class="n">wantPeri</span><span class="o">=</span><span class="p">(</span><span class="n">spheresInCell</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;inGtsSurface&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">_packPredicates</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">predicate</span><span class="p">)</span><span class="o">==</span><span class="n">inGtsSurface</span> <span class="ow">and</span> <span class="n">useOBB</span><span class="p">:</span>
        <span class="n">center</span><span class="p">,</span><span class="n">dim</span><span class="p">,</span><span class="n">orientation</span><span class="o">=</span><span class="n">gtsSurfaceBestFitOBB</span><span class="p">(</span><span class="n">predicate</span><span class="o">.</span><span class="n">surf</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Best-fit oriented-bounding-box computed for GTS surface, orientation is&quot;</span><span class="p">,</span><span class="n">orientation</span><span class="p">)</span>
        <span class="n">dim</span><span class="o">*=</span><span class="mi">2</span> <span class="c1"># gtsSurfaceBestFitOBB returns halfSize</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dim</span><span class="p">:</span> <span class="n">dim</span><span class="o">=</span><span class="n">predicate</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="o">==</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Infinite predicate and no dimension of packing requested.&quot;</span><span class="p">)</span>
        <span class="n">center</span><span class="o">=</span><span class="n">predicate</span><span class="o">.</span><span class="n">center</span><span class="p">()</span>
        <span class="n">orientation</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">wantPeri</span><span class="p">:</span> <span class="n">fullDim</span><span class="o">=</span><span class="nb">tuple</span><span class="p">([</span><span class="n">dim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">cropLayers</span><span class="o">*</span><span class="n">radius</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># compute cell dimensions now, as they will be compared to ones stored in the db</span>
        <span class="c1"># they have to be adjusted to not make the cell to small WRT particle radius</span>
        <span class="n">fullDim</span><span class="o">=</span><span class="n">dim</span>
        <span class="n">cloudPorosity</span><span class="o">=</span><span class="mf">0.25</span> <span class="c1"># assume this number for the initial cloud (can be underestimated)</span>
        <span class="n">beta</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># ratios β=y₀/x₀, γ=z₀/x₀</span>
        <span class="n">N100</span><span class="o">=</span><span class="n">spheresInCell</span><span class="o">/</span><span class="n">cloudPorosity</span> <span class="c1"># number of spheres for cell being filled by spheres without porosity</span>
        <span class="n">x1</span><span class="o">=</span><span class="n">radius</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">gamma</span><span class="p">)</span><span class="o">*</span><span class="n">N100</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="n">y1</span><span class="p">,</span><span class="n">z1</span><span class="o">=</span><span class="n">beta</span><span class="o">*</span><span class="n">x1</span><span class="p">,</span><span class="n">gamma</span><span class="o">*</span><span class="n">x1</span><span class="p">;</span> <span class="n">vol0</span><span class="o">=</span><span class="n">x1</span><span class="o">*</span><span class="n">y1</span><span class="o">*</span><span class="n">z1</span>
        <span class="n">maxR</span><span class="o">=</span><span class="n">radius</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">rRelFuzz</span><span class="p">)</span>
        <span class="n">x1</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="mi">8</span><span class="o">*</span><span class="n">maxR</span><span class="p">);</span> <span class="n">y1</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span><span class="mi">8</span><span class="o">*</span><span class="n">maxR</span><span class="p">);</span> <span class="n">z1</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">z1</span><span class="p">,</span><span class="mi">8</span><span class="o">*</span><span class="n">maxR</span><span class="p">);</span> <span class="n">vol1</span><span class="o">=</span><span class="n">x1</span><span class="o">*</span><span class="n">y1</span><span class="o">*</span><span class="n">z1</span>
        <span class="n">N100</span><span class="o">*=</span><span class="n">vol1</span><span class="o">/</span><span class="n">vol0</span> <span class="c1"># volume might have been increased, increase number of spheres to keep porosity the same</span>
        <span class="n">sp</span><span class="o">=</span><span class="n">_getMemoizedPacking</span><span class="p">(</span><span class="n">memoizeDb</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">rRelFuzz</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">z1</span><span class="p">,</span><span class="n">fullDim</span><span class="p">,</span><span class="n">wantPeri</span><span class="p">,</span><span class="n">fillPeriodic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">spheresInCell</span><span class="o">=</span><span class="n">spheresInCell</span><span class="p">,</span><span class="n">memoDbg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sp</span><span class="p">:</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># resetting cellSize avoids warning when rotating, plus we don&#39;t want periodic packing anyway</span>
            <span class="k">if</span> <span class="n">orientation</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">*</span><span class="n">orientation</span><span class="o">.</span><span class="n">toAxisAngle</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">filterSpherePack</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No suitable packing in database found, running&quot;</span><span class="p">,</span><span class="s1">&#39;PERIODIC compression&#39;</span> <span class="k">if</span> <span class="n">wantPeri</span> <span class="k">else</span> <span class="s1">&#39;triaxial&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">S</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">Scene</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">dem</span><span class="o">.</span><span class="n">DemField</span><span class="p">()])</span>
    <span class="k">if</span> <span class="n">wantPeri</span><span class="p">:</span>
        <span class="c1"># x1,y1,z1 already computed above</span>
        <span class="n">sp</span><span class="o">=</span><span class="n">SpherePack</span><span class="p">()</span>
        <span class="n">S</span><span class="o">.</span><span class="n">periodic</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">setBox</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">z1</span><span class="p">)</span>
        <span class="c1">#print cloudPorosity,beta,gamma,N100,x1,y1,z1,S.cell.refSize</span>
        <span class="c1">#print x1,y1,z1,radius,rRelFuzz</span>
        <span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="o">=</span><span class="p">[</span><span class="n">dem</span><span class="o">.</span><span class="n">ForceResetter</span><span class="p">(),</span><span class="n">dem</span><span class="o">.</span><span class="n">InsertionSortCollider</span><span class="p">([</span><span class="n">dem</span><span class="o">.</span><span class="n">Bo1_Sphere_Aabb</span><span class="p">()],</span><span class="n">verletDist</span><span class="o">=.</span><span class="mi">05</span><span class="o">*</span><span class="n">radius</span><span class="p">),</span><span class="n">dem</span><span class="o">.</span><span class="n">ContactLoop</span><span class="p">([</span><span class="n">dem</span><span class="o">.</span><span class="n">Cg2_Sphere_Sphere_L6Geom</span><span class="p">()],[</span><span class="n">dem</span><span class="o">.</span><span class="n">Cp2_FrictMat_FrictPhys</span><span class="p">()],[</span><span class="n">dem</span><span class="o">.</span><span class="n">Law2_L6Geom_FrictPhys_IdealElPl</span><span class="p">()],</span><span class="n">applyForces</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span><span class="n">dem</span><span class="o">.</span><span class="n">Leapfrog</span><span class="p">(</span><span class="n">damping</span><span class="o">=.</span><span class="mi">7</span><span class="p">,</span><span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span><span class="n">dem</span><span class="o">.</span><span class="n">PeriIsoCompressor</span><span class="p">(</span><span class="n">charLen</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">radius</span><span class="p">,</span><span class="n">stresses</span><span class="o">=</span><span class="p">[</span><span class="n">PERI_SIG1</span><span class="p">,</span><span class="n">PERI_SIG2</span><span class="p">],</span><span class="n">maxUnbalanced</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span><span class="n">doneHook</span><span class="o">=</span><span class="s1">&#39;print(&quot;DONE&quot;); S.stop();&#39;</span><span class="p">,</span><span class="n">globalUpdateInt</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">keepProportions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;compressor&#39;</span><span class="p">)]</span>
        <span class="n">num</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">makeCloud</span><span class="p">(</span><span class="n">Vector3</span><span class="p">()</span><span class="o">.</span><span class="n">Zero</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">size0</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">rRelFuzz</span><span class="p">,</span><span class="n">spheresInCell</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mat</span><span class="o">=</span><span class="n">dem</span><span class="o">.</span><span class="n">FrictMat</span><span class="p">(</span><span class="n">young</span><span class="o">=</span><span class="mf">30e9</span><span class="p">,</span><span class="n">tanPhi</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">ktDivKn</span><span class="o">=.</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sp</span><span class="p">:</span> <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Sphere</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">))</span>
        <span class="n">S</span><span class="o">.</span><span class="n">dt</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">pWaveDt</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">run</span><span class="p">();</span> <span class="n">S</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">sp</span><span class="o">=</span><span class="n">SpherePack</span><span class="p">();</span> <span class="n">sp</span><span class="o">.</span><span class="n">fromDem</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="p">)</span>
        <span class="c1">#print &#39;Resulting cellSize&#39;,sp.cellSize,&#39;proportions&#39;,sp.cellSize[1]/sp.cellSize[0],sp.cellSize[2]/sp.cellSize[0]</span>
        <span class="c1"># repetition to the required cell size will be done below, after memoizing the result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Aperiodic compression not implemented.&quot;</span><span class="p">)</span>
        <span class="n">assumedFinalDensity</span><span class="o">=</span><span class="mf">0.6</span>
        <span class="n">V</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">radius</span><span class="o">**</span><span class="mi">3</span><span class="p">;</span> <span class="n">N</span><span class="o">=</span><span class="n">assumedFinalDensity</span><span class="o">*</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">V</span><span class="p">;</span>
        <span class="n">TriaxialTest</span><span class="p">(</span>
            <span class="n">numberOfGrains</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="p">),</span><span class="n">radiusMean</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="n">radiusStdDev</span><span class="o">=</span><span class="n">rRelFuzz</span><span class="p">,</span>
            <span class="c1"># upperCorner is just size ratio, if radiusMean is specified</span>
            <span class="n">upperCorner</span><span class="o">=</span><span class="n">fullDim</span><span class="p">,</span>
            <span class="c1">## no need to touch any the following</span>
            <span class="n">noFiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">lowerCorner</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">sigmaIsoCompaction</span><span class="o">=</span><span class="mf">1e7</span><span class="p">,</span><span class="n">sigmaLateralConfinement</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">StabilityCriterion</span><span class="o">=.</span><span class="mi">05</span><span class="p">,</span><span class="n">strainRate</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span><span class="n">thickness</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">maxWallVelocity</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">wallOversizeFactor</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">autoUnload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">autoCompressionActivation</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;TriaxialCompressionEngine&#39;</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">WARN</span><span class="p">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">run</span><span class="p">();</span> <span class="n">S</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">sp</span><span class="o">=</span><span class="n">SpherePack</span><span class="p">();</span> <span class="n">sp</span><span class="o">.</span><span class="n">fromDem</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="p">)</span>
    <span class="n">_memoizePacking</span><span class="p">(</span><span class="n">memoizeDb</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">rRelFuzz</span><span class="p">,</span><span class="n">wantPeri</span><span class="p">,</span><span class="n">fullDim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">wantPeri</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">cellFill</span><span class="p">(</span><span class="n">Vector3</span><span class="p">(</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">fullDim</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">orientation</span><span class="p">:</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> <span class="c1"># reset periodicity to avoid warning when rotating periodic packing</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">*</span><span class="n">orientation</span><span class="o">.</span><span class="n">toAxisAngle</span><span class="p">())</span>
    <span class="n">ret</span><span class="o">=</span><span class="n">filterSpherePack</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="c1"># reset periodicity</span>
    <span class="c1"># thanks to https://ask.woodem.org/index.php/283/problem-with-inalignedbox-and-randomdensepack</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">cellSize</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="randomPeriPack"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.randomPeriPack">[docs]</a><span class="k">def</span> <span class="nf">randomPeriPack</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span><span class="n">initSize</span><span class="p">,</span><span class="n">rRelFuzz</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">memoizeDb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate periodic dense packing.</span>

<span class="sd">    A cell of initSize is stuffed with as many spheres as possible, then we run periodic compression with PeriIsoCompressor, just like with randomDensePack.</span>

<span class="sd">    :param radius: mean sphere radius</span>
<span class="sd">    :param rRelFuzz: relative fuzz of sphere radius (equal distribution); see the same param for randomDensePack.</span>
<span class="sd">    :param initSize: initial size of the periodic cell.</span>

<span class="sd">    :return: SpherePack object, which also contains periodicity information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">pi</span>
    <span class="kn">from</span> <span class="nn">woo</span> <span class="k">import</span> <span class="n">core</span><span class="p">,</span> <span class="n">dem</span>
    <span class="n">sp</span><span class="o">=</span><span class="n">_getMemoizedPacking</span><span class="p">(</span><span class="n">memoizeDb</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">rRelFuzz</span><span class="p">,</span><span class="n">initSize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">initSize</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">initSize</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">fullDim</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">wantPeri</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fillPeriodic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">spheresInCell</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">memoDbg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sp</span><span class="p">:</span> <span class="k">return</span> <span class="n">sp</span>
    <span class="c1">#oldScene=O.scene</span>
    <span class="n">S</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">Scene</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">dem</span><span class="o">.</span><span class="n">DemField</span><span class="p">()])</span>
    <span class="n">sp</span><span class="o">=</span><span class="n">SpherePack</span><span class="p">()</span>
    <span class="n">S</span><span class="o">.</span><span class="n">periodic</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">setBox</span><span class="p">(</span><span class="n">initSize</span><span class="p">)</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">makeCloud</span><span class="p">(</span><span class="n">Vector3</span><span class="p">()</span><span class="o">.</span><span class="n">Zero</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">size0</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">rRelFuzz</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">woo</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;PeriIsoCompressor&#39;</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="o">=</span><span class="p">[</span><span class="n">dem</span><span class="o">.</span><span class="n">ForceResetter</span><span class="p">(),</span><span class="n">dem</span><span class="o">.</span><span class="n">InsertionSortCollider</span><span class="p">([</span><span class="n">dem</span><span class="o">.</span><span class="n">Bo1_Sphere_Aabb</span><span class="p">()],</span><span class="n">verletDist</span><span class="o">=.</span><span class="mi">05</span><span class="o">*</span><span class="n">radius</span><span class="p">),</span><span class="n">dem</span><span class="o">.</span><span class="n">ContactLoop</span><span class="p">([</span><span class="n">dem</span><span class="o">.</span><span class="n">Cg2_Sphere_Sphere_L6Geom</span><span class="p">()],[</span><span class="n">dem</span><span class="o">.</span><span class="n">Cp2_FrictMat_FrictPhys</span><span class="p">()],[</span><span class="n">dem</span><span class="o">.</span><span class="n">Law2_L6Geom_FrictPhys_IdealElPl</span><span class="p">()],</span><span class="n">applyForces</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span><span class="n">dem</span><span class="o">.</span><span class="n">PeriIsoCompressor</span><span class="p">(</span><span class="n">charLen</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">radius</span><span class="p">,</span><span class="n">stresses</span><span class="o">=</span><span class="p">[</span><span class="n">PERI_SIG1</span><span class="p">,</span><span class="n">PERI_SIG2</span><span class="p">],</span><span class="n">maxUnbalanced</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span><span class="n">doneHook</span><span class="o">=</span><span class="s1">&#39;print(&quot;done&quot;); S.stop();&#39;</span><span class="p">,</span><span class="n">globalUpdateInt</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">keepProportions</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span><span class="n">dem</span><span class="o">.</span><span class="n">Leapfrog</span><span class="p">(</span><span class="n">damping</span><span class="o">=.</span><span class="mi">8</span><span class="p">)]</span>
    <span class="n">mat</span><span class="o">=</span><span class="n">dem</span><span class="o">.</span><span class="n">FrictMat</span><span class="p">(</span><span class="n">young</span><span class="o">=</span><span class="mf">30e9</span><span class="p">,</span><span class="n">tanPhi</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">ktDivKn</span><span class="o">=.</span><span class="mi">3</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="mf">1e3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sp</span><span class="p">:</span> <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">))</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dt</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">pWaveDt</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
    <span class="c1">#O.timingEnabled=True</span>
    <span class="n">S</span><span class="o">.</span><span class="n">run</span><span class="p">();</span> <span class="n">S</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">=</span><span class="n">SpherePack</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">fromDem</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="p">)</span>
    <span class="n">_memoizePacking</span><span class="p">(</span><span class="n">memoizeDb</span><span class="p">,</span><span class="n">ret</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">rRelFuzz</span><span class="p">,</span><span class="n">wantPeri</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fullDim</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># fullDim unused</span>
    <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="hexaNet"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.hexaNet">[docs]</a><span class="k">def</span> <span class="nf">hexaNet</span><span class="p">(</span> <span class="n">radius</span><span class="p">,</span> <span class="n">cornerCoord</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xLength</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">yLength</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">mos</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">startAtCorner</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">isSymmetric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Definition of the particles for a hexagonal wire net in the x-y-plane for the WireMatPM.</span>

<span class="sd">    :param radius: radius of the particle</span>
<span class="sd">    :param cornerCoord: coordinates of the lower left corner of the net</span>
<span class="sd">    :param xLenght: net length in x-direction</span>
<span class="sd">    :param yLenght: net length in y-direction</span>
<span class="sd">    :param mos: mesh opening size</span>
<span class="sd">    :param a: length of double-twist </span>
<span class="sd">    :param b: height of single wire section</span>
<span class="sd">    :param startAtCorner: if true the generation starts with a double-twist at the lower left corner</span>
<span class="sd">    :param isSymmetric: defines if the net is symmetric with respect to the y-axis</span>

<span class="sd">    :return: set of spheres which defines the net (net) and exact dimensions of the net (lx,ly).</span>
<span class="sd">    </span>
<span class="sd">    note::</span>
<span class="sd">    This packing works for the WireMatPM only. The particles at the corner are always generated first.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check input dimension</span>
    <span class="k">if</span><span class="p">(</span><span class="n">xLength</span><span class="o">&lt;</span><span class="n">mos</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;xLength must be greather than mos!&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">yLength</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;yLength must be greather than 2*a+b!&quot;</span><span class="p">);</span>
    <span class="n">xstart</span> <span class="o">=</span> <span class="n">cornerCoord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ystart</span> <span class="o">=</span> <span class="n">cornerCoord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">cornerCoord</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ab</span> <span class="o">=</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span>
    <span class="c1"># number of double twisted sections in y-direction and real length ly</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="n">yLength</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">ab</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">ly</span> <span class="o">=</span> <span class="n">ny</span><span class="o">*</span><span class="n">a</span><span class="o">+</span><span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">b</span>
    <span class="n">jump</span><span class="o">=</span><span class="mi">0</span>
    <span class="c1"># number of sections in x-direction and real length lx</span>
    <span class="k">if</span> <span class="n">isSymmetric</span><span class="p">:</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">xLength</span><span class="o">/</span><span class="n">mos</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">lx</span> <span class="o">=</span> <span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">mos</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">startAtCorner</span><span class="p">:</span>
            <span class="n">nx</span><span class="o">+=-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="n">xLength</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">mos</span><span class="p">)</span><span class="o">/</span><span class="n">mos</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">lx</span> <span class="o">=</span> <span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">mos</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">mos</span>
    <span class="n">net</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># generate corner particles</span>
    <span class="k">if</span> <span class="n">startAtCorner</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ny</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span> <span class="c1"># if ny even no symmetry in y-direction</span>
            <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">xstart</span><span class="p">,</span><span class="n">ystart</span><span class="o">+</span><span class="n">ly</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span> <span class="c1"># upper left corner</span>
            <span class="k">if</span> <span class="n">isSymmetric</span><span class="p">:</span>
                <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">xstart</span><span class="o">+</span><span class="n">lx</span><span class="p">,</span><span class="n">ystart</span><span class="o">+</span><span class="n">ly</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span> <span class="c1"># upper right corner</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">xstart</span><span class="o">+</span><span class="n">lx</span><span class="p">,</span><span class="n">ystart</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span> <span class="c1"># lower right corner</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># if ny odd symmetry in y-direction</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isSymmetric</span><span class="p">:</span>
                <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">xstart</span><span class="o">+</span><span class="n">lx</span><span class="p">,</span><span class="n">ystart</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span> <span class="c1"># lower right corner</span>
                <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">xstart</span><span class="o">+</span><span class="n">lx</span><span class="p">,</span><span class="n">ystart</span><span class="o">+</span><span class="n">ly</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span> <span class="c1"># upper right corner</span>
        <span class="n">jump</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># do not start at corner</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ny</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span> <span class="c1"># if ny even no symmetry in y-direction</span>
            <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">xstart</span><span class="p">,</span><span class="n">ystart</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span> <span class="c1"># lower left corner</span>
            <span class="k">if</span> <span class="n">isSymmetric</span><span class="p">:</span>
                <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">xstart</span><span class="o">+</span><span class="n">lx</span><span class="p">,</span><span class="n">ystart</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span> <span class="c1"># lower right corner</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">xstart</span><span class="o">+</span><span class="n">lx</span><span class="p">,</span><span class="n">ystart</span><span class="o">+</span><span class="n">ly</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span> <span class="c1"># upper right corner</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># if ny odd symmetry in y-direction</span>
            <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">xstart</span><span class="p">,</span><span class="n">ystart</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span> <span class="c1"># lower left corner</span>
            <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">xstart</span><span class="p">,</span><span class="n">ystart</span><span class="o">+</span><span class="n">ly</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span> <span class="c1"># upper left corner</span>
            <span class="k">if</span> <span class="n">isSymmetric</span><span class="p">:</span>
                <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">xstart</span><span class="o">+</span><span class="n">lx</span><span class="p">,</span><span class="n">ystart</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span> <span class="c1"># lower right corner</span>
                <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">xstart</span><span class="o">+</span><span class="n">lx</span><span class="p">,</span><span class="n">ystart</span><span class="o">+</span><span class="n">ly</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span> <span class="c1"># upper right corner</span>
        <span class="n">xstart</span><span class="o">+=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">mos</span>
    <span class="c1"># generate other particles</span>
    <span class="k">if</span> <span class="n">isSymmetric</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">ystart</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">ab</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">xstart</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">mos</span>
                <span class="c1"># add two particles of one vertical section (double-twist)</span>
                <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span>
                <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">a</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span>
            <span class="c1"># set values for next section</span>
            <span class="n">xstart</span> <span class="o">=</span> <span class="n">xstart</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">mos</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">jump</span><span class="p">)</span>
            <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">jump</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">ystart</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">ab</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">xstart</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">mos</span>
                <span class="c1"># add two particles of one vertical section (double-twist)</span>
                <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span>
                <span class="n">net</span><span class="o">+=</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">sphere</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">a</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)]</span>
            <span class="c1"># set values for next section</span>
            <span class="n">xstart</span> <span class="o">=</span> <span class="n">xstart</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">mos</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">jump</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">net</span><span class="p">,</span><span class="n">lx</span><span class="p">,</span><span class="n">ly</span><span class="p">]</span></div>


<span class="c1">#</span>
<span class="c1"># stresses for isotropic compaction (load/unload) in dense packing routines</span>
<span class="c1"># those are changed after stress computation fixes in PeriIsoCompressor</span>
<span class="c1"># and must be re-adjusted to work well with default materials</span>
<span class="c1">#</span>
<span class="c1"># they used to be -100e9,-1e6</span>
<span class="c1">#</span>
<span class="n">PERI_SIG1</span><span class="p">,</span><span class="n">PERI_SIG2</span><span class="o">=-</span><span class="mf">1e7</span><span class="p">,</span><span class="o">-</span><span class="mf">1e5</span>


<div class="viewcode-block" id="makePeriodicFeedPack"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.makePeriodicFeedPack">[docs]</a><span class="k">def</span> <span class="nf">makePeriodicFeedPack</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="n">psd</span><span class="p">,</span><span class="n">lenAxis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">damping</span><span class="o">=.</span><span class="mi">3</span><span class="p">,</span><span class="n">porosity</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span><span class="n">goal</span><span class="o">=.</span><span class="mi">15</span><span class="p">,</span><span class="n">maxNum</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">dontBlock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">returnSpherePack</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">memoizeDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">clumps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">gen</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">memoizeDir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dontBlock</span><span class="p">:</span>
        <span class="c1"># increase number at the end for every change in the algorithm to make old feeds incompatible</span>
        <span class="n">params</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">psd</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">goal</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">damping</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">porosity</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">lenAxis</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">clumps</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">gen</span> <span class="k">else</span> <span class="n">gen</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;expr&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">noMagic</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;5&#39;</span>
        <span class="kn">import</span> <span class="nn">hashlib</span>
        <span class="n">paramHash</span><span class="o">=</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">memoizeFile</span><span class="o">=</span><span class="n">memoizeDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">paramHash</span><span class="o">+</span><span class="s1">&#39;.perifeed&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Memoize file is &#39;</span><span class="p">,</span><span class="n">memoizeFile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">memoizeDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">paramHash</span><span class="o">+</span><span class="s1">&#39;.perifeed&#39;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Returning memoized result&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">gen</span><span class="p">:</span>
                <span class="n">sp</span><span class="o">=</span><span class="n">SpherePack</span><span class="p">()</span>
                <span class="n">sp</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">memoizeFile</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">returnSpherePack</span><span class="p">:</span> <span class="k">return</span> <span class="n">sp</span>
                <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span><span class="p">[</span><span class="n">lenAxis</span><span class="p">],]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">woo.dem</span>
                <span class="n">sp</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">ShapePack</span><span class="p">(</span><span class="n">loadFrom</span><span class="o">=</span><span class="n">memoizeFile</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">sp</span>
    <span class="n">p3</span><span class="o">=</span><span class="n">porosity</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">psd</span><span class="p">:</span> <span class="n">rMax</span><span class="o">=</span><span class="n">psd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span><span class="s1">&#39;psdPts&#39;</span><span class="p">):</span> <span class="n">rMax</span><span class="o">=</span><span class="n">gen</span><span class="o">.</span><span class="n">psdPts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Generators without PSD do not inform about the biggest particle radius.&#39;</span><span class="p">)</span>
    <span class="n">minSize</span><span class="o">=</span><span class="n">rMax</span><span class="o">*</span><span class="mi">5</span>
    <span class="n">cellSize</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">p3</span><span class="p">,</span><span class="n">minSize</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">p3</span><span class="p">,</span><span class="n">minSize</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">p3</span><span class="p">,</span><span class="n">minSize</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;dimension&#39;</span><span class="p">,</span><span class="n">dim</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;initial cell size&#39;</span><span class="p">,</span><span class="n">cellSize</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;psd=&#39;</span><span class="p">,</span><span class="n">psd</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">woo.core</span><span class="o">,</span> <span class="nn">woo.dem</span><span class="o">,</span> <span class="nn">math</span>
    <span class="n">S</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Scene</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">DemField</span><span class="p">()])</span>
    <span class="n">S</span><span class="o">.</span><span class="n">periodic</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">setBox</span><span class="p">(</span><span class="n">cellSize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gen</span><span class="p">:</span> <span class="n">generator</span><span class="o">=</span><span class="n">gen</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">clumps</span><span class="p">:</span> <span class="n">generator</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">PsdSphereGenerator</span><span class="p">(</span><span class="n">psdPts</span><span class="o">=</span><span class="n">psd</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">generator</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">PsdClumpGenerator</span><span class="p">(</span><span class="n">psdPts</span><span class="o">=</span><span class="n">psd</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">clumps</span><span class="o">=</span><span class="n">clumps</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="o">=</span><span class="p">[</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">InsertionSortCollider</span><span class="p">([</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Bo1_Sphere_Aabb</span><span class="p">()]),</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">BoxInlet</span><span class="p">(</span>
            <span class="n">box</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">cellSize</span><span class="p">),</span>
            <span class="n">maxMass</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">maxNum</span><span class="o">=</span><span class="n">maxNum</span><span class="p">,</span>
            <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
            <span class="n">massRate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">maxAttempts</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
            <span class="n">materials</span><span class="o">=</span><span class="p">[</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">FrictMat</span><span class="p">(</span><span class="n">density</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">young</span><span class="o">=</span><span class="mf">1e7</span><span class="p">,</span><span class="n">ktDivKn</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span><span class="n">tanPhi</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="p">))],</span>
            <span class="n">shooter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span>
    <span class="c1"># if dontBlock: return S</span>
    <span class="n">S</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created </span><span class="si">%d</span><span class="s1"> particles, compacting...&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="p">)))</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dt</span><span class="o">=.</span><span class="mi">9</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">pWaveDt</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">noClumps</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dtSafety</span><span class="o">=.</span><span class="mi">9</span>
    <span class="k">if</span> <span class="n">clumps</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;utils.pWaveDt called with noClumps=True (clumps ignored), the result (S.dt=</span><span class="si">%g</span><span class="s1">) might be significantly off!&#39;</span><span class="o">%</span><span class="n">S</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="o">=</span><span class="p">[</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">PeriIsoCompressor</span><span class="p">(</span><span class="n">charLen</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">rMax</span><span class="p">,</span><span class="n">stresses</span><span class="o">=</span><span class="p">[</span><span class="n">PERI_SIG1</span><span class="p">,</span><span class="n">PERI_SIG2</span><span class="p">],</span><span class="n">maxUnbalanced</span><span class="o">=</span><span class="n">goal</span><span class="p">,</span><span class="n">doneHook</span><span class="o">=</span><span class="s1">&#39;print(&quot;done&quot;); S.stop();&#39;</span><span class="p">,</span><span class="n">globalUpdateInt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepProportions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;peri&#39;</span><span class="p">),</span>
        <span class="c1"># plots only useful for debugging - uncomment if needed</span>
        <span class="c1"># woo.core.PyRunner(100,&#39;S.plot.addData(i=S.step,unb=S.lab.peri.currUnbalanced,sig=S.lab.peri.sigma)&#39;),</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">PyRunner</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="s1">&#39;print(S.lab.peri.stresses[S.lab.peri.state],S.lab.peri.sigma,S.lab.peri.currUnbalanced)&#39;</span><span class="p">),</span>
    <span class="p">]</span><span class="o">+</span><span class="n">utils</span><span class="o">.</span><span class="n">defaultEngines</span><span class="p">(</span><span class="n">damping</span><span class="o">=</span><span class="n">damping</span><span class="p">,</span><span class="n">dynDtPeriod</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plots</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:(</span><span class="s1">&#39;unb&#39;</span><span class="p">),</span><span class="s1">&#39; i&#39;</span><span class="p">:(</span><span class="s1">&#39;sig_x&#39;</span><span class="p">,</span><span class="s1">&#39;sig_y&#39;</span><span class="p">,</span><span class="s1">&#39;sig_z&#39;</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">dontBlock</span><span class="p">:</span> <span class="k">return</span> <span class="n">S</span>
    <span class="n">S</span><span class="o">.</span><span class="n">run</span><span class="p">();</span> <span class="n">S</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">gen</span><span class="p">:</span> <span class="n">sp</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">ShapePack</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">sp</span><span class="o">=</span><span class="n">SpherePack</span><span class="p">()</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">fromDem</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Packing size is&#39;</span><span class="p">,</span><span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span><span class="p">)</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">canonicalize</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">gen</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">makeOverlapFree</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loose packing size is&#39;</span><span class="p">,</span><span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span><span class="p">)</span>
    <span class="n">cc</span><span class="p">,</span><span class="n">rr</span><span class="o">=</span><span class="p">[],[]</span>
    <span class="n">inf</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="n">boxMin</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">boxMax</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
    <span class="n">boxMin</span><span class="p">[</span><span class="n">lenAxis</span><span class="p">]</span><span class="o">=-</span><span class="n">inf</span>
    <span class="n">boxMax</span><span class="p">[</span><span class="n">lenAxis</span><span class="p">]</span><span class="o">=</span><span class="n">inf</span>
    <span class="n">box</span><span class="o">=</span><span class="n">AlignedBox3</span><span class="p">(</span><span class="n">boxMin</span><span class="p">,</span><span class="n">boxMax</span><span class="p">)</span>
    <span class="n">sp2</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="n">inAlignedBox</span><span class="p">(</span><span class="n">box</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Box is &#39;</span><span class="p">,</span><span class="n">box</span><span class="p">)</span>
    <span class="c1">#for c,r in sp:</span>
    <span class="c1">#    if c-Vector3(r,r,r) not in box or c+Vector3(r,r,r) not in box: continue</span>
    <span class="c1">#    cc.append(c); rr.append(r)</span>
    <span class="k">if</span> <span class="n">memoizeDir</span> <span class="ow">or</span> <span class="n">returnSpherePack</span> <span class="ow">or</span> <span class="n">gen</span><span class="p">:</span>
        <span class="c1">#sp2=SpherePack()</span>
        <span class="c1">#sp2.fromList(cc,rr)</span>
        <span class="c1">#sp2.cellSize=sp.cellSize</span>
        <span class="k">if</span> <span class="n">memoizeDir</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving to&#39;</span><span class="p">,</span><span class="n">memoizeFile</span><span class="p">)</span>
            <span class="c1"># print len(sp2)</span>
            <span class="n">sp2</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">memoizeFile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">returnSpherePack</span> <span class="ow">or</span> <span class="n">gen</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sp2</span>
    <span class="n">cc</span><span class="p">,</span><span class="n">rr</span><span class="o">=</span><span class="n">sp2</span><span class="o">.</span><span class="n">toCcRr</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cc</span><span class="p">,</span><span class="n">rr</span><span class="p">,</span><span class="n">sp2</span><span class="o">.</span><span class="n">cellSize</span><span class="p">[</span><span class="n">lenAxis</span><span class="p">]</span></div>




<div class="viewcode-block" id="makeBandFeedPack"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.makeBandFeedPack">[docs]</a><span class="k">def</span> <span class="nf">makeBandFeedPack</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">gravity</span><span class="p">,</span><span class="n">psd</span><span class="o">=</span><span class="p">[],</span><span class="n">excessWd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">damping</span><span class="o">=.</span><span class="mi">3</span><span class="p">,</span><span class="n">porosity</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span><span class="n">goal</span><span class="o">=.</span><span class="mi">15</span><span class="p">,</span><span class="n">dtSafety</span><span class="o">=.</span><span class="mi">9</span><span class="p">,</span><span class="n">dontBlock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">memoizeDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">botLine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">leftLine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rightLine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">clumps</span><span class="o">=</span><span class="p">[],</span><span class="n">returnSpherePack</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">useEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">gen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create dense packing periodic in the +x direction, suitable for use with ConveyorInlet.</span>
<span class="sd">:param useEnergy: use :obj:`woo.utils.unbalancedEnergy` instead of :obj:`woo.utils.unbalancedForce` as stop criterion.</span>
<span class="sd">:param goal: target unbalanced force/energy; if unbalanced energy is used, this value is **multiplied by .2**.</span>
<span class="sd">:param psd: particle size distribution</span>
<span class="sd">:param mat: material for particles</span>
<span class="sd">:param gravity: gravity acceleration (as Vector3)</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="c1"># log.info(&#39;woo.pack.makeBandFeedPack(dim=%s,psd=%s,mat=%s,gravity=%s,excessWd=%s,damping=%s,dontBlock=True,botLine=%s,leftLine=%s,rightLine=%s,clumps=%s,gen=%s,bias=%s)&#39;%(repr(dim),repr(psd),mat.dumps(format=&#39;expr&#39;,width=-1,noMagic=True),repr(gravity),repr(excessWd),repr(damping),repr(botLine),repr(leftLine),repr(rightLine),repr(clumps),(gen.dumps(format=&#39;expr&#39;,width=-1,noMagic=True) if gen is not None else &#39;None&#39;),(bias.dumps(format=&#39;expr&#39;,width=-1,noMagic=True) if bias is not None else &#39;None&#39;)))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;woo.pack.makeBandFeedPack(dim=</span><span class="si">{dim}</span><span class="s1">,psd=</span><span class="si">{psd}</span><span class="s1">,mat={mat.dumps(format=&quot;expr&quot;,width=-1,noMagic=True)},gravity=</span><span class="si">{gravity}</span><span class="s1">,excessWd=</span><span class="si">{excessWd}</span><span class="s1">,damping=</span><span class="si">{damping}</span><span class="s1">,dontBlock=</span><span class="si">{dontBlock}</span><span class="s1">,botLine=</span><span class="si">{botLine}</span><span class="s1">,leftLine=</span><span class="si">{leftLine}</span><span class="s1">,rightLine=</span><span class="si">{rightLine}</span><span class="s1">,clumps=</span><span class="si">{clumps}</span><span class="s1">,gen={gen.dumps(format=&quot;expr&quot;,width=-1,noMagic=True)},bias={bias.dumps(format=&quot;expr&quot;,width=-1,noMagic=True) if bias else None})&#39;</span><span class="p">)</span>
    <span class="n">dim</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="c1"># make modifiable in case of excess width</span>



    <span class="n">retWd</span><span class="o">=</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nRepeatCells</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># if 0, repetition is disabled</span>
    <span class="c1"># too wide band is created by repeating narrower one</span>
    <span class="k">if</span> <span class="n">excessWd</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">excessWd</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;makeBandFeedPack: excess with </span><span class="si">%g</span><span class="s1">&gt;</span><span class="si">%g</span><span class="s1">, using </span><span class="si">%g</span><span class="s1"> with packing repeated&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">excessWd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">excessWd</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">retWd</span><span class="o">=</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># this var is used at the end</span>
            <span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">excessWd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nRepeatCells</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">retWd</span><span class="o">/</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">cellSize</span><span class="o">=</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">],(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">porosity</span><span class="p">)</span><span class="o">*</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cell size </span><span class="si">%s</span><span class="s1">, target height </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">cellSize</span><span class="p">,</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">factoryBottom</span><span class="o">=.</span><span class="mi">3</span><span class="o">*</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">botLine</span> <span class="k">else</span> <span class="nb">max</span><span class="p">([</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">botLine</span><span class="p">])</span> <span class="c1"># point above which are particles generated</span>
    <span class="n">factoryLeft</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">leftLine</span> <span class="k">else</span> <span class="nb">max</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">leftLine</span><span class="p">])</span>
    <span class="c1">#print &#39;factoryLeft =&#39;,factoryLeft,&#39;leftLine =&#39;,leftLine,&#39;cellSize =&#39;,cellSize</span>
    <span class="n">factoryRight</span><span class="o">=</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">rightLine</span> <span class="k">else</span> <span class="nb">min</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rightLine</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">leftLine</span><span class="p">:</span> <span class="n">leftLine</span><span class="o">=</span><span class="p">[</span><span class="n">Vector2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rightLine</span><span class="p">:</span><span class="n">rightLine</span><span class="o">=</span><span class="p">[</span><span class="n">Vector2</span><span class="p">(</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">botLine</span><span class="p">:</span>  <span class="n">botLine</span><span class="o">=</span><span class="p">[</span><span class="n">Vector2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">Vector2</span><span class="p">(</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">)]</span>
    <span class="n">boundary2d</span><span class="o">=</span><span class="n">leftLine</span><span class="o">+</span><span class="n">botLine</span><span class="o">+</span><span class="n">rightLine</span>
    <span class="c1"># boundary clipped to the part filled by particles</span>
    <span class="n">b2c</span><span class="o">=</span><span class="p">[</span><span class="n">Vector2</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">min</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">boundary2d</span><span class="p">]</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Clipped boundary </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">b2c</span><span class="p">)</span>
    <span class="n">b2c</span><span class="o">+=</span><span class="p">[</span><span class="n">b2c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b2c</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="c1"># close the polygon</span>
    <span class="n">area2d</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">b2c</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">b2c</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">b2c</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">b2c</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]))</span>

    <span class="k">def</span> <span class="nf">printBulkParams</span><span class="p">(</span><span class="n">sp</span><span class="p">):</span>
        <span class="n">volume</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">solidVolume</span><span class="p">()</span> <span class="c1"># works with both ShapePack and SpherePack</span>
        <span class="n">mass</span><span class="o">=</span><span class="n">volume</span><span class="o">*</span><span class="n">mat</span><span class="o">.</span><span class="n">density</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Particle mass: </span><span class="si">%g</span><span class="s1"> kg (volume </span><span class="si">%g</span><span class="s1"> m3, mass density </span><span class="si">%g</span><span class="s1"> kg/m3).&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span><span class="n">volume</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">density</span><span class="p">))</span>
        <span class="n">vol</span><span class="o">=</span><span class="n">area2d</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Bulk density: </span><span class="si">%g</span><span class="s1"> kg/m3 (area </span><span class="si">%g</span><span class="s1"> m2, length </span><span class="si">%g</span><span class="s1"> m).&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">mass</span><span class="o">/</span><span class="n">vol</span><span class="p">,</span><span class="n">area2d</span><span class="p">,</span><span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Porosity: </span><span class="si">%g</span><span class="s1"> </span><span class="si">%%</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">mass</span><span class="o">/</span><span class="n">vol</span><span class="p">)</span><span class="o">/</span><span class="n">mat</span><span class="o">.</span><span class="n">density</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">memoizeDir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dontBlock</span><span class="p">:</span>
        <span class="n">params</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nRepeatCells</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cellSize</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">psd</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">goal</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">damping</span><span class="p">)</span><span class="o">+</span><span class="n">mat</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;expr&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">noMagic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">gravity</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">porosity</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">botLine</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">leftLine</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">rightLine</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">clumps</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">useEnergy</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;expr&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">noMagic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">gen</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">bias</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;expr&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">noMagic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">bias</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;ver7b&#39;</span>
        <span class="kn">import</span> <span class="nn">hashlib</span>
        <span class="n">paramHash</span><span class="o">=</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">memoizeFile</span><span class="o">=</span><span class="n">memoizeDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">paramHash</span><span class="o">+</span><span class="s1">&#39;.bandfeed&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Memoize file is </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">memoizeFile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">memoizeDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">paramHash</span><span class="o">+</span><span class="s1">&#39;.bandfeed&#39;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Returning memoized result&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">gen</span><span class="p">:</span>
                <span class="n">sp</span><span class="o">=</span><span class="n">SpherePack</span><span class="p">()</span>
                <span class="n">sp</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">memoizeFile</span><span class="p">)</span>
                <span class="n">printBulkParams</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">returnSpherePack</span><span class="p">:</span> <span class="k">return</span> <span class="n">sp</span>
                <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">woo.dem</span>
                <span class="n">sp</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">ShapePack</span><span class="p">(</span><span class="n">loadFrom</span><span class="o">=</span><span class="n">memoizeFile</span><span class="p">)</span>
                <span class="n">printBulkParams</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">sp</span>


    <span class="kn">import</span> <span class="nn">woo</span><span class="o">,</span> <span class="nn">woo.core</span><span class="o">,</span> <span class="nn">woo.dem</span>
    <span class="n">S</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Scene</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">DemField</span><span class="p">(</span><span class="n">gravity</span><span class="o">=</span><span class="n">gravity</span><span class="p">)])</span>
    <span class="n">S</span><span class="o">.</span><span class="n">periodic</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">setBox</span><span class="p">(</span><span class="n">cellSize</span><span class="p">)</span>
    <span class="c1"># add limiting surface</span>
    <span class="n">p</span><span class="o">=</span><span class="n">sweptPolylines2gtsSurface</span><span class="p">([</span><span class="n">utils</span><span class="o">.</span><span class="n">tesselatePolyline</span><span class="p">([</span><span class="n">Vector3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">yz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">yz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">yz</span> <span class="ow">in</span> <span class="n">boundary2d</span><span class="p">],</span><span class="n">maxDist</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">4.</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="mi">4</span><span class="p">)])</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gtsSurface2Facets</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="mb">0b011</span><span class="p">),</span><span class="n">nodes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># nodes not needed</span>
    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">## XXX</span>
        <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">wallId</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Wall</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;makeBandFeedPack: Adding artificial wall to avoid periodic-inlet issues (under investigation)&#39;</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">loneMask</span><span class="o">=</span><span class="mb">0b010</span>


    <span class="c1">#massToDoApprox=porosity*mat.density*dim[0]*dim[1]*dim[2]</span>
    <span class="n">massToDoApprox</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">porosity</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="o">.</span><span class="n">density</span><span class="o">*</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">massMin</span><span class="o">=</span><span class="mf">1.</span><span class="o">*</span><span class="n">massToDoApprox</span> <span class="c1"># avoid mistaken finish</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Will need approx </span><span class="si">%g</span><span class="s1"> mass (require </span><span class="si">%g</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">massToDoApprox</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">massMin</span><span class="p">))</span>

    <span class="c1">## FIXME: decrease friction angle to help stabilization</span>
    <span class="n">mat0</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
    <span class="n">mat</span><span class="o">.</span><span class="n">tanPhi</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span><span class="n">mat0</span><span class="o">.</span><span class="n">tanPhi</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gen</span><span class="p">:</span> <span class="n">generator</span><span class="o">=</span><span class="n">gen</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">clumps</span><span class="p">:</span> <span class="n">generator</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">PsdSphereGenerator</span><span class="p">(</span><span class="n">psdPts</span><span class="o">=</span><span class="n">psd</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">generator</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">PsdClumpGenerator</span><span class="p">(</span><span class="n">psdPts</span><span class="o">=</span><span class="n">psd</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">clumps</span><span class="o">=</span><span class="n">clumps</span><span class="p">)</span>
    
    <span class="c1"># todo: move trackEnergy under useEnergy once we don&#39;t need comparisons</span>
    <span class="n">S</span><span class="o">.</span><span class="n">trackEnergy</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">if</span> <span class="n">useEnergy</span><span class="p">:</span>
        <span class="n">unbalancedFunc</span><span class="o">=</span><span class="s1">&#39;woo.utils.unbalancedEnergy&#39;</span>
        <span class="c1"># smaller goal for energy criterion</span>
        <span class="n">goal</span><span class="o">*=.</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">unbalancedFunc</span><span class="o">=</span><span class="s1">&#39;woo.utils.unbalancedForce&#39;</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">goalHt</span><span class="o">=</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">goalUnb</span><span class="o">=</span><span class="n">goal</span>
    <span class="kn">import</span> <span class="nn">textwrap</span>
    <span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">defaultEngines</span><span class="p">(</span><span class="n">damping</span><span class="o">=</span><span class="n">damping</span><span class="p">,</span><span class="n">dynDtPeriod</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">+</span><span class="p">[</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">BoxInlet</span><span class="p">(</span>
            <span class="n">box</span><span class="o">=</span><span class="p">((</span><span class="o">.</span><span class="mi">01</span><span class="o">*</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">factoryLeft</span><span class="p">,</span><span class="n">factoryBottom</span><span class="p">),(</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">factoryRight</span><span class="p">,</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>
            <span class="n">stepPeriod</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">maxMass</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># massToDo,</span>
            <span class="n">massRate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">maxAttempts</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
            <span class="n">materials</span><span class="o">=</span><span class="p">[</span><span class="n">mat</span><span class="p">],</span>
            <span class="n">shooter</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">AlignedMinMaxShooter</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">vRange</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span>
            <span class="n">mask</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;inlet&#39;</span><span class="p">,</span>
            <span class="n">doneHook</span><span class="o">=</span><span class="s1">&#39;S.dem.par.remove(S.lab.wallId)&#39;</span><span class="p">,</span>
            <span class="n">spatialBias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
            <span class="c1">#periSpanMask=1, # x is periodic</span>
        <span class="p">),</span>
        <span class="c1">#PyRunner(200,&#39;plot.addData(uf=utils.unbalancedForce(),i=O.scene.step)&#39;),</span>
        <span class="c1"># woo.core.PyRunner(300,&#39;import woo\nprint &quot;%g/%g mass, %d particles, unbalanced &#39;+(&#39;energy&#39; if useEnergy else &#39;force&#39;)+&#39;%g/&#39;+str(goal)+&#39;&quot;%(S.lab.factory.mass,S.lab.factory.maxMass,len(S.dem.par),&#39;+unabalncedFunc+&#39;(S))&#39;),</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">PyRunner</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        import woo, woo.utils, math</span>
<span class="s2">        inlet=S.lab.inlet</span>
<span class="s2">        if not inlet.dead:</span>
<span class="s2">            q95=woo.utils.contactCoordQuantiles(S.dem,[.95])[0]</span>
<span class="s2">            unbe=unbf=float(&#39;nan&#39;)</span>
<span class="s2">        else:</span>
<span class="s2">            relq=float(&#39;nan&#39;)</span>
<span class="s2">            unbe,unbf=woo.utils.unbalancedEnergy(S),woo.utils.unbalancedForce(S)</span>
<span class="s2">        print(&#39;rel 95</span><span class="si">%%</span><span class="s2"> ht: </span><span class="si">%s</span><span class="s2"> / </span><span class="si">%g</span><span class="s2">, mass </span><span class="si">%g</span><span class="s2">, </span><span class="si">%d</span><span class="s2"> particles, unbalanced F: </span><span class="si">%g</span><span class="s2"> E: </span><span class="si">%g</span><span class="s2"> / </span><span class="si">%g</span><span class="s2">&#39;%(&#39;OK&#39; if inlet.dead else str(q95),S.lab.goalHt,inlet.mass,len(S.dem.par),unbf,unbf,S.lab.goalUnb))</span>
<span class="s2">        if not inlet.dead and q95&gt;=S.lab.goalHt and inlet.mass&gt;S.lab.massMin:</span>
<span class="s2">            S.lab.leapfrog.damping=min(.9,S.lab.leapfrog.damping*1.5)</span>
<span class="s2">            inlet.dead=True</span>
<span class="s2">            S.dem.par.remove(S.lab.wallId)</span>
<span class="s2">            print(&quot;Particles reach high enough, stopping inlet; waiting for unbalanced E to go below </span><span class="si">%g</span><span class="s2">.&quot;%S.lab.goalUnb)</span>
<span class="s2">        if inlet.dead and unbe&lt;S.lab.goalUnb:</span>
<span class="s2">            print(&quot;Unbalanced E dropped, finished.&quot;)</span>
<span class="s2">            S.stop()</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">))</span>
        <span class="c1"># woo.core.PyRunner(300,&#39;import woo\nprint(&quot;%g/%g mass, %d particles, unbalanced F: %g E: %g /&#39;+str(goal)+&#39;&quot;%(S.lab.factory.mass,S.lab.factory.maxMass,len(S.dem.par),woo.utils.unbalancedForce(S),woo.utils.unbalancedEnergy(S)))&#39;),</span>
        <span class="c1"># woo.core.PyRunner(300,&#39;import woo.utils; relq=woo.utils.contactCoordQuantiles(S.dem,[.95])[0]/S.lab.goalHt; print(&quot;Rel. coord 95% quantile:&quot;,relq);\nif relq&gt;1:\n    S.lab.factory.dead=True; S.dem.par.remove(S.lab.wallId);&#39;),</span>
        <span class="c1"># woo.core.PyRunner(300,&#39;import woo\nif S.lab.factory.dead: S.lab.leapfrog.damping=1.5*%g&#39;%damping),</span>
        <span class="c1"># woo.core.PyRunner(200,&#39;import woo\nif &#39;+unbalancedFunc+&#39;(S)&lt;&#39;+str(goal)+&#39; and S.lab.factory.dead: S.stop()&#39;),</span>
    <span class="p">]</span>
    <span class="c1"># S.dt=.7*utils.spherePWaveDt(psd[0][0],mat.density,mat.young)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dtSafety</span><span class="o">=</span><span class="n">dtSafety</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Inlet box is </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">inlet</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dontBlock</span><span class="p">:</span> <span class="k">return</span> <span class="n">S</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">S</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">S</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">gen</span><span class="p">:</span> <span class="n">sp</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">ShapePack</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">sp</span><span class="o">=</span><span class="n">SpherePack</span><span class="p">()</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">fromDem</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="p">)</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">canonicalize</span><span class="p">()</span>
    <span class="c1"># remove what is above the requested height; starts from 0, but a bit less, use -dim[2] for dimensionality consistency</span>
    <span class="n">sp</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">inAxisRange</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span><span class="n">recenter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">printBulkParams</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nRepeatCells</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;nRepeatCells=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">nRepeatCells</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">cellRepeat</span><span class="p">(</span><span class="n">Vector3i</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nRepeatCells</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">Vector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">nRepeatCells</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">sp</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">inAxisRange</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">retWd</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">retWd</span><span class="o">/</span><span class="mf">2.</span><span class="p">)),</span><span class="n">recenter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">Vector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-.</span><span class="mi">5</span><span class="o">*</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">))</span>
    <span class="c1"># only periodic along the x-axis</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">memoizeDir</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">memoizeFile</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">saveTxt</span><span class="p">(</span><span class="n">memoizeFile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">returnSpherePack</span> <span class="ow">or</span> <span class="n">gen</span><span class="p">:</span> <span class="k">return</span> <span class="n">sp</span>
    <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span></div>


<span class="c1">##</span>
<span class="c1">## an attempt at a better randomDensePack</span>
<span class="c1">## currently ShapePack does not support moving, or the interface is not clear, so it just waits here</span>


<span class="k">def</span> <span class="nf">_randomDensePack2_singleCell</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span><span class="n">iniBoxSize</span><span class="p">,</span><span class="n">memoizeDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Helper function for :obj:`randomDensePack2`, operating on a single cell (no tiling or predicate filtering).</span>

<span class="sd">    :param woo.dem.ParticleGenerator generator: predicate generator object</span>
<span class="sd">    :param minieigen.Vector3 iniBoxSize: periodic cell size for loose packing generation</span>
<span class="sd">    :param str or None memoizeDir: directory for memoizing the result</span>
<span class="sd">    :param bool debug: return :obj:`~woo.core.Scene` object for compaction instead of the packing</span>
<span class="sd">    :returns: periodic and canonicalized :obj:`woo.dem.ShapePack` instance (unless *debug* is ``True``)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">memoizeDir</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">hashlib</span>
        <span class="c1"># increase hash version every time the algorithm is tuned</span>
        <span class="n">hashbase</span><span class="o">=</span><span class="s1">&#39;hash version 3 &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iniBoxSize</span><span class="p">)</span><span class="o">+</span><span class="n">generator</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;expr&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">noMagic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">hashbase</span><span class="p">)</span>
        <span class="nb">hash</span><span class="o">=</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">hashbase</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">memo</span><span class="o">=</span><span class="n">memoizeDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nb">hash</span><span class="o">+</span><span class="s1">&#39;.randomdense&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Memoize file is </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">memo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">memo</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Returning memoized result&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">ShapePack</span><span class="p">(</span><span class="n">loadFrom</span><span class="o">=</span><span class="n">memo</span><span class="p">)</span>

    <span class="c1"># compaction scene</span>
    <span class="n">S</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Scene</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">DemField</span><span class="p">()])</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dtSafety</span><span class="o">=.</span><span class="mi">9</span>
    <span class="n">S</span><span class="o">.</span><span class="n">periodic</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">setBox</span><span class="p">(</span><span class="n">iniBoxSize</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="o">=</span><span class="p">[</span>    
        <span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">InsertionSortCollider</span><span class="p">([</span><span class="n">c</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">woo</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">childClasses</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">BoundFunctor</span><span class="p">)]),</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">BoxInlet</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">iniBoxSize</span><span class="p">),</span><span class="n">maxMass</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">maxNum</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span><span class="n">massRate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">maxAttempts</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">materials</span><span class="o">=</span><span class="p">[</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">FrictMat</span><span class="p">(</span><span class="n">density</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">young</span><span class="o">=</span><span class="mf">1e7</span><span class="p">,</span><span class="n">ktDivKn</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span><span class="n">tanPhi</span><span class="o">=.</span><span class="mi">1</span><span class="p">)],</span><span class="n">shooter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="c1"># if debug: return S</span>
    <span class="n">S</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created </span><span class="si">%d</span><span class="s1"> particles, compacting...&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="p">))</span>
    <span class="n">goal</span><span class="o">=.</span><span class="mi">15</span>
    <span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="o">=</span><span class="p">[</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">PeriIsoCompressor</span><span class="p">(</span><span class="n">charLen</span><span class="o">=</span><span class="n">generator</span><span class="o">.</span><span class="n">minMaxDiam</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">stresses</span><span class="o">=</span><span class="p">[</span><span class="n">PERI_SIG1</span><span class="p">,</span><span class="n">PERI_SIG2</span><span class="p">],</span><span class="n">maxUnbalanced</span><span class="o">=</span><span class="n">goal</span><span class="p">,</span><span class="n">doneHook</span><span class="o">=</span><span class="s1">&#39;print(&quot;done&quot;); S.stop()&#39;</span><span class="p">,</span><span class="n">globalUpdateInt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepProportions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;peri&#39;</span><span class="p">),</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">PyRunner</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="s1">&#39;print(S.lab.peri.stresses[S.lab.peri.state], S.lab.peri.sigma, S.lab.peri.currUnbalanced)&#39;</span><span class="p">)]</span><span class="o">+</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">DemField</span><span class="o">.</span><span class="n">minimalEngines</span><span class="p">(</span><span class="n">damping</span><span class="o">=.</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plots</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:(</span><span class="s1">&#39;unb&#39;</span><span class="p">),</span><span class="s1">&#39; i&#39;</span><span class="p">:(</span><span class="s1">&#39;sig_x&#39;</span><span class="p">,</span><span class="s1">&#39;sig_y&#39;</span><span class="p">,</span><span class="s1">&#39;sig_z&#39;</span><span class="p">)}</span>
    <span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="o">+</span><span class="p">[</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">PyRunner</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="s1">&#39;S.plot.addData(i=S.step,unb=S.lab.peri.currUnbalanced,sig=S.lab.peri.sigma)&#39;</span><span class="p">)]</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">collider</span><span class="o">.</span><span class="n">paraPeri</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">return</span> <span class="n">S</span>
    <span class="n">S</span><span class="o">.</span><span class="n">run</span><span class="p">();</span> <span class="n">S</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="n">sp</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">ShapePack</span><span class="p">()</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">fromDem</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Compacted packing size is </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span><span class="p">)</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">canonicalize</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">memoizeDir</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">memo</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">memo</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sp</span>
    


<div class="viewcode-block" id="randomDensePack2"><a class="viewcode-back" href="../../woo.pack.html#woo.pack.randomDensePack2">[docs]</a><span class="k">def</span> <span class="nf">randomDensePack2</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span><span class="n">generator</span><span class="p">,</span><span class="n">settle</span><span class="o">=.</span><span class="mi">3</span><span class="p">,</span><span class="n">approxLoosePoro</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">maxNum</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">memoizeDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">porosity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return dense arrangement of particles clipped by predicate. Particle are losely generated in cuboid volume of sufficient dimensions; the cuboid might be made smaller if *maxNum* were significantly exceeded, and tiled into the predicate volume afterwards.</span>

<span class="sd">    The algorithm computes initial (loose) volume from predicate bounding box using *approxLoosePoro*, and fills periodic cell of that size and aspect ratio (or of a part of it, if *maxNum* would be significantly exceeded) with generated particles. Isotropic compression (via :obj:`woo.dem.PeriIsoCompressor`) is subsequently applied with a predefined material (young 10MPa, no friction) down to 100MPa (and stabilization) and then the sample is unloaded to 1MPa and stabilized (those values are currently hard-coded). The resulting packing is tiled (if smaller than predicate), clipped by the predicate and returned as a :obj:`woo.dem.ShapePack` object (geometry only, no material data).</span>

<span class="sd">    The packing is not completely overlap-free, thus using options like :obj:`woo.dem.Law2_L6Geom_FrictPhys_IdealElPl.iniEqlb` might be useful, depending on the stiffness used in the simulation.</span>

<span class="sd">    :param woo.pack.Predicate predicate: volume definition</span>
<span class="sd">    :param woo.dem.ParticleGenerator generator: particle definition</span>
<span class="sd">    :param float settle: relative final volume of dense packing, relative to the loose packing used for generation; usually not necessary to adjust for usual particles, but might have to be made smaller is the initial packing is very loose (significantly elongated particles or clumps and similar)</span>
<span class="sd">    :param int maxNum: maximum number of initial particle; if the number of particles for the initial volume were higher, the predicate volume will be split into smaller periodic cells and the packing will be simply repeated (tiled) to cover the entire predicate volume afterwards.</span>
<span class="sd">    :param float approxLoosePoro: estimate of loose (random) packing proosity for given particles, used for estimating number of particles. **This number is NOT related to the resulting porosity,**, it only has effect on how the predicate volume is partitioned, and thus does not need to be set in most cases.</span>
<span class="sd">    :param memoizeDir: path where memoized packings (named as hashed parameters, plus the `.randomdense` extension) are stored; if None, returned packings are not memoized. If memoized result is found, it is returned immediately, instead of running (often costly) simulation of compaction.</span>
<span class="sd">    :param bool debug: if True, returns :obj:`woo.core.Scene` used for compaction, which can be inspected (instead of the usual :obj:`woo.dem.ShapePack` with dense packing)</span>

<span class="sd">    :returns: :obj:`woo.dem.ShapePack`, unless *debug* is ``True``, in which case a :obj:`~woo.core.Scene` is returned.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># remove at some point</span>
    <span class="k">if</span> <span class="n">porosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;*porosity* argument is no longer supported, use *settle* instead (porosity will be passed on instead of settle for backwards compatibility).&#39;</span><span class="p">,</span><span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="n">settle</span><span class="o">=</span><span class="n">porosity</span>

    <span class="kn">import</span> <span class="nn">woo</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">woo.core</span><span class="o">,</span> <span class="nn">woo.dem</span>
    <span class="n">box</span><span class="o">=</span><span class="n">predicate</span><span class="o">.</span><span class="n">aabb</span><span class="p">()</span>
    <span class="n">boxSize</span><span class="o">=</span><span class="n">box</span><span class="o">.</span><span class="n">sizes</span><span class="p">()</span>
    <span class="n">iniBoxSize</span><span class="o">=</span><span class="n">boxSize</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">settle</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">3.</span><span class="p">)))</span>
    <span class="n">dMin</span><span class="p">,</span><span class="n">dMax</span><span class="o">=</span><span class="n">generator</span><span class="o">.</span><span class="n">minMaxDiam</span><span class="p">()</span>
    <span class="n">vMid</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.</span><span class="o">*</span><span class="p">(</span><span class="n">dMin</span><span class="o">**</span><span class="mi">3</span><span class="o">+</span><span class="n">dMax</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">tiling</span><span class="o">=</span><span class="n">Vector3i</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># number of volume tiles so that the predicate is covered</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">nApprox</span><span class="o">=</span><span class="n">iniBoxSize</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">approxLoosePoro</span><span class="p">)</span><span class="o">/</span><span class="n">vMid</span>
        <span class="k">if</span> <span class="n">nApprox</span><span class="o">&lt;=</span><span class="n">maxNum</span><span class="p">:</span> <span class="k">break</span> <span class="c1"># OK, finished</span>
        <span class="c1"># find longest side of iniBoxSize</span>
        <span class="n">iMax</span><span class="o">=</span><span class="nb">sorted</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">iniBoxSize</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># split it in half, adjust tiling</span>
        <span class="n">iniBoxSize</span><span class="p">[</span><span class="n">iMax</span><span class="p">]</span><span class="o">/=</span><span class="mf">2.</span><span class="p">;</span> <span class="n">tiling</span><span class="p">[</span><span class="n">iMax</span><span class="p">]</span><span class="o">*=</span><span class="mi">2</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dense packing tiling: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">tiling</span><span class="p">)</span>

    <span class="c1"># this does the hard work</span>
    <span class="n">sp</span><span class="o">=</span><span class="n">_randomDensePack2_singleCell</span><span class="p">(</span><span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span><span class="n">iniBoxSize</span><span class="o">=</span><span class="n">iniBoxSize</span><span class="p">,</span><span class="n">memoizeDir</span><span class="o">=</span><span class="n">memoizeDir</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">return</span> <span class="n">sp</span> <span class="c1"># in this case a Scene object</span>

    <span class="c1"># compute tiling necessary</span>
    <span class="n">tiling2</span><span class="o">=</span><span class="n">Vector3i</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span> <span class="n">tiling2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">boxSize</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="c1"># do we need to warn in case of difference...?</span>
    <span class="k">if</span> <span class="n">tiling</span><span class="o">!=</span><span class="n">tiling2</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;expected tiling &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tiling</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; differs from one necessary to cover the predicate box &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tiling2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; (the latter will be used); predicate has dimensions &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">boxSize</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, dense pack cell &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">cellRepeat</span><span class="p">(</span><span class="n">tiling2</span><span class="p">)</span>
    <span class="c1"># make packing aperiodic and centered at predicate&#39;s center</span>
    <span class="n">spCenter</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">cellSize</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># make aperiodic</span>
    <span class="c1"># translate current center to predicate center</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">predicate</span><span class="o">.</span><span class="n">center</span><span class="p">()</span><span class="o">-</span><span class="n">spCenter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="n">predicate</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">Woo 1.0+rev1-git-681f22d documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">woo.pack</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2012−2022, Václav Šmilauer &lt;eu@doxos.eu&gt;.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>