


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>woo.pre.horse &#8212; Woo 1.0+rev1-git-4118aa7 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/cloud.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>

    
    
     
        <script src="../../../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../../../_static/cloud.base.js"></script>
    

    
     
        <script src="../../../_static/cloud.js"></script>
    

    <link rel="shortcut icon" href="../../../_static/woo-favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../../index.html">Woo 1.0+rev1-git-4118aa7 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">woo.pre.horse</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for woo.pre.horse</h1><div class="highlight"><pre>
<span></span><span class="c1"># encoding: utf-8</span>

<span class="kn">from</span> <span class="nn">woo.dem</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">woo.fem</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">woo.core</span>
<span class="kn">import</span> <span class="nn">woo.dem</span>
<span class="kn">import</span> <span class="nn">woo.pyderived</span>
<span class="kn">import</span> <span class="nn">woo.models</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">minieigen</span> <span class="k">import</span> <span class="o">*</span>

<div class="viewcode-block" id="FallingHorse"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.horse.FallingHorse">[docs]</a><span class="k">class</span> <span class="nc">FallingHorse</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Preprocessor</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">pyderived</span><span class="o">.</span><span class="n">PyWooObject</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Preprocessor for the falling horse simulation. The falling horse is historically the demo of Woo. IT shows importing triangulated surfaces, filling imported geometry with particle arrangement, selection of material model, export for VTK (Paraview) and the :obj:`woo.dem.FlowAnalysis` tool. \n\n.. youtube:: LB3T6sBdwz0</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">_classTraits</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_PAT</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">pyderived</span><span class="o">.</span><span class="n">PyAttrTrait</span> <span class="c1"># less typing</span>
    <span class="n">_attrTraits</span><span class="o">=</span><span class="p">[</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span><span class="o">.</span><span class="mi">002</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;mm&#39;</span><span class="p">,</span><span class="n">startGroup</span><span class="o">=</span><span class="s1">&#39;General&#39;</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Radius of spheres (fill of the upper horse)&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;relGap&#39;</span><span class="p">,</span><span class="o">.</span><span class="mi">25</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Gap between particles in pattern, relative to :obj:`radius`&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;halfThick&#39;</span><span class="p">,</span><span class="o">.</span><span class="mi">002</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;mm&#39;</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Half-thickness of the mesh.&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;relEkStop&#39;</span><span class="p">,</span><span class="o">.</span><span class="mi">02</span><span class="p">,</span><span class="s1">&#39;Stop when kinetic energy drops below this fraction of gravity work (and step number is greater than 100)&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="n">Vector3</span><span class="p">,</span><span class="s1">&#39;gravity&#39;</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mf">9.81</span><span class="p">),</span><span class="s1">&#39;Gravity acceleration vector&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="n">Vector3</span><span class="p">,</span><span class="s1">&#39;dir&#39;</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s1">&#39;Direction of the upper horse from the lower one. The default is upwards. Will be normalized automatically.&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;pattern&#39;</span><span class="p">,</span><span class="s1">&#39;hexa&#39;</span><span class="p">,</span><span class="n">choice</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hexa&#39;</span><span class="p">,</span><span class="s1">&#39;ortho&#39;</span><span class="p">],</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Pattern to use when filling the volume with spheres&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ContactModelSelector</span><span class="p">,</span><span class="s1">&#39;model&#39;</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ContactModelSelector</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Schwarz&#39;</span><span class="p">,</span><span class="n">restitution</span><span class="o">=.</span><span class="mi">7</span><span class="p">,</span><span class="n">numMat</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">matDesc</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;particles&#39;</span><span class="p">,</span><span class="s1">&#39;mesh&#39;</span><span class="p">],</span><span class="n">mats</span><span class="o">=</span><span class="p">[</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">HertzMat</span><span class="p">(</span><span class="n">density</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span><span class="n">young</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span><span class="n">surfEnergy</span><span class="o">=.</span><span class="mi">4</span><span class="p">,</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">6</span><span class="p">)]),</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Select contact model. The first material is for particles; the second, optional, material, is for the meshed horse (the first material is used if there is no second one).&#39;</span><span class="p">),</span>
        <span class="c1"># _PAT(woo.dem.FrictMat,&#39;meshMat&#39;,None,&#39;Material for the meshed horse; if not given, :obj:`mat` is used here as well.&#39;),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span><span class="s1">&#39;deformable&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="n">startGroup</span><span class="o">=</span><span class="s1">&#39;Deformability&#39;</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Whether the meshed horse is deformable. Note that deformable horse does not track energy and disables plotting.&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span><span class="s1">&#39;stand&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Whether the bottoms of the legs should be fixed (applicable with :obj:`deformable` only)&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;meshDamping&#39;</span><span class="p">,</span><span class="o">.</span><span class="mi">03</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Damping for mesh nodes; only used when then contact :obj:`model` sets zero :obj:`~woo.dem.Leapfrog.damping`. In that case, :obj:`Leapfrog.damping &lt;woo.dem.Leapfrog.damping&gt;` is set to :obj:`meshDamping` and all other nodes set :obj:`woo.dem.DemData.dampingSkip`.&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;dtSafety&#39;</span><span class="p">,</span><span class="o">.</span><span class="mi">3</span><span class="p">,</span><span class="n">startGroup</span><span class="o">=</span><span class="s1">&#39;Tunables&#39;</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Safety factor for :obj:`woo.utils.pWaveDt` and :obj:`woo.dem.DynDt`.&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;reportFmt&#39;</span><span class="p">,</span><span class="s2">&quot;/tmp/</span><span class="si">{tid}</span><span class="s2">.xhtml&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">startGroup</span><span class="o">=</span><span class="s2">&quot;Outputs&quot;</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Report output format; :obj:`Scene.tags &lt;woo.core.Scene.tags&gt;` can be used.&quot;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="s1">&#39;vtkStep&#39;</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="s2">&quot;How often should :obj:`woo.dem.VtkExport` run. If non-positive, never run the export.&quot;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="s1">&#39;vtkFlowStep&#39;</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="s2">&quot;How often should :obj:`VtkFlowExport` run. If non-positive, never run.&quot;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;vtkPrefix&#39;</span><span class="p">,</span><span class="s2">&quot;/tmp/</span><span class="si">{tid}</span><span class="s2">-&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Prefix for saving :obj:`woo.dem.VtkExport` and :obj:`woo.dem.VtkFlowExport` data; formatted with ``format()`` providing :obj:`woo.core.Scene.tags` as keys.&quot;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;Use grid collider (experimental)&#39;</span><span class="p">),</span>
    <span class="p">]</span>
<div class="viewcode-block" id="FallingHorse.__new__"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.horse.FallingHorse.__new__">[docs]</a>    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">=</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wooPyInit</span><span class="p">(</span><span class="n">FallingHorse</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Preprocessor</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Preprocessor</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wooPyInit</span><span class="p">(</span><span class="n">FallingHorse</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Preprocessor</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
<div class="viewcode-block" id="FallingHorse.__call__"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.horse.FallingHorse.__call__">[docs]</a>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># preprocessor builds the simulation when called</span>
        <span class="k">return</span> <span class="n">prepareHorse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="prepareHorse"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.horse.prepareHorse">[docs]</a><span class="k">def</span> <span class="nf">prepareHorse</span><span class="p">(</span><span class="n">pre</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">woo</span>
    <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">usesApi</span><span class="o">=</span><span class="mi">10102</span>
    <span class="kn">import</span> <span class="nn">woo.gts</span> <span class="k">as</span> <span class="nn">gts</span> <span class="c1"># not sure whether this is necessary</span>
    <span class="kn">import</span> <span class="nn">woo.pack</span><span class="o">,</span> <span class="nn">woo.utils</span><span class="o">,</span> <span class="nn">woo.core</span><span class="o">,</span> <span class="nn">woo</span>
    <span class="kn">import</span> <span class="nn">pkg_resources</span>
    <span class="n">S</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Scene</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">DemField</span><span class="p">()])</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;reportFmt&#39;</span><span class="p">,</span><span class="s1">&#39;vtkPrefix&#39;</span><span class="p">]:</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">fixWindowsPath</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span><span class="n">a</span><span class="p">)))</span>
    <span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span> <span class="c1"># so that our manipulation does not affect input fields</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">gravity</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">gravity</span>
    <span class="c1"># if not pre.meshMat: pre.meshMat=pre.mat.deepcopy()</span>

    <span class="n">mat</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">meshMat</span><span class="o">=</span><span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mats</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="n">mat</span><span class="p">)</span>
    

    <span class="c1"># load the horse</span>
    <span class="c1"># FIXME: pyinstaller should support pkg_resources on package which is frozen as well :|</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span><span class="s1">&#39;frozen&#39;</span><span class="p">):</span> <span class="n">surf</span><span class="o">=</span><span class="n">gts</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_MEIPASS</span><span class="o">+</span><span class="s1">&#39;/data/horse.coarse.gts&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">surf</span><span class="o">=</span><span class="n">gts</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_stream</span><span class="p">(</span><span class="s1">&#39;woo&#39;</span><span class="p">,</span><span class="s1">&#39;data/horse.coarse.gts&#39;</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">surf</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Horse surface not closed?!&#39;</span><span class="p">)</span>
    <span class="n">pred</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">inGtsSurface</span><span class="p">(</span><span class="n">surf</span><span class="p">)</span>
    <span class="n">aabb</span><span class="o">=</span><span class="n">pred</span><span class="o">.</span><span class="n">aabb</span><span class="p">()</span>
    <span class="c1"># filled horse above</span>
    <span class="k">if</span> <span class="n">pre</span><span class="o">.</span><span class="n">pattern</span><span class="o">==</span><span class="s1">&#39;hexa&#39;</span><span class="p">:</span> <span class="n">packer</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">regularHexa</span>
    <span class="k">elif</span> <span class="n">pre</span><span class="o">.</span><span class="n">pattern</span><span class="o">==</span><span class="s1">&#39;ortho&#39;</span><span class="p">:</span> <span class="n">packer</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">regularOrtho</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;FallingHorse.pattern must be one of hexa, ortho (not </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">pre</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">packer</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">relGap</span><span class="o">*</span><span class="n">pre</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">retSpherePack</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="c1"># meshed horse below</span>
    <span class="n">xSpan</span><span class="p">,</span><span class="n">ySpan</span><span class="p">,</span><span class="n">zSpan</span><span class="o">=</span><span class="n">aabb</span><span class="o">.</span><span class="n">sizes</span><span class="p">()</span> <span class="c1"># aabb[1][0]-aabb[0][0],aabb[1][1]-aabb[0][1],aabb[1][2]-aabb[0][2]</span>
    <span class="k">if</span> <span class="n">pre</span><span class="o">.</span><span class="n">dir</span><span class="o">.</span><span class="n">squaredNorm</span><span class="p">()</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span>
        <span class="n">trans</span><span class="o">=-</span><span class="n">pre</span><span class="o">.</span><span class="n">dir</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span><span class="o">*</span><span class="n">zSpan</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">trans</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">zSpan</span><span class="p">)</span>
    <span class="n">surf</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="o">*</span><span class="n">trans</span><span class="p">)</span>
    <span class="n">zMin</span><span class="o">=</span><span class="n">aabb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">trans</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">pre</span><span class="o">.</span><span class="n">halfThick</span>
    <span class="n">xMin</span><span class="p">,</span><span class="n">yMin</span><span class="p">,</span><span class="n">xMax</span><span class="p">,</span><span class="n">yMax</span><span class="o">=</span><span class="n">aabb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">zSpan</span><span class="o">+</span><span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">aabb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">zSpan</span><span class="o">+</span><span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">aabb</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">zSpan</span><span class="o">+</span><span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">aabb</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">zSpan</span><span class="o">+</span><span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">gtsSurface2Facets</span><span class="p">(</span><span class="n">surf</span><span class="p">,</span><span class="n">wire</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">flex</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">deformable</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">meshMat</span><span class="p">,</span><span class="n">halfThick</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">halfThick</span><span class="p">,</span><span class="n">fixed</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">pre</span><span class="o">.</span><span class="n">deformable</span><span class="p">)))</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">wall</span><span class="p">(</span><span class="n">zMin</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">sense</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">meshMat</span><span class="p">,</span><span class="n">glAB</span><span class="o">=</span><span class="p">((</span><span class="n">xMin</span><span class="p">,</span><span class="n">yMin</span><span class="p">),(</span><span class="n">xMax</span><span class="p">,</span><span class="n">yMax</span><span class="p">)),</span><span class="n">mask</span><span class="o">=</span><span class="n">DemField</span><span class="o">.</span><span class="n">defaultMovableMask</span><span class="p">))</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">saveDead</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># for traces, if used</span>
    
    <span class="n">nan</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">pre</span><span class="o">.</span><span class="n">grid</span><span class="p">:</span> <span class="n">collider</span><span class="o">=</span><span class="n">InsertionSortCollider</span><span class="p">([</span><span class="n">Bo1_Sphere_Aabb</span><span class="p">(),</span><span class="n">Bo1_Facet_Aabb</span><span class="p">(),</span><span class="n">Bo1_Wall_Aabb</span><span class="p">()],</span><span class="n">verletDist</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">collider</span><span class="o">=</span><span class="n">GridCollider</span><span class="p">([</span><span class="n">Grid1_Sphere</span><span class="p">(),</span><span class="n">Grid1_Facet</span><span class="p">(),</span><span class="n">Grid1_Wall</span><span class="p">()],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;collider&#39;</span><span class="p">)</span>

    <span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">DemField</span><span class="o">.</span><span class="n">minimalEngines</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="n">grid</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span><span class="n">dynDtPeriod</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="p">)</span><span class="o">+</span><span class="p">[</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">PyRunner</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;S.plot.addData(i=S.step,t=S.time,total=S.energy.total(),relErr=(S.energy.relErr() if S.step&gt;100 else 0),**S.energy)&#39;</span><span class="p">),</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">PyRunner</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="s1">&#39;import woo.pre.horse</span><span class="se">\n</span><span class="s1">if S.step&gt;100 and S.energy[&quot;kinetic&quot;]&lt;S.pre.relEkStop*abs(S.energy[&quot;grav&quot;]): woo.pre.horse.finished(S)&#39;</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">S</span><span class="o">.</span><span class="n">trackEnergy</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">S</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plots</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="s1">&#39;**S.energy&#39;</span><span class="p">),</span><span class="s1">&#39; t&#39;</span><span class="p">:(</span><span class="s1">&#39;relErr&#39;</span><span class="p">)}</span>
    <span class="n">S</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:[</span><span class="n">nan</span><span class="p">],</span><span class="s1">&#39;total&#39;</span><span class="p">:[</span><span class="n">nan</span><span class="p">],</span><span class="s1">&#39;relErr&#39;</span><span class="p">:[</span><span class="n">nan</span><span class="p">]}</span> <span class="c1"># to make plot displayable from the very start</span>

    <span class="k">if</span> <span class="n">pre</span><span class="o">.</span><span class="n">deformable</span><span class="p">:</span>
        <span class="c1"># set damping just for mesh nodes, if particles have no damping</span>
        <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">leapfrog</span><span class="o">.</span><span class="n">damping</span><span class="o">==</span><span class="mf">0.</span><span class="p">:</span>
            <span class="n">setNoDamp</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">leapfrog</span><span class="o">.</span><span class="n">damping</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">meshDamping</span> 
        <span class="k">else</span><span class="p">:</span> <span class="n">setNoDamp</span><span class="o">=</span><span class="kc">False</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">DemData</span><span class="o">.</span><span class="n">setOriMassInertia</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">parRef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="n">Membrane</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pre</span><span class="o">.</span><span class="n">stand</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;-</span><span class="mf">0.22</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">blocked</span><span class="o">=</span><span class="s1">&#39;xyzXYZ&#39;</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># non-membrane</span>
                <span class="k">if</span> <span class="n">setNoDamp</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">dampingSkip</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">!=</span><span class="n">Membrane</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">p</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">DemField</span><span class="o">.</span><span class="n">defaultMovableMask</span><span class="o">|</span><span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">loneMask</span><span class="p">)</span><span class="o">^</span><span class="n">DemField</span><span class="o">.</span><span class="n">defaultOutletMask</span> <span class="c1"># make horse movable, but avoid deletion by the deleter</span>

        <span class="c1"># more complicated here</span>
        <span class="c1"># go through facet&#39;s nodes, give them some mass</span>
        <span class="c1">#nodeM=1e-1*mat.density*(4/3)*math.pi*pre.radius**3</span>
        <span class="c1">#nodeI=3e3*(2/5.)*nodeM*pre.radius**2</span>
        <span class="c1">#for p in S.dem.par:</span>
        <span class="c1">#    if type(p.shape)!=Membrane:</span>
        <span class="c1">#        if not setNoDamp: continue</span>
        <span class="c1">#        for n in p.shape.nodes:</span>
        <span class="c1">#            n.dem.dampingSkip=True</span>
        <span class="c1">#    else:</span>
        <span class="c1">#        for n in p.shape.nodes:</span>
        <span class="c1">#            n.dem.mass=nodeM</span>
        <span class="c1">#            n.dem.inertia=nodeI*Vector3(1,1,1)</span>
        <span class="c1">#            # n.dem.gravitySkip=True</span>

        <span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">IntraForce</span><span class="p">([</span><span class="n">In2_Membrane_ElastMat</span><span class="p">(</span><span class="n">bending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">thickness</span><span class="o">=</span><span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">radius</span> <span class="k">if</span> <span class="n">pre</span><span class="o">.</span><span class="n">halfThick</span><span class="o">&lt;=</span><span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))),</span><span class="n">In2_Sphere_ElastMat</span><span class="p">()])]</span><span class="o">+</span><span class="p">[</span><span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="c1"># put dynDt to the very end</span>
        <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">contactLoop</span><span class="o">.</span><span class="n">applyForces</span><span class="o">=</span><span class="kc">False</span>

    <span class="k">if</span> <span class="n">pre</span><span class="o">.</span><span class="n">grid</span><span class="p">:</span>
        <span class="n">c</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">collider</span>
        <span class="n">zMax</span><span class="o">=</span><span class="nb">max</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="p">])</span>
        <span class="n">c</span><span class="o">.</span><span class="n">domain</span><span class="o">=</span><span class="p">((</span><span class="n">xMin</span><span class="p">,</span><span class="n">yMin</span><span class="p">,</span><span class="n">zMin</span><span class="o">-.</span><span class="mi">01</span><span class="o">*</span><span class="n">zSpan</span><span class="p">),(</span><span class="n">xMax</span><span class="p">,</span><span class="n">yMax</span><span class="p">,</span><span class="n">zMax</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">minCellSize</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">pre</span><span class="o">.</span><span class="n">radius</span>
        <span class="n">c</span><span class="o">.</span><span class="n">verletDist</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="n">pre</span><span class="o">.</span><span class="n">radius</span>

    <span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="o">+</span><span class="p">[</span>
        <span class="n">BoxOutlet</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="p">((</span><span class="n">xMin</span><span class="p">,</span><span class="n">yMin</span><span class="p">,</span><span class="n">zMin</span><span class="o">-.</span><span class="mi">1</span><span class="o">*</span><span class="n">zSpan</span><span class="p">),(</span><span class="n">xMax</span><span class="p">,</span><span class="n">yMax</span><span class="p">,</span><span class="n">aabb</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">+.</span><span class="mi">1</span><span class="o">*</span><span class="n">zSpan</span><span class="p">)),</span><span class="n">inside</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">stepPeriod</span><span class="o">=</span><span class="mi">100</span><span class="p">),</span>
        <span class="n">VtkExport</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">vtkPrefix</span><span class="p">,</span><span class="n">stepPeriod</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">vtkStep</span><span class="p">,</span><span class="n">what</span><span class="o">=</span><span class="n">VtkExport</span><span class="o">.</span><span class="n">all</span><span class="p">,</span><span class="n">dead</span><span class="o">=</span><span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">vtkStep</span><span class="o">&lt;=</span><span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">pre</span><span class="o">.</span><span class="n">vtkPrefix</span><span class="p">)),</span>
        <span class="c1"># VtkFlowExport(out=pre.vtkPrefix+&#39;-flow-&#39;,box=((xMin,yMin,zMin-.1*zSpan),(xMax,yMax,aabb[1][2]+.1*zSpan)),stepPeriod=pre.vtkFlowStep,dead=(pre.vtkFlowStep&lt;=0 or not pre.vtkPrefix),stDev=3*pre.radius,divSize=3*pre.radius),</span>
        <span class="n">FlowAnalysis</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;flowAnalysis&#39;</span><span class="p">,</span><span class="n">box</span><span class="o">=</span><span class="p">((</span><span class="n">xMin</span><span class="p">,</span><span class="n">yMin</span><span class="p">,</span><span class="n">zMin</span><span class="o">-.</span><span class="mi">1</span><span class="o">*</span><span class="n">zSpan</span><span class="p">),(</span><span class="n">xMax</span><span class="p">,</span><span class="n">yMax</span><span class="p">,</span><span class="n">aabb</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">+.</span><span class="mi">1</span><span class="o">*</span><span class="n">zSpan</span><span class="p">)),</span><span class="n">stepPeriod</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">vtkFlowStep</span><span class="p">,</span><span class="n">cellSize</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="n">pre</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span><span class="n">cellData</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dead</span><span class="o">=</span><span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">vtkFlowStep</span><span class="o">&lt;=</span><span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">pre</span><span class="o">.</span><span class="n">vtkPrefix</span><span class="p">)),</span>
    <span class="p">]</span><span class="o">+</span><span class="p">(</span>
        <span class="p">[</span><span class="n">Tracer</span><span class="p">(</span><span class="n">stepPeriod</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">compress</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">compSkip</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">dead</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scalar</span><span class="o">=</span><span class="n">Tracer</span><span class="o">.</span><span class="n">scalarVel</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;tracer&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="s1">&#39;opengl&#39;</span> <span class="ow">in</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">features</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="p">)</span>

    <span class="c1">#woo.master.timingEnabled=True</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dtSafety</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">dtSafety</span>
    <span class="kn">import</span> <span class="nn">woo.config</span>
    <span class="k">if</span> <span class="s1">&#39;opengl&#39;</span> <span class="ow">in</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
        <span class="n">S</span><span class="o">.</span><span class="n">gl</span><span class="p">(</span>
            <span class="n">woo</span><span class="o">.</span><span class="n">gl</span><span class="o">.</span><span class="n">Gl1_DemField</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="s1">&#39;spheroids&#39;</span><span class="p">,</span><span class="n">colorBy</span><span class="o">=</span><span class="s1">&#39;vel&#39;</span><span class="p">,</span><span class="n">deadNodes</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">woo</span><span class="o">.</span><span class="n">gl</span><span class="o">.</span><span class="n">Gl1_Membrane</span><span class="p">(</span><span class="n">relPhi</span><span class="o">=</span><span class="mf">0.</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">S</span></div>

<div class="viewcode-block" id="plotBatchResults"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.horse.plotBatchResults">[docs]</a><span class="k">def</span> <span class="nf">plotBatchResults</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="s1">&#39;Hook called from woo.batch.writeResults&#39;</span>

    <span class="kn">import</span> <span class="nn">re</span><span class="o">,</span><span class="nn">math</span><span class="o">,</span><span class="nn">woo.batch</span><span class="o">,</span><span class="nn">os</span>
    <span class="n">results</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">dbReadResults</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">out</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.pdf&#39;</span><span class="o">%</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\.hdf5$&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">db</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="k">import</span> <span class="n">Figure</span>
    <span class="kn">from</span> <span class="nn">matplotlib.backends.backend_agg</span> <span class="k">import</span> <span class="n">FigureCanvasAgg</span>
    <span class="n">fig</span><span class="o">=</span><span class="n">Figure</span><span class="p">();</span>
    <span class="n">canvas</span><span class="o">=</span><span class="n">FigureCanvasAgg</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Kinetic energy [J]&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Relative energy error&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">series</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;series&#39;</span><span class="p">]</span>
        <span class="n">pre</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;pre&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]:</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;sceneId&#39;</span><span class="p">]</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">series</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">],</span><span class="n">series</span><span class="p">[</span><span class="s1">&#39;kinetic&#39;</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">series</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">],</span><span class="n">series</span><span class="p">[</span><span class="s1">&#39;relErr&#39;</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span><span class="n">loc</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span><span class="s1">&#39;lower left&#39;</span><span class="p">),(</span><span class="n">ax2</span><span class="p">,</span><span class="s1">&#39;lower right&#39;</span><span class="p">):</span>
        <span class="n">l</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span><span class="n">labelspacing</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">7</span><span class="p">})</span>
        <span class="n">l</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="o">.</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Batch figure saved to file://</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">out</span><span class="p">))</span></div>

    

<div class="viewcode-block" id="finished"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.horse.finished">[docs]</a><span class="k">def</span> <span class="nf">finished</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">re</span><span class="o">,</span><span class="nn">woo.batch</span><span class="o">,</span><span class="nn">woo.utils</span><span class="o">,</span><span class="nn">codecs</span>
    <span class="n">S</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="n">repName</span><span class="o">=</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">reportFmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">S</span><span class="o">=</span><span class="n">S</span><span class="p">,</span><span class="o">**</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">))))</span> <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">reportFmt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">woo</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">writeResults</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">defaultDb</span><span class="o">=</span><span class="s1">&#39;horse.hdf5&#39;</span><span class="p">,</span><span class="n">series</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">postHooks</span><span class="o">=</span><span class="p">[</span><span class="n">plotBatchResults</span><span class="p">],</span><span class="n">simulationName</span><span class="o">=</span><span class="s1">&#39;horse&#39;</span><span class="p">,</span><span class="n">report</span><span class="o">=</span><span class="p">((</span><span class="s1">&#39;file://&#39;</span><span class="o">+</span><span class="n">repName</span><span class="p">)</span> <span class="k">if</span> <span class="n">repName</span> <span class="k">else</span> <span class="kc">None</span><span class="p">))</span>

    <span class="c1"># energy plot, to show how to add plot to the report</span>
    <span class="c1"># instead of doing pylab stuff here, just get plot object from woo</span>
    <span class="n">figs</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">noShow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">subPlots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">repName</span><span class="p">:</span>
        <span class="n">repExtra</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\.xhtml$&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">repName</span><span class="p">)</span>
        <span class="n">svgs</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">fig</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">figs</span><span class="p">):</span>
            <span class="n">svgs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Figure </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span><span class="n">repExtra</span><span class="o">+</span><span class="s1">&#39;.fig-</span><span class="si">%d</span><span class="s1">.svg&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">svgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">rep</span><span class="o">=</span><span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">repName</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
        <span class="n">html</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">htmlReportHead</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="s1">&#39;Report for falling horse simulation&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&lt;h2&gt;Figures&lt;/h2&gt;&#39;</span><span class="o">+</span><span class="p">(</span>
            <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&lt;h3&gt;&#39;</span><span class="o">+</span><span class="n">svg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="sa">u</span><span class="s1">&#39;&lt;/h3&gt;&#39;</span><span class="o">+</span><span class="s1">&#39;&lt;img src=&quot;</span><span class="si">%s</span><span class="s1">&quot; alt=&quot;</span><span class="si">%s</span><span class="s1">&quot;/&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">svg</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">svg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">svg</span> <span class="ow">in</span> <span class="n">svgs</span><span class="p">])</span>
            <span class="o">+</span><span class="s1">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span>
        <span class="p">)</span>
        <span class="n">rep</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="n">rep</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">woo</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">inBatch</span><span class="p">():</span>
            <span class="kn">import</span> <span class="nn">webbrowser</span>
            <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">repName</span><span class="p">),</span><span class="n">new</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1">## save flow data</span>
    <span class="c1">#if not S.lab.flowAnalysis.dead: S.lab.flowAnalysis.vtkExport(out=S.pre.vtkPrefix)</span>

    <span class="c1"># catch exception if there are no VTK data (disabled in preprocessor)</span>
    <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">vtkPrefix</span> <span class="ow">and</span> <span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">vtkStep</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">vtkFlowStep</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">woo.paraviewscript</span>
            <span class="n">pvscript</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">paraviewscript</span><span class="o">.</span><span class="n">fromEngines</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">expandTags</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">vtkPrefix</span><span class="p">),</span><span class="n">launch</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">woo</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">inBatch</span><span class="p">()))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Paraview script written to&#39;</span><span class="p">,</span><span class="n">pvscript</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span> <span class="k">raise</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../../index.html">Woo 1.0+rev1-git-4118aa7 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">woo.pre.horse</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2012−2022, Václav Šmilauer &lt;eu@doxos.eu&gt;.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>