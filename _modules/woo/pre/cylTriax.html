


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>woo.pre.cylTriax &#8212; Woo 1.0+rev1-git-f169989 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/cloud.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>

    
    
     
        <script src="../../../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../../../_static/cloud.base.js"></script>
    

    
     
        <script src="../../../_static/cloud.js"></script>
    

    <link rel="shortcut icon" href="../../../_static/woo-favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../../index.html">Woo 1.0+rev1-git-f169989 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">woo.pre.cylTriax</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for woo.pre.cylTriax</h1><div class="highlight"><pre>
<span></span><span class="c1"># encoding: utf-8</span>

<span class="kn">from</span> <span class="nn">woo.dem</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">woo.fem</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">woo.core</span>
<span class="kn">import</span> <span class="nn">woo.dem</span>
<span class="kn">import</span> <span class="nn">woo.pyderived</span>
<span class="kn">import</span> <span class="nn">woo.pack</span>
<span class="kn">import</span> <span class="nn">woo</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">minieigen</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<div class="viewcode-block" id="CylTriaxTest"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.cylTriax.CylTriaxTest">[docs]</a><span class="k">class</span> <span class="nc">CylTriaxTest</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Preprocessor</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">pyderived</span><span class="o">.</span><span class="n">PyWooObject</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Preprocessor for cylindrical triaxial test with membrane. The test is run in 3 stages:</span>

<span class="sd">        * compaction, where random loose packing of spheres is compressed to attain the :math:`\sigma_{\rm iso}` (:obj:`sigIso`) pressure in all directions; during this stage, the cylindrical boundary is rigid and resized along main axes (so it can become (slightly) elliptical); friction is turned off during this stage to achieve better compacity; the compaction finishes when stress level is sufficiently close to the desired one, and unbalanced force drops below :obj:`maxUnbalanced`.</span>

<span class="sd">        * Membrane stabilization: once the compression is done, membrane around the cylinder is activated -- loaded with surface pressure and made flexible. Friction is activated at this moment. The cylinder may deform axially (stress-controlled), but lateral deformation is now due to membrane-particle interaction. This stage finishes when unbalanced force drops below 1/10th of :obj:`maxUnbalanced` (the reason is that membrane motion is not considered when computing unbalanced force, only mononodal particles are). Surface pressure is adjusted so that the value of lateral stress (in terms of global stress tensor) is close to :obj:`sigIso`. At the same time, friction is increased from initial zero values</span>

<span class="sd">        * Triaxial compression: displacement-controlled compression along the ``z`` axis, with strain rate increasing until :obj:`maxRates` is reached; the test finishes when axial strain attains :obj:`stopStrain`; during the triaxial phase, lateral pressure is exerted by surface load of membrane elements.</span>

<span class="sd">    Membrane thickness :obj:`memThick` should be set carefully. The article :cite:`Molenkamp1981` discusses membrane thickness relative to maximum grain size, depending on the ratio of grain stiffness and applied stress.</span>

<span class="sd">    Supports are from the same material as *particles*, but they may have their friction reduced (when :obj:`suppTanPhi` is given). </span>

<span class="sd">    .. warning:: There are (unfortunately) quite a few tunables which must be tinkered with to get the desired result (those are in the *Tunables* section: :obj:`dtSafety`, :obj:`massFactor`, :obj:`model.damping &lt;woo.models.ContactModelSelector.damping&gt;`, :obj:`maxUnbalanced`). Several factors are also hard-set in the code, hoping that they will work in different scenarios than those which were tested.</span>

<span class="sd">    .. youtube:: Li13NrIyMYU</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">_classTraits</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_PAT</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">pyderived</span><span class="o">.</span><span class="n">PyAttrTrait</span> <span class="c1"># less typing</span>
    <span class="n">_attrTraits</span><span class="o">=</span><span class="p">[</span>
        <span class="c1">##</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="n">Vector2</span><span class="p">,</span><span class="s1">&#39;htDiam&#39;</span><span class="p">,</span><span class="n">Vector2</span><span class="p">(</span><span class="o">.</span><span class="mi">06</span><span class="p">,</span><span class="o">.</span><span class="mi">04</span><span class="p">),</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="n">startGroup</span><span class="o">=</span><span class="s1">&#39;Geometry &amp; control&#39;</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Initial size of the cylinder (radius and height)&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;memThick&#39;</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Membrane thickness; if negative, relative to largest particle diameter&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;cylDiv&#39;</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="s1">&#39;Number of segments for cylinder (first component)&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;sigIso&#39;</span><span class="p">,</span><span class="o">-</span><span class="mf">500e3</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;Pa&#39;</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Isotropic compaction stress, and lateral stress during the triaxial phase&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;stopStrain&#39;</span><span class="p">,</span><span class="o">-.</span><span class="mi">2</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;%&#39;</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Goal value of axial deformation in the triaxial phase&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="n">Vector2</span><span class="p">,</span><span class="s1">&#39;maxRates&#39;</span><span class="p">,(</span><span class="mf">2e-1</span><span class="p">,</span><span class="mf">1.</span><span class="p">),</span><span class="s1">&#39;Maximum strain rates during the compaction phase (for all axes), and during the triaxial phase in the axial sense.&#39;</span><span class="p">),</span>

        <span class="c1">## materials</span>
        <span class="n">_PAT</span><span class="p">(</span>
            <span class="n">woo</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ContactModelSelector</span><span class="p">,</span><span class="s1">&#39;model&#39;</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ContactModelSelector</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="n">damping</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span><span class="n">numMat</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">matDesc</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;particles&#39;</span><span class="p">,</span><span class="s1">&#39;membrane&#39;</span><span class="p">],</span><span class="n">mats</span><span class="o">=</span><span class="p">[</span>
                <span class="n">FrictMat</span><span class="p">(</span><span class="n">young</span><span class="o">=</span><span class="mf">0.3e9</span><span class="p">,</span><span class="n">ktDivKn</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span><span class="n">tanPhi</span><span class="o">=.</span><span class="mi">4</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="mf">1e8</span><span class="p">),</span>
                <span class="n">FrictMat</span><span class="p">(</span><span class="n">young</span><span class="o">=</span><span class="mf">1.1e6</span><span class="p">,</span><span class="n">ktDivKn</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span><span class="n">tanPhi</span><span class="o">=.</span><span class="mi">4</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="mf">1e8</span><span class="p">)</span>
            <span class="p">]),</span>
            <span class="n">startGroup</span><span class="o">=</span><span class="s1">&#39;Materials&#39;</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Select contact model. The first material is for particles; the second, optional, material, is for the membrane (the first material is used if there is no second one, but its friction is nevertheless reduced during the compaction phase to :obj:`suppTanPhi`).&#39;</span>
        <span class="p">),</span>
        <span class="n">_PAT</span><span class="p">([</span><span class="n">Vector2</span><span class="p">,],</span><span class="s1">&#39;psd&#39;</span><span class="p">,[(</span><span class="mf">2e-3</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mf">2.5e-3</span><span class="p">,</span><span class="o">.</span><span class="mi">2</span><span class="p">),(</span><span class="mf">4e-3</span><span class="p">,</span><span class="mf">1.</span><span class="p">)],</span><span class="n">unit</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mm&#39;</span><span class="p">,</span><span class="s1">&#39;%&#39;</span><span class="p">],</span><span class="n">psd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Particle size distribution of particles; first value is diameter, scond is cummulative mass fraction.&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">([</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">SphereClumpGeom</span><span class="p">],</span><span class="s1">&#39;clumps&#39;</span><span class="p">,[],</span><span class="s2">&quot;Clump definitions (if empty, use spheres, not clumps)&quot;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;spheresFrom&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">existingFilename</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Instead of generating spheres, load them from file (space-separated colums with x,y,z,r entries). The initial cylinder is made to fit inside the packing</span><span class="se">\&#39;</span><span class="s1">s axis-aligned bounding box (the user is responsible for having those spheres inside cylinder). Cylinder geometry (:obj:`htDiam`) and particle sizes (:obj:`psd` and :obj:`clumps`) are ignored.</span><span class="se">\n\n</span><span class="s1">.. note:: :obj:`packCacheDir` is still used as usual to cache packings after compaction (to disable packing cache, set it to empty string), and will take precedence over :obj:`spheresFrom` if compacted packing for the same parameters is already cached.&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;suppTanPhi&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span><span class="s1">&#39;Friction at supports; if NaN, the same as for particles is used. Supports use the same material as particles otherwise.&#39;</span><span class="p">),</span>

        <span class="c1">## output</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;reportFmt&#39;</span><span class="p">,</span><span class="s2">&quot;/tmp/</span><span class="si">{tid}</span><span class="s2">.xhtml&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">startGroup</span><span class="o">=</span><span class="s2">&quot;Outputs&quot;</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Report output format; :obj:`Scene.tags &lt;woo.core.Scene.tags&gt;` can be used.&quot;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;packCacheDir&#39;</span><span class="p">,</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="n">dirname</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Directory where to store pre-generated feed packings; if empty, packing wil be re-generated every time.&quot;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;saveFmt&#39;</span><span class="p">,</span><span class="s2">&quot;/tmp/</span><span class="si">{tid}</span><span class="s2">-</span><span class="si">{stage}</span><span class="s2">.bin.gz&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Savefile format; keys are :obj:`Scene.tags &lt;woo.core.Scene.tags&gt;`; additionally ``</span><span class="si">{stage}</span><span class="s1">`` will be replaced by ``pre-triax`` after membrane stabilization (right before the triaxial compression actually starts) and ``done`` at the very end.&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="s1">&#39;vtkStep&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;Periodicity of saving VTK exports&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;vtkFmt&#39;</span><span class="p">,</span><span class="s1">&#39;/tmp/</span><span class="si">{title}</span><span class="s1">.</span><span class="si">{id}</span><span class="s1">-&#39;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Prefix for VTK exports&#39;</span><span class="p">),</span>
        <span class="c1">#_PAT(int,&#39;backupSaveTime&#39;,1800,doc=&#39;How often to save backup of the simulation (0 or negative to disable)&#39;),</span>

        <span class="c1">## tunables</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;dtSafety&#39;</span><span class="p">,</span><span class="o">.</span><span class="mi">9</span><span class="p">,</span><span class="n">startGroup</span><span class="o">=</span><span class="s1">&#39;Tunables&#39;</span><span class="p">,</span><span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Safety factor, stored in :obj:`woo.core.Scene.dtSafety` and used for computing the initial timestep as well as by :obj:`woo.dem.DynDt` later during the simulation.&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;massFactor&#39;</span><span class="p">,</span><span class="mf">10.</span><span class="p">,</span><span class="s1">&#39;Multiply real mass of particles by this number to obtain the :obj:`woo.dem.WeirdTriaxControl.mass` control parameter&#39;</span><span class="p">),</span>
        <span class="n">_PAT</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;maxUnbalanced&#39;</span><span class="p">,</span><span class="o">.</span><span class="mi">05</span><span class="p">,</span><span class="s1">&#39;Maximum unbalanced force at the end of compaction&#39;</span><span class="p">),</span>
    <span class="p">]</span>
<div class="viewcode-block" id="CylTriaxTest.__new__"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.cylTriax.CylTriaxTest.__new__">[docs]</a>    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">=</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wooPyInit</span><span class="p">(</span><span class="n">CylTriaxTest</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Preprocessor</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Preprocessor</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wooPyInit</span><span class="p">(</span><span class="n">CylTriaxTest</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Preprocessor</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
<div class="viewcode-block" id="CylTriaxTest.__call__"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.cylTriax.CylTriaxTest.__call__">[docs]</a>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># preprocessor builds the simulation when called</span>
        <span class="k">return</span> <span class="n">prepareCylTriax</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="mkFacetCyl"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.cylTriax.mkFacetCyl">[docs]</a><span class="k">def</span> <span class="nf">mkFacetCyl</span><span class="p">(</span><span class="n">aabb</span><span class="p">,</span><span class="n">cylDiv</span><span class="p">,</span><span class="n">suppMat</span><span class="p">,</span><span class="n">sideMat</span><span class="p">,</span><span class="n">suppMask</span><span class="p">,</span><span class="n">sideMask</span><span class="p">,</span><span class="n">suppBlock</span><span class="p">,</span><span class="n">sideBlock</span><span class="p">,</span><span class="n">sideThick</span><span class="p">,</span><span class="n">mass</span><span class="p">,</span><span class="n">inertia</span><span class="p">):</span>
    <span class="s1">&#39;Make closed cylinder from facets. Z is axis of the cylinder. The position is determined by aabb; the cylinder may be elliptical, if the x and y dimensions are different. Return list of particles and list of nodes. The first two nodes in the list are bottom central node and top central node. cylDiv is tuple specifying division in circumferential and axial direcrtion respectively.&#39;</span>
    <span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="n">aabb</span><span class="o">.</span><span class="n">sizes</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">aabb</span><span class="o">.</span><span class="n">sizes</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">C</span><span class="o">=</span><span class="n">aabb</span><span class="o">.</span><span class="n">center</span><span class="p">()</span>
    <span class="n">zMin</span><span class="p">,</span><span class="n">zMax</span><span class="o">=</span><span class="n">aabb</span><span class="o">.</span><span class="n">min</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">aabb</span><span class="o">.</span><span class="n">max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">centrals</span><span class="o">=</span><span class="p">[</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">zMin</span><span class="p">)),</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">zMax</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">centrals</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dem</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">DemData</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">mass</span><span class="o">=</span><span class="n">mass</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">inertia</span><span class="o">=</span><span class="n">inertia</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">blocked</span><span class="o">=</span><span class="s1">&#39;xyzXYZ&#39;</span>

    <span class="n">retParticles</span><span class="o">=</span><span class="p">[]</span>

    <span class="c1"># nodes on the perimeter</span>
    <span class="n">thetas</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">cylDiv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">xxyy</span><span class="o">=</span><span class="p">[</span><span class="n">Vector2</span><span class="p">(</span><span class="n">r1</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)</span><span class="o">+</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">r2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)</span><span class="o">+</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">thetas</span><span class="p">]</span>
    <span class="n">zz</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">zMin</span><span class="p">,</span><span class="n">zMax</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">cylDiv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">nnn</span><span class="o">=</span><span class="p">[[</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">z</span><span class="p">))</span> <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="n">xxyy</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zz</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">nn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nnn</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span><span class="o">==</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nnn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="n">blocked</span><span class="o">=</span><span class="n">suppBlock</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">blocked</span><span class="o">=</span><span class="n">sideBlock</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nn</span><span class="p">:</span>
            <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">DemData</span><span class="p">()</span>
            <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">mass</span><span class="o">=</span><span class="n">mass</span>
            <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">inertia</span><span class="o">=</span><span class="n">inertia</span>
            <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">blocked</span><span class="o">=</span><span class="n">blocked</span>
    <span class="k">def</span> <span class="nf">mkCap</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span><span class="n">central</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">mat</span><span class="p">):</span>
        <span class="n">ret</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">NaN</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nn</span><span class="p">)):</span>
            <span class="c1"># with NaN in fakeVel[0], local linear (interpolated) velocity is zero even if nodes move</span>
            <span class="c1"># that&#39;s what we need at supports, which stretch to the membrane&#39;s edge,</span>
            <span class="c1"># but that is not any physical motion</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Particle</span><span class="p">(</span><span class="n">material</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">Facet</span><span class="p">(</span><span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="n">nn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nn</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">nn</span><span class="p">)],</span><span class="n">central</span><span class="p">],</span><span class="n">fakeVel</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="n">NaN</span><span class="p">,</span><span class="n">NaN</span><span class="p">,</span><span class="n">NaN</span><span class="p">)),</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">))</span>
            <span class="n">nn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">addParRef</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">nn</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">nn</span><span class="p">)]</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">addParRef</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">central</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">addParRef</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ret</span>
    <span class="n">retParticles</span><span class="o">+=</span><span class="n">mkCap</span><span class="p">(</span><span class="n">nnn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">central</span><span class="o">=</span><span class="n">centrals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mask</span><span class="o">=</span><span class="n">suppMask</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">suppMat</span><span class="p">)</span>
    <span class="n">retParticles</span><span class="o">+=</span><span class="n">mkCap</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">nnn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span><span class="n">central</span><span class="o">=</span><span class="n">centrals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">mask</span><span class="o">=</span><span class="n">suppMask</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">suppMat</span><span class="p">)</span> <span class="c1"># reverse to have normals outside</span>
    <span class="k">def</span> <span class="nf">mkAround</span><span class="p">(</span><span class="n">nnAC</span><span class="p">,</span><span class="n">nnBD</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">halfThick</span><span class="p">):</span>
        <span class="n">ret</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nnAC</span><span class="p">)):</span>
            <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">D</span><span class="o">=</span><span class="n">nnAC</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nnBD</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nnAC</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">nnAC</span><span class="p">)],</span><span class="n">nnBD</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">nnBD</span><span class="p">)]</span>
            <span class="n">ret</span><span class="o">+=</span><span class="p">[</span><span class="n">woo</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">Particle</span><span class="p">(</span><span class="n">material</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">Membrane</span><span class="p">(</span><span class="n">nodes</span><span class="o">=</span><span class="n">fNodes</span><span class="p">,</span><span class="n">halfThick</span><span class="o">=</span><span class="n">halfThick</span><span class="p">),</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">fNodes</span> <span class="ow">in</span> <span class="p">((</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">D</span><span class="p">),(</span><span class="n">A</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">C</span><span class="p">))]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">D</span><span class="p">):</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">addParRef</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">C</span><span class="p">):</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">addParRef</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ret</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">nnn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">retParticles</span><span class="o">+=</span><span class="n">mkAround</span><span class="p">(</span><span class="n">nnn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nnn</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">mask</span><span class="o">=</span><span class="n">sideMask</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">sideMat</span><span class="p">,</span><span class="n">halfThick</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="n">sideThick</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">retParticles</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">wire</span><span class="o">=</span><span class="kc">True</span>
    <span class="kn">import</span> <span class="nn">itertools</span>
    <span class="k">return</span> <span class="n">retParticles</span><span class="p">,</span><span class="n">centrals</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">nnn</span><span class="p">))</span></div>

<div class="viewcode-block" id="prepareCylTriax"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.cylTriax.prepareCylTriax">[docs]</a><span class="k">def</span> <span class="nf">prepareCylTriax</span><span class="p">(</span><span class="n">pre</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">woo</span>
    <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">usesApi</span><span class="o">=</span><span class="mi">10102</span>
    <span class="n">margin</span><span class="o">=</span><span class="mf">1.5</span>
    <span class="n">rad</span><span class="p">,</span><span class="n">ht</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="n">pre</span><span class="o">.</span><span class="n">htDiam</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pre</span><span class="o">.</span><span class="n">htDiam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bot</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="n">margin</span><span class="o">*</span><span class="n">ht</span><span class="p">,(</span><span class="mi">1</span><span class="o">+</span><span class="n">margin</span><span class="p">)</span><span class="o">*</span><span class="n">ht</span>
    <span class="n">xymin</span><span class="o">=</span><span class="n">Vector2</span><span class="p">(</span><span class="n">margin</span><span class="o">*</span><span class="n">rad</span><span class="p">,</span><span class="n">margin</span><span class="o">*</span><span class="n">rad</span><span class="p">)</span>
    <span class="n">xymax</span><span class="o">=</span><span class="n">Vector2</span><span class="p">((</span><span class="n">margin</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">rad</span><span class="p">,(</span><span class="n">margin</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">rad</span><span class="p">)</span>
    <span class="n">xydomain</span><span class="o">=</span><span class="n">Vector2</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">margin</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">rad</span><span class="p">,(</span><span class="mi">2</span><span class="o">*</span><span class="n">margin</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">rad</span><span class="p">)</span>
    <span class="n">xymid</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="n">xydomain</span>
    <span class="n">S</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Scene</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">DemField</span><span class="p">()])</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;reportFmt&#39;</span><span class="p">,</span><span class="s1">&#39;packCacheDir&#39;</span><span class="p">,</span><span class="s1">&#39;saveFmt&#39;</span><span class="p">,</span><span class="s1">&#39;vtkFmt&#39;</span><span class="p">]:</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">fixWindowsPath</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span><span class="n">a</span><span class="p">)))</span>
    <span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
    <span class="n">S</span><span class="o">.</span><span class="n">periodic</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">setBox</span><span class="p">(</span><span class="n">xydomain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xydomain</span><span class="p">[</span><span class="mi">1</span><span class="p">],(</span><span class="mi">2</span><span class="o">*</span><span class="n">margin</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ht</span><span class="p">)</span>


    <span class="n">meshMask</span><span class="o">=</span><span class="mb">0b0011</span>
    <span class="n">spheMask</span><span class="o">=</span><span class="mb">0b0001</span>
    <span class="n">loneMask</span><span class="o">=</span><span class="mb">0b0010</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">loneMask</span><span class="o">=</span><span class="n">loneMask</span>

    <span class="c1"># save materials for later manipulation</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">parMat</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">memMat</span><span class="o">=</span><span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mats</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="n">pre</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">())</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">suppMat</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">suppMat</span><span class="o">.</span><span class="n">tanPhi</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">suppTanPhi</span>

    <span class="c1">## generate particles inside cylinder</span>
    <span class="c1"># radius minus polygonal imprecision (circle segment), minus halfThickness of the membrane</span>
    <span class="k">if</span> <span class="n">pre</span><span class="o">.</span><span class="n">memThick</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">pre</span><span class="o">.</span><span class="n">memThick</span><span class="o">*=-</span><span class="n">pre</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">innerRad</span><span class="o">=</span><span class="n">rad</span><span class="o">-</span><span class="n">rad</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">pre</span><span class="o">.</span><span class="n">cylDiv</span><span class="p">))</span><span class="o">-.</span><span class="mi">5</span><span class="o">*</span><span class="n">pre</span><span class="o">.</span><span class="n">memThick</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">memThick</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">memThick</span>

    <span class="k">if</span> <span class="n">pre</span><span class="o">.</span><span class="n">packCacheDir</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">hashlib</span><span class="o">,</span><span class="nn">os</span>
        <span class="n">compactMemoize</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">packCacheDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">((</span><span class="n">pre</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;expr&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">noMagic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;ver3&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.triax-compact&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Compaction memoize file is &#39;</span><span class="p">,</span><span class="n">compactMemoize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">compactMemoize</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="c1"># no memoize file</span>

    <span class="k">if</span> <span class="n">pre</span><span class="o">.</span><span class="n">packCacheDir</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">compactMemoize</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using memoized compact state&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">SpherePack</span><span class="p">()</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">compactMemoize</span><span class="p">)</span>
        <span class="n">meshAabb</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">userData</span><span class="p">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">compactMemoize</span><span class="o">=</span><span class="kc">None</span> <span class="c1"># none means we just loaded that file</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">toSimulation</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">parMat</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pre</span><span class="o">.</span><span class="n">spheresFrom</span><span class="p">:</span>
            <span class="n">pack</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">SpherePack</span><span class="p">()</span>
            <span class="n">pack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">spheresFrom</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pack</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">randomLoosePsd</span><span class="p">(</span><span class="n">predicate</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">inCylinder</span><span class="p">(</span><span class="n">centerBottom</span><span class="o">=</span><span class="p">(</span><span class="n">xymid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xymid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">bot</span><span class="p">),</span><span class="n">centerTop</span><span class="o">=</span><span class="p">(</span><span class="n">xymid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xymid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">top</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">innerRad</span><span class="p">),</span><span class="n">psd</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">psd</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">parMat</span><span class="p">,</span><span class="n">clumps</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">clumps</span><span class="p">,</span><span class="n">returnSpherePack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pack</span><span class="o">.</span><span class="n">toSimulation</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
        <span class="n">meshAabb</span><span class="o">=</span><span class="n">AlignedBox3</span><span class="p">((</span><span class="n">xymin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xymin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">bot</span><span class="p">),(</span><span class="n">xymax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xymax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">top</span><span class="p">))</span>
        <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">compactMemoize</span><span class="o">=</span><span class="n">compactMemoize</span>

    <span class="n">sumParMass</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">mass</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="p">])</span>

    <span class="c1"># create mesh (supports+membrane)</span>
    <span class="n">cylDivHt</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ht</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">rad</span><span class="o">/</span><span class="n">pre</span><span class="o">.</span><span class="n">cylDiv</span><span class="p">)))</span> <span class="c1"># try to be as square as possible</span>
    <span class="n">nodeMass</span><span class="o">=</span><span class="p">(</span><span class="n">ht</span><span class="o">/</span><span class="n">cylDivHt</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">pre</span><span class="o">.</span><span class="n">memThick</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">memMat</span><span class="o">.</span><span class="n">density</span> <span class="c1"># approx mass of square slab of our size</span>
    <span class="n">nodeInertia</span><span class="o">=</span><span class="p">((</span><span class="mi">3</span><span class="o">/</span><span class="mf">4.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">nodeMass</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">6</span><span class="o">/</span><span class="mf">15.</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="c1"># inertial of sphere with the same mass</span>
    <span class="n">particles</span><span class="p">,</span><span class="n">nodes</span><span class="o">=</span><span class="n">mkFacetCyl</span><span class="p">(</span>
        <span class="n">aabb</span><span class="o">=</span><span class="n">meshAabb</span><span class="p">,</span>
        <span class="n">cylDiv</span><span class="o">=</span><span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">cylDiv</span><span class="p">,</span><span class="n">cylDivHt</span><span class="p">),</span>
        <span class="n">suppMask</span><span class="o">=</span><span class="n">meshMask</span><span class="p">,</span><span class="n">sideMask</span><span class="o">=</span><span class="n">meshMask</span><span class="p">,</span>
        <span class="n">sideBlock</span><span class="o">=</span><span class="s1">&#39;xyzXYZ&#39;</span><span class="p">,</span><span class="n">suppBlock</span><span class="o">=</span><span class="s1">&#39;xyzXYZ&#39;</span><span class="p">,</span>
        <span class="n">mass</span><span class="o">=</span><span class="n">nodeMass</span><span class="p">,</span><span class="n">inertia</span><span class="o">=</span><span class="n">nodeInertia</span><span class="o">*</span><span class="n">Vector3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">suppMat</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">suppMat</span><span class="p">,</span><span class="n">sideMat</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">memMat</span><span class="p">,</span>
        <span class="n">sideThick</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">memThick</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">cylNodes</span><span class="o">=</span><span class="n">nodes</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span><span class="n">nodes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># add all nodes (may be the same automatic?)</span>


    <span class="c1">#S.dt=pre.pWaveSafety*woo.utils.pWaveDt(S,noClumps=True)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">dtSafety</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">dtSafety</span>
    <span class="k">if</span> <span class="n">pre</span><span class="o">.</span><span class="n">clumps</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: clumps used, Scene.dt might not be correct; lower CylTriaxTest.dtSafety (currently </span><span class="si">%g</span><span class="s1">) if the simulation is unstable&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">dtSafety</span><span class="p">))</span>
    <span class="c1"># setup engines</span>
    <span class="n">S</span><span class="o">.</span><span class="n">engines</span><span class="o">=</span><span class="p">[</span>
        <span class="n">WeirdTriaxControl</span><span class="p">(</span><span class="n">goal</span><span class="o">=</span><span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">sigIso</span><span class="p">,</span><span class="n">pre</span><span class="o">.</span><span class="n">sigIso</span><span class="p">,</span><span class="n">pre</span><span class="o">.</span><span class="n">sigIso</span><span class="p">),</span><span class="n">maxStrainRate</span><span class="o">=</span><span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">maxRates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pre</span><span class="o">.</span><span class="n">maxRates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pre</span><span class="o">.</span><span class="n">maxRates</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">relVol</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">innerRad</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">ht</span><span class="o">/</span><span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span><span class="n">stressMask</span><span class="o">=</span><span class="mb">0b0111</span><span class="p">,</span><span class="n">maxUnbalanced</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">maxUnbalanced</span><span class="p">,</span><span class="n">mass</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">massFactor</span><span class="o">*</span><span class="n">sumParMass</span><span class="p">,</span><span class="n">doneHook</span><span class="o">=</span><span class="s1">&#39;import woo.pre.cylTriax; woo.pre.cylTriax.compactionDone(S)&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;triax&#39;</span><span class="p">,</span><span class="n">absStressTol</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span><span class="n">relStressTol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">),</span>
    <span class="p">]</span><span class="o">+</span><span class="n">DemField</span><span class="o">.</span><span class="n">minimalEngines</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="n">lawKw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">noFrict</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">+</span><span class="p">[</span>
        <span class="c1">#InsertionSortCollider([Bo1_Sphere_Aabb(),Bo1_Facet_Aabb()],verletDist=-.05),</span>
        <span class="c1">#ContactLoop(</span>
        <span class="c1">#    [Cg2_Sphere_Sphere_L6Geom(),Cg2_Facet_Sphere_L6Geom()],</span>
        <span class="c1">#    [Cp2_FrictMat_FrictPhys()],</span>
        <span class="c1">#    [Law2_L6Geom_FrictPhys_IdealElPl(noFrict=True,label=&#39;contactLaw&#39;)],</span>
        <span class="c1">#    applyForces=True,label=&#39;contactLoop&#39;</span>
        <span class="c1">#), </span>
        <span class="n">IntraForce</span><span class="p">([</span>
                <span class="n">In2_Sphere_ElastMat</span><span class="p">(),</span>
                <span class="n">In2_Membrane_ElastMat</span><span class="p">(</span><span class="n">bending</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;intraForce&#39;</span><span class="p">,</span><span class="n">dead</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># ContactLoop applies forces during compaction</span>
        <span class="p">),</span> 
        <span class="c1"># run the same as addPlotData</span>
        <span class="n">MeshVolume</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">loneMask</span><span class="p">,</span><span class="n">stepPeriod</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;meshVolume&#39;</span><span class="p">,</span><span class="n">dead</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>  
        <span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">PyRunner</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="s1">&#39;import woo.pre.cylTriax; woo.pre.cylTriax.addPlotData(S)&#39;</span><span class="p">),</span>
        <span class="n">VtkExport</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">vtkFmt</span><span class="p">,</span><span class="n">stepPeriod</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">vtkStep</span><span class="p">,</span><span class="n">what</span><span class="o">=</span><span class="n">VtkExport</span><span class="o">.</span><span class="n">all</span><span class="p">,</span><span class="n">dead</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;vtk&#39;</span><span class="p">),</span>
        <span class="c1">#Leapfrog(damping=pre.damping,reset=True,label=&#39;leapfrog&#39;),</span>
        <span class="c1">#DynDt(stepPeriod=500),</span>
    <span class="p">]</span>

    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">stage</span><span class="o">=</span><span class="s1">&#39;compact&#39;</span>

    <span class="c1">## if spheres were loaded externally, compaction is done just now</span>
    <span class="c1">##</span>
    <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">compactMemoize</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="n">compactionDone</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">woo.gl</span>
        <span class="n">S</span><span class="o">.</span><span class="n">gl</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">gl</span><span class="o">.</span><span class="n">Renderer</span><span class="p">(</span><span class="n">dispScale</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">rotScale</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cell</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span><span class="n">woo</span><span class="o">.</span><span class="n">gl</span><span class="o">.</span><span class="n">Gl1_DemField</span><span class="p">(),</span><span class="n">woo</span><span class="o">.</span><span class="n">gl</span><span class="o">.</span><span class="n">Gl1_CPhys</span><span class="p">(),</span><span class="n">woo</span><span class="o">.</span><span class="n">gl</span><span class="o">.</span><span class="n">Gl1_Membrane</span><span class="p">(</span><span class="n">phiSplit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">phiWd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">relPhi</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">uScale</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">slices</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">wire</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span><span class="n">woo</span><span class="o">.</span><span class="n">gl</span><span class="o">.</span><span class="n">Gl1_Facet</span><span class="p">(</span><span class="n">wd</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">slices</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="k">pass</span>

    <span class="k">return</span> <span class="n">S</span></div>

<div class="viewcode-block" id="addPlotData"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.cylTriax.addPlotData">[docs]</a><span class="k">def</span> <span class="nf">addPlotData</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">stage</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;compact&#39;</span><span class="p">,</span><span class="s1">&#39;stabilize&#39;</span><span class="p">,</span><span class="s1">&#39;triax&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">woo</span>
    <span class="n">t</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">triax</span>
    <span class="c1"># global stress tensor</span>
    <span class="n">sxx</span><span class="p">,</span><span class="n">syy</span><span class="p">,</span><span class="n">szz</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">stress</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span> 
    <span class="n">dotE</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">gradV</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
    <span class="n">dotEMax</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">maxStrainRate</span>
    <span class="c1"># net volume, without membrane thickness</span>
    <span class="n">vol</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">meshVolume</span><span class="o">.</span><span class="n">netVol</span> 
    <span class="c1"># current radial stress</span>
    <span class="n">srr</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">sxx</span><span class="o">+</span><span class="n">syy</span><span class="p">)</span> 
    <span class="c1"># mean stress</span>
    <span class="n">p</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">stress</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="mf">3.</span>
    <span class="c1"># deviatoric stress</span>
    <span class="n">q</span><span class="o">=</span><span class="n">szz</span><span class="o">-.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">sxx</span><span class="o">+</span><span class="n">syy</span><span class="p">)</span> 
    <span class="n">qDivP</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="o">/</span><span class="n">p</span> <span class="k">if</span> <span class="n">p</span><span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>


    <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">stage</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;compact&#39;</span><span class="p">,</span><span class="s1">&#39;stabilize&#39;</span><span class="p">):</span>
        <span class="c1">## t.strain is log(l/l0) for all components</span>
        <span class="n">exx</span><span class="p">,</span><span class="n">eyy</span><span class="p">,</span><span class="n">ezz</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">strain</span> 
        <span class="n">err</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">exx</span><span class="o">+</span><span class="n">eyy</span><span class="p">)</span>
        <span class="c1"># volumetric strain is not defined directly, and it is not needed either        </span>
        <span class="n">eVol</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># triaxial phase:</span>
        <span class="c1"># only axial strain (ezz) and volumetric strain (eVol) are known</span>
        <span class="c1">#</span>
        <span class="c1"># set the initial volume, if not yet done</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="p">,</span><span class="s1">&#39;netVol0&#39;</span><span class="p">):</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">netVol0</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">meshVolume</span><span class="o">.</span><span class="n">netVol</span>
        <span class="c1"># axial strain is known; xy components irrelevant (inactive)</span>
        <span class="n">ezz</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">strain</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> 
        <span class="c1"># current net volume / initial net volume</span>
        <span class="n">eVol</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vol</span><span class="o">/</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">netVol0</span><span class="p">)</span> 
        <span class="c1"># radial strain</span>
        <span class="n">err</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">eVol</span><span class="o">-</span><span class="n">ezz</span><span class="p">)</span> 
        <span class="c1"># undefined</span>
        <span class="n">exx</span><span class="o">=</span><span class="n">eyy</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span> 
    <span class="c1"># deviatoric strain</span>
    <span class="n">eDev</span><span class="o">=</span><span class="n">ezz</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">err</span><span class="o">+</span><span class="n">ezz</span><span class="p">)</span> <span class="c1"># FIXME: is this correct?!</span>

    <span class="n">surfLoad</span><span class="o">=</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">stage</span><span class="o">==</span><span class="s1">&#39;compact&#39;</span> <span class="k">else</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">surfLoad</span><span class="p">)</span>


    <span class="n">S</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">addData</span><span class="p">(</span><span class="n">unbalanced</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">unbalancedForce</span><span class="p">(),</span><span class="n">i</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
        <span class="n">sxx</span><span class="o">=</span><span class="n">sxx</span><span class="p">,</span><span class="n">syy</span><span class="o">=</span><span class="n">syy</span><span class="p">,</span>
        <span class="n">srr</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">sxx</span><span class="o">+</span><span class="n">syy</span><span class="p">),</span><span class="n">szz</span><span class="o">=</span><span class="n">szz</span><span class="p">,</span>
        <span class="n">surfLoad</span><span class="o">=</span><span class="n">surfLoad</span><span class="p">,</span>
        <span class="n">exx</span><span class="o">=</span><span class="n">exx</span><span class="p">,</span><span class="n">eyy</span><span class="o">=</span><span class="n">eyy</span><span class="p">,</span>
        <span class="n">err</span><span class="o">=</span><span class="n">err</span><span class="p">,</span><span class="n">ezz</span><span class="o">=</span><span class="n">ezz</span><span class="p">,</span>
        <span class="n">dotE</span><span class="o">=</span><span class="n">dotE</span><span class="p">,</span><span class="n">dotErr</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">dotE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dotE</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">dotEMax</span><span class="o">=</span><span class="n">dotEMax</span><span class="p">,</span>
        <span class="n">dotEMax_z_neg</span><span class="o">=-</span><span class="n">dotEMax</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">eDev</span><span class="o">=</span><span class="n">eDev</span><span class="p">,</span><span class="n">eVol</span><span class="o">=</span><span class="n">eVol</span><span class="p">,</span>
        <span class="n">vol</span><span class="o">=</span><span class="n">vol</span><span class="p">,</span>
        <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span><span class="n">qDivP</span><span class="o">=</span><span class="n">qDivP</span><span class="p">,</span>
        <span class="n">isTriax</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">stage</span><span class="o">==</span><span class="s1">&#39;triax&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span> <span class="c1"># to be able to filter data</span>
        <span class="n">grossVol</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">meshVolume</span><span class="o">.</span><span class="n">vol</span><span class="p">,</span>
        <span class="n">parTanPhi</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">parMat</span><span class="o">.</span><span class="n">tanPhi</span><span class="p">,</span>
        <span class="n">memTanPhi</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">memMat</span><span class="o">.</span><span class="n">tanPhi</span><span class="p">,</span>
        <span class="n">suppTanPhi</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">suppMat</span><span class="o">.</span><span class="n">tanPhi</span>
        <span class="c1"># save all available energy data</span>
        <span class="c1">#Etot=O.energy.total()#,**O.energy</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">S</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plots</span><span class="p">:</span>
        <span class="n">S</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plots</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;i&#39;</span><span class="p">:(</span><span class="s1">&#39;unbalanced&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;parTanPhi&#39;</span><span class="p">,</span><span class="s1">&#39;memTanPhi&#39;</span><span class="p">,</span><span class="s1">&#39;suppTanPhi&#39;</span><span class="p">),</span><span class="s1">&#39;i &#39;</span><span class="p">:(</span><span class="s1">&#39;srr&#39;</span><span class="p">,</span><span class="s1">&#39;szz&#39;</span><span class="p">,</span><span class="s1">&#39;surfLoad&#39;</span><span class="p">),</span><span class="s1">&#39; i&#39;</span><span class="p">:(</span><span class="s1">&#39;err&#39;</span><span class="p">,</span><span class="s1">&#39;ezz&#39;</span><span class="p">,</span><span class="s1">&#39;eVol&#39;</span><span class="p">),</span><span class="s1">&#39;  i&#39;</span><span class="p">:(</span><span class="s1">&#39;vol&#39;</span><span class="p">,</span><span class="s1">&#39;grossVol&#39;</span><span class="p">),</span><span class="s1">&#39;i  &#39;</span><span class="p">:(</span><span class="s1">&#39;dotE_z&#39;</span><span class="p">,</span><span class="s1">&#39;dotEMax_z&#39;</span><span class="p">,</span><span class="s1">&#39;dotEMax_z_neg&#39;</span><span class="p">)</span>
            <span class="c1"># energy plot</span>
            <span class="c1">#&#39; i &#39;:(O.energy.keys,None,&#39;Etot&#39;),</span>
        <span class="p">}</span>
        <span class="n">S</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">xylabels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;i &#39;</span><span class="p">:(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span><span class="s1">&#39;Stress [Pa]&#39;</span><span class="p">,),</span><span class="s1">&#39; i&#39;</span><span class="p">:(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span><span class="s1">&#39;Strains [-]&#39;</span><span class="p">,</span><span class="s1">&#39;Strains [-]&#39;</span><span class="p">)}</span>
        <span class="n">S</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">labels</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;sxx&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$\sigma_</span><span class="si">{xx}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;syy&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$\sigma_</span><span class="si">{yy}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;szz&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$\sigma_</span><span class="si">{zz}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;srr&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$\sigma_</span><span class="si">{rr}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;surfLoad&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$\sigma_{\rm hydro}$&#39;</span><span class="p">,</span>
            <span class="s1">&#39;exx&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$\varepsilon_</span><span class="si">{xx}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;eyy&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$\varepsilon_</span><span class="si">{yy}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;ezz&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$\varepsilon_</span><span class="si">{zz}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;err&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$\varepsilon_</span><span class="si">{rr}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;eVol&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$\varepsilon_</span><span class="si">{v}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;vol&#39;</span><span class="p">:</span><span class="s1">&#39;net volume&#39;</span><span class="p">,</span><span class="s1">&#39;grossVol&#39;</span><span class="p">:</span><span class="s1">&#39;midplane volume&#39;</span><span class="p">,</span>
            <span class="s1">&#39;dotE_x&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$\dot\varepsilon_</span><span class="si">{xx}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;dotE_y&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$\dot\varepsilon_</span><span class="si">{yy}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;dotE_z&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$\dot\varepsilon_</span><span class="si">{zz}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;dotE_rr&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$\dot\varepsilon_</span><span class="si">{rr}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;dotEMax_z&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$\dot\varepsilon_</span><span class="si">{zz}</span><span class="s1">^{\rm max}$&#39;</span><span class="p">,</span><span class="s1">&#39;dotEMax_z_neg&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$-\dot\varepsilon_</span><span class="si">{zz}</span><span class="s1">^{\rm max}$&#39;</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">meshVolume</span><span class="o">.</span><span class="n">netVol</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">triax</span><span class="o">.</span><span class="n">relVol</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">meshVolume</span><span class="o">.</span><span class="n">netVol</span><span class="o">/</span><span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">volume</span>

    <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">stage</span><span class="o">==</span><span class="s1">&#39;stabilize&#39;</span><span class="p">:</span>
        <span class="n">stable</span><span class="o">=</span><span class="kc">True</span>
        <span class="c1">#</span>
        <span class="c1"># adjust surface load so that we approach the right value</span>
        <span class="c1">#</span>
        <span class="n">sl</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">surfLoad</span><span class="o">-.</span><span class="mi">002</span><span class="o">*</span><span class="p">(</span><span class="n">srr</span><span class="o">-</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">sigIso</span><span class="p">)</span>
        <span class="c1">#print &#39;Old&#39;,S.lab.surfLoad,&#39;new&#39;,sl,&#39;(desired&#39;,S.pre.sigIso,&#39;current&#39;,srr,&#39;)&#39;</span>
        <span class="k">del</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">surfLoad</span>
        <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">surfLoad</span><span class="o">=</span><span class="n">sl</span>
        <span class="c1">#print &#39;Changing surface load to &#39;,S.lab.surfLoad,&#39;, srr is&#39;,srr</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">Membrane</span><span class="p">):</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">surfLoad</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">surfLoad</span>
        <span class="c1">## 2% tolerance on stress</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">srr</span><span class="o">-</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">sigIso</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">sigIso</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">2e-2</span><span class="p">:</span> <span class="n">stable</span><span class="o">=</span><span class="kc">False</span>

        <span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">tp</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">parMat</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">parTanPhi</span><span class="p">),(</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">memMat</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">memTanPhi</span><span class="p">),(</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">suppMat</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">suppTanPhi</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">tanPhi</span><span class="o">&lt;</span><span class="n">tp</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">tanPhi</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">tanPhi</span><span class="o">+.</span><span class="mi">002</span><span class="o">*</span><span class="n">tp</span><span class="p">,</span><span class="n">tp</span><span class="p">)</span>
                <span class="n">stable</span><span class="o">=</span><span class="kc">False</span>

        <span class="c1"># once the membrane is stabilized, decrease strain rate as well</span>
        <span class="k">if</span> <span class="n">stable</span><span class="p">:</span>
            <span class="c1"># decrease max strain rate along z</span>
            <span class="c1"># to avoid gross oscillations</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">maxStrainRate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;.</span><span class="mi">01</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">maxRates</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">maxStrainRate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">maxStrainRate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-.</span><span class="mi">01</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">maxRates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">.</span><span class="mi">01</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">maxRates</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">stable</span><span class="o">=</span><span class="kc">False</span>
            <span class="c1">## don&#39;t do this, can take forever</span>
            <span class="c1"># and then wait for strain rate to drop what will be applied next</span>
            <span class="c1"># we go down to 1/1000th, that&#39;s where we start during the triaxial test then...</span>
            <span class="c1"># wait for strain rate to settle down</span>
            <span class="c1"># if abs(S.cell.gradV[2,2])&gt;.001*S.pre.maxRates[1]: stable=False</span>

        <span class="c1"># green light for triax to finish</span>
        <span class="k">if</span> <span class="n">stable</span><span class="p">:</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">triax</span><span class="o">.</span><span class="n">goal</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">stage</span><span class="o">==</span><span class="s1">&#39;triax&#39;</span><span class="p">:</span>
        <span class="n">t</span><span class="o">.</span><span class="n">maxStrainRate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">maxStrainRate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+.</span><span class="mi">001</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">maxRates</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">maxRates</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="velocityFieldPlots"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.cylTriax.velocityFieldPlots">[docs]</a><span class="k">def</span> <span class="nf">velocityFieldPlots</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">nameBase</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">woo</span>
    <span class="kn">from</span> <span class="nn">woo</span> <span class="k">import</span> <span class="n">post2d</span>
    <span class="n">flattener</span><span class="o">=</span><span class="n">post2d</span><span class="o">.</span><span class="n">CylinderFlatten</span><span class="p">(</span><span class="n">useRef</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],(</span><span class="o">.</span><span class="mi">6</span><span class="o">/</span><span class="mf">2.2</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
    <span class="c1">#maxVel=float(&#39;inf&#39;) #5e-2</span>
    <span class="c1">#exVel=lambda p: p.vel if p.vel.norm()&lt;=maxVel else p.vel/(p.vel.norm()/maxVel)</span>
    <span class="n">exVel</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">vel</span>
    <span class="n">exVelNorm</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">exVel</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
    <span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="k">import</span> <span class="n">Figure</span>
    <span class="n">fVRaw</span><span class="o">=</span><span class="n">Figure</span><span class="p">();</span> <span class="n">ax</span><span class="o">=</span><span class="n">fVRaw</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">post2d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">post2d</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">exVel</span><span class="p">,</span><span class="n">flattener</span><span class="p">),</span><span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">3</span><span class="p">,</span><span class="n">minlength</span><span class="o">=.</span><span class="mi">3</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
    <span class="n">fV2</span><span class="o">=</span><span class="n">Figure</span><span class="p">();</span> <span class="n">ax</span><span class="o">=</span><span class="n">fV1</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">post2d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">post2d</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">exVel</span><span class="p">,</span><span class="n">flattener</span><span class="p">,</span><span class="n">stDev</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">div</span><span class="o">=</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="mi">80</span><span class="p">)),</span><span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">minlength</span><span class="o">=.</span><span class="mi">6</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
    <span class="n">fV1</span><span class="o">=</span><span class="n">Figure</span><span class="p">();</span> <span class="n">ax</span><span class="o">=</span><span class="n">fV1</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">post2d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">post2d</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">exVelNorm</span><span class="p">,</span><span class="n">flattener</span><span class="p">,</span><span class="n">stDev</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">div</span><span class="o">=</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="mi">80</span><span class="p">)),</span><span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
    <span class="n">outs</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">fig</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;particle-velocity&#39;</span><span class="p">,</span><span class="n">fVRaw</span><span class="p">),(</span><span class="s1">&#39;smooth-velocity&#39;</span><span class="p">,</span><span class="n">fV2</span><span class="p">),(</span><span class="s1">&#39;smooth-velocity-norm&#39;</span><span class="p">,</span><span class="n">fV1</span><span class="p">)]:</span>
        <span class="n">out</span><span class="o">=</span><span class="n">nameBase</span><span class="o">+</span><span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">.png&#39;</span><span class="o">%</span><span class="n">name</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outs</span></div>

<div class="viewcode-block" id="membraneStabilized"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.cylTriax.membraneStabilized">[docs]</a><span class="k">def</span> <span class="nf">membraneStabilized</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Membrane stabilized at step&#39;</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">step</span><span class="p">,</span><span class="s1">&#39;with surface pressure&#39;</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">surfLoad</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">triax</span><span class="o">.</span><span class="n">goal</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">stopStrain</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">triax</span><span class="o">.</span><span class="n">stressMask</span><span class="o">=</span><span class="mb">0b0000</span> <span class="c1"># all strain-controlled</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">triax</span><span class="o">.</span><span class="n">maxStrainRate</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">.</span><span class="mi">001</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">maxRates</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">triax</span><span class="o">.</span><span class="n">maxUnbalanced</span><span class="o">=</span><span class="mi">10</span> <span class="c1"># don&#39;t care, just compress until done</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">leapfrog</span><span class="o">.</span><span class="n">damping</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">damping</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">triax</span><span class="o">.</span><span class="n">doneHook</span><span class="o">=</span><span class="s1">&#39;import woo.pre.cylTriax; woo.pre.cylTriax.triaxDone(S)&#39;</span>

    <span class="c1"># this is the real ref config now</span>
    <span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">trsf</span><span class="o">=</span><span class="n">Matrix3</span><span class="o">.</span><span class="n">Identity</span>
    <span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">refHSize</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">hSize</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">woo.gl</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">gl</span><span class="o">.</span><span class="n">Gl1_DemField</span><span class="o">.</span><span class="n">updateRefPos</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="k">pass</span>

    <span class="c1"># not sure if this does any good actually</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">vel</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">angVel</span><span class="o">=</span><span class="n">Vector3</span><span class="o">.</span><span class="n">Zero</span>

    <span class="k">del</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">stage</span> <span class="c1"># avoid warning </span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">stage</span><span class="o">=</span><span class="s1">&#39;triax&#39;</span>

    <span class="c1"># this is no longer needed, tanPhi is constant now</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">contactLoop</span><span class="o">.</span><span class="n">updatePhys</span><span class="o">=</span><span class="kc">False</span>

    <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">saveFmt</span><span class="p">:</span>
        <span class="n">out</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">saveFmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="s1">&#39;pre-triax&#39;</span><span class="p">,</span><span class="n">S</span><span class="o">=</span><span class="n">S</span><span class="p">,</span><span class="o">**</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving to&#39;</span><span class="p">,</span><span class="n">out</span><span class="p">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>


<div class="viewcode-block" id="compactionDone"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.cylTriax.compactionDone">[docs]</a><span class="k">def</span> <span class="nf">compactionDone</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">compactMemoize</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Compaction done at step&#39;</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">woo</span>
    <span class="n">t</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">triax</span>
    <span class="c1"># set the current cell configuration to be the reference one</span>
    <span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">trsf</span><span class="o">=</span><span class="n">Matrix3</span><span class="o">.</span><span class="n">Identity</span>
    <span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">refHSize</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">hSize</span>
    <span class="n">t</span><span class="o">.</span><span class="n">maxUnbalanced</span><span class="o">=.</span><span class="mi">1</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">maxUnbalanced</span> <span class="c1"># need more stability for triax?</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">leapfrog</span><span class="o">.</span><span class="n">damping</span><span class="o">=.</span><span class="mi">7</span> <span class="c1"># increase damping to a larger value</span>
    <span class="n">t</span><span class="o">.</span><span class="n">goal</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">sigIso</span><span class="p">)</span> <span class="c1"># this will be set to 0 once all friction angles are OK</span>
    <span class="n">t</span><span class="o">.</span><span class="n">maxStrainRate</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">maxRates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">t</span><span class="o">.</span><span class="n">doneHook</span><span class="o">=</span><span class="s1">&#39;import woo.pre.cylTriax; woo.pre.cylTriax.membraneStabilized(S)&#39;</span>
    <span class="n">t</span><span class="o">.</span><span class="n">stressMask</span><span class="o">=</span><span class="mb">0b0100</span> <span class="c1"># z is stress-controlled, xy strain-controlled</span>
    <span class="c1"># allow faster deformation along x,y to better maintain stresses</span>


    <span class="c1"># make the membrane flexible: apply force on the membrane</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">contactLoop</span><span class="o">.</span><span class="n">applyForces</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">intraForce</span><span class="o">.</span><span class="n">dead</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">meshVolume</span><span class="o">.</span><span class="n">dead</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">vtk</span><span class="o">.</span><span class="n">dead</span><span class="o">=</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">vtkStep</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">vtkFmt</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># free the nodes</span>
    <span class="n">top</span><span class="p">,</span><span class="n">bot</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">cylNodes</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">bot</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">cylNodes</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
        <span class="c1"># supports may move in-plane, and also may rotate</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">top</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&lt;</span><span class="n">tol</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">bot</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&lt;</span><span class="n">tol</span><span class="p">:</span>
            <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">blocked</span><span class="o">=</span><span class="s1">&#39;z&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">blocked</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="c1"># add surface load</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">surfLoad</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">sigIso</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">memThick</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">htDiam</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial surface load&#39;</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">surfLoad</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">par</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">Membrane</span><span class="p">):</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">surfLoad</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">surfLoad</span>
    <span class="c1"># set velocity to 0 (so that when loading packing, the conditions are the same)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">vel</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">dem</span><span class="o">.</span><span class="n">angVel</span><span class="o">=</span><span class="n">Vector3</span><span class="o">.</span><span class="n">Zero</span>

    <span class="c1"># restore friction: friction dissipates a lot of energy, and also creates stress decrease along +z</span>
    <span class="c1"># which we want to have here, not when the membrane is already stable and the triax itself starts</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">contactLaw</span><span class="o">.</span><span class="n">noFrict</span><span class="o">=</span><span class="kc">False</span>

    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">contactLoop</span><span class="o">.</span><span class="n">updatePhys</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># force updating CPhys at every step</span>
    <span class="c1"># save desired values of friction angle</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">parTanPhi</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">parMat</span><span class="o">.</span><span class="n">tanPhi</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">memTanPhi</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">memMat</span><span class="o">.</span><span class="n">tanPhi</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">suppTanPhi</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">suppMat</span><span class="o">.</span><span class="n">tanPhi</span>
    <span class="c1"># and set it to zero</span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">parMat</span><span class="o">.</span><span class="n">tanPhi</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">memMat</span><span class="o">.</span><span class="n">tanPhi</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">suppMat</span><span class="o">.</span><span class="n">tanPhi</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">compactMemoize</span><span class="p">:</span> <span class="c1"># if None or &#39;&#39;, don&#39;t save</span>
        <span class="c1">#S.save(&#39;/tmp/compact.gz&#39;)</span>
        <span class="n">aabb</span><span class="o">=</span><span class="n">AlignedBox3</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">cylNodes</span><span class="p">:</span> <span class="n">aabb</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">SpherePack</span><span class="p">()</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">fromSimulation</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">userData</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">aabb</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">compactMemoize</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saved compacted packing to&#39;</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">compactMemoize</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">stage</span> <span class="c1"># avoid warning </span>
    <span class="n">S</span><span class="o">.</span><span class="n">lab</span><span class="o">.</span><span class="n">stage</span><span class="o">=</span><span class="s1">&#39;stabilize&#39;</span></div>

    

<div class="viewcode-block" id="plotBatchResults"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.cylTriax.plotBatchResults">[docs]</a><span class="k">def</span> <span class="nf">plotBatchResults</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">titleRegex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">stressPath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sorter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s1">&#39;Hook called from woo.batch.writeResults&#39;</span>
    <span class="kn">import</span> <span class="nn">re</span><span class="o">,</span><span class="nn">math</span><span class="o">,</span><span class="nn">woo.batch</span><span class="o">,</span><span class="nn">os</span>
    <span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="k">import</span> <span class="n">Figure</span>
    <span class="kn">from</span> <span class="nn">matplotlib.backends.backend_agg</span> <span class="k">import</span> <span class="n">FigureCanvasAgg</span>

    <span class="n">results</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">dbReadResults</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sorter</span><span class="p">:</span> <span class="n">results</span><span class="o">=</span><span class="n">sorter</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="n">out</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.pdf&#39;</span><span class="o">%</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\.results$&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">db</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="k">import</span> <span class="n">FuncFormatter</span>
    <span class="n">kiloPascal</span><span class="o">=</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="mf">1e-3</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>
    <span class="n">percent</span><span class="o">=</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="mf">1e2</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">stressPath</span><span class="p">:</span>
        <span class="n">fig1</span><span class="p">,</span><span class="n">fig2</span><span class="p">,</span><span class="n">fig3</span><span class="o">=</span><span class="mi">311</span><span class="p">,</span><span class="mi">312</span><span class="p">,</span><span class="mi">313</span>
        <span class="n">fig</span><span class="o">=</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig1</span><span class="p">,</span><span class="n">fig2</span><span class="o">=</span><span class="mi">121</span><span class="p">,</span><span class="mi">122</span>
        <span class="n">fig</span><span class="o">=</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">right</span><span class="o">=.</span><span class="mi">98</span><span class="p">,</span><span class="n">bottom</span><span class="o">=.</span><span class="mi">15</span><span class="p">,</span><span class="n">top</span><span class="o">=.</span><span class="mi">9</span><span class="p">,</span><span class="n">wspace</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span><span class="n">hspace</span><span class="o">=.</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">canvas</span><span class="o">=</span><span class="n">FigureCanvasAgg</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="n">ed_qp</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">fig1</span><span class="p">)</span>
    <span class="n">ed_qp</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\varepsilon_d$ [%]&#39;</span><span class="p">)</span>
    <span class="n">ed_qp</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$q/p$&#39;</span><span class="p">)</span>
    <span class="n">ed_qp</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">percent</span><span class="p">)</span>
    <span class="n">ed_qp</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ed_ev</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">fig2</span><span class="p">)</span>
    <span class="n">ed_ev</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\varepsilon_d$ [%]&#39;</span><span class="p">)</span>
    <span class="n">ed_ev</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\varepsilon_v$ [%]&#39;</span><span class="p">)</span>
    <span class="n">ed_ev</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">percent</span><span class="p">)</span>
    <span class="n">ed_ev</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">percent</span><span class="p">)</span>
    <span class="n">ed_ev</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stressPath</span><span class="p">:</span>
        <span class="n">p_q</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">fig3</span><span class="p">)</span>
        <span class="n">p_q</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$p$ [kPa]&#39;</span><span class="p">)</span>
        <span class="n">p_q</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$q$ [kPa]&#39;</span><span class="p">)</span>
        <span class="n">p_q</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">kiloPascal</span><span class="p">)</span>
        <span class="n">p_q</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">kiloPascal</span><span class="p">)</span>
        <span class="n">p_q</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">titlesSkipped</span><span class="p">,</span><span class="n">titlesIncluded</span><span class="o">=</span><span class="p">[],[]</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">series</span><span class="p">,</span><span class="n">pre</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;series&#39;</span><span class="p">],</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;pre&#39;</span><span class="p">]</span>
        <span class="n">title</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;sceneId&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">titleRegex</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">titleRegex</span><span class="p">,</span><span class="n">title</span><span class="p">):</span>
            <span class="n">titlesSkipped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">titlesIncluded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">isTriax</span><span class="o">=</span><span class="n">series</span><span class="p">[</span><span class="s1">&#39;isTriax&#39;</span><span class="p">]</span>
        <span class="c1"># skip the very first number, since that&#39;s the transitioning step and strains are still at their old value</span>
        <span class="n">ed</span><span class="o">=</span><span class="n">series</span><span class="p">[</span><span class="s1">&#39;eDev&#39;</span><span class="p">][</span><span class="n">isTriax</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">ev</span><span class="o">=</span><span class="n">series</span><span class="p">[</span><span class="s1">&#39;eVol&#39;</span><span class="p">][</span><span class="n">isTriax</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">p</span><span class="o">=</span><span class="n">series</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">][</span><span class="n">isTriax</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">q</span><span class="o">=</span><span class="n">series</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">][</span><span class="n">isTriax</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">qDivP</span><span class="o">=</span><span class="n">series</span><span class="p">[</span><span class="s1">&#39;qDivP&#39;</span><span class="p">][</span><span class="n">isTriax</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">ed_qp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ed</span><span class="p">,</span><span class="n">qDivP</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">title</span><span class="p">,</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">ed_ev</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ed</span><span class="p">,</span><span class="n">ev</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">title</span><span class="p">,</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stressPath</span><span class="p">:</span>
            <span class="n">p_q</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">title</span><span class="p">,</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">titlesIncluded</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No simulations in </span><span class="si">%s%s</span><span class="s1"> found.&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">db</span><span class="p">,(</span><span class="s1">&#39; matching </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">titleRegex</span> <span class="k">if</span> <span class="n">titleRegex</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
    <span class="n">ed_qp</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
    <span class="n">ed_ev</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
    <span class="n">ed_ev</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">stressPath</span><span class="p">:</span>
        <span class="n">p_q</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
        <span class="n">p_q</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span><span class="n">loc</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">ed_qp</span><span class="p">,</span><span class="s1">&#39;lower right&#39;</span><span class="p">),(</span><span class="n">ed_ev</span><span class="p">,</span><span class="s1">&#39;lower right&#39;</span><span class="p">)]</span><span class="o">+</span><span class="p">([(</span><span class="n">p_q</span><span class="p">,</span><span class="s1">&#39;upper left&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="n">stressPath</span> <span class="k">else</span> <span class="p">[]):</span>
        <span class="n">l</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span><span class="n">labelspacing</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">7</span><span class="p">})</span>
        <span class="n">l</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="o">.</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Included simulations:&#39;</span><span class="p">,</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">titlesIncluded</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">titlesSkipped</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipped simulations:&#39;</span><span class="p">,</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">titlesSkipped</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Batch figure saved to file://</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">out</span><span class="p">))</span></div>


<div class="viewcode-block" id="triaxDone"><a class="viewcode-back" href="../../../woo.pre.html#woo.pre.cylTriax.triaxDone">[docs]</a><span class="k">def</span> <span class="nf">triaxDone</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Triaxial done at step&#39;</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">saveFmt</span><span class="p">:</span>
        <span class="n">out</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">saveFmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="s1">&#39;done&#39;</span><span class="p">,</span><span class="n">S</span><span class="o">=</span><span class="n">S</span><span class="p">,</span><span class="o">**</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">tags</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving to&#39;</span><span class="p">,</span><span class="n">out</span><span class="p">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="kn">import</span> <span class="nn">woo.utils</span>
    <span class="p">(</span><span class="n">repName</span><span class="p">,</span><span class="n">figs</span><span class="p">)</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">htmlReport</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">reportFmt</span><span class="p">,</span><span class="s1">&#39;Cylindrical triaxial test&#39;</span><span class="p">,</span><span class="n">afterHead</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">figures</span><span class="o">=</span><span class="p">[(</span><span class="kc">None</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">noShow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">subPlots</span><span class="o">=</span><span class="kc">False</span><span class="p">)],</span><span class="n">svgEmbed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">woo</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">writeResults</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">defaultDb</span><span class="o">=</span><span class="s1">&#39;cylTriax.hdf5&#39;</span><span class="p">,</span><span class="n">series</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">postHooks</span><span class="o">=</span><span class="p">[</span><span class="n">plotBatchResults</span><span class="p">],</span><span class="n">simulationName</span><span class="o">=</span><span class="s1">&#39;cylTriax&#39;</span><span class="p">,</span><span class="n">report</span><span class="o">=</span><span class="s1">&#39;file://&#39;</span><span class="o">+</span><span class="n">repName</span><span class="p">)</span></div>



</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../../index.html">Woo 1.0+rev1-git-f169989 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">woo.pre.cylTriax</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2012−2022, Václav Šmilauer &lt;eu@doxos.eu&gt;.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>