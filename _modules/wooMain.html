


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>wooMain &#8212; Woo 1.0+rev1-git-e79c213 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/cloud.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>

    
    
     
        <script src="../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../_static/cloud.base.js"></script>
    

    
     
        <script src="../_static/cloud.js"></script>
    

    <link rel="shortcut icon" href="../_static/woo-favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">Woo 1.0+rev1-git-e79c213 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">wooMain</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for wooMain</h1><div class="highlight"><pre>
<span></span><span class="c1"># encoding: utf-8</span>

<span class="n">__all__</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">,</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span><span class="s1">&#39;options&#39;</span><span class="p">,</span><span class="s1">&#39;WooOptions&#39;</span><span class="p">]</span>


<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="n">WIN</span><span class="o">=</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s1">&#39;win32&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="WooOptions"><a class="viewcode-back" href="../wooMain.html#wooMain.WooOptions">[docs]</a><span class="k">class</span> <span class="nc">WooOptions</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Object holding load-time options for Woo. The object&#39;s dictionary is frozen after construction, which prevents mistakenly adding non-existing option. Do not construct this object directly, set attributes of the :obj:`wooMain.options` instance instead.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceNoGui</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ompThreads</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ompCores</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;WOO_FLAVOR&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flavor</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;WOO_FLAVOR&#39;</span><span class="p">]</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Woo: honoring WOO_FLAVOR=</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;WOO_FLAVOR&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clDev</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fakeDisplay</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batchTable</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batchLine</span><span class="o">=-</span><span class="mi">1</span>     <span class="c1"># if &gt;=0, in a batch without batchTable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batchResults</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quirks</span><span class="o">=</span><span class="mi">3</span> <span class="c1">### was 3, but Intel seems to work now OK</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quirkIntel</span><span class="o">=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quirkFirePro</span><span class="o">=</span><span class="mi">2</span>
        <span class="c1">## internal use only; ignores some import errors which will not make rebuilding as such fail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rebuilding</span><span class="o">=</span><span class="kc">False</span> 
        <span class="c1"># no attributes can be added beyond this point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frozen</span><span class="o">=</span><span class="kc">None</span> 
    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;_frozen&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;No such attribute: &#39;</span><span class="o">+</span><span class="n">name</span><span class="p">)</span></div>

<span class="n">options</span><span class="o">=</span><span class="n">WooOptions</span><span class="p">()</span>
<span class="s1">&#39;Hold load-time options for the compiled part of Woo. Usually modified by command-line switches, but can be used directly if Woo is imported from &quot;pure&quot; Python.&#39;</span>

<span class="k">def</span> <span class="nf">makeColorFuncs</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span><span class="n">dumbWinColors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="c1"># this was a (failed) attempt to fix ipython_console in sphinx</span>
        <span class="c1"># since I though it was being broken by colorama</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">getdefaultencoding</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;utf-8&#39;</span> <span class="ow">and</span> <span class="kc">False</span> <span class="p">:</span> 
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="s1">&#39;@&#39;</span><span class="o">+</span><span class="s1">&#39;NOTE: Not importing colorama, since we are probably generating documentation (sys.getdefaultencoding()==&quot;utf-8&quot;)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ImportError</span>
        <span class="kn">import</span> <span class="nn">colorama</span>
        
        <span class="k">pass</span><span class="c1"># work around http://code.google.com/p/colorama/issues/detail?id=16</span>
        <span class="c1"># not under Windows, or under Windows in dumb &quot;terminal&quot; (cmd.exe), where autodetection works</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">WIN</span><span class="p">:</span> <span class="n">colorama</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="c1"># windows with proper terminal emulator</span>
        <span class="k">elif</span> <span class="s1">&#39;TERM&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span> <span class="n">colorama</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">autoreset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">convert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">strip</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># dumb windows terminal - no colors for our messages, but IPython prompts is colorized properly</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dumbWinColors</span><span class="p">:</span> <span class="n">colorama</span><span class="o">.</span><span class="n">init</span><span class="p">()</span> <span class="c1"># used for batch output</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ImportError</span> <span class="c1"># this would break ipython prompt completely</span>
        <span class="n">ret</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;BRIGHT&#39;</span><span class="p">,):</span> <span class="n">ret</span><span class="o">+=</span><span class="p">[</span><span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="p">,</span><span class="n">c</span><span class="p">)</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">ret</span><span class="o">+=</span><span class="p">[</span><span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="p">,</span><span class="n">c</span><span class="p">)</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ret</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
        
<span class="c1">## special setup for frozen configuration</span>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span><span class="s1">&#39;frozen&#39;</span><span class="p">):</span>
    <span class="c1"># set IPYTHON dir, if we are in read-only location</span>
    <span class="c1"># reported at https://github.com/ipython/ipython/issues/2702</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">expanduser</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;IPYTHONDIR&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/.ipython&#39;</span><span class="p">)</span>
    

<span class="k">def</span> <span class="nf">flavorFromArgv0</span><span class="p">(</span><span class="n">argv0</span><span class="p">,</span><span class="n">batch</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="k">if</span> <span class="n">WIN</span><span class="p">:</span> <span class="n">a0</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;-script.py&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">argv0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">a0</span><span class="o">=</span><span class="n">argv0</span>
    <span class="n">m</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;(.*[/</span><span class="se">\\\\</span><span class="s1">]|)(w|)woo(?P&lt;flavor&gt;-[a-zA-Z_0-9-]*|)&#39;</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;[-_]batch&#39;</span> <span class="k">if</span> <span class="n">batch</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span><span class="n">a0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;flavor&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;flavor&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># strip leading dash</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Woo flavor could not be guessed from program name: &#39;</span><span class="o">+</span><span class="n">argv0</span><span class="p">)</span>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../wooMain.html#wooMain.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">sysArgv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Entry point for the woo executable. *sysArgv* (if specified) replaces sys.argv, which is used for option processing.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">os.path</span><span class="o">,</span><span class="nn">time</span><span class="o">,</span><span class="nn">re</span><span class="o">,</span><span class="nn">logging</span><span class="o">,</span><span class="nn">subprocess</span>
    <span class="k">if</span> <span class="n">sysArgv</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">=</span><span class="n">sysArgv</span>

    <span class="k">global</span> <span class="n">options</span>
    

    <span class="c1"># handle command-line options first</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="n">par</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Woo: open-source platform for dynamic computations, http://woodem.org, http://woodem.eu.&quot;</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--version&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,)</span>
    <span class="c1">#</span>
    <span class="c1"># those MUST be stored in *options*</span>
    <span class="c1">#</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-j&#39;</span><span class="p">,</span><span class="s1">&#39;--threads&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of OpenMP threads to run; unset (0) by default, which means to use all available cores, but at most 4. Equivalent to setting OMP_NUM_THREADS environment variable.&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;threads&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cores&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Comma-separated list of cores to use - determined number of OpenMP threads and sets affinity for those threads as well.&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;cores&#39;</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cl-dev&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Numerical couple (comma-separated) givin OpenCL platform/device indices. This is machine-dependent value&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;clDev&#39;</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run without graphical interface (equivalent to unsetting the DISPLAY environment variable)&quot;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;nogui&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-D&#39;</span><span class="p">,</span><span class="s1">&#39;--debug&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run the debug build, if available.&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="c1"># quirks set flags in options</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--quirks&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Bitmask for workarounds for broken configurations; all quirks are enabled by default. 1: set LIBGL_ALWAYS_SOFTWARE=1 for Intel GPUs (determined from `lspci | grep VGA`) (avoids GPU freeze), 2: set --in-gdb when on AMD FirePro GPUs to avoid crash in fglrx.so (only when using the fglrx driver)&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;quirks&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># , except the Intel one (seems to work properly now)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--flavor&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Build flavor of woo to use.&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="n">flavorFromArgv0</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="c1"># batch-related options (replacing WOO_BATCH env var)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--batch-table&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Batch table file.&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;batchTable&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--batch-line&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Batch table line.&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;batchLine&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--batch-results&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Batch results file.&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;batchResults&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
    <span class="c1">#</span>
    <span class="c1"># end store in *options*</span>
    <span class="c1">#</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run these python commands after the start (use -x to exit afterwards)&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;commands&#39;</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;COMMANDS&#39;</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-e&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Evaluate this expression (instead of loading file). It should be a scene object or a preprocessor, which will be run&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;expression&#39;</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;EXPR&#39;</span><span class="p">)</span>
    <span class="c1"># par.add_argument(&#39;--update&#39;,help=&#39;Update deprecated class names in given script(s) using text search &amp; replace. Changed files will be backed up with ~ suffix. Exit when done without running any simulation.&#39;,dest=&#39;updateScripts&#39;,action=&#39;store_true&#39;)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--paused&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;When proprocessor or simulation is given on the command-line, don</span><span class="se">\&#39;</span><span class="s1">t run it automatically (default)&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--nice&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Increase nice level (i.e. decrease priority) by given number.&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;nice&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-x&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Exit when the script finishes&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;exitAfter&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Increase logging verbosity; first occurence sets default logging level to info (only available if built with log4cxx), second to debug, third to trace.&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;verbosity&#39;</span><span class="p">)</span>
    <span class="c1"># par.add_argument(&#39;--generate-manpage&#39;,help=&quot;Generate man page documenting this program and exit&quot;,dest=&#39;manpage&#39;,metavar=&#39;FILE&#39;)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">WIN</span><span class="p">:</span> <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-R&#39;</span><span class="p">,</span><span class="s1">&#39;--rebuild&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Re-run build in the source directory, then run the updated woo with the same command line except --rebuild. The build flavor for this build and its stored parameters will be used. If given twice, update from the repository will be attempted before recompilation.&quot;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;rebuild&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--test&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run regression test suite and exit; the exists status is 0 if all tests pass, 1 if a test fails and 2 for an unspecified exception.&quot;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-gdb&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Do not show backtrace when Woo crashes (only effective with \-\-debug).&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;noGdb&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--in-gdb&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run Woo inside gdb (must be in $PATH).&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;inGdb&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--in-lldb&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run Woo inside lldb (must be in $PATH; executables tried are lldb, lldb-7, lldb-8, lddb-9 in this order).&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;inLldb&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--in-pdb&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run Woo inside pdb&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;inPdb&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--in-valgrind&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run inside valgrind (must be in $PATH); automatically adds python ignore files&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;inValgrind&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--fake-display&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Allow importing the woo.qt module without initializing Qt. This is only useful for generating documentation and should not be used otherwise.&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;fakeDisplay&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;simulation&#39;</span><span class="p">,</span><span class="n">nargs</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">REMAINDER</span><span class="p">)</span>
    <span class="n">opts</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">WIN</span><span class="p">:</span> <span class="n">opts</span><span class="o">.</span><span class="n">rebuild</span><span class="o">=</span><span class="kc">False</span> <span class="c1"># make sure it is defined</span>
    <span class="n">args</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">simulation</span>

    <span class="n">green</span><span class="p">,</span><span class="n">red</span><span class="p">,</span><span class="n">yellow</span><span class="p">,</span><span class="n">bright</span><span class="o">=</span><span class="n">makeColorFuncs</span><span class="p">([</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="s1">&#39;RED&#39;</span><span class="p">,</span><span class="s1">&#39;YELLOW&#39;</span><span class="p">,</span><span class="s1">&#39;BRIGHT&#39;</span><span class="p">])</span>
    

    <span class="c1"># copy options (will be used in woo/__init__.py)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">ompThreads</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">threads</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">cores</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">ompCores</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">cores</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;--cores must be comma-separated list of integers, e.g. --cores=0,1,2.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">ompCores</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">options</span><span class="o">.</span><span class="n">clDev</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">clDev</span>
    <span class="n">options</span><span class="o">.</span><span class="n">forceNoGui</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">nogui</span>
    <span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">debug</span>
    <span class="n">options</span><span class="o">.</span><span class="n">quirks</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">quirks</span>
    <span class="n">options</span><span class="o">.</span><span class="n">flavor</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">flavor</span>
    <span class="n">options</span><span class="o">.</span><span class="n">fakeDisplay</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">fakeDisplay</span>

    <span class="c1"># disable quirks in those cases</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">version</span> <span class="ow">or</span> <span class="n">opts</span><span class="o">.</span><span class="n">inGdb</span> <span class="ow">or</span> <span class="n">opts</span><span class="o">.</span><span class="n">test</span> <span class="ow">or</span> <span class="n">opts</span><span class="o">.</span><span class="n">rebuild</span><span class="p">):</span>
        <span class="n">options</span><span class="o">.</span><span class="n">quirks</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">quirks</span><span class="o">=</span><span class="mi">0</span>

    <span class="c1"># show version and exit</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">woo.config</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">prettyVersion</span><span class="p">(),</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">features</span><span class="p">)))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># re-build woo so that the binary is up-to-date</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">rebuild</span><span class="p">:</span> <span class="c1"># only possible under Linux</span>
        <span class="n">options</span><span class="o">.</span><span class="n">rebuilding</span><span class="o">=</span><span class="kc">True</span>
        <span class="kn">import</span> <span class="nn">woo.config</span><span class="o">,</span> <span class="nn">glob</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sourceRoot</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;This build does not define woo.config.sourceRoot (packaged version?)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">rebuild</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sourceRoot</span><span class="o">+</span><span class="s1">&#39;/.git&#39;</span><span class="p">):</span> <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;git&#39;</span><span class="p">,</span><span class="s1">&#39;-C&#39;</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sourceRoot</span><span class="p">,</span><span class="s1">&#39;pull&#39;</span><span class="p">,</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sourceRoot</span><span class="o">+</span><span class="s1">&#39;/.bzr&#39;</span><span class="p">):</span> <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;bzr&#39;</span><span class="p">,</span><span class="s1">&#39;up&#39;</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sourceRoot</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Updating Woo using &#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Error updating Woo from repository.&#39;</span><span class="p">)</span>
            <span class="c1"># find updatable dirs in wooExtra</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sourceRoot</span><span class="o">+</span><span class="s1">&#39;/wooExtra/*&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sourceRoot</span><span class="o">+</span><span class="s1">&#39;/wooExtra/*/*&#39;</span><span class="p">):</span>
                <span class="n">dd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dd</span><span class="p">):</span> <span class="k">continue</span>
                <span class="n">cmd</span><span class="o">=</span><span class="kc">None</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dd</span><span class="o">+</span><span class="s1">&#39;/.git&#39;</span><span class="p">):</span> <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;git&#39;</span><span class="p">,</span><span class="s1">&#39;-C&#39;</span><span class="p">,</span><span class="n">dd</span><span class="p">,</span><span class="s1">&#39;pull&#39;</span><span class="p">,</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span> <span class="k">continue</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running: &#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Error updating </span><span class="si">%s</span><span class="s1"> from repository.&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">dd</span><span class="p">))</span>
        <span class="c1"># rebuild</span>
        <span class="c1"># cmake</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;buildJobs&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">buildJobs</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">jobs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-j&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">buildJobs</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">jobs</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">cmd</span><span class="o">=</span><span class="p">([</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">buildProgram</span><span class="p">]</span><span class="o">+</span><span class="n">jobs</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;-C&#39;</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">buildRoot</span><span class="p">,</span><span class="s1">&#39;install&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rebuilding Woo using&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Error rebuilding Woo (--rebuild).&#39;</span><span class="p">)</span>
        <span class="c1"># run ourselves</span>
        <span class="k">if</span> <span class="s1">&#39;--rebuild&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
            <span class="n">argv</span><span class="o">=</span><span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="k">if</span> <span class="n">v</span><span class="o">!=</span><span class="s1">&#39;--rebuild&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">argv</span><span class="o">=</span><span class="p">[(</span><span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^-[a-zA-Z]*$&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="k">if</span> <span class="n">v</span><span class="o">!=</span><span class="s1">&#39;-R&#39;</span> <span class="ow">and</span> <span class="n">v</span><span class="o">!=</span><span class="s1">&#39;-RR&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running Woo using&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">argv</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">argv</span><span class="p">))</span>
    <span class="c1"># QUIRK running in gdb</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">options</span><span class="o">.</span><span class="n">quirkFirePro</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">forceNoGui</span> <span class="ow">and</span> <span class="s1">&#39;DISPLAY&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">):</span>
        <span class="n">vgas</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;LC_ALL=C /sbin/lspci -nnk 2&gt;/dev/null | grep VGA -A3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">sum</span> <span class="p">([</span><span class="s1">&#39;FirePro&#39;</span> <span class="ow">in</span> <span class="n">vga</span> <span class="k">for</span> <span class="n">vga</span> <span class="ow">in</span> <span class="n">vgas</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="s1">&#39;fglrx&#39;</span> <span class="ow">in</span> <span class="n">vga</span> <span class="k">for</span> <span class="n">vga</span> <span class="ow">in</span> <span class="n">vgas</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;AMD FirePro GPU detected, will run inside gdb to avoid crash in buggy fglrx.so.&#39;</span><span class="p">)</span>
                <span class="n">opts</span><span class="o">.</span><span class="n">inGdb</span><span class="o">=</span><span class="kc">True</span>
                <span class="c1"># disable quirk to avoid infinite loop</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">=</span><span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;--quirks=</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">quirks</span><span class="o">&amp;</span><span class="p">(</span><span class="o">~</span><span class="n">options</span><span class="o">.</span><span class="n">quirkFirePro</span><span class="p">))]</span><span class="o">+</span><span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;--quirks&#39;</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1"># print &#39;AMD FirePro GPU without fglrx detected (quirk ignored).&#39;</span>
    <span class="c1"># re-run inside gdb</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">inGdb</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">tempfile</span><span class="o">,</span> <span class="nn">subprocess</span>
        <span class="c1"># windows can&#39;t open opened file, don&#39;t delete it then</span>
        <span class="c1"># Linux: delete afterwards, since gdb can open it in the meantime without problem</span>
        <span class="n">gdbBatch</span><span class="o">=</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;woo-gdb-&#39;</span><span class="p">,</span><span class="n">delete</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">WIN</span><span class="p">))</span>
        <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">WIN</span> <span class="k">else</span> <span class="s2">&quot;&#39;&quot;</span> <span class="c1"># gdb seems to read files differently on windows??</span>
        <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">sep</span><span class="o">+</span><span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="sa">r</span><span class="s2">&quot;\&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">sep</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="k">if</span> <span class="n">arg</span><span class="o">!=</span><span class="s1">&#39;--in-gdb&#39;</span><span class="p">]</span>
        <span class="n">gdbBatch</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;set pagination off</span><span class="se">\n</span><span class="s1">run &#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">WIN</span><span class="p">:</span> <span class="n">gdbBatch</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">gdbBatch</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>  
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Spawning: gdb -x &#39;</span><span class="o">+</span><span class="n">gdbBatch</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;gdb&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">([]</span> <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">debug</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;-batch-silent&#39;</span><span class="p">])</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;-x&#39;</span><span class="p">,</span><span class="n">gdbBatch</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">inLldb</span><span class="p">:</span>
        <span class="n">lldbExec</span><span class="p">,</span><span class="n">lldbMaybe</span><span class="o">=</span><span class="kc">None</span><span class="p">,[</span><span class="s1">&#39;lldb&#39;</span><span class="p">,</span><span class="s1">&#39;lldb-7&#39;</span><span class="p">,</span><span class="s1">&#39;lldb-8&#39;</span><span class="p">,</span><span class="s1">&#39;lldb-9&#39;</span><span class="p">]</span>
        <span class="kn">import</span> <span class="nn">shutil</span>
        <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">lldbMaybe</span><span class="p">:</span>
            <span class="n">lldbExec</span><span class="o">=</span><span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lldbExec</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">if</span> <span class="n">lldbExec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unable to find any of </span><span class="si">%s</span><span class="s2"> in $PATH&quot;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lldbMaybe</span><span class="p">)))</span>
        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="n">lldbExec</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span><span class="s1">&#39;--batch&#39;</span><span class="p">,</span><span class="s1">&#39;--one-line&#39;</span><span class="p">,</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;--one-line-on-crash&#39;</span><span class="p">,</span><span class="s1">&#39;bt all&#39;</span><span class="p">,</span><span class="s1">&#39;--&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="k">if</span> <span class="n">arg</span><span class="o">!=</span><span class="s1">&#39;--in-lldb&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Spawning: &#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">inValgrind</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">urllib.request</span><span class="o">,</span><span class="nn">os.path</span>
        <span class="n">saveTo</span><span class="o">=</span><span class="s1">&#39;/tmp/valgrind-python.supp&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">saveTo</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Downloading &#39;</span><span class="o">+</span><span class="n">saveTo</span><span class="p">)</span>
            <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="s1">&#39;http://svn.python.org/projects/python/trunk/Misc/valgrind-python.supp&#39;</span><span class="p">,</span><span class="n">saveTo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using already-downloaded &#39;</span><span class="o">+</span><span class="n">saveTo</span><span class="p">)</span>
        <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;valgrind&#39;</span><span class="p">,</span><span class="s1">&#39;--suppressions=&#39;</span><span class="o">+</span><span class="n">saveTo</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="k">if</span> <span class="n">a</span><span class="o">!=</span><span class="s1">&#39;--in-valgrind&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

    <span class="c1"># run this instance inside pdb</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">inPdb</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pdb</span>
        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
    <span class="c1">## run regression test suite and exit</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">woo.tests</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">testAll</span><span class="p">(</span><span class="n">sysExit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">options</span><span class="o">.</span><span class="n">batchLine</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">batchLine</span> <span class="c1"># copy this one in all cases</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">batchTable</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">batchLine</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;--batch-table given without --batch--line.&#39;</span><span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">batchTable</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">batchTable</span>
        <span class="n">options</span><span class="o">.</span><span class="n">batchLine</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">batchLine</span>
    <span class="c1"># this can be given even without batch line &amp; table</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">batchResults</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">batchResults</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">batchResults</span>
        <span class="k">if</span> <span class="s1">&#39;WOO_BATCH&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;WOO_BATCH env var exists, but --batch-table was also specified (WOO_BATCH is deprecated, it can still be used for backwards-compatibility, but not mixed with --batch-table).&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;WOO_BATCH&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">batch</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;WOO_BATCH&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;WOO_BATCH environment variable is malformed.&#39;</span><span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">batchTable</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">options</span><span class="o">.</span><span class="n">batchLine</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">batchResults</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WOO_BATCH environment variable is still honored, but deprecated. Say --batch-table=</span><span class="si">%s</span><span class="s1"> --batch-line=</span><span class="si">%d</span><span class="s1"> &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">batchTable</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">batchLine</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39; --batch-results=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">options</span><span class="o">.</span><span class="n">batchResults</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; instead.&#39;</span><span class="p">)</span>

    <span class="c1"># c++ boot code checks for WOO_DEBUG at some places; debug verbosity is equivalent</span>
    <span class="c1"># do this early, to have debug messages in the boot code (plugin registration etc)</span>
    <span class="c1">#print opts.verbosity,type(opts.verbosity)</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">verbosity</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;WOO_DEBUG&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;1&#39;</span>

    <span class="c1"># initialization and c++ plugins import</span>
    <span class="kn">import</span> <span class="nn">woo</span>
    <span class="c1"># other parts we will need soon</span>
    <span class="kn">import</span> <span class="nn">woo.config</span>
    <span class="kn">import</span> <span class="nn">woo.runtime</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">green</span><span class="p">(</span><span class="s1">&#39;Welcome to &#39;</span><span class="o">+</span><span class="n">bright</span><span class="p">(</span><span class="s1">&#39;Woo &#39;</span><span class="o">+</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">prettyVersion</span><span class="p">())</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39; (debug build)&#39;</span> <span class="k">if</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,(</span><span class="s1">&#39;, flavor &#39;</span><span class="o">+</span><span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">flavor</span> <span class="k">if</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">flavor</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39;, API </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">api</span><span class="p">)</span>
    <span class="n">ex</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;wooExtra.&#39;</span><span class="p">)])</span>
    <span class="k">if</span> <span class="n">ex</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">yellow</span><span class="p">(</span><span class="s1">&#39;wooExtra modules loaded: &#39;</span><span class="o">+</span><span class="n">bright</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="kn">import</span> <span class="nn">woo.log</span>
    <span class="kn">import</span> <span class="nn">woo.system</span>

    <span class="c1"># continue option processing</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">nice</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">WIN</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">psutil</span>
                <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">nice</span><span class="o">&lt;-</span><span class="mi">10</span><span class="p">:</span> <span class="n">wcl</span><span class="o">=</span><span class="n">psutil</span><span class="o">.</span><span class="n">HIGH_PRIORITY_PRIORITY_CLASS</span>
                <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">nice</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">wcl</span><span class="o">=</span><span class="n">psutil</span><span class="o">.</span><span class="n">ABOVE_NORMAL_PRIORITY_CLASS</span>
                <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">nice</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">wcl</span><span class="o">=</span><span class="n">psutil</span><span class="o">.</span><span class="n">NORMAL_PRIORITY_CLASS</span>
                <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">nice</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">:</span> <span class="n">wcl</span><span class="o">=</span><span class="n">psutil</span><span class="o">.</span><span class="n">BELOW_NORMAL_PRIORITY_CLASS</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">wcl</span><span class="o">=</span><span class="n">psutil</span><span class="o">.</span><span class="n">IDLE_PRIORITY_CLASS</span>
                <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span><span class="o">.</span><span class="n">nice</span><span class="o">=</span><span class="n">wcl</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Nice value </span><span class="si">%d</span><span class="s1"> ignored, since module psutil could not be imported (Windows only)&#39;</span><span class="o">%</span><span class="n">opts</span><span class="o">.</span><span class="n">nice</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">nice</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">nice</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">noGdb</span><span class="p">:</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">disableGdb</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">verbosity</span> <span class="ow">and</span> <span class="p">((</span><span class="s1">&#39;log4cxx&#39;</span> <span class="ow">in</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;spdlog&#39;</span> <span class="ow">in</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">features</span><span class="p">)):</span>
        <span class="n">woo</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,[</span><span class="n">woo</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">TRACE</span><span class="p">][</span><span class="nb">min</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">verbosity</span><span class="p">,</span><span class="mi">2</span><span class="p">)])</span>

    <span class="c1">## modify sys.argv in-place so that it can be handled by userSession</span>
    <span class="n">woo</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">origArgv</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[:]</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">argv</span><span class="o">=</span><span class="n">args</span>
    <span class="n">woo</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">opts</span><span class="o">=</span><span class="n">opts</span>

    <span class="c1"># be helpful when not overridden</span>
    <span class="k">def</span> <span class="nf">onSelection</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You selected an object. Define your own useful *onSelection(obj)* function to process it.&quot;</span><span class="p">)</span>

    <span class="c1">#from math import *</span>

    <span class="c1"># avoid warnings from ipython import (http://stackoverflow.com/a/3924047/761090)</span>
    <span class="c1"># the same is in gui/qt4/__init__.py, where IPython is imported earlier than here, if $DISPLAY is present</span>
    <span class="kn">import</span> <span class="nn">warnings</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">,</span><span class="n">module</span><span class="o">=</span><span class="s1">&#39;.*/IPython/.*&#39;</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># select gui to use</span>
    <span class="c1">#</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">woo.qt</span> <span class="c1"># this import fails if running with -n or $DISPLAY can&#39;t be connected to</span>
        <span class="k">if</span> <span class="s1">&#39;qt4&#39;</span> <span class="ow">in</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">features</span><span class="p">:</span> <span class="n">gui</span><span class="o">=</span><span class="s1">&#39;qt4&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">gui</span><span class="o">=</span><span class="s1">&#39;qt5&#39;</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">gui</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">woo</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">hasDisplay</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">woo</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">hasDisplay</span><span class="o">=</span><span class="kc">False</span>

    <span class="c1"># run remote access things, before actually starting the user session</span>
    <span class="kn">from</span> <span class="nn">woo</span> <span class="k">import</span> <span class="n">remote</span><span class="p">,</span> <span class="n">batch</span>
    <span class="n">woo</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">useQThread</span><span class="o">=</span><span class="p">(</span><span class="n">gui</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;qt4&#39;</span><span class="p">,</span><span class="s1">&#39;qt5&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">fakeDisplay</span><span class="p">)</span>
    <span class="c1"># only run XMLRPC server when in batch</span>
    <span class="c1"># do not run the TCP command prompt, is probably useless now</span>
    <span class="n">woo</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">runServers</span><span class="p">(</span><span class="n">xmlrpc</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">inBatch</span><span class="p">(),</span><span class="n">tcpPy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># for scripts</span>
    <span class="c1">#from woo import *</span>
    <span class="c1">#from math import *</span>
    <span class="kn">import</span> <span class="nn">woo.plot</span> <span class="c1"># monkey-patches, which require woo.runtime.hasDisplay (hence not importable from _monkey :/)</span>

    <span class="k">if</span> <span class="n">gui</span><span class="o">==</span><span class="kc">None</span> <span class="ow">or</span> <span class="n">opts</span><span class="o">.</span><span class="n">fakeDisplay</span><span class="p">:</span>
        <span class="n">ipythonSession</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">gui</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;qt4&#39;</span><span class="p">,</span><span class="s1">&#39;qt5&#39;</span><span class="p">):</span>
        <span class="c1">## we already tested that DISPLAY is available and can be opened</span>
        <span class="c1">### otherwise Qt4 might crash at this point</span>
        <span class="c1">#import woo.qt # this handles all Qt imports</span>
        <span class="n">ipythonSession</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span><span class="n">qt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">qapp</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">qt</span><span class="o">.</span><span class="n">wooQApp</span><span class="p">,</span><span class="n">qtConsole</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">qt</span><span class="o">.</span><span class="n">useQtConsole</span><span class="p">)</span>
    <span class="c1">#woo.master.exitNoBacktrace()</span>
    <span class="c1"># uninstall crash handlers</span>
    <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">disableGdb</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">0</span></div>


<span class="k">def</span> <span class="nf">ipythonSession</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span><span class="n">qt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">qapp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">qtConsole</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># prepare nice namespace for users</span>
    <span class="kn">import</span> <span class="nn">woo</span><span class="o">,</span> <span class="nn">woo.runtime</span><span class="o">,</span> <span class="nn">woo.config</span>
    <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">traceback</span><span class="o">,</span> <span class="nn">site</span>
    <span class="k">try</span><span class="p">:</span> <span class="kn">import</span> <span class="nn">wooExtra</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">arg0</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">qt</span><span class="p">:</span> <span class="n">woo</span><span class="o">.</span><span class="n">qt</span><span class="o">.</span><span class="n">Controller</span><span class="p">();</span>
        <span class="k">if</span> <span class="n">arg0</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">):</span>
            <span class="c1"># the script is reponsible for consuming all other arguments</span>
            <span class="k">def</span> <span class="nf">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Running script &quot;</span><span class="o">+</span><span class="n">arg0</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">exec</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">script</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span><span class="nb">globals</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span> <span class="k">raise</span>
                <span class="k">except</span><span class="p">:</span> <span class="c1"># all other exceptions</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">woo</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">exitAfter</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">woo</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">exitAfter</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">__opts</span><span class="o">=</span><span class="n">opts</span>
            <span class="n">runScript</span><span class="p">(</span><span class="n">arg0</span><span class="p">)</span>
            <span class="n">opts</span><span class="o">=</span><span class="n">__opts</span> <span class="c1"># in case the script uses opts as well :| (ugly)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Extra arguments to file to load: &#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
            <span class="c1"># attempt to load this file</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Object</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">arg0</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error loading file (wrong format?)&#39;</span><span class="p">,</span><span class="n">arg0</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Scene</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Running simulation &quot;</span><span class="o">+</span><span class="n">arg0</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">scene</span><span class="o">=</span><span class="n">obj</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Preprocessor</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Using preprocessor &quot;</span><span class="o">+</span><span class="n">arg0</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">woo.batch</span>
                <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">scene</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">runPreprocessor</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">arg0</span><span class="p">)</span>
                <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">saveTmp</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: Object loaded from &quot;</span><span class="si">%s</span><span class="s1">&quot; is a </span><span class="si">%s</span><span class="s1"> (must be Scene or a Preprocessor)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">paused</span><span class="p">:</span>
                <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">run</span><span class="p">()</span> <span class="c1"># run the new simulation</span>
                <span class="c1"># wait for the Master (if scenes are switched)</span>
                <span class="k">if</span> <span class="n">woo</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">exitAfter</span><span class="p">:</span> <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">waitForScenes</span><span class="p">()</span> 
    <span class="k">if</span> <span class="n">woo</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">expression</span><span class="p">:</span>
        <span class="c1"># try to be smart iporting some modules</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">m</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;(woo\.pre\.[a-zA-Z0-9_]+)\.([a-zA-Z0-9_]+)\(&#39;</span><span class="p">,</span><span class="n">opts</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>    <span class="nb">__import__</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">obj</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Scene</span><span class="p">):</span> <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">scene</span><span class="o">=</span><span class="n">obj</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Preprocessor</span><span class="p">):</span>
            <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">scene</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">runPreprocessor</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">saveTmp</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Expression given with -e must be a Scene or a Preprocessor, not a </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">paused</span><span class="p">:</span>
            <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">woo</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">exitAfter</span><span class="p">:</span> <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">waitForScenes</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">woo</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">woo</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">commands</span><span class="p">,</span><span class="nb">globals</span><span class="p">(),</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">woo</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">exitAfter</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Woo: normal exit.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># fake normal exit (so that batch looks fine if we crash at shutdown)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># common ipython configuration</span>
    <span class="n">ipconfig</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span> <span class="c1"># ipython options, see e.g. http://www.cv.nrao.edu/~rreid/casa/tips/ipy_user_conf.py</span>
        <span class="n">banner1</span><span class="o">=</span><span class="s1">&#39;[[ ^L clears screen, ^U kills line. &#39;</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;F12 controller&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">([</span><span class="s1">&#39;F11 3d view&#39;</span><span class="p">,</span><span class="s1">&#39;F10 both&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;opengl&#39;</span> <span class="ow">in</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">features</span> <span class="k">else</span> <span class="p">[])</span><span class="o">+</span><span class="p">([</span><span class="s1">&#39;F9 generator&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">qt</span> <span class="k">else</span> <span class="p">[])</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;F8 plot&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;. ]]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">prompt_in1</span><span class="o">=</span><span class="s1">&#39;Woo [\#]: &#39;</span><span class="p">,</span>
        <span class="n">prompt_in2</span><span class="o">=</span><span class="s1">&#39;    .\D.: &#39;</span><span class="p">,</span>
        <span class="n">prompt_out</span><span class="o">=</span><span class="s2">&quot; -&gt; [\#]: &quot;</span><span class="p">,</span>
        <span class="n">separate_in</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">separate_out</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">separate_out2</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">readline_parse_and_bind</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;tab: complete&#39;</span><span class="p">,</span>
            <span class="c1"># only with the gui; the escape codes might not work on non-linux terminals.</span>
            <span class="p">]</span>
            <span class="o">+</span><span class="p">([</span><span class="s1">&#39;&quot;\e[24~&quot;: &quot;\C-Uwoo.qt.Controller();\C-M&quot;&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">([</span><span class="s1">&#39;&quot;\e[23~&quot;: &quot;\C-Uwoo.qt.View();\C-M&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&quot;\e[21~&quot;: &quot;\C-Uwoo.qt.Controller(), woo.qt.View();\C-M&quot;&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;opengl&#39;</span> <span class="ow">in</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">features</span> <span class="k">else</span> <span class="p">[])</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;&quot;\e[20~&quot;: &quot;\C-Uwoo.qt.Generator();\C-M&quot;&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">qt</span> <span class="k">else</span> <span class="p">[])</span> <span class="c1"># F12,F11,F10,F9</span>
            <span class="o">+</span><span class="p">[</span><span class="s1">&#39;&quot;\e[19~&quot;: &quot;\C-Uwoo.master.scene.plot.plot();\C-M&quot;&#39;</span><span class="p">,</span> <span class="c1">#F8</span>
                <span class="s1">&#39;&quot;\e[A&quot;: history-search-backward&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;\e[B&quot;: history-search-forward&#39;</span><span class="p">,</span> <span class="c1"># incremental history forward/backward</span>
        <span class="p">]</span>
    <span class="p">)</span>
            
    <span class="c1"># shortcuts don&#39;t really work under windows, show controller directly in that case</span>
    <span class="k">if</span> <span class="n">qt</span> <span class="ow">and</span> <span class="n">WIN</span><span class="p">:</span> <span class="n">woo</span><span class="o">.</span><span class="n">qt</span><span class="o">.</span><span class="n">Controller</span><span class="p">()</span>

    <span class="n">ipython_version</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">ipython_version</span><span class="p">()</span>
    <span class="c1"># show python console</span>
    <span class="k">if</span> <span class="n">qtConsole</span><span class="p">:</span>
        <span class="n">qapp</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">IPython.terminal.embed</span> <span class="k">import</span> <span class="n">InteractiveShellEmbed</span> 
        <span class="c1"># use the dict to set attributes</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ipconfig</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">InteractiveShellEmbed</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">ipconfig</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">ipshell</span><span class="o">=</span><span class="n">InteractiveShellEmbed</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ipython_version</span><span class="o">&lt;</span><span class="mi">500</span><span class="p">:</span>
            <span class="n">ipshell</span><span class="o">.</span><span class="n">prompt_manager</span><span class="o">.</span><span class="n">in_template</span><span class="o">=</span> <span class="s1">&#39;Woo [\#]: &#39;</span>
            <span class="n">ipshell</span><span class="o">.</span><span class="n">prompt_manager</span><span class="o">.</span><span class="n">in2_template</span><span class="o">=</span><span class="s1">&#39;    .\D.: &#39;</span>
            <span class="n">ipshell</span><span class="o">.</span><span class="n">prompt_manager</span><span class="o">.</span><span class="n">out_template</span><span class="o">=</span><span class="s1">&#39; -&gt; [\#]: &#39;</span>
        <span class="c1"># IPython &gt;= 5.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># important, equivalent to %gui qt5 magick</span>
            <span class="k">if</span> <span class="n">qt</span><span class="p">:</span> <span class="n">ipshell</span><span class="o">.</span><span class="n">enable_gui</span><span class="p">(</span><span class="s1">&#39;qt5&#39;</span> <span class="k">if</span> <span class="s1">&#39;qt5&#39;</span> <span class="ow">in</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">features</span> <span class="k">else</span> <span class="s1">&#39;qt4&#39;</span><span class="p">)</span>
            <span class="c1"># custom prompt</span>
            <span class="c1"># http://stackoverflow.com/a/38277813/761090</span>
            <span class="kn">from</span> <span class="nn">IPython.terminal.prompts</span> <span class="k">import</span> <span class="n">Prompts</span><span class="p">,</span> <span class="n">Token</span>
            <span class="k">class</span> <span class="nc">WooPrompt</span><span class="p">(</span><span class="n">Prompts</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">in_prompt_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cli</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="k">return</span> <span class="p">[(</span><span class="n">Token</span><span class="o">.</span><span class="n">Prompt</span><span class="p">,</span><span class="s1">&#39;Woo [&#39;</span><span class="p">),(</span><span class="n">Token</span><span class="o">.</span><span class="n">PromptNum</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">execution_count</span><span class="p">)),(</span><span class="n">Token</span><span class="o">.</span><span class="n">Prompt</span><span class="p">,</span><span class="s1">&#39;]: &#39;</span><span class="p">),(</span><span class="n">Token</span><span class="o">.</span><span class="n">Generic</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)]</span>
                <span class="k">def</span> <span class="nf">out_prompt_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">[(</span><span class="n">Token</span><span class="o">.</span><span class="n">OutPrompt</span><span class="p">,</span><span class="s1">&#39;--&gt; [&#39;</span><span class="p">),(</span><span class="n">Token</span><span class="o">.</span><span class="n">OutPromptNum</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">execution_count</span><span class="p">)),(</span><span class="n">Token</span><span class="o">.</span><span class="n">OutPrompt</span><span class="p">,</span><span class="s1">&#39;]: &#39;</span><span class="p">),(</span><span class="n">Token</span><span class="o">.</span><span class="n">Generic</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># IPython&lt;7.0</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ipshell</span><span class="p">,</span><span class="s1">&#39;pt_cli&#39;</span><span class="p">):</span> <span class="n">registry</span><span class="o">=</span><span class="n">ipshell</span><span class="o">.</span><span class="n">pt_cli</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">key_bindings_registry</span>
                <span class="c1"># IPython 7.x</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ipshell</span><span class="p">,</span><span class="s1">&#39;pt_app&#39;</span><span class="p">):</span> <span class="n">registry</span><span class="o">=</span><span class="n">ipshell</span><span class="o">.</span><span class="n">pt_app</span><span class="o">.</span><span class="n">key_bindings</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">registry</span><span class="o">=</span><span class="kc">None</span>
            <span class="k">except</span><span class="p">:</span> <span class="n">registry</span><span class="o">=</span><span class="kc">None</span>
            <span class="k">if</span> <span class="n">registry</span><span class="p">:</span>
                <span class="c1"># shortcuts setup</span>
                <span class="c1"># tersely documented at http://ipython.readthedocs.io/en/latest/config/details.html#keyboard-shortcuts</span>
                <span class="kn">from</span> <span class="nn">prompt_toolkit.keys</span> <span class="k">import</span> <span class="n">Keys</span>
                <span class="kn">import</span> <span class="nn">traceback</span>
                <span class="k">def</span> <span class="nf">_catch</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                    <span class="s1">&#39;Wrap all shortcut calls in this catcher, otherwise the whole program crashes when there is exception in the event callback&#39;</span>
                    <span class="k">try</span><span class="p">:</span> <span class="n">c</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="c1"># add shortcuts here (we discard the event object which the callback always receives)</span>
                <span class="n">registry</span><span class="o">.</span><span class="n">add_binding</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">F8</span><span class="p">)(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">_catch</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot</span><span class="p">()))</span>
                <span class="k">if</span> <span class="n">qt</span><span class="p">:</span>
                    <span class="n">registry</span><span class="o">.</span><span class="n">add_binding</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">F9</span><span class="p">)(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span>  <span class="n">_catch</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">woo</span><span class="o">.</span><span class="n">qt</span><span class="o">.</span><span class="n">Generator</span><span class="p">()))</span>
                    <span class="n">registry</span><span class="o">.</span><span class="n">add_binding</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">F12</span><span class="p">)(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">_catch</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">woo</span><span class="o">.</span><span class="n">qt</span><span class="o">.</span><span class="n">Controller</span><span class="p">()))</span>
                <span class="k">if</span> <span class="s1">&#39;opengl&#39;</span> <span class="ow">in</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
                    <span class="n">registry</span><span class="o">.</span><span class="n">add_binding</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">F10</span><span class="p">)(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">_catch</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[</span><span class="n">woo</span><span class="o">.</span><span class="n">qt</span><span class="o">.</span><span class="n">Controller</span><span class="p">(),</span><span class="n">woo</span><span class="o">.</span><span class="n">qt</span><span class="o">.</span><span class="n">View</span><span class="p">()]))</span>
                    <span class="n">registry</span><span class="o">.</span><span class="n">add_binding</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">F11</span><span class="p">)(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">_catch</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">woo</span><span class="o">.</span><span class="n">qt</span><span class="o">.</span><span class="n">View</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARN: prompt_toolkit not used by IPython, key bindings were not set.&#39;</span><span class="p">)</span>
            <span class="n">ipshell</span><span class="o">.</span><span class="n">prompts</span><span class="o">=</span><span class="n">WooPrompt</span><span class="p">(</span><span class="n">ipshell</span><span class="p">)</span>
        <span class="n">ipshell</span><span class="p">()</span>


<div class="viewcode-block" id="batch"><a class="viewcode-back" href="../wooMain.html#wooMain.batch">[docs]</a><span class="k">def</span> <span class="nf">batch</span><span class="p">(</span><span class="n">sysArgv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Entry point for the woo-batch executable. *sysArgv* (if specified) replaces sys.argv, which is used for option processing.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">_thread</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">pipes</span><span class="o">,</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">xmlrpc.client</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">os.path</span>
    <span class="k">if</span> <span class="n">sysArgv</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">=</span><span class="n">sysArgv</span>
    
    <span class="n">green</span><span class="p">,</span><span class="n">red</span><span class="p">,</span><span class="n">yellow</span><span class="p">,</span><span class="n">bright</span><span class="o">=</span><span class="n">makeColorFuncs</span><span class="p">([</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="s1">&#39;RED&#39;</span><span class="p">,</span><span class="s1">&#39;YELLOW&#39;</span><span class="p">,</span><span class="s1">&#39;BRIGHT&#39;</span><span class="p">],</span><span class="n">dumbWinColors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="c1">#socket.setdefaulttimeout(10) </span>
    
    <span class="n">match</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(.*)[_-]batch(-script\.py|.exe)?$&#39;</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Batch executable &quot;</span><span class="si">%s</span><span class="s1">&quot;does not match &quot;.*[_-]batch(-script\.py)?&quot;&#39;</span><span class="o">%</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">executable</span><span class="o">=</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">options</span>
    <span class="n">options</span><span class="o">.</span><span class="n">forceNoGui</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">options</span><span class="o">.</span><span class="n">quirks</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">options</span><span class="o">.</span><span class="n">flavor</span><span class="o">=</span><span class="n">flavorFromArgv0</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">batch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">woo</span><span class="o">,</span> <span class="nn">woo.batch</span><span class="o">,</span> <span class="nn">woo.config</span><span class="o">,</span> <span class="nn">woo.remote</span>
    
    <span class="c1">#re.sub(&#39;-batch(|.bat|.py)?$&#39;,&#39;\\1&#39;,sys.argv[0])</span>
    
    
    <span class="k">class</span> <span class="nc">JobInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">num</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">hrefCommand</span><span class="p">,</span><span class="n">log</span><span class="p">,</span><span class="n">nCores</span><span class="p">,</span><span class="n">script</span><span class="p">,</span><span class="n">table</span><span class="p">,</span><span class="n">lineNo</span><span class="p">,</span><span class="n">affinity</span><span class="p">,</span><span class="n">resultsDb</span><span class="p">,</span><span class="n">debug</span><span class="p">,</span><span class="n">executable</span><span class="p">,</span><span class="n">nice</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">durationSec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">exitStatus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span> <span class="c1"># duration is a string, durationSec is a number</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrefCommand</span><span class="o">=</span><span class="n">hrefCommand</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">=</span><span class="nb">id</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nCores</span><span class="o">=</span><span class="n">nCores</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores</span><span class="o">=</span><span class="nb">set</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">infoSocket</span><span class="o">=</span><span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">script</span><span class="o">=</span><span class="n">script</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineNo</span><span class="o">=</span><span class="n">lineNo</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity</span><span class="o">=</span><span class="n">affinity</span><span class="p">;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resultsDb</span><span class="o">=</span><span class="n">resultsDb</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">=</span><span class="n">executable</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nice</span><span class="o">=</span><span class="n">nice</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hasXmlrpc</span><span class="o">=</span><span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;PENDING&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threadNum</span><span class="o">=</span><span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">winBatch</span><span class="o">=</span><span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotsLastUpdate</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">plotsFile</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">tmpFilename</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">woo</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">plotImgFormat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hrefCommand</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{self.executable}</span><span class="s1"> &lt;a href=&quot;jobs/</span><span class="si">{self.num}</span><span class="s1">/table&quot;&gt;--batch-table=</span><span class="si">{self.table}</span><span class="s1"> --batch-line=</span><span class="si">{self.lineNo}</span><span class="s1"> --batch-results=</span><span class="si">{self.resultsDb}</span><span class="s1">&lt;/a&gt;  &lt;a href=&quot;jobs/</span><span class="si">{self.num}</span><span class="s1">/script&quot;&gt;</span><span class="si">{self.script}</span><span class="s1">&lt;/a&gt; &amp;gt; &lt;a href=&quot;jobs/</span><span class="si">{self.num}</span><span class="s1">/log&quot;&gt;</span><span class="si">{self.log}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">WIN</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hrefCommand</span><span class="o">=</span><span class="s1">&#39;&lt;a href=&quot;jobs/</span><span class="si">{self.num}</span><span class="s1">/winbatch&quot;&gt;.bat&lt;/a&gt;: &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">hrefCommand</span>
        <span class="k">def</span> <span class="nf">prepareToRun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="s1">&#39;Assemble command to run as needed&#39;</span>
            <span class="kn">import</span> <span class="nn">pipes</span>
            <span class="n">batchOpts</span><span class="o">=</span><span class="s1">&#39;--batch-table=</span><span class="si">{self.table}</span><span class="s1"> --batch-line=</span><span class="si">{self.lineNo}</span><span class="s1"> --batch-results=</span><span class="si">{self.resultsDb}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">WIN</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">winBatch</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">tmpFilename</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.bat&#39;</span>
                <span class="n">batch</span><span class="o">=</span><span class="s1">&#39;@ECHO OFF</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="c1"># don&#39;s show commands in terminal</span>
                <span class="n">batch</span><span class="o">+=</span><span class="s1">&#39;set OMP_NUM_THREADS=</span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">job</span><span class="o">.</span><span class="n">nCores</span>
                <span class="n">batch</span><span class="o">+=</span><span class="s1">&#39;set PYTHONIOENCODING=utf_8</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">job</span><span class="o">.</span><span class="n">nCores</span>
                <span class="c1">#batch+=&#39;set WOO_BATCH={self.table}:{self.lineNo}:{self.resultsDb}\n&#39;.format(self=self)</span>
                <span class="c1">#batch+=&#39;start /B /WAIT /LOW &#39;</span>
                <span class="n">batch</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">{self.executable}</span><span class="s1"> -x -n </span><span class="si">{batchOpts}</span><span class="s1"> </span><span class="si">{self.script}</span><span class="s1"> </span><span class="si">{debugFlag}</span><span class="s1"> &gt; </span><span class="si">{self.log}</span><span class="s1"> 2&gt;&amp;1 </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">batchOpts</span><span class="o">=</span><span class="n">batchOpts</span><span class="p">,</span><span class="n">debugFlag</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;-D&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="c1">#sys.stderr.write(batch)</span>
                <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">winBatch</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">winBatch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hrefCommand</span><span class="o">+=</span><span class="s1">&#39;&lt;br&gt;&lt;tt&gt;&lt;a href=&quot;jobs/</span><span class="si">{self.num}</span><span class="s1">/winbatch&quot;&gt;</span><span class="si">{self.command}</span><span class="s1">&lt;/a&gt;&lt;/tt&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ompOpt</span><span class="p">,</span><span class="n">niceOpt</span><span class="p">,</span><span class="n">debugOpt</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores</span><span class="p">:</span> <span class="n">ompOpt</span><span class="o">=</span><span class="s1">&#39;--cores=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores</span><span class="p">))</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nCores</span><span class="p">:</span> <span class="n">ompOpt</span><span class="o">=</span><span class="s1">&#39;--threads=</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nCores</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nice</span><span class="p">:</span> <span class="n">niceOpt</span><span class="o">=</span><span class="s1">&#39;--nice=</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">nice</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span> <span class="n">debugOpt</span><span class="o">=</span><span class="s1">&#39;--debug&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">=</span><span class="s1">&#39;PYTHONIOENCODING=utf_8 </span><span class="si">{self.executable}</span><span class="s1"> -x -n </span><span class="si">{batchOpts}</span><span class="s1"> </span><span class="si">{ompOpt}</span><span class="s1"> </span><span class="si">{niceOpt}</span><span class="s1"> </span><span class="si">{debugOpt}</span><span class="s1"> </span><span class="si">{self.script}</span><span class="s1"> &gt; </span><span class="si">{logFile}</span><span class="s1"> 2&gt;&amp;1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">batchOpts</span><span class="o">=</span><span class="n">batchOpts</span><span class="p">,</span><span class="n">ompOpt</span><span class="o">=</span><span class="n">ompOpt</span><span class="p">,</span><span class="n">niceOpt</span><span class="o">=</span><span class="n">niceOpt</span><span class="p">,</span><span class="n">debugOpt</span><span class="o">=</span><span class="n">debugOpt</span><span class="p">,</span><span class="n">logFile</span><span class="o">=</span><span class="n">pipes</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hrefCommand</span><span class="o">+=</span><span class="s1">&#39;&lt;br&gt;&lt;tt&gt;&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;&lt;/tt&gt;&#39;</span>
            
        <span class="k">def</span> <span class="nf">saveInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">log</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">=================== JOB SUMMARY ================</span>
<span class="s2">id      : </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">status  : </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">duration: </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">command : </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">started : </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">finished: </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">exitStatus</span><span class="p">,</span><span class="s1">&#39;OK&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exitStatus</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;FAILED&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">)),</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">))));</span>
            <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">ensureXmlrpc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="s1">&#39;Attempt to establish xmlrpc connection to the job (if it does not exist yet). If the connection could not be established, as magic line was not found in the log, return False.&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasXmlrpc</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;XMLRPC info provider on&#39;</span><span class="p">):</span> <span class="k">continue</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">l</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xmlrpcConn</span><span class="o">=</span><span class="n">xmlrpc</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ServerProxy</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hasXmlrpc</span><span class="o">=</span><span class="kc">True</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasXmlrpc</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span> <span class="c1"># catches the case where the magic line is not in the log yet</span>
        <span class="k">def</span> <span class="nf">getInfoDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">!=</span><span class="s1">&#39;RUNNING&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensureXmlrpc</span><span class="p">():</span> <span class="k">return</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmlrpcConn</span><span class="o">.</span><span class="n">basicInfo</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error getting simulation information via XMLRPC&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">updatePlots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">!=</span><span class="s1">&#39;RUNNING&#39;</span><span class="p">:</span> <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensureXmlrpc</span><span class="p">():</span> <span class="k">return</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">plotsLastUpdate</span><span class="o">&lt;</span><span class="n">opts</span><span class="o">.</span><span class="n">plotTimeout</span><span class="p">:</span>
                <span class="c1">#sys.stderr.write(&#39;[%g-%g=%g&lt;%g]&#39;%(time.time(),self.plotsLastUpdate,time.time()-self.plotsLastUpdate,opts.plotTimeout))</span>
                <span class="k">return</span>
            <span class="n">img</span><span class="o">=</span><span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xmlrpcConn</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error getting plot via XMLRPC&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">img</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotsFile</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotsFile</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotsFile</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c1">#sys.stderr.write(&#39;[Plot updated!]&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotsLastUpdate</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1"># print woo.remote.plotImgFormat,&#39;(%d bytes) written to %s&#39;%(os.path.getsize(self.plotsFile),self.plotsFile)</span>
    
        <span class="k">def</span> <span class="nf">htmlStats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">ret</span><span class="o">=</span><span class="s1">&#39;&lt;tr&gt;&#39;</span>
            <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;td&gt;</span><span class="si">%s</span><span class="s1">&lt;/td&gt;&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;PENDING&#39;</span><span class="p">:</span> <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;td bgcolor=&quot;grey&quot;&gt;(pending)&lt;/td&gt;&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;RUNNING&#39;</span><span class="p">:</span> <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;td bgcolor=&quot;yellow&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/td&gt;&#39;</span><span class="o">%</span><span class="n">t2hhmmss</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;DONE&#39;</span><span class="p">:</span> <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;td bgcolor=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/td&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39;lime&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exitStatus</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getInfoDict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updatePlots</span><span class="p">()</span> <span class="c1"># checks for last update time</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                <span class="n">runningTime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">started</span>
                <span class="n">stopAtStep</span><span class="p">,</span><span class="n">stopAtTime</span><span class="p">,</span><span class="n">step</span><span class="p">,</span><span class="n">_time</span><span class="o">=</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;stopAtStep&#39;</span><span class="p">],</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;stopAtTime&#39;</span><span class="p">],</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">],</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
                <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;td&gt;&#39;</span>
                <span class="k">if</span> <span class="n">stopAtStep</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;nobr&gt;</span><span class="si">%2.2f%%</span><span class="s1"> done&lt;/nobr&gt;&lt;br/&gt;&lt;nobr&gt;step </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&lt;/nobr&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">step</span><span class="o">*</span><span class="mf">100.</span><span class="o">/</span><span class="n">stopAtStep</span><span class="p">,</span><span class="n">step</span><span class="p">,</span><span class="n">stopAtStep</span><span class="p">)</span>
                    <span class="n">finishTime</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">runningTime</span><span class="o">*</span><span class="p">(</span><span class="n">stopAtStep</span><span class="o">/</span><span class="n">step</span><span class="p">)))))</span>
                    <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;br/&gt;&lt;font size=&quot;1&quot;&gt;&lt;nobr&gt;ETA </span><span class="si">%s</span><span class="s1">&lt;/nobr&gt;&lt;/font&gt;&lt;br/&gt;&#39;</span><span class="o">%</span><span class="n">finishTime</span>

                <span class="k">else</span><span class="p">:</span> <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;nobr&gt;step </span><span class="si">%d</span><span class="s1">&lt;/nobr&gt;&#39;</span><span class="o">%</span><span class="n">step</span>
                <span class="k">if</span> <span class="n">runningTime</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span> <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;br/&gt;&lt;nobr&gt;avg </span><span class="si">%g</span><span class="s1">/sec&lt;/nobr&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">step</span><span class="o">/</span><span class="n">runningTime</span><span class="p">)</span>
                <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;br/&gt;&lt;nobr&gt;&amp;Delta;t </span><span class="si">%g</span><span class="s1"> s&lt;/nobr&gt;&#39;</span><span class="o">%</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>
                <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;br/&gt;&lt;nobr&gt;</span><span class="si">%d</span><span class="s1"> particles&lt;/nobr&gt;&lt;br/&gt;&lt;nobr&gt;</span><span class="si">%d</span><span class="s1"> contacts&lt;/nobr&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;numBodies&#39;</span><span class="p">],</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;numIntrs&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">stopAtTime</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;br/&gt;&lt;nobr&gt;</span><span class="si">%2.2f%%</span><span class="s1"> done&lt;/nobr&gt;&lt;br/&gt;&lt;nobr&gt;time </span><span class="si">%g</span><span class="s1">/</span><span class="si">%g</span><span class="s1"> s&lt;/nobr&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">_time</span><span class="o">*</span><span class="mf">100.</span><span class="o">/</span><span class="n">stopAtTime</span><span class="p">,</span><span class="n">_time</span><span class="p">,</span><span class="n">stopAtTime</span><span class="p">)</span>
                    <span class="n">finishTime</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">runningTime</span><span class="o">*</span><span class="p">(</span><span class="n">stopAtTime</span><span class="o">/</span><span class="n">_time</span><span class="p">)))))</span>
                    <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;br/&gt;&lt;font size=&quot;1&quot;&gt;&lt;nobr&gt;ETA </span><span class="si">%s</span><span class="s1">&lt;/nobr&gt;&lt;/font&gt;&lt;br/&gt;&#39;</span><span class="o">%</span><span class="n">finishTime</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;br/&gt;&lt;nobr&gt;time </span><span class="si">%g</span><span class="s1"> s&lt;/nobr&gt;&#39;</span><span class="o">%</span><span class="n">_time</span>
                <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]:</span> <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;br/&gt;title &lt;i&gt;</span><span class="si">%s</span><span class="s1">&lt;/i&gt;&#39;</span><span class="o">%</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;PID&#39;</span><span class="p">]:</span> <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;br/&gt;PID </span><span class="si">%d</span><span class="s1">&lt;/br&gt;&#39;</span><span class="o">%</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;PID&#39;</span><span class="p">]</span>
                <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;/td&gt;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;td&gt; (no info) &lt;/td&gt;&#39;</span>
            <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;td&gt;</span><span class="si">%d%s</span><span class="s1">&lt;/td&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nCores</span><span class="p">,(</span><span class="s1">&#39; (&#39;</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;RUNNING&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># TODO: make clickable so that it can be served full-size</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotsFile</span><span class="p">):</span>
                <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="k">pass</span>
                    <span class="c1">## all this mess to embed SVG; clicking on it does not work, though</span>
                    <span class="c1">## question posted at http://www.abclinuxu.cz/poradna/linux/show/314041</span>
                    <span class="c1">## see also http://www.w3schools.com/svg/svg_inhtml.asp and http://dutzend.blogspot.com/2010/04/svg-im-anklickbar-machen.html</span>
                    <span class="c1">#img=&#39;&lt;object data=&quot;/jobs/%d/plots&quot; type=&quot;%s&quot; width=&quot;300px&quot; alt=&quot;[plots]&quot;/&gt;&#39;%(self.num,woo.remote.plotImgMimetype)</span>
                    <span class="c1">#img=&#39;&lt;iframe src=&quot;/jobs/%d/plots&quot; type=&quot;%s&quot; width=&quot;300px&quot; alt=&quot;[plots]&quot;/&gt;&#39;%(self.num,woo.remote.plotImgMimetype)</span>
                    <span class="c1">#img=&#39;&lt;embed src=&quot;/jobs/%d/plots&quot; type=&quot;%s&quot; width=&quot;300px&quot; alt=&quot;[plots]&quot;/&gt;&#39;%(self.num,woo.remote.plotImgMimetype)a</span>
                <span class="n">img</span><span class="o">=</span><span class="s1">&#39;&lt;img src=&quot;/jobs/</span><span class="si">%d</span><span class="s1">/plots&quot; width=&quot;300px&quot; alt=&quot;[plots]&quot;&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num</span><span class="p">)</span>
                <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;td&gt;&lt;a href=&quot;/jobs/</span><span class="si">%d</span><span class="s1">/plots&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/a&gt;&lt;/td&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num</span><span class="p">,</span><span class="n">img</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;td&gt; (no plots) &lt;/td&gt;&#39;</span>
            <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;td&gt;</span><span class="si">%s</span><span class="s1">&lt;/td&gt;&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">hrefCommand</span>
            <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;/tr&gt;&#39;</span>
            <span class="k">return</span> <span class="n">ret</span>
    <span class="k">def</span> <span class="nf">t2hhmmss</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">:</span><span class="si">%02d</span><span class="s1">:</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">dt</span><span class="o">//</span><span class="mi">3600</span><span class="p">,(</span><span class="n">dt</span><span class="o">%</span><span class="mi">3600</span><span class="p">)</span><span class="o">//</span><span class="mi">60</span><span class="p">,(</span><span class="n">dt</span><span class="o">%</span><span class="mi">60</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">totalRunningTime</span><span class="p">():</span>
        <span class="n">tt0</span><span class="p">,</span><span class="n">tt1</span><span class="o">=</span><span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">started</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">started</span><span class="p">],[</span><span class="n">j</span><span class="o">.</span><span class="n">finished</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">finished</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()]</span>
        <span class="c1"># it is safe to suppose that </span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt0</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span> <span class="c1"># no job has been started at all</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">tt1</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">tt0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">globalHtmlStats</span><span class="p">():</span>
        <span class="n">tt0</span><span class="o">=</span><span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">started</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">started</span><span class="o">!=</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt0</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">t0</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">tt0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">t0</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">unfinished</span><span class="o">=</span><span class="nb">len</span><span class="p">([</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">status</span><span class="o">!=</span><span class="s1">&#39;DONE&#39;</span><span class="p">])</span>
        <span class="n">nUsedCores</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">j</span><span class="o">.</span><span class="n">nCores</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;RUNNING&#39;</span><span class="p">])</span>
        <span class="c1"># global maxJobs</span>
        <span class="k">if</span> <span class="n">unfinished</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">=</span><span class="s1">&#39;&lt;p&gt;Running for </span><span class="si">%s</span><span class="s1">, since </span><span class="si">%s</span><span class="s1">.&lt;/p&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">t2hhmmss</span><span class="p">(</span><span class="n">totalRunningTime</span><span class="p">()),</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">t0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">failed</span><span class="o">=</span><span class="nb">len</span><span class="p">([</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">exitStatus</span><span class="o">!=</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">jobs</span><span class="p">:</span> <span class="n">lastFinished</span><span class="o">=</span><span class="nb">max</span><span class="p">([</span><span class="n">j</span><span class="o">.</span><span class="n">finished</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">lastFinished</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1"># FIXME: do not report sum of runnign time of all jobs, only the real timespan</span>
            <span class="n">ret</span><span class="o">=</span><span class="s1">&#39;&lt;p&gt;&lt;span style=&quot;background-color:</span><span class="si">%s</span><span class="s1">&quot;&gt;Finished&lt;/span&gt;, idle for </span><span class="si">%s</span><span class="s1">, running time </span><span class="si">%s</span><span class="s1"> since </span><span class="si">%s</span><span class="s1">.&lt;/p&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39;red&#39;</span> <span class="k">if</span> <span class="n">failed</span> <span class="k">else</span> <span class="s1">&#39;lime&#39;</span><span class="p">,</span><span class="n">t2hhmmss</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">lastFinished</span><span class="p">),</span><span class="n">t2hhmmss</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">j</span><span class="o">.</span><span class="n">finished</span><span class="o">-</span><span class="n">j</span><span class="o">.</span><span class="n">started</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">started</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])),</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">t0</span><span class="p">))</span>
        <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;p&gt;Pid </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">globalLog</span><span class="p">:</span> <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;, log &lt;a href=&quot;/log&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/a&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">globalLog</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;/p&gt;&#39;</span>
        <span class="n">allCores</span><span class="p">,</span><span class="n">busyCores</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">maxJobs</span><span class="p">)),</span><span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">cores</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;RUNNING&#39;</span><span class="p">))</span>
        <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;p&gt;</span><span class="si">%d</span><span class="s1"> cores available, </span><span class="si">%d</span><span class="s1"> used + </span><span class="si">%d</span><span class="s1"> free.&lt;/p&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">maxJobs</span><span class="p">,</span><span class="n">nUsedCores</span><span class="p">,</span><span class="n">maxJobs</span><span class="o">-</span><span class="n">nUsedCores</span><span class="p">)</span>
        <span class="c1"># show busy and free cores; gives nonsense if not all jobs have CPU affinity set</span>
        <span class="c1"># &#39;([%s] = [%s] + [%s])&#39;%(&#39;,&#39;.join([str(c) for c in allCores]),&#39;,&#39;.join([str(c) for c in busyCores]),&#39;,&#39;.join([str(c) for s in (allCores-busyCores)]))</span>
        <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;h3&gt;Jobs&lt;/h3&gt;&#39;</span>
        <span class="n">nFailed</span><span class="o">=</span><span class="nb">len</span><span class="p">([</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;DONE&#39;</span> <span class="ow">and</span> <span class="n">j</span><span class="o">.</span><span class="n">exitStatus</span><span class="o">!=</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;&lt;p&gt;&lt;b&gt;</span><span class="si">%d</span><span class="s1">&lt;/b&gt; total, &lt;b&gt;</span><span class="si">%d</span><span class="s1">&lt;/b&gt; &lt;span style=&quot;background-color:yellow&quot;&gt;running&lt;/span&gt;, &lt;b&gt;</span><span class="si">%d</span><span class="s1">&lt;/b&gt; &lt;span style=&quot;background-color:lime&quot;&gt;done&lt;/span&gt;</span><span class="si">%s</span><span class="s1">&lt;/p&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">),</span><span class="nb">len</span><span class="p">([</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;RUNNING&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">([</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;DONE&#39;</span><span class="p">]),</span><span class="s1">&#39; (&lt;b&gt;</span><span class="si">%d</span><span class="s1"> &lt;span style=&quot;background-color:red&quot;&gt;&lt;b&gt;failed&lt;/b&gt;&lt;/span&gt;)&#39;</span><span class="o">%</span><span class="n">nFailed</span> <span class="k">if</span> <span class="n">nFailed</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
    
    <span class="kn">from</span> <span class="nn">http.server</span> <span class="k">import</span> <span class="n">BaseHTTPRequestHandler</span><span class="p">,</span><span class="n">HTTPServer</span>
    <span class="kn">import</span> <span class="nn">socket</span><span class="o">,</span><span class="nn">re</span><span class="o">,</span><span class="nn">socketserver</span>
    <span class="k">class</span> <span class="nc">HttpStatsServer</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">ThreadingMixIn</span><span class="p">,</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
        <span class="n">favicon</span><span class="o">=</span><span class="kc">None</span> <span class="c1"># binary favicon, created when first requested</span>
        <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">==</span><span class="s1">&#39;/&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendGlobal</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">==</span><span class="s1">&#39;/favicon.ico&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">favicon</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">pkg_resources</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">favicon</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;woo&#39;</span><span class="p">,</span><span class="s1">&#39;data/woo-favicon.ico&#39;</span><span class="p">),</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sendHttp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">favicon</span><span class="p">,</span><span class="n">contentType</span><span class="o">=</span><span class="s1">&#39;image/vnd.microsoft.icon&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">==</span><span class="s1">&#39;/log&#39;</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">globalLog</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sendTextFile</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">globalLog</span><span class="p">,</span><span class="n">refresh</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">refresh</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">jobMatch</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;/jobs/([0-9]+)/(.*)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">jobMatch</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">);</span> <span class="k">return</span>
                <span class="n">jobId</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">jobMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">jobId</span><span class="o">&gt;=</span><span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">);</span> <span class="k">return</span>
                <span class="n">job</span><span class="o">=</span><span class="n">jobs</span><span class="p">[</span><span class="n">jobId</span><span class="p">]</span>
                <span class="n">rest</span><span class="o">=</span><span class="n">jobMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rest</span><span class="o">==</span><span class="s1">&#39;plots&#39;</span><span class="p">:</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">updatePlots</span><span class="p">()</span> <span class="c1"># internally checks for last update time</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sendFile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">plotsFile</span><span class="p">,</span><span class="n">contentType</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">plotImgMimetype</span><span class="p">,</span><span class="n">refresh</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;DONE&#39;</span> <span class="k">else</span> <span class="n">opts</span><span class="o">.</span><span class="n">refresh</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">rest</span><span class="o">==</span><span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">log</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">);</span> <span class="k">return</span>
                    <span class="c1">## once we authenticate properly, send the whole file</span>
                    <span class="c1">## self.sendTextFile(jobs[jobId].log,refresh=opts.refresh)</span>
                    <span class="c1">## now we have to filter away the cookie</span>
                    <span class="n">cookieRemoved</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span> <span class="n">data</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">log</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">cookieRemoved</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^.*TCP python prompt on .*, auth cookie.*$&#39;</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
                            <span class="n">ii</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;auth cookie `&#39;</span><span class="p">);</span> <span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="p">[:</span><span class="n">ii</span><span class="o">+</span><span class="mi">13</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;******&#39;</span><span class="o">+</span><span class="n">l</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">19</span><span class="p">:];</span> <span class="n">cookieRemoved</span><span class="o">=</span><span class="kc">True</span>
                        <span class="n">data</span><span class="o">+=</span><span class="n">l</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sendHttp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">contentType</span><span class="o">=</span><span class="s1">&#39;text/plain;charset=utf-8;&#39;</span><span class="p">,</span><span class="n">refresh</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;DONE&#39;</span> <span class="k">else</span> <span class="n">opts</span><span class="o">.</span><span class="n">refresh</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">rest</span><span class="o">==</span><span class="s1">&#39;script&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sendPygmentizedFile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">script</span><span class="p">,</span><span class="n">linenostep</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">rest</span><span class="o">==</span><span class="s1">&#39;table&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">table</span><span class="p">:</span> <span class="k">return</span>
                    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xls&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">table</span><span class="p">,</span><span class="n">contentType</span><span class="o">=</span><span class="s1">&#39;application/vnd.ms-excel&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendPygmentizedFile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">table</span><span class="p">,</span><span class="n">hl_lines</span><span class="o">=</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">lineNo</span><span class="p">],</span><span class="n">linenostep</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">rest</span><span class="o">==</span><span class="s1">&#39;winbatch&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">winBatch</span><span class="p">:</span> <span class="k">return</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sendPygmentizedFile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">winBatch</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">def</span> <span class="nf">log_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">req</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">def</span> <span class="nf">sendGlobal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">html</span><span class="o">=</span><span class="s1">&#39;&lt;HTML&gt;&lt;TITLE&gt;Woo-batch at </span><span class="si">%s</span><span class="s1"> overview&lt;/TITLE&gt;&lt;BODY&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span>
            <span class="n">html</span><span class="o">+=</span><span class="n">globalHtmlStats</span><span class="p">()</span>
            <span class="n">html</span><span class="o">+=</span><span class="s1">&#39;&lt;TABLE border=1&gt;&lt;tr&gt;&lt;th&gt;id&lt;/th&gt;&lt;th&gt;status&lt;/th&gt;&lt;th&gt;info&lt;/th&gt;&lt;th&gt;cores&lt;/th&gt;&lt;th&gt;plots&lt;/th&gt;&lt;th&gt;command&lt;/th&gt;&lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span> <span class="n">html</span><span class="o">+=</span><span class="n">j</span><span class="o">.</span><span class="n">htmlStats</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">html</span><span class="o">+=</span><span class="s1">&#39;&lt;/TABLE&gt;&lt;/BODY&gt;&lt;/HTML&gt;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendHttp</span><span class="p">(</span><span class="n">html</span><span class="p">,</span><span class="n">contentType</span><span class="o">=</span><span class="s1">&#39;text/html&#39;</span><span class="p">,</span><span class="n">refresh</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">refresh</span><span class="p">)</span> <span class="c1"># refresh sent as header</span>
        <span class="k">def</span> <span class="nf">sendTextFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="o">**</span><span class="n">headers</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">404</span><span class="p">);</span> <span class="k">return</span>
            <span class="kn">import</span> <span class="nn">codecs</span>
            <span class="n">f</span><span class="o">=</span><span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendHttp</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span><span class="n">contentType</span><span class="o">=</span><span class="s1">&#39;text/plain;charset=utf-8;&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">sendFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">contentType</span><span class="p">,</span><span class="o">**</span><span class="n">headers</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">404</span><span class="p">);</span> <span class="k">return</span>
            <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendHttp</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span><span class="n">contentType</span><span class="o">=</span><span class="n">contentType</span><span class="p">,</span><span class="o">**</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">sendHttp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">contentType</span><span class="p">,</span><span class="o">**</span><span class="n">headers</span><span class="p">):</span>
            <span class="s2">&quot;Send file over http, using appropriate content-type. Headers are converted to strings. The *refresh* header is handled specially: if the value is 0, it is not sent at all.&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s1">&#39;Content-type&#39;</span><span class="p">,</span><span class="n">contentType</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;refresh&#39;</span> <span class="ow">in</span> <span class="n">headers</span> <span class="ow">and</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;refresh&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">del</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;refresh&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="n">h</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="c1"># convert to bytes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="c1"># global httpLastServe</span>
                <span class="n">httpLastServe</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1"># disconnected when serving the request</span>
            <span class="k">except</span> <span class="ne">BrokenPipeError</span><span class="p">:</span>
                <span class="k">pass</span> 
        <span class="k">def</span> <span class="nf">sendPygmentizedFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">404</span><span class="p">);</span> <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">codecs</span>
                <span class="kn">from</span> <span class="nn">pygments</span> <span class="k">import</span> <span class="n">highlight</span>
                <span class="kn">from</span> <span class="nn">pygments.lexers</span> <span class="k">import</span> <span class="n">PythonLexer</span>
                <span class="kn">from</span> <span class="nn">pygments.formatters</span> <span class="k">import</span> <span class="n">HtmlFormatter</span>
                <span class="n">data</span><span class="o">=</span><span class="n">highlight</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span><span class="n">PythonLexer</span><span class="p">(),</span><span class="n">HtmlFormatter</span><span class="p">(</span><span class="n">linenos</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">f</span><span class="p">),</span><span class="o">**</span><span class="n">kw</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendHttp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">contentType</span><span class="o">=</span><span class="s1">&#39;text/html;charset=utf-8;&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendTextFile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">runHttpStatsServer</span><span class="p">():</span>
        <span class="n">maxPort</span><span class="o">=</span><span class="mi">11000</span><span class="p">;</span> <span class="n">port</span><span class="o">=</span><span class="mi">9080</span>
        <span class="k">while</span> <span class="n">port</span><span class="o">&lt;</span><span class="n">maxPort</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">server</span><span class="o">=</span><span class="n">HTTPServer</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">port</span><span class="p">),</span><span class="n">HttpStatsServer</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">_thread</span><span class="p">;</span> <span class="n">_thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">,())</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;http://localhost:</span><span class="si">%d</span><span class="s2"> shows batch summary&quot;</span><span class="o">%</span><span class="n">port</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">webbrowser</span>
                <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;http://localhost:</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">port</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="n">port</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">port</span><span class="o">==</span><span class="n">maxPort</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARN: No free port in range 9080-11000, not starting HTTP stats server!&quot;</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">runJob</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;RUNNING&#39;</span>
        <span class="n">job</span><span class="o">.</span><span class="n">prepareToRun</span><span class="p">()</span>
        <span class="n">job</span><span class="o">.</span><span class="n">started</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">();</span>
        
        <span class="nb">print</span><span class="p">((</span><span class="n">bright</span><span class="p">(</span><span class="n">yellow</span><span class="p">(</span><span class="s1">&#39;   #</span><span class="si">{job.num}</span><span class="s1"> (</span><span class="si">{job.id}{nCores}{cores}</span><span class="s1">) started&#39;</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; on </span><span class="si">{asctime}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span><span class="n">nCores</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">nCores</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;/</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">job</span><span class="o">.</span><span class="n">nCores</span><span class="p">),</span><span class="n">cores</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39; [&#39;</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">cores</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">cores</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">asctime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()))</span>
        <span class="c1">#print &#39;#%d cores&#39;,%(job.num,job.cores)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">WIN</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">exitStatus</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">winBatch</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">exitStatus</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">exitStatus</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>  <span class="c1"># fake normal exit, if crashing at the very end</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">log</span><span class="p">)</span> <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Woo: normal exit.&#39;</span><span class="p">)])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">exitStatus</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">exitStatus</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   #</span><span class="si">%d</span><span class="s1"> system exit status </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">num</span><span class="p">,</span><span class="n">job</span><span class="o">.</span><span class="n">exitStatus</span><span class="p">))</span>
        <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;DONE&#39;</span>
        <span class="n">job</span><span class="o">.</span><span class="n">finished</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">dt</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">finished</span><span class="o">-</span><span class="n">job</span><span class="o">.</span><span class="n">started</span><span class="p">;</span>
        <span class="n">job</span><span class="o">.</span><span class="n">durationSec</span><span class="o">=</span><span class="n">dt</span>
        <span class="n">job</span><span class="o">.</span><span class="n">duration</span><span class="o">=</span><span class="n">t2hhmmss</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">colorize</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">bright</span><span class="p">(</span><span class="n">green</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">exitStatus</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">bright</span><span class="p">(</span><span class="n">red</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
        <span class="n">havePlot</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">plotsFile</span><span class="p">):</span>
            <span class="n">f</span><span class="o">=</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">log</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.log&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">job</span><span class="o">.</span><span class="n">log</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">woo</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">plotImgFormat</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">plotsFile</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
                <span class="n">job</span><span class="o">.</span><span class="n">plotsFile</span><span class="o">=</span><span class="n">f</span>
                <span class="n">havePlot</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span> <span class="k">pass</span> <span class="c1"># file deleted in the meantime?</span>
        <span class="nb">print</span><span class="p">((</span><span class="n">colorize</span><span class="p">(</span><span class="s1">&#39;   #</span><span class="si">{job.num}</span><span class="s1"> (</span><span class="si">{job.id}{nCores}</span><span class="s1">) </span><span class="si">{strStatus}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;(exit status </span><span class="si">{job.exitStatus}</span><span class="s1">), duration </span><span class="si">{job.duration}</span><span class="s1">, log </span><span class="si">{job.log}{jobPlot}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span><span class="n">nCores</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">nCores</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;/</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">job</span><span class="o">.</span><span class="n">nCores</span><span class="p">,</span><span class="n">strStatus</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;done    &#39;</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">exitStatus</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;FAILED &#39;</span><span class="p">),</span><span class="n">jobPlot</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;, plot </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">plotsFile</span><span class="p">)</span> <span class="k">if</span> <span class="n">havePlot</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
        <span class="n">job</span><span class="o">.</span><span class="n">saveInfo</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">runJobs</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span><span class="n">numCores</span><span class="p">):</span>
        <span class="n">running</span><span class="p">,</span><span class="n">pending</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>
        <span class="n">inf</span><span class="o">=</span><span class="mi">1000000</span>
        <span class="c1"># time to sleep between check for finished jobs</span>
        <span class="c1"># this value is adjusted dynamically</span>
        <span class="n">sleepTime</span><span class="o">=.</span><span class="mi">5</span> 
        <span class="n">sleepTimeMin</span><span class="p">,</span><span class="n">sleepTimeMax</span><span class="o">=.</span><span class="mi">005</span><span class="p">,</span><span class="mi">2</span> <span class="c1"># in seconds; .005 is in the order of the startup time</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">running</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pending</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">pending</span><span class="p">,</span><span class="n">running</span><span class="p">,</span><span class="n">done</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">j</span><span class="o">.</span><span class="n">nCores</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;PENDING&#39;</span><span class="p">]),</span><span class="nb">sum</span><span class="p">([</span><span class="n">j</span><span class="o">.</span><span class="n">nCores</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;RUNNING&#39;</span><span class="p">]),</span><span class="nb">sum</span><span class="p">([</span><span class="n">j</span><span class="o">.</span><span class="n">nCores</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;DONE&#39;</span><span class="p">])</span>
            <span class="n">numFreeCores</span><span class="o">=</span><span class="n">numCores</span><span class="o">-</span><span class="n">running</span>
            <span class="n">minRequire</span><span class="o">=</span><span class="nb">min</span><span class="p">([</span><span class="n">inf</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">nCores</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;PENDING&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">minRequire</span><span class="o">==</span><span class="n">inf</span><span class="p">:</span> <span class="n">minRequire</span><span class="o">=</span><span class="mi">0</span>
            <span class="c1">#print pending,&#39;pending;&#39;,running,&#39;running;&#39;,done,&#39;done;&#39;,numFreeCores,&#39;free;&#39;,minRequire,&#39;min&#39;</span>
            <span class="n">overloaded</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">if</span> <span class="n">minRequire</span><span class="o">&gt;</span><span class="n">numFreeCores</span> <span class="ow">and</span> <span class="n">running</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">overloaded</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># a job wants more cores than the total we have</span>
            <span class="n">pendingJobs</span><span class="o">=</span><span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;PENDING&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">randomize</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">pendingJobs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">pendingJobs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">nCores</span><span class="o">&lt;=</span><span class="n">numFreeCores</span> <span class="ow">or</span> <span class="n">overloaded</span><span class="p">:</span>
                    <span class="n">freeCores</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">numCores</span><span class="p">))</span><span class="o">-</span><span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">cores</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;RUNNING&#39;</span><span class="p">))</span>
                    <span class="c1">#print &#39;freeCores:&#39;,freeCores,&#39;numFreeCores:&#39;,numFreeCores,&#39;overloaded&#39;,overloaded</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">overloaded</span><span class="p">:</span>
                        <span class="c1"># only set cores if CPU affinity is desired; otherwise, just numer of cores is used</span>
                        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">affinity</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">cores</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">freeCores</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">j</span><span class="o">.</span><span class="n">nCores</span><span class="p">]</span> <span class="c1"># take required number of free cores</span>
                    <span class="c1"># if overloaded, do not assign cores directly</span>
                    <span class="n">_thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span><span class="n">runJob</span><span class="p">,(</span><span class="n">j</span><span class="p">,))</span>
                    <span class="k">break</span>
            <span class="c1"># adjust sleepTime if some jobs have already finished</span>
            <span class="k">if</span> <span class="n">done</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">avgDone</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">j</span><span class="o">.</span><span class="n">durationSec</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="s1">&#39;DONE&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">done</span>
                <span class="c1"># don&#39;t waist more than 5% of time by being idle</span>
                <span class="n">sleepTime</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="o">.</span><span class="mi">05</span><span class="o">*</span><span class="n">avgDone</span><span class="p">,</span><span class="n">sleepTimeMax</span><span class="p">),</span><span class="n">sleepTimeMin</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleepTime</span><span class="p">)</span> <span class="c1">## FIXME: make this configurable, or auto-adjusting</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    
    
    <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">re</span><span class="o">,</span><span class="nn">argparse</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">multiprocessing</span>
    <span class="n">numCores</span><span class="o">=</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
    <span class="n">maxOmpThreads</span><span class="o">=</span><span class="n">numCores</span> <span class="k">if</span> <span class="s1">&#39;openmp&#39;</span> <span class="ow">in</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">features</span> <span class="k">else</span> <span class="mi">1</span>
    
    <span class="n">parser</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Woo: batch system: runs Woo simulation multiple times with different parameters.</span><span class="se">\n\n</span><span class="s1">See https://woodem.org/user/batch.html for details.</span><span class="se">\n\n</span><span class="s1">Batch can be specified either with parameter table TABLE (must not end in .py), which is either followed by exactly one SIMULATION.py (must end in .py), or contains !SCRIPT column specifying the simulation to be run. The second option is to specify multiple scripts, which can optionally have /nCores suffix to specify number of cores for that particular simulation (corresponds to !THREADS column in the parameter table), e.g. sim.py/3.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-j&#39;</span><span class="p">,</span><span class="s1">&#39;--jobs&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;maxJobs&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum number of simultaneous threads to run (default: number of cores, further limited by OMP_NUM_THREADS if set by the environment: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="n">numCores</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;NUM&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="n">numCores</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--job-threads&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;defaultThreads&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Default number of threads for one job; can be overridden by per-job with !THREADS (or !OMP_NUM_THREADS) column. Defaults to 1.&quot;</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;NUM&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--force-threads&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;forceThreads&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Force jobs to not use more cores than the maximum (see \-j), even if !THREADS colums specifies more.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--log&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;logFormat&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Format of job log files: must contain a $, </span><span class="si">%%</span><span class="s1"> or @, which will be replaced by script name, line number or by title column respectively. Directory for logs will be created automatically. (default: logs/$.@.log)&#39;</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;FORMAT&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;logs/$.@.log&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--global-log&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;globalLog&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Filename where to redirect output of woo-batch itself (as opposed to \-\-log); if not specified (default), stdout/stderr are used&#39;</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;FILE&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-l&#39;</span><span class="p">,</span><span class="s1">&#39;--lines&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;lineList&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Lines of TABLE to use, in the format 2,3-5,8,11-13 (default: all available lines in TABLE)&#39;</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;LIST&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--results&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;resultsDb&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;File (HDF5 or SQLite) where simulation should store its results (such as input/output files and some data); the default is to use </span><span class="si">{tableName}</span><span class="s1">.hdf5 (</span><span class="si">{tableName}</span><span class="s1">.sqlite under Windows), if there is a param table, otherwise each simulation defines its own default files to write results in.</span><span class="se">\n</span><span class="s1">The preferred format is HDF5 (usually *.hdf5, *.h5, *.he5, *.hdf), SQLite is used for *.sqlite, *.db.&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--nice&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;nice&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Nice value of spawned jobs (default: 10)&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cpu-affinity&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;affinity&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Bind each job to specific CPU cores; cores are assigned in a quasi-random order, depending on availability at the moment the jobs is started. Each job can override this setting by setting AFFINE column.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--executable&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;executable&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of the program to run (default: </span><span class="si">%s</span><span class="s1">). Jobs can override with !EXEC column.&#39;</span><span class="o">%</span><span class="n">executable</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="n">executable</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;FILE&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--rebuild&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;rebuild&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run executable(s) with --rebuild prior to running any jobs.&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--debug&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run the executable with --debug. Can be overriddenn per-job with !DEBUG column.&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--gnuplot&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;gnuplotOut&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Gnuplot file where gnuplot from all jobs should be put together&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;FILE&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dry-run&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;dryRun&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Do not actually run (useful for getting gnuplot only, for instance)&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--http-wait&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;httpWait&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Do not quit if still serving overview over http repeatedly&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--exit-prompt&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;exitPrompt&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Do not quit until a key is pressed in the terminal (useful for reviewing plots after all simulations finish).&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># parser.add_argument(&#39;--generate-manpage&#39;,help=&#39;Generate man page documenting this program and exit&#39;,dest=&#39;manpage&#39;,metavar=&#39;FILE&#39;)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot-update&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;plotAlwaysUpdateTime&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Interval (in seconds) at which job plots will be updated even if not requested via HTTP. Non-positive values will make the plots not being updated and saved unless requested via HTTP (see \-\-plot-timeout for controlling maximum age of those).  Plots are saved at exit under the same name as the log file, with the .log extension removed. (default: 120 seconds)&#39;</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot-timeout&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;plotTimeout&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Maximum age (in seconds) of plots served over HTTP; they will be updated if they are older. (default: 30 seconds)&#39;</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--refresh&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;refresh&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Refresh rate of automatically reloaded web pages (summary, logs, ...).&#39;</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--timing&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;timing&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;COUNT&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Repeat each job COUNT times, and output a simple table with average/variance/minimum/maximum job duration; used for measuring how various parameters affect execution time. Jobs can override the global value with the !COUNT column.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--timing-output&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;FILE&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;timingOut&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;With --timing, save measured durations to FILE, instead of writing to standard output.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--randomize&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;randomize&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Randomize job order (within constraints given by assigned cores).&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-table&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;notable&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Treat all command-line argument as simulations to be run, either python scripts or saved simulations.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;simulations&#39;</span><span class="p">,</span><span class="n">nargs</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">REMAINDER</span><span class="p">)</span>
    <span class="c1">#parser.add_argument(&#39;--serial&#39;,action=&#39;store_true&#39;,dest=&#39;serial&#39;,default=False,help=&#39;Run all jobs serially, even if there are free cores</span>
    <span class="n">opts</span><span class="o">=</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">args</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">simulations</span>
    
    <span class="n">logFormat</span><span class="p">,</span><span class="n">lineList</span><span class="p">,</span><span class="n">maxJobs</span><span class="p">,</span><span class="n">nice</span><span class="p">,</span><span class="n">executable</span><span class="p">,</span><span class="n">gnuplotOut</span><span class="p">,</span><span class="n">dryRun</span><span class="p">,</span><span class="n">httpWait</span><span class="p">,</span><span class="n">globalLog</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">logFormat</span><span class="p">,</span><span class="n">opts</span><span class="o">.</span><span class="n">lineList</span><span class="p">,</span><span class="n">opts</span><span class="o">.</span><span class="n">maxJobs</span><span class="p">,</span><span class="n">opts</span><span class="o">.</span><span class="n">nice</span><span class="p">,</span><span class="n">opts</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span><span class="n">opts</span><span class="o">.</span><span class="n">gnuplotOut</span><span class="p">,</span><span class="n">opts</span><span class="o">.</span><span class="n">dryRun</span><span class="p">,</span><span class="n">opts</span><span class="o">.</span><span class="n">httpWait</span><span class="p">,</span><span class="n">opts</span><span class="o">.</span><span class="n">globalLog</span>
    
    <span class="c1">#if opts.manpage:</span>
    <span class="c1">#    import woo.manpage</span>
    <span class="c1">#    woo.config.metadata[&#39;short_desc&#39;]=&#39;batch system for computational platform Woo&#39;</span>
    <span class="c1">#    woo.config.metadata[&#39;long_desc&#39;]=&#39;Manage batches of computation jobs for the Woo platform; batches are described using text-file tables with parameters which are passed to individual runs of woo. Jobs are being run with pre-defined number of computational cores as soon as the required number of cores is available. Logs of all computations are stored in files and the batch progress can be watched online at (usually) http://localhost:9080. Unless overridden, the executable woo%s is used to run jobs.&#39;%(suffix)</span>
    <span class="c1">#    woo.manpage.generate_manpage(parser,woo.config.metadata,opts.manpage,section=1,seealso=&#39;woo%s (1)\n.br\nhttps://woodem.org/user/batch.html&#39;%suffix)</span>
    <span class="c1">#    print &#39;Manual page %s generated.&#39;%opts.manpage</span>
    <span class="c1">#    sys.exit(0)</span>
    
    <span class="n">tailProcess</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">def</span> <span class="nf">runTailProcess</span><span class="p">(</span><span class="n">globalLog</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="n">tailProcess</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s2">&quot;tail&quot;</span><span class="p">,</span><span class="s2">&quot;--line=+0&quot;</span><span class="p">,</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span><span class="n">globalLog</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">WIN</span> <span class="ow">and</span> <span class="n">globalLog</span> <span class="ow">and</span> <span class="kc">False</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Redirecting all output to&#39;</span><span class="p">,</span><span class="n">globalLog</span><span class="p">)</span>
        <span class="c1"># if not deleted, tail detects truncation and outputs multiple times</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">globalLog</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">globalLog</span><span class="p">)</span> 
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">globalLog</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
        <span class="c1"># try to run tee in separate thread</span>
        <span class="kn">import</span> <span class="nn">_thread</span>
        <span class="n">_thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span><span class="n">runTailProcess</span><span class="p">,(</span><span class="n">globalLog</span><span class="p">,))</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;.*\.py(/[0-9]+)?&#39;</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">opts</span><span class="o">.</span><span class="n">notable</span><span class="p">:</span>
        <span class="c1"># if all args end in .py, they are simulations that we will run</span>
        <span class="n">table</span><span class="o">=</span><span class="kc">None</span><span class="p">;</span> <span class="n">scripts</span><span class="o">=</span><span class="n">args</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">table</span><span class="p">,</span><span class="n">scripts</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],[</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">table</span><span class="p">,</span><span class="n">scripts</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Will run simulation(s) </span><span class="si">%s</span><span class="s2"> using `</span><span class="si">%s</span><span class="s2">&#39;, nice value </span><span class="si">%d</span><span class="s2">, using max </span><span class="si">%d</span><span class="s2"> cores.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">scripts</span><span class="p">,</span><span class="n">executable</span><span class="p">,</span><span class="n">nice</span><span class="p">,</span><span class="n">maxJobs</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">table</span><span class="p">:</span>
        <span class="n">reader</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">TableParamReader</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="n">params</span><span class="o">=</span><span class="n">reader</span><span class="o">.</span><span class="n">paramDict</span><span class="p">()</span>
        <span class="n">availableLines</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Will use table `</span><span class="si">%s</span><span class="s2">&#39;, with available lines&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">table</span><span class="p">),</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">availableLines</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">lineList</span><span class="p">:</span>
            <span class="n">useLines</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">def</span> <span class="nf">numRange2List</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span> <span class="n">ret</span><span class="o">+=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]));</span> <span class="n">ret</span><span class="o">+=</span><span class="p">[</span><span class="n">ret</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">ret</span><span class="o">+=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span>
                <span class="k">return</span> <span class="n">ret</span>
            <span class="n">useLines0</span><span class="o">=</span><span class="n">numRange2List</span><span class="p">(</span><span class="n">lineList</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">useLines0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">availableLines</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Skipping unavailable line </span><span class="si">%d</span><span class="s1"> that was requested from the command line.&#39;</span><span class="o">%</span><span class="n">l</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">useLines</span><span class="o">+=</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">useLines</span><span class="o">=</span><span class="n">availableLines</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Will use lines &quot;</span><span class="p">,</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">useLines</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running </span><span class="si">%d</span><span class="s2"> stand-alone simulation(s) in batch mode.&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scripts</span><span class="p">)))</span>
        <span class="n">useLines</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scripts</span><span class="p">):</span>
            <span class="n">fakeLineNo</span><span class="o">=</span><span class="n">i</span>
            <span class="n">useLines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fakeLineNo</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">fakeLineNo</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span><span class="s1">&#39;default&#39;</span><span class="p">,</span><span class="s1">&#39;!SCRIPT&#39;</span><span class="p">:</span><span class="n">s</span><span class="p">}</span>
            <span class="c1"># fix script and set threads if script.py/num</span>
            <span class="n">m</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;(.*)(/[0-9]+)$&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">fakeLineNo</span><span class="p">][</span><span class="s1">&#39;!SCRIPT&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">params</span><span class="p">[</span><span class="n">fakeLineNo</span><span class="p">][</span><span class="s1">&#39;!THREADS&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
    
    <span class="n">jobs</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">executables</span><span class="o">=</span><span class="nb">set</span><span class="p">()</span>
    <span class="n">logFiles</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">resultsDb</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">prefExt</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;hdf5&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s1">&#39;win32&#39;</span> <span class="k">else</span> <span class="s1">&#39;sqlite&#39;</span><span class="p">)</span>
        <span class="n">resultsDb</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">prefExt</span><span class="p">)</span> <span class="k">if</span> <span class="n">table</span> <span class="k">else</span> <span class="s1">&#39;batch.&#39;</span><span class="o">+</span><span class="n">prefExt</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">resultsDb</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">resultsDb</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results database is&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">resultsDb</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">woo</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">mayHaveStaleLock</span><span class="p">(</span><span class="n">resultsDb</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="s1">&#39;###&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   The results database (</span><span class="si">%s</span><span class="s1">) is locked</span><span class="se">\n\n</span><span class="s1">The lock might be stale (unless something is really writing results right now) which will make simulation to hang waiting for the lock to be released. If you encounter problems (simulations never finishing), try to break the lock by deleting the lock file (by default, </span><span class="si">%s</span><span class="s1">.lock)</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">resultsDb</span><span class="p">,</span><span class="n">resultsDb</span><span class="p">)</span><span class="o">+</span><span class="mi">100</span><span class="o">*</span><span class="s1">&#39;###&#39;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">useLines</span><span class="p">):</span>
        <span class="n">script</span><span class="o">=</span><span class="n">scripts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scripts</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">envVars</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">nCores</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">defaultThreads</span>
        <span class="n">jobExecutable</span><span class="o">=</span><span class="n">executable</span>
        <span class="n">jobAffinity</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">affinity</span>
        <span class="n">jobDebug</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">debug</span>
        <span class="n">jobCount</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">timing</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;!&#39;</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">val</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">==</span><span class="s1">&#39;!OMP_NUM_THREADS&#39;</span> <span class="ow">or</span> <span class="n">col</span><span class="o">==</span><span class="s1">&#39;!THREADS&#39;</span><span class="p">:</span> <span class="n">nCores</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">col</span><span class="o">==</span><span class="s1">&#39;!EXEC&#39;</span><span class="p">:</span> <span class="n">jobExecutable</span><span class="o">=</span><span class="n">val</span>
            <span class="k">elif</span> <span class="n">col</span><span class="o">==</span><span class="s1">&#39;!SCRIPT&#39;</span><span class="p">:</span> <span class="n">script</span><span class="o">=</span><span class="n">val</span>
            <span class="k">elif</span> <span class="n">col</span><span class="o">==</span><span class="s1">&#39;!AFFINITY&#39;</span><span class="p">:</span> <span class="n">jobAffinity</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">col</span><span class="o">==</span><span class="s1">&#39;!DEBUG&#39;</span><span class="p">:</span> <span class="n">jobDebug</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">col</span><span class="o">==</span><span class="s1">&#39;!COUNT&#39;</span><span class="p">:</span> <span class="n">jobCount</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">envVars</span><span class="o">+=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">val</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">script</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;When only batch table is given without script to run, it must contain !SCRIPT column with simulation to be run.&#39;</span><span class="p">)</span>
        <span class="n">logFile</span><span class="o">=</span><span class="n">logFormat</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span><span class="n">script</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">,</span><span class="n">params</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nCores</span><span class="o">&gt;</span><span class="n">maxJobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">forceThreads</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Forcing job #</span><span class="si">%d</span><span class="s1"> to use only </span><span class="si">%d</span><span class="s1"> cores (max available) instead of </span><span class="si">%d</span><span class="s1"> requested&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">maxJobs</span><span class="p">,</span><span class="n">nCores</span><span class="p">))</span>
                <span class="n">nCores</span><span class="o">=</span><span class="n">maxJobs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;WARNING: job #</span><span class="si">%d</span><span class="s1"> will use </span><span class="si">%d</span><span class="s1"> cores but only </span><span class="si">%d</span><span class="s1"> are available&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">nCores</span><span class="p">,</span><span class="n">maxJobs</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;openmp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">woo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">features</span> <span class="ow">and</span> <span class="n">nCores</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Job #</span><span class="si">%d</span><span class="s1"> will be uselessly run with </span><span class="si">%d</span><span class="s1"> threads (compiled without OpenMP support).&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">nCores</span><span class="p">))</span>
        <span class="n">executables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">jobExecutable</span><span class="p">)</span>
        <span class="c1"># compose command-line: build the hyper-linked variant, then strip HTML tags (ugly, but ensures consistency)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">opts</span><span class="o">.</span><span class="n">timing</span> <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">timing</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">jobNum</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>
            <span class="n">logFile2</span><span class="o">=</span><span class="n">logFile</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">j</span> <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">timing</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">logDir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">logFile2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logDir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">logDir</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;WARNING: creating log directory &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">logDir</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">logDir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">WIN</span><span class="p">:</span> <span class="n">logFile2</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[&lt;&gt;:&quot;|?*=,]&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">logFile2</span><span class="p">)</span>
            <span class="c1"># append numbers to log file if it already exists, to prevent overwriting</span>
            <span class="k">if</span> <span class="n">logFile2</span> <span class="ow">in</span> <span class="n">logFiles</span><span class="p">:</span>
                <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
                <span class="k">while</span> <span class="n">logFile2</span><span class="o">+</span><span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span> <span class="ow">in</span> <span class="n">logFiles</span><span class="p">:</span> <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">logFile2</span><span class="o">+=</span><span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span>
            <span class="n">logFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logFile2</span><span class="p">)</span>
            
            <span class="n">hrefCmd</span><span class="o">=</span><span class="n">fullCmd</span><span class="o">=</span><span class="kc">None</span>
            <span class="n">desc</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;!SCRIPT&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="n">desc</span><span class="o">=</span><span class="n">script</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">desc</span> <span class="c1"># prepend filename if script is specified explicitly</span>
            <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">timing</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">desc</span><span class="o">+=</span><span class="s1">&#39;[</span><span class="si">%d</span><span class="s1">]&#39;</span><span class="o">%</span><span class="n">j</span>
            <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">JobInfo</span><span class="p">(</span><span class="n">jobNum</span><span class="p">,</span><span class="n">desc</span><span class="p">,</span><span class="n">fullCmd</span><span class="p">,</span><span class="n">hrefCmd</span><span class="p">,</span><span class="n">logFile2</span><span class="p">,</span><span class="n">nCores</span><span class="p">,</span><span class="n">script</span><span class="o">=</span><span class="n">script</span><span class="p">,</span><span class="n">table</span><span class="o">=</span><span class="p">(</span><span class="n">table</span> <span class="k">if</span> <span class="n">table</span><span class="o">!=</span><span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span><span class="n">lineNo</span><span class="o">=</span><span class="n">l</span><span class="p">,</span><span class="n">affinity</span><span class="o">=</span><span class="n">jobAffinity</span><span class="p">,</span><span class="n">resultsDb</span><span class="o">=</span><span class="n">resultsDb</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">jobDebug</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="n">jobExecutable</span><span class="p">,</span><span class="n">nice</span><span class="o">=</span><span class="n">nice</span><span class="p">))</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Master process pid&quot;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">WIN</span><span class="p">:</span>
        <span class="c1"># HACK: shell suspends the batch sometimes due to tty output, unclear why (both zsh and bash do that).</span>
        <span class="c1">#       Let&#39;s just ignore SIGTTOU here.</span>
        <span class="kn">import</span> <span class="nn">signal</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTTOU</span><span class="p">,</span><span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>
    
    
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">rebuild</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rebuilding all active executables, since --rebuild was specified&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">executables</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">subprocess</span>
            <span class="k">if</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">e</span><span class="p">,</span><span class="s1">&#39;--rebuild&#39;</span><span class="p">,</span><span class="s1">&#39;-x&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">([</span><span class="s1">&#39;--debug&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">debug</span> <span class="k">else</span> <span class="p">[])):</span>
                 <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Error rebuilding </span><span class="si">%s</span><span class="s1"> (--rebuild).&#39;</span><span class="o">%</span><span class="n">e</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rebuilding done.&quot;</span><span class="p">)</span>
            
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Job summary:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">((</span><span class="n">bright</span><span class="p">(</span><span class="s1">&#39;   #</span><span class="si">{job.num}</span><span class="s1"> (</span><span class="si">{job.id}{cores}</span><span class="s1">)&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;: </span><span class="si">{job.table}</span><span class="s1"> </span><span class="si">{job.lineNo}</span><span class="s1"> </span><span class="si">{job.resultsDb}</span><span class="s1">: </span><span class="si">{job.executable}</span><span class="s1"> </span><span class="si">{job.script}</span><span class="s1"> &gt; </span><span class="si">{job.log}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">nCores</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;/</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">job</span><span class="o">.</span><span class="n">nCores</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    
    
    <span class="n">httpLastServe</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">runHttpStatsServer</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">plotAlwaysUpdateTime</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="c1"># update plots periodically regardless of whether they are requested via HTTP</span>
        <span class="k">def</span> <span class="nf">updateAllPlots</span><span class="p">():</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">plotAlwaysUpdateTime</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                <span class="c1"># sys.stderr(&#39;Update plots for job %s&#39;%str(job))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">updatePlots</span><span class="p">()</span>
        <span class="n">_thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span><span class="n">updateAllPlots</span><span class="p">,())</span>
    
    <span class="c1"># OK, go now</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dryRun</span><span class="p">:</span> <span class="n">runJobs</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span><span class="n">maxJobs</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All jobs finished, total time &#39;</span><span class="p">,</span><span class="n">t2hhmmss</span><span class="p">(</span><span class="n">totalRunningTime</span><span class="p">()))</span>
    
    <span class="n">plots</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">plotsFile</span><span class="p">):</span> <span class="k">continue</span>
        <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">plotsFile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plots</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Plot files:&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots</span><span class="p">))</span>
    
    <span class="c1"># for easy grepping in logfiles:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Log files:&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">j</span><span class="o">.</span><span class="n">log</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">]))</span>
    
    <span class="c1"># write timing table</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">timing</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">timingOut</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing gathered timing information to&#39;</span><span class="p">,</span><span class="n">opts</span><span class="o">.</span><span class="n">timingOut</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">timingOut</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to open file </span><span class="si">%s</span><span class="s1"> for timing output, writing to stdout.&#39;</span><span class="o">%</span><span class="n">opts</span><span class="o">.</span><span class="n">timingOut</span><span class="p">)</span>
                <span class="n">out</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Gathered timing information:&#39;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="c1"># write header</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;## timing data, written &#39;</span><span class="o">+</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39; with arguments</span><span class="se">\n</span><span class="s1">##    &#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">##</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">paramNames</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">());</span> <span class="n">paramNames</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;## line</span><span class="se">\t</span><span class="s1">count</span><span class="se">\t</span><span class="s1">avg</span><span class="se">\t</span><span class="s1">dev</span><span class="se">\t</span><span class="s1">relDev</span><span class="se">\t</span><span class="s1">min</span><span class="se">\t</span><span class="s1">max</span><span class="se">\t</span><span class="s1">|</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paramNames</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">math</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">useLines</span><span class="p">):</span>
            <span class="n">jobTimes</span><span class="o">=</span><span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">durationSec</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">lineNo</span><span class="o">==</span><span class="n">l</span> <span class="ow">and</span> <span class="n">j</span><span class="o">.</span><span class="n">durationSec</span><span class="o">!=</span><span class="kc">None</span><span class="p">]</span>
            <span class="n">tSum</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">jobTimes</span><span class="p">);</span> <span class="n">tAvg</span><span class="o">=</span><span class="n">tSum</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">jobTimes</span><span class="p">)</span>
            <span class="n">tMin</span><span class="p">,</span><span class="n">tMax</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">jobTimes</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">jobTimes</span><span class="p">)</span>
            <span class="n">tDev</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">t</span><span class="o">-</span><span class="n">tAvg</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">jobTimes</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">jobTimes</span><span class="p">))</span>
            <span class="n">tRelDev</span><span class="o">=</span><span class="n">tDev</span><span class="o">/</span><span class="n">tAvg</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="se">\t</span><span class="si">%d</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.3g</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="s1">|</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">jobTimes</span><span class="p">),</span><span class="n">tAvg</span><span class="p">,</span><span class="n">tDev</span><span class="p">,</span><span class="n">tRelDev</span><span class="p">,</span><span class="n">tMin</span><span class="p">,</span><span class="n">tMax</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paramNames</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">gnuplotOut</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bye.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Assembling gnuplot files…&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">file</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">log</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gnuplot &#39;</span><span class="p">):</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">plot</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">break</span>
        <span class="n">preamble</span><span class="p">,</span><span class="n">plots</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,[]</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARN: No plot found for job &quot;</span><span class="o">+</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">file</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">plot</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;plot&#39;</span><span class="p">):</span>
                    <span class="c1"># attempt to parse the plot line</span>
                    <span class="n">ll</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># rest of the line, without newline</span>
                    <span class="c1"># replace title &#39;something&#39; with title &#39;title&#39;: something&#39;</span>
                    <span class="n">ll</span><span class="p">,</span><span class="n">nn</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">subn</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;title\s+[</span><span class="se">\&#39;</span><span class="s1">&quot;]([^</span><span class="se">\&#39;</span><span class="s1">&quot;]*)[</span><span class="se">\&#39;</span><span class="s1">&quot;]&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;title &quot;&#39;</span><span class="o">+</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;: \1&quot;&#39;</span><span class="p">,</span><span class="n">ll</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nn</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Plot line in &quot;</span><span class="o">+</span><span class="n">job</span><span class="o">.</span><span class="n">plot</span><span class="o">+</span><span class="s2">&quot; not parsed (skipping): &quot;</span><span class="o">+</span><span class="n">ll</span><span class="p">)</span>
                    <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">plots</span><span class="p">:</span> <span class="c1"># first plot, copy all preceding lines</span>
                    <span class="n">preamble</span><span class="o">+=</span><span class="n">l</span>
        <span class="n">gp</span><span class="o">=</span><span class="n">file</span><span class="p">(</span><span class="n">gnuplotOut</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">gp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span>
        <span class="n">gp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;plot &#39;</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gnuplot&quot;</span><span class="p">,</span><span class="n">gnuplotOut</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plot written, bye.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">httpWait</span> <span class="ow">and</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">httpLastServe</span><span class="o">&lt;</span><span class="mi">30</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(continue serving http until no longer requested  as per --http-wait)&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">httpLastServe</span><span class="o">&lt;</span><span class="mi">30</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">exitPrompt</span><span class="p">:</span>
        <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Press Enter to exit (--exit-prompt)...&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">tailProcess</span><span class="p">:</span> <span class="n">tailProcess</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    <span class="c1">#woo.master.exitNoBacktrace()</span>
    <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">disableGdb</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">0</span></div>
    
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">Woo 1.0+rev1-git-e79c213 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">wooMain</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2012−2022, Václav Šmilauer &lt;eu@doxos.eu&gt;.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>