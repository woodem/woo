


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Performance issues &#8212; Woo 1.0+rev1-git-515e770 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/cloud.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>

    
    
     
        <script src="../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../_static/cloud.base.js"></script>
    

    
     
        <script src="../_static/cloud.js"></script>
    

    <link rel="shortcut icon" href="../_static/woo-favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Timestep computation" href="timestep.html" />
    <link rel="prev" title="Conventions" href="conventions.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="timestep.html" title="Timestep computation"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="conventions.html" title="Conventions"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">Woo 1.0+rev1-git-515e770 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Programming manual</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Performance issues</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="performance-issues">
<h1>Performance issues<a class="headerlink" href="#performance-issues" title="Permalink to this headline">¶</a></h1>
<section id="timing">
<h2>Timing<a class="headerlink" href="#timing" title="Permalink to this headline">¶</a></h2>
<p>Timing services can be used to determine bottlenecks of a simulation, for the purposes of changing its setup, or improving the c++ code. Woo provides two services to measure time spent in different parts of the code. The first one is on per-engine level, the other on arbitrary fine c++-source level (requiring re-compilation).</p>
<section id="engine-timing">
<span id="id1"></span><h3>Engine timing<a class="headerlink" href="#engine-timing" title="Permalink to this headline">¶</a></h3>
<p>The coarser timing works by merely accumulating numebr of invocations and time (with the precision of the <code class="docutils literal notranslate"><span class="pre">clock_gettime</span></code> function) spent in each engine, which can be then post-processed by associated Python module <a class="reference internal" href="../woo.timing.html#module-woo.timing" title="woo.timing"><code class="xref py py-obj docutils literal notranslate"><span class="pre">woo.timing</span></code></a>. There is the bool variable <a class="reference internal" href="../woo.core.html#woo.core.Master.timingEnabled" title="woo.core.Master.timingEnabled"><code class="xref py py-obj docutils literal notranslate"><span class="pre">woo.master.timingEnabled</span></code></a> controlling whether such measurements take place (disabled by default). If the script sets this flag to <code class="docutils literal notranslate"><span class="pre">True</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">timingEnabled</span><span class="o">=</span><span class="kc">True</span>
</pre></div>
</div>
<p>then the data can be reported in aggregated form by <a class="reference internal" href="../woo.timing.html#woo.timing.stats" title="woo.timing.stats"><code class="xref py py-obj docutils literal notranslate"><span class="pre">woo.timing.stats</span></code></a> and reset to zero using <a class="reference internal" href="../woo.timing.html#woo.timing.reset" title="woo.timing.reset"><code class="xref py py-obj docutils literal notranslate"><span class="pre">woo.timing.reset</span></code></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For legacy reasons, this timing functions operate on the master scene only, which should not be an issue in normal circumstances.</p>
</div>
<p>Let’s see the output from the <a class="reference internal" href="../woo.pre.html#woo.pre.horse.FallingHorse" title="woo.pre.horse.FallingHorse"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FallingHorse</span></code></a> preprocessor:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Woo</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">woo.pre.horse</span><span class="o">,</span> <span class="nn">woo.timing</span>
<span class="n">Woo</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">S</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">scene</span><span class="o">=</span><span class="n">woo</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">horse</span><span class="o">.</span><span class="n">FallingHorse</span><span class="p">()()</span>
<span class="n">Woo</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">woo</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">timingEnabled</span><span class="o">=</span><span class="kc">True</span>
<span class="n">Woo</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">S</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">Woo</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">woo.timing</span>
<span class="n">Woo</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">woo</span><span class="o">.</span><span class="n">timing</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>

<span class="n">Name</span>                                                  <span class="n">Count</span>            <span class="n">Time</span> <span class="p">[</span><span class="n">ms</span><span class="p">]</span>        <span class="n">Rel</span><span class="o">.</span> <span class="n">time</span> <span class="p">[</span><span class="o">%</span><span class="p">]</span>
<span class="o">-----------------------------------------------------------------------------------------------------</span>
<span class="s2">&quot;leapfrog&quot;</span>                                        <span class="mi">500</span>                <span class="mf">831.3</span>                <span class="mf">21.85</span>
<span class="s2">&quot;collider&quot;</span>                                  <span class="p">(</span><span class="mi">175</span><span class="p">)</span> <span class="mi">500</span>               <span class="mf">1478.2</span>                <span class="mf">38.86</span>
<span class="s2">&quot;contactLoop&quot;</span>                                     <span class="mi">500</span>                <span class="mf">839.1</span>                <span class="mf">22.06</span>
<span class="s2">&quot;dynDt&quot;</span>                                             <span class="mi">5</span>                  <span class="mf">6.7</span>                 <span class="mf">0.18</span>
<span class="n">PyRunner</span>                                           <span class="mi">50</span>                 <span class="mf">13.0</span>                 <span class="mf">0.34</span>
<span class="n">PyRunner</span>                                           <span class="mi">10</span>                  <span class="mf">1.8</span>                 <span class="mf">0.05</span>
<span class="n">BoxOutlet</span>                                           <span class="mi">5</span>                  <span class="mf">0.3</span>                 <span class="mf">0.01</span>
<span class="n">VtkExport</span>                                          <span class="mi">12</span>                <span class="mf">595.4</span>                <span class="mf">15.65</span>
<span class="s2">&quot;flowAnalysis&quot;</span>                                     <span class="mi">13</span>                 <span class="mf">25.8</span>                 <span class="mf">0.68</span>
<span class="s2">&quot;tracer&quot;</span>                                           <span class="mi">25</span>                 <span class="mf">12.7</span>                 <span class="mf">0.33</span>
<span class="n">TOTAL</span>                                                               <span class="mf">3804.2</span>               <span class="mf">100.00</span>
</pre></div>
</div>
<p>Interpretation of the table is straight-forward. Total running time was 3.8s, out of which ≈20% was motion integration (labels are shown for engines which do have a label, and are thus accessible as e.g. <code class="docutils literal notranslate"><span class="pre">S.lab.leapfrog</span></code>), ≈40% collision detection, ≈20% contact resolution, ≈15% export to VTK and then negligible amount of time for the rest. The number <code class="docutils literal notranslate"><span class="pre">(175)</span></code> for collider signifies how many times it did the full run (as opposed only to checking that it does not have to run in that step).</p>
</section>
<section id="in-engine-and-in-functor-timing">
<span id="timing-deltas-timing"></span><h3>In-engine and in-functor timing<a class="headerlink" href="#in-engine-and-in-functor-timing" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Refer also to <a class="reference external" href="https://yade-dem.org/doc/prog.html#timing">Yade documentation on timing</a> for documentation of the older interface; those documents could still be useful despite changes.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">woo::TimingDeltas</span></code> class is responsible for tracking hi-resolution timing information; it can handle parallel execution of code, which is often the case with functors, which are run in parallel. There is no locking involved in parallel execution, thus the impact of taking time measurements should be small. This type of analysis requires the respective section of code to be recompiled, as this type of timing is not enabled in production code and is used for developing only.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Even when compiled-in, also this detailed timing framework will be active at runtime only when <a class="reference internal" href="../woo.core.html#woo.core.Master.timingEnabled" title="woo.core.Master.timingEnabled"><code class="xref py py-obj docutils literal notranslate"><span class="pre">woo.master.timingEnabled</span></code></a> is set, as explained above.</p>
</div>
<p>It is advisable to guard the timing calls by locally-defined macros, so that it can be enabled-disabled with a single change in the source code. Checkpoints are identified by a number (often <code class="docutils literal notranslate"><span class="pre">__LINE__</span></code> is used for that, as it is unique as long as the timed code stays within one single file, but any other number is permissible) and also has a human-readable name which appears in the output.</p>
<p>Every <a class="reference internal" href="../woo.core.html#woo.core.Engine" title="woo.core.Engine"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Engine</span></code></a> and <a class="reference internal" href="../woo.core.html#woo.core.Functor" title="woo.core.Functor"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Functor</span></code></a> contains the <code class="docutils literal notranslate"><span class="pre">timingDeltas</span></code> member, but it is by default unallocated. Thus it should be conditionally allocated when the engine is called.</p>
<p>This is your hypothetical header:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define MYENGINE_TIMING </span><span class="c1">// comment this definition to disable timing altogether</span>
<span class="cp">#ifdef MYENGINE_TIMING</span>
   <span class="cp">#define MYENGINE_CHECKPOINT(name) timingDeltas-&gt;checkpoint(__LINE__,name)</span>
<span class="cp">#else</span>
   <span class="cp">#define MYENGINE_CHECKPOINT(name) </span><span class="c1">// expand to nothing unless MYENGINE_TIMING is defined</span>
<span class="cp">#else</span>

<span class="k">struct</span> <span class="nl">MyEngine</span><span class="p">:</span> <span class="k">public</span> <span class="n">Engine</span><span class="p">{</span>
   <span class="kt">void</span> <span class="n">run</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
   <span class="c1">// ...</span>
<span class="p">};</span>
<span class="n">WOO_REGISTER_OBJECT</span><span class="p">(</span><span class="n">MyEngine</span><span class="p">);</span>
</pre></div>
</div>
<p>And this would be the implementation file:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">MyEngine</span><span class="o">::</span><span class="n">run</span><span class="p">(){</span>
   <span class="cp">#ifdef MYENGINE_TIMING</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">timingDeltas</span><span class="p">)</span> <span class="n">timingDeltas</span><span class="o">=</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">TimingDeltas</span><span class="o">&gt;</span><span class="p">();</span>
      <span class="n">timingDeltas</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
   <span class="cp">#endif</span>
   <span class="c1">// some code</span>
   <span class="n">MYENGINE_CHECKPOINT</span><span class="p">(</span><span class="s">&quot;step-1&quot;</span><span class="p">)</span>
   <span class="c1">// some code</span>
   <span class="n">MYENGINE_CHECKPOINT</span><span class="p">(</span><span class="s">&quot;step-2&quot;</span><span class="p">)</span>
   <span class="c1">// some code</span>
   <span class="n">MYENGINE_CHECKPOINT</span><span class="p">(</span><span class="s">&quot;finito&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For functors, allocating <code class="docutils literal notranslate"><span class="pre">timingDeltas</span></code> is mandatorily done in the constructor, since the very first call might be parallel already, leading to race conditions (this could be done for engines as well, but it is not necessary); we are omiting the marco-guard here for simplicity:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nl">Law2_L6Geom_FrictPhys_MyLaw</span><span class="p">:</span> <span class="k">public</span> <span class="n">LawFunctor</span><span class="p">{</span>
   <span class="kt">bool</span> <span class="n">go</span><span class="p">(</span><span class="k">const</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">CGeom</span><span class="o">&gt;&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">CPhys</span><span class="o">&gt;&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Contact</span><span class="o">&gt;&amp;</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
   <span class="n">FUNCTOR2D</span><span class="p">(</span><span class="n">L6Geom</span><span class="p">,</span><span class="n">FrictPhys</span><span class="p">);</span>
   <span class="cp">#define woo_dem_Law2_L6Geom_FrictPhys_MyLaw__CLASS_BASE_DOC_ATTRS_CTOR \</span>
<span class="cp">      Law2_L6Geom_FrictPhys_MyLaw,LawFunctor,&quot;Some documentation&quot; \</span>
<span class="cp">      ((int,someVar,-1,,&quot;Document someVar&quot;)) \</span>
<span class="cp">      ,</span><span class="cm">/*ctor*/</span><span class="cp"> timingDeltas=make_shared&lt;TimingDeltas&gt;(); </span><span class="cm">/* &lt;--- this constructs the TimingDeltas */</span><span class="cp"></span>

   <span class="n">WOO_DECL__CLASS_BASe_DOC_ATTRS_CTOR</span><span class="p">(</span><span class="n">woo_dem_Law2_L6Geom_FrictPhys_MyLaw__CLASS_BASE_DOC_ATTRS_CTOR</span><span class="p">);</span>
<span class="p">};</span>
<span class="n">WOO_REGISTER_OBJECT</span><span class="p">(</span><span class="n">Law2_L6Geom_FrictPhys_MyLaw</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">meanwhile in the .cpp file:</span>
<span class="cm">*/</span>

<span class="kt">bool</span> <span class="n">Law2_L6Geom_FrictPhys_IdealElPl</span><span class="o">::</span><span class="n">go</span><span class="p">(</span><span class="k">const</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">CGeom</span><span class="o">&gt;&amp;</span> <span class="n">cg</span><span class="p">,</span> <span class="k">const</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">CPhys</span><span class="o">&gt;&amp;</span> <span class="n">cp</span><span class="p">,</span> <span class="k">const</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Contact</span><span class="o">&gt;&amp;</span> <span class="n">C</span><span class="p">){</span>
   <span class="n">timingDeltas</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span> <span class="c1">// important to check time at the very beginning!</span>
   <span class="cm">/* ... */</span>
   <span class="n">timingDeltas</span><span class="o">-&gt;</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">,</span><span class="s">&quot;init&quot;</span><span class="p">);</span>
   <span class="cm">/* ... */</span>
   <span class="n">timingDeltas</span><span class="o">-&gt;</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">,</span><span class="s">&quot;finito&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Report issues or inclarities to <a class="reference external" href="https://github.com/woodem/woo/issues">github</a>.</p>
</div>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="sphinx-toc sphinxlocaltoc">
    <h3><a href="../contents.html">Page contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Performance issues</a><ul>
<li><a class="reference internal" href="#timing">Timing</a><ul>
<li><a class="reference internal" href="#engine-timing">Engine timing</a></li>
<li><a class="reference internal" href="#in-engine-and-in-functor-timing">In-engine and in-functor timing</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="conventions.html"
                          title="Previous page">&larr; Conventions</a></p>
  </div>
  <div class="sphinxnext">
    <h4>Next page</h4>
    <p class="topless"><a href="timestep.html"
                          title="Next page">&rarr; Timestep computation</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/prog/performance.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="timestep.html" title="Timestep computation"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="conventions.html" title="Conventions"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">Woo 1.0+rev1-git-515e770 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >Programming manual</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Performance issues</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2012−2022, Václav Šmilauer &lt;eu@doxos.eu&gt;.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>